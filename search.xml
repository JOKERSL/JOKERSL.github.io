<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[iOSä¸­copy,strong,retain,weakå’Œassignçš„åŒºåˆ«]]></title>
    <url>%2F2018%2F09%2F14%2FiOS%E4%B8%ADcopy-strong-retain-weak%E5%92%8Cassign%E7%9A%84%E5%8C%BA%E5%88%AB%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡é€»è¾‘å›¾ï¼š æ–‡ç« é€»è¾‘å›¾ åœ¨çŸ¥é“ä»–ä»¬åŒºåˆ«ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“NSObjectå¯¹è±¡çš„èµ‹å€¼æ“ä½œåšäº†å“ªäº›æ“ä½œã€‚ A=Cå…¶å®žæ˜¯åœ¨å†…å­˜ä¸­åˆ›å»ºäº†ä¸€ä¸ªAï¼Œç„¶åŽåˆå¼€è¾Ÿäº†ä¸€ä¸ªå†…å­˜Cï¼ŒCé‡Œé¢å­˜æ”¾çš„ç€å€¼Bã€‚ NSObjectèµ‹å€¼ç¤ºæ„å›¾1 å¦‚ä¸‹ï¼š 1234NSMutableString*tempMStr = [[NSMutableString alloc]initWithString:@&quot;strValue&quot;];NSLog(@&quot;tempMStrå€¼åœ°å€:%pï¼ŒtempMStrå€¼%@,tempMStrå€¼å¼•ç”¨è®¡æ•°%@\\n&quot;, tempMStr,tempMStr,[tempMStr valueForKey:@&quot;retainCount&quot;]);//è¾“å‡ºtempMStrå€¼åœ°å€:0x7a05f650ï¼ŒtempMStrå€¼strValue,tempMStrå€¼å¼•ç”¨è®¡æ•°1 æ­¤å¤„tempMStrå°±æ˜¯Aï¼Œå€¼åœ°å€å°±æ˜¯Cï¼Œâ€œstrValueâ€å°±æ˜¯Bï¼Œè€Œå¼•ç”¨è®¡æ•°è¿™ä¸ªæ¦‚å¿µæ˜¯é’ˆå¯¹Cçš„ï¼Œèµ‹å€¼ç»™å…¶ä»–å˜é‡æˆ–è€…æŒ‡é’ˆè®¾ç½®ä¸ºnilï¼Œå¦‚tempStr = nilï¼Œéƒ½ä¼šä½¿å¾—å¼•ç”¨è®¡æ•°æœ‰æ‰€å¢žå‡ã€‚å½“å†…å­˜åŒºåŸŸå¼•ç”¨è®¡æ•°ä¸º0æ—¶å°±ä¼šå°†æ•°æ®æŠ¹é™¤ã€‚è€Œæˆ‘ä»¬ä½¿ç”¨copy,strong,retain,weak,assignåŒºåˆ«å°±åœ¨ï¼š 1.æ˜¯å¦å¼€è¾Ÿæ–°çš„å†…å­˜2.æ˜¯å¦å¯¹åœ°å€Cæœ‰å¼•ç”¨è®¡æ•°å¢žåŠ  éœ€è¦æ³¨æ„çš„æ˜¯propertyä¿®é¥°ç¬¦æ˜¯åœ¨è¢«èµ‹å€¼æ—¶èµ·ä½œç”¨ã€‚ 1.ä»¥å…¸åž‹çš„NSMutableStringä¸ºä¾‹ 123456789101112131415161718192021222324@property(copy,nonatomic)NSMutableString*aCopyMStr;@property(strong,nonatomic)NSMutableString*strongMStr;@property(weak,nonatomic)NSMutableString*weakMStr;@property(assign,nonatomic)NSMutableString*assignMStr;NSMutableString*mstrOrigin = [[NSMutableStringalloc]initWithString:@&quot;mstrOriginValue&quot;];self.aCopyMStr= mstrOrigin;self.strongMStr= mstrOrigin;self.strongMStr= mstrOrigin;self.weakMStr= mstrOrigin;NSLog(@&quot;mstrOriginè¾“å‡º:%p,%@\\n&quot;, mstrOrigin,mstrOrigin);NSLog(@&quot;aCopyMStrè¾“å‡º:%p,%@\\n&quot;,_aCopyMStr,_aCopyMStr);NSLog(@&quot;strongMStrè¾“å‡º:%p,%@\\n&quot;,_strongMStr,_strongMStr);NSLog(@&quot;weakMStrè¾“å‡º:%p,%@\\n&quot;,_weakMStr,_weakMStr);NSLog(@&quot;å¼•ç”¨è®¡æ•°%@&quot;,[mstrOriginvalueForKey:@&quot;retainCount&quot;]);//è¾“å‡ºç»“æžœ//2016-09-01 15:19:13.134 lbCopy[1205:87583] mstrOriginè¾“å‡º:0x7892a5e0,mstrOriginValue//2016-09-01 15:19:13.135 lbCopy[1205:87583] aCopyMStrè¾“å‡º:0x7893deb0,mstrOriginValue//2016-09-01 15:19:13.135 lbCopy[1205:87583] strongMStrè¾“å‡º:0x7892a5e0,mstrOriginValue//2016-09-01 15:19:13.135 lbCopy[1205:87583] weakMStrè¾“å‡º:0x7892a5e0,mstrOriginValue//2016-09-01 15:19:13.135 lbCopy[1205:87583] å¼•ç”¨è®¡æ•°2 strongMStrå’ŒweakMStræŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åœ°å€éƒ½å’ŒmstrOriginç›¸åŒ,ä½†mstrOriginå†…å­˜å¼•ç”¨è®¡æ•°ä¸º2ï¼Œä¸ä¸º3ï¼Œå› ä¸ºweakMStrè™½ç„¶æŒ‡å‘äº†æ•°æ®å†…å­˜åœ°å€ï¼ˆä¹‹åŽç”¨Cç®€ç§°ï¼Œè§ç¤ºæ„å›¾1ï¼‰ï¼Œä½†ä¸ä¼šå¢žåŠ Cè®¡æ•°ã€‚copyä¿®é¥°çš„çš„aCopyMStrï¼Œèµ‹å€¼åŽåˆ™æ˜¯è‡ªå·±å•ç‹¬å¼€è¾Ÿäº†ä¸€å—å†…å­˜ï¼Œå†…å­˜ä¸Šä¿å­˜â€œmstrOriginâ€å­—ç¬¦ä¸²ï¼Œå¹¶æŒ‡å‘ã€‚ æ‹·è´ç¤ºæ„å›¾å¦‚ä¸‹ NSMutableStringæ‹·è´ç¤ºæ„å›¾2 å¯è§å½“æˆ‘ä¿®æ”¹mstrOriginçš„å€¼çš„æ—¶å€™ï¼Œå¿…ç„¶ä¸ä¼šå½±å“aCopyMStr,åªä¼šå½±å“strongMStrå’ŒweakMStrã€‚æˆ‘ä»¬æ¥éªŒè¯ä¸‹ 12345678910111213NSLog(@&quot;------------------ä¿®æ”¹åŽŸå€¼åŽ------------------------&quot;);[mstrOriginappendString:@&quot;1&quot;];NSLog(@&quot;mstrOriginè¾“å‡º:%p,%@\\n&quot;, mstrOrigin,mstrOrigin);NSLog(@&quot;aCopyMStrè¾“å‡º:%p,%@\\n&quot;,_aCopyMStr,_aCopyMStr);NSLog(@&quot;strongMStrè¾“å‡º:%p,%@\\n&quot;,_strongMStr,_strongMStr);NSLog(@&quot;weakMStrè¾“å‡º:%p,%@\\n&quot;,_weakMStr,_weakMStr);//è¾“å‡ºç»“æžœ//2016-09-01 15:33:02.839 lbCopy[1205:87583] mstrOriginè¾“å‡º:0x7892a5e0,mstrOrigin1//2016-09-01 15:33:02.839 lbCopy[1205:87583] aCopyMStrè¾“å‡º:0x7893deb0,mstrOrigin//2016-09-01 15:33:02.839 lbCopy[1205:87583] strongMStrè¾“å‡º:0x7892a5e0,mstrOrigin1//2016-09-01 15:33:02.839 lbCopy[1205:87583] weakMStrè¾“å‡º:0x7892a5e0,mstrOrigin1 copyä¼šé‡æ–°å¼€è¾Ÿæ–°çš„å†…å­˜æ¥ä¿å­˜ä¸€ä»½ç›¸åŒçš„æ•°æ®ã€‚è¢«èµ‹å€¼å¯¹è±¡å’ŒåŽŸå€¼ä¿®æ”¹äº’ä¸å½±å“ã€‚strongå’Œweakèµ‹å€¼éƒ½æŒ‡å‘åŽŸæ¥æ•°æ®åœ°å€ï¼ŒåŒºåˆ«æ˜¯å‰è€…ä¼šå¯¹æ•°æ®åœ°å€è¿›è¡Œå¼•ç”¨è®¡æ•°+1ï¼ŒåŽè€…ä¸ä¼š å¼•ç”¨è®¡æ•°æ˜¯å¦+1æœ‰ä»€ä¹ˆå®žè´¨åŒºåˆ«å‘¢ï¼Ÿ å¦‚æžœçŸ¥é“â€œå€¼åœ°å€çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œåœ°å€ä¸Šä¿å­˜çš„å€¼å°±ä¼šè¢«é‡Šæ”¾â€ã€‚é‚£ä¹ˆåŒºåˆ«å°±ä¸éš¾ç†è§£ï¼Œweakä¿®é¥°çš„æŒ‡é’ˆAæŒ‡å‘çš„å€¼åœ°å€Cï¼Œé‚£ä¹ˆåœ°å€ä¸Šå½“å…¶ä»–æŒ‡å‘ä»–çš„æŒ‡é’ˆè¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼åœ°å€å¼•ç”¨è®¡æ•°ä¹Ÿå°±å˜ä¸º0äº†ï¼Œè¿™ä¸ªAçš„å€¼ä¹Ÿå°±ä¸ºniläº†ã€‚æ¢å¥è¯è¯´å½“å€¼åœ°å€Cä¸Šæ²¡æœ‰å…¶ä»–å¼ºå¼•ç”¨æŒ‡é’ˆä¿®é¥°çš„æ—¶å€™Cå°±ä¼šè¢«ç«‹å³é‡Šæ”¾ï¼ŒAçš„å€¼å°±å˜ä¸ºniläº†ã€‚ è¿™é‡Œæˆ‘ä»¬æ¥åˆå§‹åŒ–mstrOriginå’Œå¹¶å°†strongMStrè®¾ç½®ä¸ºnilè®©Cçš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œç„¶åŽè¾“å‡ºweakMStrï¼Œçœ‹æ˜¯å¦ä¸ºnil.æ³¨ï¼šåˆå§‹åŒ–å’Œè®¾ä¸ºniléƒ½å¯ä»¥å°†æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ•°æ®åœ°å€å¼•ç”¨è®¡æ•°å‡å°‘1 12345678910mstrOrigin = [[NSMutableStringalloc]initWithString:@&quot;mstrOriginChange2&quot;];self.strongMStr=nil;NSLog(@&quot;mstrOriginè¾“å‡º:%p,%@\\n&quot;, mstrOrigin,mstrOrigin);NSLog(@&quot;strongMStrè¾“å‡º:%p,%@\\n&quot;,_strongMStr,_strongMStr);NSLog(@&quot;weakMStrè¾“å‡º:%p,%@\\n&quot;,_weakMStr,_weakMStr);è¾“å‡ºç»“æžœ//2016-09-01 15:41:33.793 lbCopy[1247:100742] mstrOriginè¾“å‡º:0x7874d140,mstrOriginChange2//2016-09-01 15:41:33.793 lbCopy[1247:100742] strongMStrè¾“å‡º:0x0,(null)//2016-09-01 15:41:33.794 lbCopy[1247:100742] weakMStrè¾“å‡º:0x0,(null) å¯è§ä¹‹å‰å¼•ç”¨è®¡æ•°2æ˜¯mstrOriginå’ŒstrongMStræ·»åŠ çš„ã€‚ç»“è®ºï¼šcopyä¼šé‡æ–°å¼€è¾Ÿæ–°çš„å†…å­˜æ¥ä¿å­˜ä¸€ä»½ç›¸åŒçš„æ•°æ®ã€‚è¢«èµ‹å€¼å¯¹è±¡å’ŒåŽŸå€¼ä¿®æ”¹äº’ä¸å½±å“ã€‚strongå’Œweakè™½ç„¶éƒ½æŒ‡å‘åŽŸæ¥æ•°æ®åœ°å€ï¼ŒåŽŸå€¼ä¿®æ”¹çš„æ—¶å€™storngå’Œweakä¼šéšä¹‹å˜åŒ–ã€‚åŒºåˆ«æ˜¯å‰è€…ä¼šå¯¹æ•°æ®åœ°å€è¿›è¡Œå¼•ç”¨è®¡æ•°+1é˜²æ­¢åŽŸåœ°å€å€¼è¢«é‡Šæ”¾ï¼Œä½†åŽè€…ä¸ä¼šï¼Œå½“å…¶ä»–å€¼éƒ½ä¸åœ¨æŒ‡å‘å€¼åœ°å€æ—¶ï¼Œå€¼åœ°å€è¢«é‡Šæ”¾ï¼Œweakçš„å€¼ä¹Ÿå°±æ˜¯ä¸ºniläº†ã€‚æˆ‘ä»¬ç§°ä¼šå¯¹æ•°æ®åœ°å€å¢žåŠ å¼•ç”¨è®¡æ•°çš„ä¸ºå¼ºå¼•ç”¨ï¼Œä¸æ”¹å˜å¼•ç”¨è®¡æ•°çš„ä¸ºå¼±å¼•ç”¨ 1.2 assignå’Œweakçš„åŒºåˆ«å¯¹assignå’Œweakä¿®é¥°çš„å€¼è¿›è¡Œèµ‹å€¼ï¼Œå¹¶è¾“å‡ºæŒ‡é’ˆç»“æž„åœ°å€å’Œå€¼ 12345self.assignMStr= mstrOrigin;self.weakMStr= mstrOrigin;mstrOrigin = [[NSMutableStringalloc]initWithString:@&quot;mstrOriginChange3&quot;];NSLog(@&quot;weakMStrè¾“å‡º:%p,%@\\n&quot;,_weakMStr,_weakMStr);NSLog(@&quot;assignMStrè¾“å‡º:%p,%@\\n&quot;,self.assignMStr,self.assignMStr); å¯ä»¥å‘çŽ°åœ¨è¾“å‡ºassignMStræ—¶ä¼šå¶å°”å‡ºçŽ°å¥”æºƒçš„æƒ…å†µã€‚åŽŸå› æ˜¯å‘é€äº†é‡ŽæŒ‡é’ˆçš„æƒ…å†µã€‚assignåŒweakï¼ŒæŒ‡å‘Cå¹¶ä¸”è®¡æ•°ä¸+1ï¼Œä½†å½“Cåœ°å€å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œassignä¸ä¼šå¯¹Cåœ°å€è¿›è¡ŒBæ•°æ®çš„æŠ¹é™¤æ“ä½œï¼Œåªæ˜¯è¿›è¡Œå€¼é‡Šæ”¾ã€‚è¿™å°±å¯¼è‡´é‡ŽæŒ‡é’ˆå­˜åœ¨ï¼Œå³å½“è¿™å—åœ°å€è¿˜æ²¡å†™ä¸Šå…¶ä»–å€¼å‰ï¼Œèƒ½è¾“å‡ºæ­£å¸¸å€¼ï¼Œä½†ä¸€æ—¦é‡æ–°å†™ä¸Šæ•°æ®ï¼Œè¯¥æŒ‡é’ˆéšæ—¶å¯èƒ½æ²¡æœ‰å€¼ï¼Œé€ æˆå¥”æºƒã€‚ 1.3é‚£retainæ˜¯ä»€ä¹ˆARCä¹‹å‰å±žæ€§æž„é€ å™¨çš„å…³é”®å­—æ˜¯retain,copy,assignï¼Œstrongå’Œweakæ˜¯ARCå¸¦å‡ºæ¥çš„å…³é”®å­—ã€‚retainçŽ°åœ¨åŒstrongï¼Œå°±æ˜¯æŒ‡é’ˆæŒ‡å‘å€¼åœ°å€ï¼ŒåŒæ—¶è¿›è¡Œå¼•ç”¨è®¡æ•°åŠ 1ã€‚ 2.éžNSMutableStringçš„æƒ…å†µä¸Šé¢æˆ‘ä»¬è®¨è®ºäº†å…¸åž‹çš„ä¾‹å­NSMutableStringï¼Œå³éžå®¹å™¨å¯å˜å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´è¿˜å­˜åœ¨å…¶ä»–ä¸‰ç§ç±»åž‹éœ€è¦è®¨è®ºâ€¦ 1.éžå®¹å™¨ä¸å¯å˜å˜é‡NSSting2.å®¹å™¨å¯å˜å˜é‡NSMutableArray3.å®¹å™¨ä¸å¯å˜å˜é‡NSArray æ›´é‡è¦çš„æ˜¯ä¸åŒç±»åž‹ä¼šæœ‰ä¸åŒç»“æžœâ€¦ï¼Œå¥½å§ï¼Œä¸è¦å¥”æºƒï¼Œä¸Šé¢ä¸€å¤§æ®µæˆ‘ä»¬è®¨è®ºäº†1/4ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬è¦è®¨è®ºå…¶ä»–çš„3/4æƒ…å†µã€‚ä½†å¥½æ¶ˆæ¯æ˜¯ï¼Œå…¶ä»–å‡ ç§æƒ…å†µåŸºæœ¬ä¸Žä¸Šé¢éžå®¹å™¨å¯å˜å˜é‡æƒ…å†µåŸºæœ¬ç±»ä¼¼ã€‚ 2.1å®¹å™¨å¯å˜å˜é‡å®¹å™¨å¯å˜å˜é‡çš„å…¸åž‹ä¾‹å­å°±æ˜¯NSMutableArrayä¸‹é¢ä»£ç å¯ä»¥å¿½ç•¥ï¼Œåªåšå‚è€ƒç”¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113@property(copy,nonatomic)NSMutableArray*aCopyMArr;@property(strong,nonatomic)NSMutableArray*strongMArr;@property(weak,nonatomic)NSMutableArray*weakMArr;NSMutableArray*mArrOrigin = [[NSMutableArrayalloc]init];NSMutableString*mstr1 = [[NSMutableStringalloc]initWithString:@&quot;value1&quot;];NSMutableString*mstr2 = [[NSMutableStringalloc]initWithString:@&quot;value2&quot;];NSMutableString*mstr3 = [[NSMutableStringalloc]initWithString:@&quot;value3&quot;];[mArrOriginaddObject:mstr1];[mArrOriginaddObject:mstr2];//å°†mArrOriginæ‹·è´ç»™aCopyMArrï¼ŒstrongMArrï¼ŒweakMArrself.aCopyMArr= mArrOrigin;self.strongMArr= mArrOrigin;self.weakMArr= mArrOrigin;NSLog(@&quot;mArrOriginè¾“å‡º:%p,%@\\n&quot;, mArrOrigin,mArrOrigin);NSLog(@&quot;aCopyMArrè¾“å‡º:%p,%@\\n&quot;,_aCopyMArr,_aCopyMArr);NSLog(@&quot;strongMArrè¾“å‡º:%p,%@\\n&quot;,_strongMArr,_strongMArr);NSLog(@&quot;weakMArrè¾“å‡º:%p,%@\\n&quot;,_weakMArr,_weakMArr);NSLog(@&quot;weakMArrè¾“å‡º:%p,%@\\n&quot;,_weakMArr[0],_weakMArr[0]);NSLog(@&quot;mArrOriginä¸­çš„æ•°æ®å¼•ç”¨è®¡æ•°%@&quot;, [mArrOriginvalueForKey:@&quot;retainCount&quot;]);NSLog(@&quot;%p %p %p %p&quot;,&amp;mArrOrigin,mArrOrigin,mArrOrigin[0],mArrOrigin[1]);//ä»¥ä¸‹æ˜¯è¾“å‡º2016-09-02 20:42:30.777 lbCopy[4207:475091] mArrOriginè¾“å‡º:0x78f81680,(value1,value2)2016-09-02 20:42:30.777 lbCopy[4207:475091] aCopyMArrè¾“å‡º:0x7a041340,(value1,value2)2016-09-02 20:42:30.777 lbCopy[4207:475091] strongMArrè¾“å‡º:0x78f81680,(value1,value2)2016-09-02 20:42:30.777 lbCopy[4207:475091] weakMArrè¾“å‡º:0x78f81680,(value1,value2)2016-09-02 20:42:30.777 lbCopy[4207:475091] weakMArrè¾“å‡º:0x78f816a0,value12016-09-02 20:42:30.778 lbCopy[4207:475091] mArrOriginä¸­çš„æ•°æ®å¼•ç”¨è®¡æ•°(3,3)2016-09-02 20:42:30.778 lbCopy[4207:475091] 0xbffb4098 0x78f81680 0x78f816a0 0x78f81710//ä»¥ä¸Šæ˜¯è¾“å‡º//ç»™åŽŸæ•°ç»„æ·»åŠ ä¸€ä¸ªå…ƒç´ [mArrOriginaddObject:mstr3];NSLog(@&quot;mArrOriginè¾“å‡º:%p,%@\\n&quot;, mArrOrigin,mArrOrigin);NSLog(@&quot;aCopyMArrè¾“å‡º:%p,%@\\n&quot;,_aCopyMArr,_aCopyMArr);NSLog(@&quot;strongMArrè¾“å‡º:%p,%@\\n&quot;,_strongMArr,_strongMArr);NSLog(@&quot;weakMArrè¾“å‡º:%p,%@\\n&quot;,_weakMArr,_weakMArr);NSLog(@&quot;mArrOriginä¸­çš„æ•°æ®å¼•ç”¨è®¡æ•°%@&quot;, [mArrOriginvalueForKey:@&quot;retainCount&quot;]);//ä¿®æ”¹åŽŸæ•°ç»„ä¸­çš„å…ƒç´ ï¼Œçœ‹æ˜¯å¦æœ‰éšä¹‹å˜åŒ–[mstr1appendFormat:@&quot;aaa&quot;];NSLog(@&quot;mArrOriginè¾“å‡º:%p,%@\\n&quot;, mArrOrigin,mArrOrigin);NSLog(@&quot;aCopyMArrè¾“å‡º:%p,%@\\n&quot;,_aCopyMArr,_aCopyMArr);NSLog(@&quot;strongMArrè¾“å‡º:%p,%@\\n&quot;,_strongMArr,_strongMArr);NSLog(@&quot;weakMArrè¾“å‡º:%p,%@\\n&quot;,_weakMArr,_weakMArr);//ä»¥ä¸‹æ˜¯è¾“å‡º2016-09-02 20:42:30.778 lbCopy[4207:475091] mArrOriginè¾“å‡º:0x78f81680,(value1,value2,value3)2016-09-02 20:42:30.778 lbCopy[4207:475091] aCopyMArrè¾“å‡º:0x7a041340,(value1,value2)2016-09-02 20:42:30.778 lbCopy[4207:475091] strongMArrè¾“å‡º:0x78f81680,(value1,value2,value3)2016-09-02 20:42:30.778 lbCopy[4207:475091] weakMArrè¾“å‡º:0x78f81680,(value1,value2,value3)2016-09-02 20:42:30.779 lbCopy[4207:475091] mArrOriginä¸­çš„æ•°æ®å¼•ç”¨è®¡æ•°(3,3,2)2016-09-02 20:42:30.779 lbCopy[4207:475091] mArrOriginè¾“å‡º:0x78f81680,(value1aaa,value2,value3)2016-09-02 20:42:30.779 lbCopy[4207:475091] aCopyMArrè¾“å‡º:0x7a041340,(value1aaa,value2)2016-09-02 20:42:30.779 lbCopy[4207:475091] strongMArrè¾“å‡º:0x78f81680,(value1aaa,value2,value3)2016-09-02 20:42:30.779 lbCopy[4207:475091] weakMArrè¾“/å‡º:0x78f81680,(value1aaa,value2,value3)//ä»¥ä¸Šæ˜¯è¾“å‡º ä¸Šé¢ä»£ç æœ‰ç‚¹å¤šï¼Œæ‰€åšçš„æ“ä½œæ˜¯mArrOriginï¼ˆvalue1,value2ï¼‰èµ‹å€¼ç»™copy,strong,weakä¿®é¥°çš„aCopyMArr,strongMArr,weakMArrã€‚é€šè¿‡ç»™åŽŸæ•°ç»„å¢žåŠ å…ƒç´ ï¼Œä¿®æ”¹åŽŸæ•°ç»„å…ƒç´ å€¼ï¼Œç„¶åŽè¾“å‡ºmArrOriginçš„å¼•ç”¨è®¡æ•°ï¼Œå’Œæ•°ç»„åœ°å€ï¼ŒæŸ¥çœ‹å˜åŒ–ã€‚å‘çŽ°å…¶ä¸­æ•°ç»„æœ¬èº«æŒ‡å‘çš„å†…å­˜åœ°å€é™¤äº†aCopyMArré‡æ–°å¼€è¾Ÿäº†ä¸€å—åœ°å€ï¼ŒstrongMArr,weakMArrå’ŒmArrOriginæŒ‡é’ˆæŒ‡å‘çš„åœ°å€æ˜¯ä¸€æ ·çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ å®¹å™¨å¯å˜å˜é‡ä¸­å®¹å™¨æœ¬èº«å’Œéžå®¹å™¨å¯å˜å˜é‡æ˜¯ä¸€æ ·çš„ï¼Œcopyæ·±æ‹·è´ï¼ŒstrongMArr,weakMArrå’Œassignéƒ½æ˜¯æµ…æ‹·è´ å¦å¤–æˆ‘ä»¬å‘çŽ°è¢«æ‹·è´å¯¹è±¡mArrOriginä¸­çš„æ•°æ®å¼•ç”¨è®¡æ•°å±…ç„¶ä¸æ˜¯1è€Œæ˜¯3ã€‚ä¹Ÿå°±æ˜¯è¯´å®¹å™¨å†…çš„æ•°æ®æ‹·è´éƒ½æ˜¯è¿›è¡Œäº†æµ…æ‹·è´ã€‚åŒæ—¶å½“æˆ‘ä»¬ä¿®æ”¹æ•°ç»„ä¸­çš„ä¸€ä¸ªæ•°æ®æ—¶strongMArr,weakMArrï¼ŒaCopyMArrä¸­çš„æ•°æ®éƒ½æ”¹å˜äº†ï¼Œè¯´æ˜Ž å®¹å™¨å¯å˜å˜é‡ä¸­çš„æ•°æ®åœ¨æ‹·è´çš„æ—¶å€™éƒ½æ˜¯æµ…æ‹·è´ å®¹å™¨å¯å˜å˜é‡çš„æ‹·è´ç»“æž„å¦‚ä¸‹å›¾ NSMutableArrayæ‹·è´ç¤ºæ„å›¾3 2.2éžå®¹å™¨ä¸å˜å˜é‡ å…¸åž‹ä¾‹å­æ˜¯NSString æˆ‘ä»¬è¿˜æ˜¯ä»¥ä»£ç å¼•å‡ºç»“æžœ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596@property(copy,nonatomic)NSString*aCopyStr;@property(strong,nonatomic)NSString*strongStr;@property(weak,nonatomic)NSString*weakStr;@property(assign,nonatomic)NSString*assignStr;NSLog(@&quot;\\n\\n\\n\\n------------------ä¸å¯å˜é‡å®žéªŒ------------------------&quot;);NSString*strOrigin = [[NSStringalloc]initWithUTF8String:&quot;strOrigin0123456&quot;];self.aCopyStr= strOrigin;self.strongStr= strOrigin;self.weakStr= strOrigin;NSLog(@&quot;strOriginè¾“å‡º:%p,%@\\n&quot;, strOrigin,strOrigin);NSLog(@&quot;aCopyStrè¾“å‡º:%p,%@\\n&quot;,_aCopyStr,_aCopyStr);NSLog(@&quot;strongStrè¾“å‡º:%p,%@\\n&quot;,_strongStr,_strongStr);NSLog(@&quot;weakStrè¾“å‡º:%p,%@\\n&quot;,_weakStr,_weakStr);NSLog(@&quot;------------------ä¿®æ”¹åŽŸå€¼åŽ------------------------&quot;);strOrigin =@&quot;aaa&quot;;NSLog(@&quot;strOriginè¾“å‡º:%p,%@\\n&quot;, strOrigin,strOrigin);NSLog(@&quot;aCopyStrè¾“å‡º:%p,%@\\n&quot;,_aCopyStr,_aCopyStr);NSLog(@&quot;strongStrè¾“å‡º:%p,%@\\n&quot;,_strongStr,_strongStr);NSLog(@&quot;weakStrè¾“å‡º:%p,%@\\n&quot;,_weakStr,_weakStr);NSLog(@&quot;------------------ç»“è®º------------------------&quot;);NSLog(@&quot;strOriginå€¼å€¼ä¸ºæ”¹å˜ï¼Œä½†strOriginå’ŒaCopyStræŒ‡é’ˆåœ°å€å’ŒæŒ‡å‘éƒ½å·²ç»æ”¹å˜ï¼Œè¯´æ˜Žä¸å¯å˜ç±»åž‹å€¼ä¸å¯è¢«ä¿®æ”¹ï¼Œé‡æ–°åˆå§‹åŒ–&quot;);self.aCopyStr=nil;self.strongStr=nil;NSLog(@&quot;strOriginè¾“å‡º:%p,%@\\n&quot;, strOrigin,strOrigin);NSLog(@&quot;aCopyStrè¾“å‡º:%p,%@\\n&quot;,_aCopyStr,_aCopyStr);NSLog(@&quot;strongStrè¾“å‡º:%p,%@\\n&quot;,_strongStr,_strongStr);NSLog(@&quot;weakStrè¾“å‡º:%p,%@\\n&quot;,_weakStr,_weakStr);NSLog(@&quot;------------------ç»“è®º------------------------&quot;);NSLog(@&quot;å½“åªæœ‰weakStræ‹¥æœ‰Cæ—¶ï¼Œå€¼ä¾æ—§ä¼šè¢«é‡Šæ”¾ï¼ŒåŒéžå®¹å™¨å¯å˜å˜é‡&quot;);//ä»¥ä¸‹æ˜¯è¾“å‡º------------------ä¸å¯å˜é‡å®žéªŒ------------------------2016-09-02 21:08:44.053 lbCopy[4297:488549] strOriginè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.053 lbCopy[4297:488549] aCopyStrè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.054 lbCopy[4297:488549] strongStrè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.054 lbCopy[4297:488549] weakStrè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.054 lbCopy[4297:488549] strOriginå€¼å†…å­˜å¼•ç”¨è®¡æ•°32016-09-02 21:08:44.054 lbCopy[4297:488549] ------------------ä¿®æ”¹åŽŸå€¼åŽ------------------------2016-09-02 21:08:44.054 lbCopy[4297:488549] strOriginè¾“å‡º:0x8c1f8,aaa2016-09-02 21:08:44.054 lbCopy[4297:488549] aCopyStrè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.054 lbCopy[4297:488549] strongStrè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.055 lbCopy[4297:488549] weakStrè¾“å‡º:0x7a2550d0,strOrigin01234562016-09-02 21:08:44.055 lbCopy[4297:488549] ------------------ç»“è®º------------------------2016-09-02 21:08:44.055 lbCopy[4297:488549] strOriginå€¼å€¼ä¸ºæ”¹å˜ï¼Œä½†strOriginå’ŒaCopyStræŒ‡é’ˆåœ°å€å’ŒæŒ‡å‘éƒ½å·²ç»æ”¹å˜ï¼Œè¯´æ˜Žä¸å¯å˜ç±»åž‹å€¼ä¸å¯è¢«ä¿®æ”¹ï¼Œé‡æ–°åˆå§‹åŒ–2016-09-02 21:08:44.059 lbCopy[4297:488549] strOriginè¾“å‡º:0x8c1f8,aaa2016-09-02 21:08:44.059 lbCopy[4297:488549] aCopyStrè¾“å‡º:0x0,(null)2016-09-02 21:08:44.060 lbCopy[4297:488549] strongStrè¾“å‡º:0x0,(null)2016-09-02 21:08:44.060 lbCopy[4297:488549] weakStrè¾“å‡º:0x0,(null)2016-09-02 21:08:44.060 lbCopy[4297:488549] ------------------ç»“è®º------------------------2016-09-02 21:08:44.061 lbCopy[4297:488549]å½“åªæœ‰weakStræ‹¥æœ‰Cæ—¶ï¼Œå€¼ä¾æ—§ä¼šè¢«é‡Šæ”¾ï¼ŒåŒéžå®¹å™¨å¯å˜å˜é‡//ä»¥ä¸Šæ˜¯è¾“å‡º æ­¤å¤„æˆ‘ä»¬å°†strOriginæ‹·è´ç»™aCopyStrï¼ŒstrongStrï¼ŒweakStrï¼Œç„¶åŽè¾“å‡ºä»–ä»¬çš„å€¼åœ°å€ï¼Œå‘çŽ°ä»–ä»¬å››ä¸ªçš„å€¼åœ°å€ä¸€æ ·ï¼Œä¸”strOriginå€¼çš„å¼•ç”¨è®¡æ•°ä¸º3ã€‚ä¿®æ”¹strOriginå’Œå‘çŽ°strOriginå€¼åœ°å€æ”¹å˜ï¼Œå…¶ä»–ä¸‰ä¸ªå€¼åœ°å€ä¸å˜ï¼Œå°†aCopyStrï¼ŒstrongStrè®¾ä¸ºnilåŽï¼Œå‘çŽ°weakStréšä¹‹nilã€‚ ç»¼åˆä¸Šé¢çŽ°è±¡NSStringå’ŒNSMutableStringï¼ˆéžå®¹å™¨å¯å˜å˜é‡ï¼‰åŸºæœ¬ç›¸åŒï¼Œé™¤äº†copyï¼ŒNSStringä¸ºæµ…æ‹·è´ï¼ŒNSMutableStringæ˜¯æ·±æ‹·è´ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆNSStringçš„copyæ˜¯æµ…æ‹·è´å‘¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ºä»€ä¹ˆaCopySträ¸è‡ªå·±å¼€è¾Ÿä¸€ä¸ªç‹¬ç«‹çš„å†…å­˜å‡ºæ¥å‘¢ã€‚ç­”æ¡ˆå¾ˆç®€å•ï¼Œå› ä¸ºä¸å¯å˜é‡çš„å€¼ä¸ä¼šæ”¹å˜ï¼Œæ—¢ç„¶éƒ½ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥æ²¡å¿…è¦é‡æ–°å¼€è¾Ÿä¸€ä¸ªå†…å­˜å‡ºæ¥è®©aCopyStræŒ‡å‘ä»–ï¼Œç›´æŽ¥æŒ‡å‘åŽŸæ¥å€¼ä½ç½®å°±å¯ä»¥äº†ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ NSStringæ‹·è´ç¤ºæ„å›¾4 æ‰€ä»¥éžå®¹å™¨ä¸å¯å˜é‡é™¤äº†copyå…¶ä»–ç‰¹æ€§åŒéžå®¹å™¨å¯å˜å˜é‡ï¼Œcopyæ˜¯æµ…æ‹·è´ 2.3ä¸å¯å˜å®¹å™¨å˜é‡å…¸åž‹å¯¹è±¡NSArrayã€‚è¯¥å¯¹è±¡å®žéªŒè‡ªè¡Œå®žéªŒã€‚ä½†ç»“è®ºåœ¨è¿™é‡Œç»™å‡ºï¼Œå…¶å®žä¸å®žéªŒä¹Ÿå¯ä»¥å¤§æ¦‚çŸ¥é“æ¦‚çŽ‡åœ¨ä¸å¯å˜å®¹å™¨å˜é‡ä¸­ï¼Œå®¹å™¨æœ¬èº«éƒ½æ˜¯æµ…æ‹·è´åŒ…æ‹¬copyï¼ŒåŒNSStringï¼Œå®¹å™¨é‡Œé¢çš„æ•°æ®éƒ½æ˜¯æµ…æ‹·è´ï¼ŒåŒNSMutableArrayã€‚ 3.æ€»ç»“copyï¼Œstrongï¼Œweakï¼Œassignçš„åŒºåˆ«ã€‚ å¯å˜å˜é‡ä¸­ï¼Œcopyæ˜¯é‡æ–°å¼€è¾Ÿä¸€ä¸ªå†…å­˜ï¼Œstrongï¼Œweakï¼ŒassginåŽä¸‰è€…ä¸å¼€è¾Ÿå†…å­˜ï¼Œåªæ˜¯æŒ‡é’ˆæŒ‡å‘åŽŸæ¥ä¿å­˜å€¼çš„å†…å­˜çš„ä½ç½®ï¼ŒstorngæŒ‡å‘åŽä¼šå¯¹è¯¥å†…å­˜å¼•ç”¨è®¡æ•°+1ï¼Œè€Œweakï¼Œassginä¸ä¼šã€‚weakï¼Œassginä¼šåœ¨å¼•ç”¨ä¿å­˜å€¼çš„å†…å­˜å¼•ç”¨è®¡æ•°ä¸º0çš„æ—¶å€™å€¼ä¸ºç©ºï¼Œå¹¶ä¸”weakä¼šå°†å†…å­˜å€¼è®¾ä¸ºnilï¼Œassignä¸ä¼šï¼Œassignåœ¨å†…å­˜æ²¡æœ‰è¢«é‡å†™å‰ä¾æ—§å¯ä»¥è¾“å‡ºï¼Œä½†ä¸€æ—¦è¢«é‡å†™å°†å‡ºçŽ°å¥”æºƒ ä¸å¯å˜å˜é‡ä¸­ï¼Œå› ä¸ºå€¼æœ¬èº«ä¸å¯è¢«æ”¹å˜ï¼Œcopyæ²¡å¿…è¦å¼€è¾Ÿå‡ºä¸€å—å†…å­˜å­˜æ”¾å’ŒåŽŸæ¥å†…å­˜ä¸€æ¨¡ä¸€æ ·çš„å€¼ï¼Œæ‰€ä»¥å†…å­˜ç®¡ç†ç³»ç»Ÿé»˜è®¤éƒ½æ˜¯æµ…æ‹·è´ã€‚å…¶ä»–å’Œå¯å˜å˜é‡ä¸€æ ·ï¼Œå¦‚weakä¿®é¥°çš„å˜é‡åŒæ ·ä¼šåœ¨å†…å­˜å¼•ç”¨è®¡æ•°ä¸º0æ—¶å˜ä¸ºnilã€‚ å®¹å™¨æœ¬èº«éµå®ˆä¸Šé¢å‡†åˆ™ï¼Œä½†å®¹å™¨å†…éƒ¨çš„æ¯ä¸ªå€¼éƒ½æ˜¯æµ…æ‹·è´ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œå½“åˆ›å»ºpropertyæž„é€ å™¨åˆ›å»ºå˜é‡value1çš„æ—¶å€™ï¼Œä½¿ç”¨copyï¼Œstrongï¼Œweakï¼Œassignæ ¹æ®å…·ä½“ä½¿ç”¨æƒ…å†µæ¥å†³å®šã€‚value1 = value2ï¼Œå¦‚æžœä½ å¸Œæœ›value1å’Œvalue2çš„ä¿®æ”¹ä¸ä¼šäº’ç›¸å½±å“çš„å°±ç”¨ç”¨copyï¼Œåä¹‹ç”¨strong,weak,assignã€‚å¦‚æžœä½ è¿˜å¸Œæœ›åŽŸæ¥å€¼C(Cæ˜¯ä»€ä¹ˆè§ç¤ºæ„å›¾1)ä¸ºnilçš„æ—¶å€™ï¼Œä½ çš„å˜é‡ä¸ä¸ºnilå°±ç”¨strong,åä¹‹ç”¨weakå’Œassignã€‚weakå’Œassignä¿è¯äº†ä¸å¼ºå¼•ç”¨æŸä¸€å—å†…å­˜ï¼Œå¦‚delegateæˆ‘ä»¬å°±ç”¨weakè¡¨ç¤ºï¼Œå°±æ˜¯ä¸ºäº†é˜²æ­¢å¾ªçŽ¯å¼•ç”¨çš„äº§ç”Ÿã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„æ˜¯ç±»å˜é‡ï¼Œç›´æŽ¥åˆ›å»ºå±€éƒ¨å˜é‡é»˜è®¤æ˜¯Strongä¿®é¥° è¡¥å……ï¼šdelegateä¸ºä»€ä¹ˆè¦ç”¨weakæˆ–è€…assignè€Œä¸ç”¨strongaåˆ›å»ºå¯¹è±¡b,bä¸­æœ‰Cç±»å¯¹è±¡cï¼Œæ‰€ä»¥aå¯¹bæœ‰ä¸€ä¸ªå¼•ç”¨,bå¯¹cæœ‰ä¸€ä¸ªå¼•ç”¨ï¼Œa.bå¼•ç”¨è®¡æ•°åˆ†åˆ«ä¸º1ï¼Œ1ã€‚å½“c.delegate = bçš„æ—¶å€™ï¼Œå®žåˆ™æ˜¯å¯¹bæœ‰äº†ä¸€ä¸ªå¼•ç”¨ï¼Œå¦‚æžœæ­¤æ—¶cçš„delegateç”¨strongä¿®é¥°åˆ™ä¼šå¯¹bçš„å€¼å†…å­˜å¼•ç”¨è®¡æ•°+1ï¼Œbå¼•ç”¨è®¡æ•°ä¸º2ã€‚å½“açš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œéšä¹‹é‡Šæ”¾å¯¹bçš„å¼•ç”¨ï¼Œbçš„å¼•ç”¨è®¡æ•°å˜ä¸º1ï¼Œå¯¼è‡´bä¸èƒ½é‡Šæ”¾ï¼Œbä¸èƒ½é‡Šæ”¾åˆå¯¼è‡´bå¯¹cçš„å¼•ç”¨ä¸èƒ½é‡Šæ”¾ï¼Œcå¼•ç”¨è®¡æ•°è¿˜æ˜¯ä¸º1ï¼Œè¿™æ ·å°±é€ æˆäº†bå’Œcä¸€ç›´ç•™åœ¨äº†å†…å­˜ä¸­ã€‚ è€Œè¦è§£å†³è¿™ä¸ªé—®é¢˜å°±æ˜¯ä½¿ç”¨weakæˆ–è€…assignä¿®é¥°delegateï¼Œè¿™æ ·è™½ç„¶ä¼šæœ‰cä»ç„¶ä¼šå¯¹bæœ‰ä¸€ä¸ªå¼•ç”¨ï¼Œä½†æ˜¯å¼•ç”¨æ˜¯å¼±å¼•ç”¨ï¼Œå½“aç”Ÿå‘½å‘¨æœŸç»“æŸçš„æ—¶å€™ï¼Œbçš„å¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œbé‡Šæ”¾åŽéšä¹‹cçš„å¼•ç”¨æ¶ˆå¤±ï¼Œcå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œé‡Šæ”¾ã€‚ ä¸å¯å˜å¸¸é‡çš„ç‰¹æ®Šæ€§åœ¨2.2çš„è®¨è®ºä¸­å¦‚æžœä½ 1.å­—ç¬¦ä¸²æ”¹æˆå°äºŽ10é•¿åº¦çš„å­—ç¬¦ä¸²2.NSString*strOrigin = @â€strOrigin0123456â€;åˆå§‹åŒ–NSStringï¼Œä½ éƒ½ä¼šå‘çŽ°strOriginå€¼å†…å­˜å¼•ç”¨è®¡æ•°å°†å‘ç”Ÿå¼‚å¸¸ï¼Œé€šå¸¸è¡¨çŽ°ä¸ºå¼•ç”¨è®¡æ•°ç‰¹åˆ«å¤§ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹iOSä¸­NSStringçš„ç‰¹åˆ«ä¹‹å¤„è¿™ç¯‡æ–‡ç«  é¡¹ç›®åœ°å€https://github.com/ai966669/copy]]></content>
      <categories>
        <category>Objective-Cè¯­è¨€ç‰¹æ€§</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[æ·±æ‹·è´ä¸Žæµ…æ‹·è´]]></title>
    <url>%2F2018%2F09%2F14%2F%E6%B7%B1%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B5%85%E6%8B%B7%E8%B4%9D%2F</url>
    <content type="text"><![CDATA[æ¦‚å¿µå¯¹è±¡æ‹·è´æœ‰ä¸¤ç§æ–¹å¼ï¼šæµ…å¤åˆ¶å’Œæ·±å¤åˆ¶ã€‚é¡¾åæ€ä¹‰ï¼Œæµ…å¤åˆ¶ï¼Œå¹¶ä¸æ‹·è´å¯¹è±¡æœ¬èº«ï¼Œä»…ä»…æ˜¯æ‹·è´æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆï¼›æ·±å¤åˆ¶æ˜¯ç›´æŽ¥æ‹·è´æ•´ä¸ªå¯¹è±¡å†…å­˜åˆ°å¦ä¸€å—å†…å­˜ä¸­ã€‚ ä¸€å›¾ä»¥è”½ä¹‹ å†ç®€å•äº›è¯´ï¼šæµ…å¤åˆ¶å°±æ˜¯æŒ‡é’ˆæ‹·è´ï¼›æ·±å¤åˆ¶å°±æ˜¯å†…å®¹æ‹·è´ã€‚ é›†åˆçš„æµ…å¤åˆ¶ (shallow copy)é›†åˆçš„æµ…å¤åˆ¶æœ‰éžå¸¸å¤šç§æ–¹æ³•ã€‚å½“ä½ è¿›è¡Œæµ…å¤åˆ¶æ—¶ï¼Œä¼šå‘åŽŸå§‹çš„é›†åˆå‘é€retainæ¶ˆæ¯ï¼Œå¼•ç”¨è®¡æ•°åŠ 1ï¼ŒåŒæ—¶æŒ‡é’ˆè¢«æ‹·è´åˆ°æ–°çš„é›†åˆã€‚ çŽ°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€äº›æµ…å¤åˆ¶çš„ä¾‹å­ï¼š 1NSArray *shallowCopyArray = [someArray copyWithZone:nil];NSSet *shallowCopySet = [NSSet mutableCopyWithZone:nil];NSDictionary *shallowCopyDict = [[NSDictionary alloc] initWithDictionary:someDictionary copyItems:NO]; é›†åˆçš„æ·±å¤åˆ¶ (deep copy)é›†åˆçš„æ·±å¤åˆ¶æœ‰ä¸¤ç§æ–¹æ³•ã€‚å¯ä»¥ç”¨ initWithArray:copyItems: å°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸ºYESå³å¯æ·±å¤åˆ¶ï¼Œå¦‚ 1NSDictionary shallowCopyDict = [[NSDictionary alloc] initWithDictionary:someDictionary copyItems:YES]; å¦‚æžœä½ ç”¨è¿™ç§æ–¹æ³•æ·±å¤åˆ¶ï¼Œé›†åˆé‡Œçš„æ¯ä¸ªå¯¹è±¡éƒ½ä¼šæ”¶åˆ° copyWithZone: æ¶ˆæ¯ã€‚å¦‚æžœé›†åˆé‡Œçš„å¯¹è±¡éµå¾ª NSCopying åè®®ï¼Œé‚£ä¹ˆå¯¹è±¡å°±ä¼šè¢«æ·±å¤åˆ¶åˆ°æ–°çš„é›†åˆã€‚å¦‚æžœå¯¹è±¡æ²¡æœ‰éµå¾ª NSCopying åè®®ï¼Œè€Œå°è¯•ç”¨è¿™ç§æ–¹æ³•è¿›è¡Œæ·±å¤åˆ¶ï¼Œä¼šåœ¨è¿è¡Œæ—¶å‡ºé”™ã€‚copyWithZone: è¿™ç§æ‹·è´æ–¹å¼åªèƒ½å¤Ÿæä¾›ä¸€å±‚å†…å­˜æ‹·è´(one-level-deep copy)ï¼Œè€ŒéžçœŸæ­£çš„æ·±å¤åˆ¶ã€‚ ç¬¬äºŒä¸ªæ–¹æ³•æ˜¯å°†é›†åˆè¿›è¡Œå½’æ¡£(archive)ï¼Œç„¶åŽè§£æ¡£(unarchive)ï¼Œå¦‚ï¼š 1NSArray *trueDeepCopyArray = [NSKeyedUnarchiver unarchiveObjectWithData:[NSKeyedArchiver archivedDataWithRootObject:oldArray]]; é›†åˆçš„å•å±‚æ·±å¤åˆ¶ (one-level-deep copy)çœ‹åˆ°è¿™é‡Œï¼Œæœ‰åŒå­¦ä¼šé—®ï¼šå¦‚æžœåœ¨å¤šå±‚æ•°ç»„ä¸­ï¼Œå¯¹ç¬¬ä¸€å±‚è¿›è¡Œå†…å®¹æ‹·è´ï¼Œå…¶å®ƒå±‚è¿›è¡ŒæŒ‡é’ˆæ‹·è´ï¼Œè¿™ç§æƒ…å†µæ˜¯å±žäºŽæ·±å¤åˆ¶ï¼Œè¿˜æ˜¯æµ…å¤åˆ¶ï¼Ÿå¯¹æ­¤ï¼Œè‹¹æžœå®˜ç½‘æ–‡æ¡£æœ‰è¿™æ ·ä¸€å¥è¯æè¿° This kind of copy is only capable of producing a one-level-deep copy. If you only need a one-level-deep copyâ€¦ If you need a true deep copy, such as when you have an array of arraysâ€¦ ä»Žæ–‡ä¸­å¯ä»¥çœ‹å‡ºï¼Œè‹¹æžœè®¤ä¸ºè¿™ç§å¤åˆ¶ä¸æ˜¯çœŸæ­£çš„æ·±å¤åˆ¶ï¼Œè€Œæ˜¯å°†å…¶ç§°ä¸ºå•å±‚æ·±å¤åˆ¶(one-level-deep copy)ã€‚å› æ­¤ï¼Œç½‘ä¸Šæœ‰äººå¯¹æµ…å¤åˆ¶ã€æ·±å¤åˆ¶ã€å•å±‚æ·±å¤åˆ¶åšäº†æ¦‚å¿µåŒºåˆ†ã€‚ æµ…å¤åˆ¶(shallow copy)ï¼šåœ¨æµ…å¤åˆ¶æ“ä½œæ—¶ï¼Œå¯¹äºŽè¢«å¤åˆ¶å¯¹è±¡çš„æ¯ä¸€å±‚éƒ½æ˜¯æŒ‡é’ˆå¤åˆ¶ã€‚ æ·±å¤åˆ¶(one-level-deep copy)ï¼šåœ¨æ·±å¤åˆ¶æ“ä½œæ—¶ï¼Œå¯¹äºŽè¢«å¤åˆ¶å¯¹è±¡ï¼Œè‡³å°‘æœ‰ä¸€å±‚æ˜¯æ·±å¤åˆ¶ã€‚ å®Œå…¨å¤åˆ¶(real-deep copy)ï¼šåœ¨å®Œå…¨å¤åˆ¶æ“ä½œæ—¶ï¼Œå¯¹äºŽè¢«å¤åˆ¶å¯¹è±¡çš„æ¯ä¸€å±‚éƒ½æ˜¯å¯¹è±¡å¤åˆ¶ã€‚ å½“ç„¶ï¼Œè¿™äº›éƒ½æ˜¯æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œæ²¡æœ‰å¿…è¦çº ç»“äºŽæ­¤ã€‚åªè¦çŸ¥é“è¿›è¡Œæ‹·è´æ“ä½œæ—¶ï¼Œè¢«æ‹·è´çš„æ˜¯æŒ‡é’ˆè¿˜æ˜¯å†…å®¹å³å¯ã€‚ ç³»ç»Ÿå¯¹è±¡çš„copyä¸ŽmutableCopyæ–¹æ³•ä¸ç®¡æ˜¯é›†åˆç±»å¯¹è±¡ï¼Œè¿˜æ˜¯éžé›†åˆç±»å¯¹è±¡ï¼ŒæŽ¥æ”¶åˆ°copyå’ŒmutableCopyæ¶ˆæ¯æ—¶ï¼Œéƒ½éµå¾ªä»¥ä¸‹å‡†åˆ™ï¼š copyè¿”å›žimutableå¯¹è±¡ï¼›æ‰€ä»¥ï¼Œå¦‚æžœå¯¹copyè¿”å›žå€¼ä½¿ç”¨mutableå¯¹è±¡æŽ¥å£å°±ä¼šcrashï¼› mutableCopyè¿”å›žmutableå¯¹è±¡ï¼› ä¸‹é¢å°†é’ˆå¯¹éžé›†åˆç±»å¯¹è±¡å’Œé›†åˆç±»å¯¹è±¡çš„copyå’ŒmutableCopyæ–¹æ³•è¿›è¡Œå…·ä½“çš„é˜è¿° 1ã€éžé›†åˆç±»å¯¹è±¡çš„copyä¸ŽmutableCopyç³»ç»Ÿéžé›†åˆç±»å¯¹è±¡æŒ‡çš„æ˜¯ NSString, NSNumber â€¦ ä¹‹ç±»çš„å¯¹è±¡ã€‚ä¸‹é¢å…ˆçœ‹ä¸ªéžé›†åˆç±»immutableå¯¹è±¡æ‹·è´çš„ä¾‹å­ 1NSString *string = @&quot;origin&quot;;NSString *stringCopy = [string copy];NSMutableString *stringMCopy = [string mutableCopy]; é€šè¿‡æŸ¥çœ‹å†…å­˜ï¼Œå¯ä»¥çœ‹åˆ° stringCopy å’Œ string çš„åœ°å€æ˜¯ä¸€æ ·ï¼Œè¿›è¡Œäº†æŒ‡é’ˆæ‹·è´ï¼›è€Œ stringMCopy çš„åœ°å€å’Œ string ä¸ä¸€æ ·ï¼Œè¿›è¡Œäº†å†…å®¹æ‹·è´ï¼› å†çœ‹mutableå¯¹è±¡æ‹·è´ä¾‹å­ 1NSMutableString *string = [NSMutableString stringWithString: @&quot;origin&quot;];//copyNSString *stringCopy = [string copy];NSMutableString *mStringCopy = [string copy];NSMutableString *stringMCopy = [string mutableCopy];//change value[mStringCopy appendString:@&quot;mm&quot;]; //crash[string appendString:@&quot; origion!&quot;];[stringMCopy appendString:@&quot;!!&quot;]; è¿è¡Œä»¥ä¸Šä»£ç ï¼Œä¼šåœ¨ç¬¬7è¡Œcrashï¼ŒåŽŸå› å°±æ˜¯ copy è¿”å›žçš„å¯¹è±¡æ˜¯ immutable å¯¹è±¡ã€‚æ³¨é‡Šç¬¬7è¡ŒåŽå†è¿è¡Œï¼ŒæŸ¥çœ‹å†…å­˜ï¼Œå‘çŽ° stringã€stringCopyã€mStringCopyã€stringMCopy å››ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œè¯´æ˜Žæ­¤æ—¶éƒ½æ˜¯åšå†…å®¹æ‹·è´ã€‚ ç»¼ä¸Šä¸¤ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š åœ¨éžé›†åˆç±»å¯¹è±¡ä¸­ï¼šå¯¹immutableå¯¹è±¡è¿›è¡Œcopyæ“ä½œï¼Œæ˜¯æŒ‡é’ˆå¤åˆ¶ï¼ŒmutableCopyæ“ä½œæ—¶å†…å®¹å¤åˆ¶ï¼›å¯¹mutableå¯¹è±¡è¿›è¡Œcopyå’ŒmutableCopyéƒ½æ˜¯å†…å®¹å¤åˆ¶ã€‚ç”¨ä»£ç ç®€å•è¡¨ç¤ºå¦‚ä¸‹ï¼š [immutableObject copy] // æµ…å¤åˆ¶ [immutableObject mutableCopy] //æ·±å¤åˆ¶ [mutableObject copy] //æ·±å¤åˆ¶ [mutableObject mutableCopy] //æ·±å¤åˆ¶ 2ã€é›†åˆç±»å¯¹è±¡çš„copyä¸ŽmutableCopyé›†åˆç±»å¯¹è±¡æ˜¯æŒ‡NSArrayã€NSDictionaryã€NSSet â€¦ ä¹‹ç±»çš„å¯¹è±¡ã€‚ä¸‹é¢å…ˆçœ‹é›†åˆç±»immutableå¯¹è±¡ä½¿ç”¨copyå’ŒmutableCopyçš„ä¸€ä¸ªä¾‹å­ï¼š 1NSArray *array = @[@[@&quot;a&quot;, @&quot;b&quot;], @[@&quot;c&quot;, @&quot;d&quot;];NSArray *copyArray = [array copy];NSMutableArray *mCopyArray = [array mutableCopy]; æŸ¥çœ‹å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°copyArrayå’Œarrayçš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œè€ŒmCopyArrayå’Œarrayçš„åœ°å€æ˜¯ä¸åŒçš„ã€‚è¯´æ˜Žcopyæ“ä½œè¿›è¡Œäº†æŒ‡é’ˆæ‹·è´ï¼ŒmutableCopyè¿›è¡Œäº†å†…å®¹æ‹·è´ã€‚ä½†éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼šæ­¤å¤„çš„å†…å®¹æ‹·è´ï¼Œä»…ä»…æ˜¯æ‹·è´arrayè¿™ä¸ªå¯¹è±¡ï¼Œarrayé›†åˆå†…éƒ¨çš„å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆæ‹·è´ã€‚è¿™å’Œä¸Šé¢çš„éžé›†åˆimmutableå¯¹è±¡çš„æ‹·è´è¿˜æ˜¯æŒºç›¸ä¼¼çš„ï¼Œé‚£ä¹ˆmutableå¯¹è±¡çš„æ‹·è´ä¼šä¸ä¼šç±»ä¼¼å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ï¼Œçœ‹mutableå¯¹è±¡æ‹·è´çš„ä¾‹å­ï¼š 1NSMutableArray *array = [NSMutableArray arrayWithObjects:[NSMutableString stringWithString:@&quot;a&quot;],@&quot;b&quot;,@&quot;c&quot;,nil];NSArray *copyArray = [array copy];NSMutableArray *mCopyArray = [array mutableCopy]; æŸ¥çœ‹å†…å­˜ï¼Œå¦‚æˆ‘ä»¬æ‰€æ–™ï¼ŒcopyArrayã€mCopyArrayå’Œarrayçš„å†…å­˜åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œè¯´æ˜ŽcopyArrayã€mCopyArrayéƒ½å¯¹arrayè¿›è¡Œäº†å†…å®¹æ‹·è´ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š åœ¨é›†åˆç±»å¯¹è±¡ä¸­ï¼Œå¯¹immutableå¯¹è±¡è¿›è¡Œcopyï¼Œæ˜¯æŒ‡é’ˆå¤åˆ¶ï¼ŒmutableCopyæ˜¯å†…å®¹å¤åˆ¶ï¼›å¯¹mutableå¯¹è±¡è¿›è¡Œcopyå’ŒmutableCopyéƒ½æ˜¯å†…å®¹å¤åˆ¶ã€‚ä½†æ˜¯ï¼šé›†åˆå¯¹è±¡çš„å†…å®¹å¤åˆ¶ä»…é™äºŽå¯¹è±¡æœ¬èº«ï¼Œå¯¹è±¡å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆå¤åˆ¶ã€‚ç”¨ä»£ç ç®€å•è¡¨ç¤ºå¦‚ä¸‹ï¼š [immutableObject copy] // æµ…å¤åˆ¶ [immutableObject mutableCopy] //å•å±‚æ·±å¤åˆ¶ [mutableObject copy] //å•å±‚æ·±å¤åˆ¶ [mutableObject mutableCopy] //å•å±‚æ·±å¤åˆ¶ è¿™ä¸ªä»£ç ç»“è®ºå’Œéžé›†åˆç±»çš„éžå¸¸ç›¸ä¼¼ã€‚ è¿™æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯æœ‰äººè¦é—®äº†ï¼Œå¦‚æžœè¦å¯¹é›†åˆå¯¹è±¡å¤åˆ¶å…ƒç´ æ€Žä¹ˆåŠžï¼Ÿæœ‰è¿™ç–‘é—®çš„åŒå­¦ä¸å¦¨å›žå¤´çœ‹çœ‹é›†åˆçš„æ·±å¤åˆ¶ã€‚ å¥½äº†ï¼Œæ·±å¤åˆ¶ä¸Žæµ…å¤åˆ¶å°±è®²åˆ°è¿™é‡Œã€‚ æœ€åŽè¯´ä¸ªé¢˜å¤–çš„ä¸œè¥¿ï¼Œåœ¨æœé›†èµ„æ–™çš„è¿‡ç¨‹ä¸­ï¼Œå‘çŽ°ä¸€ä¸ªæœ‰å¯èƒ½çŠ¯é”™çš„ç‚¹ 1NSString *str = @&quot;string&quot;;str = @&quot;newString&quot;; ä¸Šé¢è¿™æ®µä»£ç ï¼Œåœ¨æ‰§è¡Œç¬¬äºŒè¡Œä»£ç åŽï¼Œå†…å­˜åœ°å€å‘ç”Ÿäº†å˜åŒ–ã€‚ä¹ä¸€çœ‹ï¼Œæœ‰ç‚¹æ„å¤–ã€‚æŒ‰ç…§ C è¯­è¨€çš„ç»éªŒï¼Œåˆå§‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²ä¹‹åŽï¼Œå­—ç¬¦ä¸²çš„é¦–åœ°å€å°±è¢«ç¡®å®šä¸‹æ¥ï¼Œä¸ç®¡ä¹‹åŽå¦‚ä½•ä¿®æ”¹å­—ç¬¦ä¸²å†…å®¹ï¼Œè¿™ä¸ªåœ°å€éƒ½ä¸ä¼šæ”¹å˜ã€‚ä½†æ­¤å¤„ç¬¬äºŒè¡Œå¹¶ä¸æ˜¯å¯¹ str æŒ‡å‘çš„å†…å­˜åœ°å€é‡æ–°èµ‹å€¼ï¼Œå› ä¸ºèµ‹å€¼æ“ä½œç¬¦å·¦è¾¹çš„ str æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤å¤„ä¿®æ”¹çš„æ˜¯å†…å­˜åœ°å€ã€‚ æ‰€ä»¥ç¬¬äºŒè¡Œåº”è¯¥è¿™æ ·ç†è§£ï¼šå°†@â€newStirngâ€å½“åšä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå°†è¿™æ®µå¯¹è±¡çš„å†…å­˜åœ°å€èµ‹å€¼ç»™strã€‚ æˆ‘æœ‰å¦‚ä¸‹çš„ä¸¤ä¸ªæ–¹æ³•æŸ¥çœ‹å†…å­˜åœ°å€ p str ä¼šæ‰“å°å¯¹è±¡æœ¬èº«çš„å†…å­˜åœ°å€å’Œå¯¹è±¡å†…å®¹ 1(lldb) p str(NSString *) $0 = 0x000000010c913680 @&quot;a&quot; po &amp;str åˆ™æ‰“å°çš„æ˜¯å¼•ç”¨å¯¹è±¡çš„æŒ‡é’ˆæ‰€åœ¨çš„åœ°å€ 1(lldb) po &amp;str0x00007fff532fb6c0 è½¬è‡ª]]></content>
      <categories>
        <category>Objective-Cè¯­è¨€ç‰¹æ€§</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[KVOçš„åº•å±‚å®žçŽ°åŽŸç†]]></title>
    <url>%2F2018%2F09%2F13%2FKVO%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%2F</url>
    <content type="text"><![CDATA[addObserver:forKeyPath:options:context:å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ, observerä¸­éœ€è¦å®žçŽ°å“ªä¸ªæ–¹æ³•æ‰èƒ½èŽ·å¾—KVOå›žè°ƒï¼Ÿ12345678910111213141516171819202122/** 1. self.personï¼šè¦ç›‘å¬çš„å¯¹è±¡ 2. å‚æ•°è¯´æ˜Žï¼š * @param addObserver è§‚å¯Ÿè€…ï¼Œè´Ÿè´£å¤„ç†ç›‘å¬äº‹ä»¶çš„å¯¹è±¡ * @param forKeyPath è¦ç›‘å¬çš„å±žæ€§ * @param options è§‚å¯Ÿçš„é€‰é¡¹ï¼ˆè§‚å¯Ÿæ–°ã€æ—§å€¼ï¼Œä¹Ÿå¯ä»¥éƒ½è§‚å¯Ÿï¼‰ * @param context ä¸Šä¸‹æ–‡ï¼Œç”¨äºŽä¼ é€’æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨ä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„ç›‘å¬ */[self.person addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:@&quot;Person Name&quot;];/** * å½“ç›‘æŽ§çš„æŸä¸ªå±žæ€§çš„å€¼æ”¹å˜äº†å°±ä¼šè°ƒç”¨ * * @param keyPath ç›‘å¬çš„å±žæ€§å * @param object å±žæ€§æ‰€å±žçš„å¯¹è±¡ * @param change å±žæ€§çš„ä¿®æ”¹æƒ…å†µï¼ˆå±žæ€§åŽŸæ¥çš„å€¼`oldValue`ã€å±žæ€§æœ€æ–°çš„å€¼`newValue`ï¼‰ * @param context ä¼ é€’çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¸Žç›‘å¬çš„æ—¶å€™ä¼ é€’çš„ä¸€è‡´ï¼Œå¯ä»¥åˆ©ç”¨ä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„ç›‘å¬ */- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context&#123; NSLog(@&quot;%@å¯¹è±¡çš„%@å±žæ€§æ”¹å˜äº†ï¼š%@&quot;, object, keyPath, change);&#125; KVO (Key-Value Observing)KVO æ˜¯ Objective-C å¯¹è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰çš„å®žçŽ°ã€‚ä¹Ÿæ˜¯ Cocoa Binding çš„åŸºç¡€ã€‚å½“è¢«è§‚å¯Ÿå¯¹è±¡çš„æŸä¸ªå±žæ€§å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œè§‚å¯Ÿè€…å¯¹è±¡ä¼šèŽ·å¾—é€šçŸ¥ã€‚ æœ‰æ„æ€çš„æ˜¯ï¼Œä½ ä¸éœ€è¦ç»™è¢«è§‚å¯Ÿçš„å¯¹è±¡æ·»åŠ ä»»ä½•é¢å¤–ä»£ç ï¼Œå°±èƒ½ä½¿ç”¨ KVO ã€‚è¿™æ˜¯æ€Žä¹ˆåšåˆ°çš„ï¼Ÿ KVOå†…éƒ¨å®žçŽ°åŽŸç† KVOæ˜¯åŸºäºŽruntimeæœºåˆ¶å®žçŽ°çš„ å½“æŸä¸ªç±»çš„å±žæ€§å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿæ—¶ï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿è¡ŒæœŸåŠ¨æ€åœ°åˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªæ´¾ç”Ÿç±»ï¼Œåœ¨è¿™ä¸ªæ´¾ç”Ÿç±»ä¸­é‡å†™åŸºç±»ä¸­ä»»ä½•è¢«è§‚å¯Ÿå±žæ€§çš„setter æ–¹æ³•ã€‚æ´¾ç”Ÿç±»åœ¨è¢«é‡å†™çš„setteræ–¹æ³•å†…å®žçŽ°çœŸæ­£çš„é€šçŸ¥æœºåˆ¶ å¦‚æžœåŽŸç±»ä¸ºPersonï¼Œé‚£ä¹ˆç”Ÿæˆçš„æ´¾ç”Ÿç±»åä¸ºNSKVONotifying_Person æ¯ä¸ªç±»å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆæŒ‡å‘å½“å‰ç±»ï¼Œå½“ä¸€ä¸ªç±»å¯¹è±¡çš„ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šå·å·å°†isaæŒ‡é’ˆæŒ‡å‘åŠ¨æ€ç”Ÿæˆçš„æ´¾ç”Ÿç±»ï¼Œä»Žè€Œåœ¨ç»™è¢«ç›‘æŽ§å±žæ€§èµ‹å€¼æ—¶æ‰§è¡Œçš„æ˜¯æ´¾ç”Ÿç±»çš„setteræ–¹æ³• é”®å€¼è§‚å¯Ÿé€šçŸ¥ä¾èµ–äºŽNSObject çš„ä¸¤ä¸ªæ–¹æ³•: willChangeValueForKey:å’Œ didChangevlueForKey:ï¼›åœ¨ä¸€ä¸ªè¢«è§‚å¯Ÿå±žæ€§å‘ç”Ÿæ”¹å˜ä¹‹å‰ï¼Œ willChangeValueForKey:ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿™å°± ä¼šè®°å½•æ—§çš„å€¼ã€‚è€Œå½“æ”¹å˜å‘ç”ŸåŽï¼ŒdidChangeValueForKey:ä¼šè¢«è°ƒç”¨ï¼Œç»§è€Œ observeValueForKey:ofObject:change:context:ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚ è¡¥å……ï¼šKVOçš„è¿™å¥—å®žçŽ°æœºåˆ¶ä¸­è‹¹æžœè¿˜å·å·é‡å†™äº†classæ–¹æ³•ï¼Œè®©æˆ‘ä»¬è¯¯è®¤ä¸ºè¿˜æ˜¯ä½¿ç”¨çš„å½“å‰ç±»ï¼Œä»Žè€Œè¾¾åˆ°éšè—ç”Ÿæˆçš„æ´¾ç”Ÿç±» â€‹ â€‹ KVOå†…éƒ¨å®žçŽ°åŽŸç†.png å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO è‡ªåŠ¨è§¦å‘çš„åœºæ™¯ï¼šåœ¨æ³¨å†ŒKVOä¹‹å‰è®¾ç½®ä¸€ä¸ªåˆå§‹å€¼ï¼Œæ³¨å†Œä¹‹åŽï¼Œè®¾ç½®ä¸€ä¸ªä¸ä¸€æ ·çš„å€¼ï¼Œå°±å¯ä»¥è§¦å‘äº† æƒ³çŸ¥é“å¦‚ä½•æ‰‹åŠ¨è§¦å‘ï¼Œå¿…é¡»çŸ¥é“è‡ªåŠ¨è§¦å‘ KVO çš„åŽŸç†ï¼Œè§ä¸Šé¢çš„æè¿° æ‰‹åŠ¨è§¦å‘æ¼”ç¤º 123456789101112@property (nonatomic, strong) NSDate *now;- (void)viewDidLoad&#123; [super viewDidLoad]; // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚ [self willChangeValueForKey:@&quot;now&quot;]; // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚ [self didChangeValueForKey:@&quot;now&quot;];&#125; æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO.png è¡¥å……ï¼š å¦‚ä½•å…³é—­é»˜è®¤çš„KVOçš„é»˜è®¤å®žçŽ°ï¼Œå¹¶è¿›å…¥è‡ªå®šä¹‰çš„KVOå®žçŽ°ï¼Ÿï¼ˆçœ‹é“¾æŽ¥ï¼‰ å¦‚ä½•è‡ªå·±åŠ¨æ‰‹å®žçŽ° KVO é™„æ³¨: KVCåº•å±‚å®žçŽ°åŽŸç†(å¦‚ä¸‹)KVCè¿ç”¨äº†ä¸€ä¸ªisa-swizzlingæŠ€æœ¯. isa-swizzlingå°±æ˜¯ç±»åž‹æ··åˆæŒ‡é’ˆæœºåˆ¶, å°†2ä¸ªå¯¹è±¡çš„isaæŒ‡é’ˆäº’ç›¸è°ƒæ¢, å°±æ˜¯ä¿—ç§°çš„é»‘é­”æ³•.KVCä¸»è¦é€šè¿‡isa-swizzling, æ¥å®žçŽ°å…¶å†…éƒ¨æŸ¥æ‰¾å®šä½çš„. é»˜è®¤çš„å®žçŽ°æ–¹æ³•ï¿½ç”±NSOjectæä¾›isaæŒ‡é’ˆ, å¦‚å…¶åç§°æ‰€æŒ‡,(å°±æ˜¯is a kind ofçš„æ„æ€), æŒ‡å‘åˆ†å‘è¡¨å¯¹è±¡çš„ç±». è¯¥åˆ†å‘è¡¨å®žé™…ä¸ŠåŒ…å«äº†æŒ‡å‘å®žçŽ°ç±»ä¸­çš„æ–¹æ³•çš„æŒ‡é’ˆ, å’Œå…¶å®ƒæ•°æ®ã€‚ å…·ä½“ä¸»è¦åˆ†ä¸ºä¸‰å¤§æ­¥ ç¬¬ä¸€æ­¥ï¼šå¯»æ‰¾è¯¥å±žæ€§æœ‰æ²¡æœ‰setsetteræ–¹æ³•ï¼Ÿæœ‰ï¼Œå°±ç›´æŽ¥èµ‹å€¼ ç¬¬äºŒæ­¥ï¼šå¯»æ‰¾æœ‰æ²¡æœ‰è¯¥å±žæ€§å¸¦ä¸‹åˆ’çº¿çš„æˆå‘˜å±žæ€§ï¼Ÿæœ‰ï¼Œå°±ç›´æŽ¥èµ‹å€¼ ç¬¬ä¸‰æ­¥ï¼šå¯»æ‰¾æœ‰æ²¡æœ‰è¯¥å±žæ€§çš„æˆå‘˜å±žæ€§ï¼Ÿæœ‰ï¼Œå°±ç›´æŽ¥èµ‹å€¼ æˆ–è€…è¿™ä¹ˆè¯´ 1ã€é¦–å…ˆæœç´¢setKey:æ–¹æ³•.(keyæŒ‡æˆå‘˜å˜é‡å, é¦–å­—æ¯å¤§å†™) 2ã€ä¸Šé¢çš„setteræ–¹æ³•æ²¡æ‰¾åˆ°, å¦‚æžœç±»æ–¹æ³•accessInstanceVariablesDirectlyè¿”å›žYES. é‚£ä¹ˆæŒ‰ _key, _isKeyï¼Œkey, iskeyçš„é¡ºåºæœç´¢æˆå‘˜å.(NSKeyValueCodingCatogeryä¸­å®žçŽ°çš„ç±»æ–¹æ³•, é»˜è®¤å®žçŽ°ä¸ºè¿”å›žYES) 3ã€å¦‚æžœæ²¡æœ‰æ‰¾åˆ°æˆå‘˜å˜é‡, è°ƒç”¨setValue:forUnderfinedKey: æ¯”å¦‚è¯´å¦‚ä¸‹çš„ä¸€è¡ŒKVCçš„ä»£ç ï¼š ä¸¾ä¸ªðŸŒ°e.g:123456789[object setValue:@&quot;13123&quot; forKey:@&quot;uuid&quot;];å°±ä¼šè¢«ç¼–è¯‘å™¨å¤„ç†æˆ:// é¦–å…ˆæ‰¾åˆ°å¯¹åº”selSEL sel = sel_get_ uuid(&quot;setValue:forKey:&quot;);// æ ¹æ®object-&gt;isaæ‰¾åˆ°selå¯¹åº”çš„IMPå®žçŽ°æŒ‡é’ˆIMP method = objc_msg_lookup (object-&gt;isa,sel);// è°ƒç”¨æŒ‡é’ˆå®ŒæˆKVCèµ‹å€¼method(object, sel, @&quot;13123&quot;, @&quot;uuid&quot;); å¯ä¾›å‚è€ƒæ–‡ç«  ä¸‹é¢è¿™ç¯‡ä¹Ÿä¸é”™ KVOçš„å®žçŽ°åŽŸç†ä¸Žå…·ä½“åº”ç”¨ [è½¬è‡ª æŽ¢ç©¶KVOçš„åº•å±‚å®žçŽ°åŽŸç†]]]></content>
      <categories>
        <category>Objective-Cè¯­è¨€ç‰¹æ€§</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[é€šçŸ¥]]></title>
    <url>%2F2018%2F09%2F13%2F%E9%80%9A%E7%9F%A5%2F</url>
    <content type="text"><![CDATA[123456789ç›®å½• ä¸€ã€é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨ 1ã€åŸºæœ¬æ¦‚å¿µ 2ã€ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥ 3ã€å¦‚ä½•ä½¿ç”¨é€šçŸ¥ 4ã€ä½¿ç”¨é€šçŸ¥éœ€è¦æ³¨æ„å“ªäº›ç»†èŠ‚ äºŒã€é€šçŸ¥çš„å®žçŽ°åŽŸç† 1ã€æ¦‚è¿° 2ã€å®žçŽ° é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨åŸºæœ¬æ¦‚å¿µNSNotification æ˜¯iOSä¸­ä¸€ä¸ªè°ƒåº¦æ¶ˆæ¯é€šçŸ¥çš„ç±»,é‡‡ç”¨å•ä¾‹æ¨¡å¼è®¾è®¡,åœ¨ç¨‹åºä¸­å®žçŽ°ä¼ å€¼ã€å›žè°ƒç­‰åœ°æ–¹åº”ç”¨å¾ˆå¹¿ã€‚åœ¨iOSä¸­ï¼ŒNSNotification &amp; NSNotificationCenteræ˜¯ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥å®žçŽ°çš„ç”¨äºŽè·¨å±‚ä¼ é€’æ¶ˆæ¯ã€‚ ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥è§‚å¯Ÿè€…æ¨¡å¼ ï¼š å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºŽå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨æ›´æ–°ã€‚ åº”ç”¨åœºæ™¯ : 1&gt; å¯¹ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜éœ€è¦åŒæ—¶æ”¹å˜å…¶ä»–å¯¹è±¡ï¼Œè€Œä¸çŸ¥é“å…·ä½“æœ‰å¤šå°‘å¯¹è±¡æœ‰å¾…æ”¹å˜ã€‚ 2&gt; ä¸€ä¸ªå¯¹è±¡å¿…é¡»é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œè€Œå®ƒåˆä¸éœ€è¦çŸ¥é“å…¶ä»–å¯¹è±¡æ˜¯ä»€ä¹ˆ 3ã€å¦‚ä½•ä½¿ç”¨é€šçŸ¥ 1&gt; å‘è§‚å¯Ÿè€…ä¸­å¿ƒæ·»åŠ è§‚å¯Ÿè€…(2ç§æ–¹å¼) 12345//è§‚å¯Ÿè€…æŽ¥æ”¶åˆ°é€šçŸ¥åŽæ‰§è¡Œä»»åŠ¡çš„ä»£ç åœ¨å‘é€é€šçŸ¥çš„çº¿ç¨‹ä¸­æ‰§è¡ŒaddObserver:selector:name:object://è§‚å¯Ÿè€…æŽ¥æ”¶åˆ°é€šçŸ¥åŽæ‰§è¡Œä»»åŠ¡çš„ä»£ç åœ¨æŒ‡å®šçš„æ“ä½œé˜Ÿåˆ—ä¸­æ‰§è¡ŒaddObserverForName:object:queue:usingBlock: 2&gt; é€šçŸ¥ä¸­å¿ƒå‘è§‚å¯Ÿè€…å‘é€æ¶ˆæ¯ 123postNotification:postNotificationName:object:postNotificationName:object:userInfo: 3&gt; è§‚å¯Ÿè€…æŽ¥æ”¶åˆ°æ¶ˆæ¯æ‰§è¡Œç›¸åº”çš„è¡Œä¸º 4&gt; åœ¨é€šçŸ¥ä¸­å¿ƒç§»é™¤è§‚å¯Ÿè€… 12removeObserver:removeObserver:name:object: 4ã€ä½¿ç”¨é€šçŸ¥éœ€è¦æ³¨æ„å“ªäº›ç»†èŠ‚ 1&gt; é€šçŸ¥ä¸€å®šè¦ç§»é™¤ï¼Œåœ¨deallocæ–¹æ³•é‡Œé¢ç§»é™¤2&gt; é€šçŸ¥æœ‰åŒæ­¥é€šçŸ¥å’Œå¼‚æ­¥é€šçŸ¥ï¼Œåªä¸è¿‡æˆ‘ä»¬åŒæ­¥é€šçŸ¥ç”¨å¾—æ¯”è¾ƒå¤šã€‚3&gt; ä¸èƒ½ç”¨- (instancetype)init åˆå§‹åŒ–ä¸€ä¸ªé€šçŸ¥ é€šçŸ¥çš„å®žçŽ°åŽŸç†1ã€æ¦‚è¿° ï¼š é¦–å…ˆï¼Œä¿¡æ¯çš„ä¼ é€’å°±ä¾é é€šçŸ¥(NSNotification),ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šçŸ¥å°±æ˜¯ä¿¡æ¯(æ‰§è¡Œçš„æ–¹æ³•ï¼Œè§‚å¯Ÿè€…æœ¬èº«(self),å‚æ•°)çš„åŒ…è£…ã€‚é€šçŸ¥ä¸­å¿ƒ(NSNotificationCenter)æ˜¯ä¸ªå•ä¾‹ï¼Œå‘é€šçŸ¥ä¸­å¿ƒæ³¨å†Œè§‚å¯Ÿè€…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé€šçŸ¥ä¸­å¿ƒæœ‰ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆå­˜æ”¾ç€è§‚å¯Ÿè€…ã€‚é‚£ä¹ˆè¿™ä¸ªé›†åˆæ˜¯ä»€ä¹ˆæ ·çš„æ•°æ®ç±»åž‹ ï¼Ÿ å¯ä»¥è¿™ä¹ˆæ€è€ƒï¼š å‘é€é€šçŸ¥éœ€è¦nameå‚æ•°ï¼Œæ·»åŠ è§‚å¯Ÿè€…ä¹Ÿæœ‰ä¸ªnameå‚æ•°ï¼Œè¿™ä¸¤ä¸ªnameä¸€æ ·çš„æ—¶å€™ï¼Œå½“å‘é€é€šçŸ¥æ—¶å€™ï¼Œè§‚å¯Ÿè€…å¯¹è±¡å°±èƒ½æŽ¥å—åˆ°ä¿¡æ¯ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚é‚£ä¹ˆè¿™ä¸ªé›†åˆå¾ˆå®¹æ˜“æƒ³åˆ°å°±æ˜¯NSDictionary!keyå°±æ˜¯nameï¼Œvalueå°±æ˜¯NSArray(å­˜æ”¾æ•°æ®æ¨¡åž‹)ï¼Œé‡Œé¢å­˜æ”¾è§‚å¯Ÿè€…å¯¹è±¡ã€‚å¦‚ä¸‹å›¾å½“å‘é€é€šçŸ¥æ—¶ï¼Œåœ¨é€šçŸ¥é€šçŸ¥çš„å­—å…¸ï¼Œæ ¹æ®nameæ‰¾åˆ°valueï¼Œè¿™ä¸ªvalueå°±æ˜¯ä¸€æ•°ç»„ï¼Œæ•°ç»„é‡Œé¢å­˜æ”¾æ•°æ®æ¨¡åž‹(observerã€SEL)ã€‚å³å¯æ‰§è¡Œå¯¹åº”çš„è¡Œä¸ºã€‚ å®žçŽ°æ ¹æ®NSNotification&amp;NSNotificationCenteræŽ¥å£ç»™å‡ºå®žçŽ°ä»£ç ,åˆ›å»ºä¸¤ä¸ªæ–°ç±»YFLNotification,YFLNotificationCenterï¼Œè¿™ä¸¤ä¸ªç±»çš„æŽ¥å£å’Œè‹¹æžœæä¾›çš„æŽ¥å£å®Œå…¨ä¸€æ ·ï¼Œæˆ‘å°†æ ¹æ®æŽ¥å£æä¾›çš„åŠŸèƒ½ç»™å‡ºå®žçŽ°ä»£ç ã€‚è¦ç‚¹æ˜¯é€šçŸ¥ä¸­å¿ƒæ˜¯å•ä¾‹ç±»ï¼Œå¹¶ä¸”é€šçŸ¥ä¸­å¿ƒç»´æŠ¤äº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ³¨å†Œçš„è§‚å¯Ÿè€…çš„é›†åˆï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº†åŠ¨æ€æ•°ç»„æ¥å­˜å‚¨æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œæºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627+(YFLNotificationCenter*)defaultCenter&#123; static YFLNotificationCenter *singleton; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; singleton = [[self alloc] initSingleton]; &#125;); return singleton;&#125;- (instancetype)initSingleton&#123; if ([super init]) &#123; _obsetvers = [[NSMutableDictionary alloc]init]; &#125; return self;&#125; è¿˜å®šä¹‰äº†ä¸€ä¸ªè§‚å¯Ÿè€…æ¨¡åž‹ç”¨äºŽä¿å­˜è§‚å¯Ÿè€…ï¼Œé€šçŸ¥æ¶ˆæ¯åï¼Œè§‚å¯Ÿè€…æ”¶åˆ°é€šçŸ¥åŽæ‰§è¡Œä»£ç æ‰€åœ¨çš„æ“ä½œé˜Ÿåˆ—å’Œæ‰§è¡Œä»£ç çš„å›žè°ƒï¼Œæ¨¡åž‹æºç å¦‚ä¸‹ï¼š 123456789@interface YFLObserverModel : NSObject@property (nonatomic, strong) id observer; //è§‚å¯Ÿè€…å¯¹è±¡@property (nonatomic, assign) SEL selector; //æ‰§è¡Œçš„æ–¹æ³•@property (nonatomic, copy) NSString *notificationName; //é€šçŸ¥åå­—@property (nonatomic, strong) id object; //æºå¸¦å‚æ•°@property (nonatomic, strong) NSOperationQueue *operationQueue;//é˜Ÿåˆ—@property (nonatomic, copy) OperationBlock block; //å›žè°ƒ@end12345678910 å‘é€šçŸ¥ä¸­å¿ƒæ³¨å†Œè§‚å¯Ÿè€…ï¼Œæºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778- (void)addObserver:(id)observer selector:(SEL)aSelector name:(nullable NSString*)aName object:(nullable id)anObject&#123; //å¦‚æžœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå³åˆ›å»º if (![self.obsetvers objectForKey:aName]) &#123; NSMutableArray *arrays = [[NSMutableArray alloc]init]; // åˆ›å»ºæ•°ç»„æ¨¡åž‹ YFLObserverModel *observerModel = [[YFLObserverModel alloc]init]; observerModel.observer = observer; observerModel.selector = aSelector; observerModel.notificationName = aName; observerModel.object = anObject; [arrays addObject:observerModel]; //å¡«å……è¿›å…¥æ•°ç»„ [self.obsetvers setObject:arrays forKey:aName]; &#125;else&#123; //å¦‚æžœå­˜åœ¨ï¼Œå–å‡ºæ¥ï¼Œç»§ç»­æ·»åŠ å‡åŽ»å³å¯ NSMutableArray *arrays = (NSMutableArray*)[self.obsetvers objectForKey:aName]; // åˆ›å»ºæ•°ç»„æ¨¡åž‹ YFLObserverModel *observerModel = [[YFLObserverModel alloc]init]; observerModel.observer = observer; observerModel.selector = aSelector; observerModel.notificationName = aName; observerModel.object = anObject; [arrays addObject:observerModel]; &#125;&#125;- (id &lt;NSObject&gt;)addObserverForName:(nullable NSString *)name object:(nullable id)obj queue:(nullable NSOperationQueue *)queue usingBlock:(void (^)(YFLNotification *note))block&#123; //å¦‚æžœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå³åˆ›å»º if (![self.obsetvers objectForKey:name]) &#123; NSMutableArray *arrays = [[NSMutableArray alloc]init]; // åˆ›å»ºæ•°ç»„æ¨¡åž‹ YFLObserverModel *observerModel = [[YFLObserverModel alloc]init]; observerModel.block = block; observerModel.notificationName = name; observerModel.object = obj; observerModel.operationQueue = queue; [arrays addObject:observerModel]; //å¡«å……è¿›å…¥æ•°ç»„ [self.obsetvers setObject:arrays forKey:name]; &#125;else&#123; //å¦‚æžœå­˜åœ¨ï¼Œå–å‡ºæ¥ï¼Œç»§ç»­æ·»åŠ å³å¯ NSMutableArray *arrays = (NSMutableArray*)[self.obsetvers objectForKey:name]; // åˆ›å»ºæ•°ç»„æ¨¡åž‹ YFLObserverModel *observerModel = [[YFLObserverModel alloc]init]; observerModel.block = block; observerModel.notificationName = name; observerModel.object = obj; observerModel.operationQueue = queue; [arrays addObject:observerModel]; &#125; return nil;&#125; å‘é€é€šçŸ¥æœ‰ä¸‰ç§æ–¹å¼ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨- (void)postNotification:(YFLNotification *)notificationï¼Œæºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536- (void)postNotification:(YFLNotification *)notification&#123; //name å–å‡ºæ¥å¯¹åº”è§‚å¯Ÿè€…æ•°ç»„ï¼Œæ‰§è¡Œä»»åŠ¡ NSMutableArray *arrays = (NSMutableArray*)[self.obsetvers objectForKey:notification.name]; [arrays enumerateObjectsUsingBlock:^(id _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123; //å–å‡ºæ•°æ®æ¨¡åž‹ YFLObserverModel *observerModel = obj; id observer = observerModel.observer; SEL secector = observerModel.selector; if (!observerModel.operationQueue) &#123; #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; [observer performSelector:secector withObject:notification];#pragma clang diagnostic pop &#125;else&#123; //åˆ›å»ºä»»åŠ¡ NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123; //è¿™é‡Œç”¨blockå›žè°ƒå‡ºåŽ» observerModel.block(notification); &#125;]; // å¦‚æžœæ·»åŠ è§‚å¯Ÿè€… ä¼ å…¥ é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡æ”¾åœ¨é˜Ÿåˆ—ä¸­æ‰§è¡Œ(å­çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ) NSOperationQueue *operationQueue = observerModel.operationQueue; [operationQueue addOperation:operation]; &#125; &#125;];&#125; ç§»é™¤è§‚å¯Ÿè€…çš„ä»£ç æˆ‘å°±ä¸è´´äº†ï¼Œä¸€æ ·çš„æ€è·¯ã€‚ è¦çœ‹æºç ç‚¹å‡»è¿™é‡Œ[è½¬è‡ª YFL_iOS]]]></content>
      <categories>
        <category>Objective-Cè¯­è¨€ç‰¹æ€§</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[iOSåˆ†ç±»]]></title>
    <url>%2F2018%2F09%2F13%2FiOS%E5%88%86%E7%B1%BB%2F</url>
    <content type="text"><![CDATA[æ¦‚è¿°Categoryæ˜¯Objective-C 2.0ä¹‹åŽæ·»åŠ çš„è¯­è¨€ç‰¹æ€§ï¼ŒCategoryåˆå«åˆ†ç±»ã€ç±»åˆ«ã€ç±»ç›®ï¼Œèƒ½å¤Ÿåœ¨ä¸æ”¹å˜åŽŸæ¥ç±»å†…å®¹çš„åŸºç¡€ä¸Šï¼Œä¸ºç±»å¢žåŠ ä¸€äº›æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒCategoryè¿˜æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š ï¼ˆ1ï¼‰å°†ç±»çš„å®žçŽ°åˆ†å¼€å†™åœ¨å‡ ä¸ªåˆ†ç±»é‡Œé¢ã€‚è¿™æ ·åšçš„å¥½å¤„: å¯ä»¥å‡å°‘å•ä¸ªæ–‡ä»¶çš„ä½“ç§¯ å¯ä»¥æŠŠä¸åŒçš„åŠŸèƒ½ç»„ç»‡åˆ°ä¸åŒçš„Categoryé‡Œ å¯ä»¥ç”±å¤šä¸ªå¼€å‘è€…å…±åŒå®Œæˆä¸€ä¸ªç±» å¯ä»¥æŒ‰éœ€åŠ è½½æƒ³è¦çš„category ï¼ˆ2ï¼‰å£°æ˜Žç§æœ‰çš„æ–¹æ³•ã€‚ ï¼ˆ3ï¼‰æ¨¡æ‹Ÿå¤šç»§æ‰¿ã€‚ Categoryçš„å®šä¹‰ä¸Žä½¿ç”¨ä¸ºäº†ä¾¿äºŽç†è§£ï¼Œè¿™é‡Œç›´æŽ¥é€šè¿‡ä¸€ä¸ªå°ä¾‹å­åŽ»è®²è§£å…¶ç”¨æ³•ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªPersonç±»ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºä¸€ä¸ªCategoryå‘½åä¸ºMyCategoryã€‚åˆ›å»ºCategoryå¾ˆç®€å•ï¼Œå¦‚ä¸‹å›¾ï¼š ä¸ºPersonåˆ›å»ºä¸€ä¸ªåä¸ºMyCategoryçš„CategoryåŽï¼Œä¼šè‡ªåŠ¨ç”ŸæˆPerson+MyCategory.hå’ŒPerson+MyCategory.mæ–‡ä»¶ã€‚æˆ‘ä»¬åœ¨MyCategoryä¸­å£°æ˜Žå’Œå®žçŽ°ä¸€ä¸ªreadæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š 12345678// Person+MyCategory.h#import &quot;Person.h&quot;@interface Person (MyCategory)-(void)read;@end 12345678910// Person+MyCategory.m#import &quot;Person+MyCategory.h&quot;@implementation Person (MyCategory)-(void)read&#123; NSLog(@&quot;è°ƒç”¨äº†MyCategoryçš„readæ–¹æ³•ï¼&quot;);&#125;@end ä¹‹åŽæˆ‘ä»¬å¯ä»¥åœ¨ViewControlleræˆ–å…¶ä»–åœ°æ–¹ä½¿ç”¨åˆ†ç±»ä¸­æ·»åŠ çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920// ViewController.m#import &quot;ViewController.h&quot;#import &quot;Person+MyCategory.h&quot;@interface ViewController ()@end@implementation ViewController- (void)viewDidLoad &#123; [super viewDidLoad]; Person *p = [[Person alloc] init]; [p read];&#125;@end æ‰“å°ç»“æžœï¼š 12017-01-09 16:27:39.089 Test[5347:483009] è°ƒç”¨äº†MyCategoryçš„readæ–¹æ³•ï¼ 1 2017-01-09 16:27:39.089 Test [5347:483009] è°ƒç”¨äº†MyCategoryçš„ readæ–¹æ³•ï¼ ä½¿ç”¨æ³¨æ„ åˆ†ç±»åªèƒ½å¢žåŠ æ–¹æ³•ï¼Œä¸èƒ½å¢žåŠ æˆå‘˜å˜é‡ã€‚ åˆ†ç±»æ–¹æ³•å®žçŽ°ä¸­å¯ä»¥è®¿é—®åŽŸæ¥ç±»ä¸­å£°æ˜Žçš„æˆå‘˜å˜é‡ã€‚ åˆ†ç±»å¯ä»¥é‡æ–°å®žçŽ°åŽŸæ¥ç±»ä¸­çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¼šè¦†ç›–æŽ‰åŽŸæ¥çš„æ–¹æ³•ï¼Œä¼šå¯¼è‡´åŽŸæ¥çš„æ–¹æ³•æ²¡æ³•å†ä½¿ç”¨ï¼ˆå®žé™…ä¸Šå¹¶æ²¡æœ‰çœŸçš„æ›¿æ¢ï¼Œè€Œæ˜¯Categoryçš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œè€ŒåŽŸæ¥ç±»çš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„åŽé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„Categoryçš„æ–¹æ³•ä¼šâ€œè¦†ç›–â€æŽ‰åŽŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºè¿è¡Œæ—¶åœ¨æŸ¥æ‰¾æ–¹æ³•çš„æ—¶å€™æ˜¯é¡ºç€æ–¹æ³•åˆ—è¡¨çš„é¡ºåºæŸ¥æ‰¾çš„ï¼Œå®ƒåªè¦ä¸€æ‰¾åˆ°å¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±ä¼šç½¢ä¼‘ï¼Œæ®Šä¸çŸ¥åŽé¢å¯èƒ½è¿˜æœ‰ä¸€æ ·åå­—çš„æ–¹æ³•ï¼‰ã€‚ å½“åˆ†ç±»ã€åŽŸæ¥ç±»ã€åŽŸæ¥ç±»çš„çˆ¶ç±»ä¸­æœ‰ç›¸åŒæ–¹æ³•æ—¶ï¼Œæ–¹æ³•è°ƒç”¨çš„ä¼˜å…ˆçº§ï¼šåˆ†ç±»(æœ€åŽå‚ä¸Žç¼–è¯‘çš„åˆ†ç±»ä¼˜å…ˆ) â€“&gt; åŽŸæ¥ç±» â€“&gt; çˆ¶ç±»ï¼Œå³å…ˆåŽ»è°ƒç”¨åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼Œåˆ†ç±»ä¸­æ²¡è¿™ä¸ªæ–¹æ³•å†åŽ»åŽŸæ¥ç±»ä¸­æ‰¾ï¼ŒåŽŸæ¥ç±»ä¸­æ²¡æœ‰å†åŽ»çˆ¶ç±»ä¸­æ‰¾ã€‚ Categoryæ˜¯åœ¨runtimeæ—¶å€™åŠ è½½ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™ã€‚ Categoryä¸Žæˆå‘˜å˜é‡ã€å±žæ€§å¦‚æžœä½ åœ¨ä½ Categoryçš„.hæ–‡ä»¶ä¸­å†™å¦‚ä¸‹ä»£ç ï¼š 123&#123; NSString *str1;&#125; Xcodeä¼šæŠ¥å¦‚ä¸‹é”™è¯¯: 1Instance variable may not be placed in categories é€šè¿‡è¿™å¥è¯æˆ‘ä»¬çŸ¥é“Xcodeæ˜¯ä¸å…è®¸æˆ‘ä»¬åœ¨Categoryä¸­æ·»åŠ æˆå‘˜å˜é‡çš„ã€‚ ä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡å‘¢ï¼Ÿ Objective-Cç±»æ˜¯ç”±Classç±»åž‹æ¥è¡¨ç¤ºçš„ï¼Œå®ƒå®žé™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘objc_classç»“æž„ä½“çš„æŒ‡é’ˆã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š 1typedef struct objc_class *Class; objc_classç»“æž„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314struct objc_class &#123; Class isa OBJC_ISA_AVAILABILITY;#if !__OBJC2__ Class super_class OBJC2_UNAVAILABLE; // çˆ¶ç±» const char *name OBJC2_UNAVAILABLE; // ç±»å long version OBJC2_UNAVAILABLE; // ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0 long info OBJC2_UNAVAILABLE; // ç±»ä¿¡æ¯ï¼Œä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯† long instance_size OBJC2_UNAVAILABLE; // è¯¥ç±»çš„å®žä¾‹å˜é‡å¤§å° struct objc_ivar_list *ivars OBJC2_UNAVAILABLE; // è¯¥ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨ struct objc_method_list **methodLists OBJC2_UNAVAILABLE; // æ–¹æ³•å®šä¹‰çš„é“¾è¡¨ struct objc_cache *cache OBJC2_UNAVAILABLE; // æ–¹æ³•ç¼“å­˜ struct objc_protocol_list *protocols OBJC2_UNAVAILABLE; // åè®®é“¾è¡¨#endif&#125; OBJC2_UNAVAILABLE; åœ¨ä¸Šé¢çš„objc_classç»“æž„ä½“ä¸­ï¼Œivarsæ˜¯objc_ivar_listï¼ˆæˆå‘˜å˜é‡åˆ—è¡¨ï¼‰æŒ‡é’ˆï¼›methodListsæ˜¯æŒ‡å‘objc_method_listæŒ‡é’ˆçš„æŒ‡é’ˆã€‚åœ¨Runtimeä¸­ï¼Œobjc_classç»“æž„ä½“å¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸å¯èƒ½å¾€è¿™ä¸ªç»“æž„ä½“ä¸­æ·»åŠ æ•°æ®ï¼Œåªèƒ½ä¿®æ”¹ã€‚æ‰€ä»¥ivarsæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå›ºå®šåŒºåŸŸï¼Œåªèƒ½ä¿®æ”¹æˆå‘˜å˜é‡å€¼ï¼Œä¸èƒ½å¢žåŠ æˆå‘˜å˜é‡ä¸ªæ•°ã€‚methodListæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹*methodListsçš„å€¼æ¥å¢žåŠ æˆå‘˜æ–¹æ³•ï¼Œè™½æ²¡åŠžæ³•æ‰©å±•methodListsæŒ‡å‘çš„å†…å­˜åŒºåŸŸï¼Œå´å¯ä»¥æ”¹å˜è¿™ä¸ªå†…å­˜åŒºåŸŸçš„å€¼ï¼ˆå­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼‰ã€‚å› æ­¤ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ã€‚ Categoryä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ï¼ˆinstance variablesï¼‰ï¼Œé‚£åˆ°åº•èƒ½ä¸èƒ½æ·»åŠ å±žæ€§ï¼ˆpropertyï¼‰å‘¢ï¼Ÿ è¿™ä¸ªæˆ‘ä»¬è¦ä»ŽCategoryçš„ç»“æž„ä½“å¼€å§‹åˆ†æžï¼š 12345678typedef struct category_t &#123; const char *name; //ç±»çš„åå­— classref_t cls; //ç±» struct method_list_t *instanceMethods; //categoryä¸­æ‰€æœ‰ç»™ç±»æ·»åŠ çš„å®žä¾‹æ–¹æ³•çš„åˆ—è¡¨ struct method_list_t *classMethods; //categoryä¸­æ‰€æœ‰æ·»åŠ çš„ç±»æ–¹æ³•çš„åˆ—è¡¨ struct protocol_list_t *protocols; //categoryå®žçŽ°çš„æ‰€æœ‰åè®®çš„åˆ—è¡¨ struct property_list_t *instanceProperties; //categoryä¸­æ·»åŠ çš„æ‰€æœ‰å±žæ€§&#125; category_t; ä»ŽCategoryçš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºCategoryçš„å¯ä¸ºï¼ˆå¯ä»¥æ·»åŠ å®žä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å®žçŽ°åè®®ï¼Œæ·»åŠ å±žæ€§ï¼‰å’Œä¸å¯ä¸ºï¼ˆæ— æ³•æ·»åŠ å®žä¾‹å˜é‡ï¼‰ã€‚ ä½†æ˜¯ä¸ºä»€ä¹ˆç½‘ä¸Šå¾ˆå¤šäººéƒ½è¯´Categoryä¸èƒ½æ·»åŠ å±žæ€§å‘¢ï¼Ÿ å®žé™…ä¸Šï¼ŒCategoryå®žé™…ä¸Šå…è®¸æ·»åŠ å±žæ€§çš„ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨@propertyï¼Œä½†æ˜¯ä¸ä¼šç”Ÿæˆ_å˜é‡ï¼ˆå¸¦ä¸‹åˆ’çº¿çš„æˆå‘˜å˜é‡ï¼‰ï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ·»åŠ å±žæ€§çš„getterå’Œsetteræ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œå°½ç®¡æ·»åŠ äº†å±žæ€§ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨ç‚¹è¯­æ³•è°ƒç”¨getterå’Œsetteræ–¹æ³•ã€‚ä½†å®žé™…ä¸Šå¯ä»¥ä½¿ç”¨runtimeåŽ»å®žçŽ°Categoryä¸ºå·²æœ‰çš„ç±»æ·»åŠ æ–°çš„å±žæ€§å¹¶ç”Ÿæˆgetterå’Œsetteræ–¹æ³•ã€‚è¯¦ç»†å†…å®¹å¯ä»¥çœ‹å³°å“¥ä¹‹å‰çš„æ–‡ç« ï¼šã€ŠiOS Runtimeä¹‹å››ï¼šå…³è”å¯¹è±¡ã€‹ å››ã€Categoryä¸ŽExtension 1ã€Extensionçš„åŸºæœ¬ç”¨æ³• Extensionçš„åˆ›å»ºæ–¹æ³•ä¸ŽCategoryä¸€æ ·ï¼Œåªè¦åœ¨åŽŸæ¥é€‰æ‹©Categoryé€‰æ‹©Extensionå³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸ºPersonåˆ›å»ºä¸€ä¸ªåä¸ºMyExtensionçš„Extensionï¼Œåˆ™æœ€ç»ˆä¼šç”Ÿæˆä¸€ä¸ªPerson_MyExtension.hæ–‡ä»¶ï¼š 1234567// Person_MyExtension.h#import &quot;Person.h&quot;@interface Person ()@end ä½†è¦æ³¨æ„çš„æ˜¯å’ŒCategoryä¸åŒçš„æ˜¯å®ƒä¸ä¼šç”ŸæˆPerson_MyExtension.mæ–‡ä»¶ã€‚ä¹‹åŽæˆ‘ä»¬å¯ä»¥åœ¨Person_MyExtension.hä¸­ç›´æŽ¥æ·»åŠ æˆå‘˜å˜é‡ã€å±žæ€§å’Œæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š 12345678910111213// Person_MyExtension.h#import &quot;Person.h&quot;@interface Person ()&#123; NSString * _address;&#125;@property (nonatomic) NSInteger age;-(NSString*)WhereAmI;@end ä»–å¸¸ç”¨çš„å½¢å¼ä¸æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨å®žçŽ°æ–‡ä»¶ä¸­æ·»åŠ ç§æœ‰çš„æˆå‘˜å˜é‡ã€å±žæ€§å’Œæ–¹æ³•ã€‚ä¾‹å¦‚ï¼š 12345678910111213141516171819202122232425// Person.m#import &quot;Person.h&quot;/////////Extension start///////////@interface Person ()&#123; NSString * _address;&#125;@property (nonatomic) NSInteger age;-(NSString*)WhereAmI;@end/////////Extension end///////////@implementation Person-(NSString*)WhereAmI&#123; return @&quot;è°çŸ¥é“ä½ åœ¨å“ªé‡Œ&quot;;&#125;@end 2ã€Extensionä¸ŽCategoryåŒºåˆ« Extension åœ¨ç¼–è¯‘å™¨å†³è®®ï¼Œæ˜¯ç±»çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç¼–è¯‘å™¨å’Œå¤´æ–‡ä»¶çš„@interfaceå’Œå®žçŽ°æ–‡ä»¶é‡Œçš„@implementä¸€èµ·å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„ç±»ã€‚ ä¼´éšç€ç±»çš„äº§ç”Ÿè€Œäº§ç”Ÿï¼Œä¹Ÿéšç€ç±»çš„æ¶ˆå¤±è€Œæ¶ˆå¤±ã€‚ Extensionä¸€èˆ¬ç”¨æ¥éšè—ç±»çš„ç§æœ‰æ¶ˆæ¯ï¼Œä½ å¿…é¡»æœ‰ä¸€ä¸ªç±»çš„æºç æ‰èƒ½æ·»åŠ ä¸€ä¸ªç±»çš„Extensionï¼Œæ‰€ä»¥å¯¹äºŽç³»ç»Ÿä¸€äº›ç±»ï¼Œå¦‚NSStringï¼Œå°±æ— æ³•æ·»åŠ ç±»æ‰©å±• Category æ˜¯è¿è¡ŒæœŸå†³è®®çš„ ç±»æ‰©å±•å¯ä»¥æ·»åŠ å®žä¾‹å˜é‡ï¼Œåˆ†ç±»ä¸èƒ½æ·»åŠ å®žä¾‹å˜é‡ åŽŸå› ï¼šå› ä¸ºåœ¨è¿è¡ŒæœŸï¼Œå¯¹è±¡çš„å†…å­˜å¸ƒå±€å·²ç»ç¡®å®šï¼Œå¦‚æžœæ·»åŠ å®žä¾‹å˜é‡ä¼šç ´åç±»çš„å†…éƒ¨å¸ƒå±€ï¼Œè¿™å¯¹ç¼–è¯‘æ€§è¯­è¨€æ˜¯ç¾éš¾æ€§çš„ã€‚ åŽŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜Žï¼š è½¬è½½è‡ªæŽå³°å³°åšå®¢]]></content>
      <categories>
        <category>Objective-Cè¯­è¨€ç‰¹æ€§</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[Runtimeå…¨æ–¹ä½è£…é€¼æŒ‡å—]]></title>
    <url>%2F2018%2F09%2F13%2FRuntime%E5%85%A8%E6%96%B9%E4%BD%8D%E8%A3%85%E9%80%BC%E6%8C%87%E5%8D%97%2F</url>
    <content type="text"><![CDATA[ï¿½æ¥”å­Runtimeæ˜¯ä»€ä¹ˆï¼Ÿè§åçŸ¥æ„ï¼Œå…¶æ¦‚å¿µæ— éžå°±æ˜¯â€œå› ä¸º Objective-C æ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œæ‰€ä»¥å®ƒéœ€è¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿâ€¦â€¦è¿™å°±æ˜¯ Runtime ç³»ç»Ÿâ€äº‘äº‘ã€‚å¯¹åšä¸»è¿™ç§èœé¸Ÿè€Œè¨€ï¼ŒRuntime åœ¨å®žé™…å¼€å‘ä¸­ï¼Œå…¶å®žå°±æ˜¯ä¸€ç»„Cè¯­è¨€çš„å‡½æ•°ã€‚èƒ¡é€‚è¯´ï¼šâ€œå¤šç ”ç©¶äº›é—®é¢˜ï¼Œå°‘è°ˆäº›ä¸»ä¹‰â€ï¼Œäº‘å±±é›¾ç½©çš„æ¦‚å¿µå¬å¤šäº†æ€»æ˜¯å®¹æ˜“å¤´æ™•ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬ç›´æŽ¥ä»Žä»£ç å…¥æ‰‹å­¦ä¹  Runtimeã€‚ï¿½ 1ã€ç”±objc_msgSendè¯´å¼€åŽ»ï¼šObjective-C ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œä¸æ˜¯ç®€å•çš„æ–¹æ³•è°ƒç”¨ï¼Œè€Œæ˜¯å‘é€æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶å®ž [receiver message] ä¼šè¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸º: objc_msgSend(receiver, selector)ï¼Œä½•ä»¥è¯æ˜Žï¼Ÿæ–°å»ºä¸€ä¸ªç±» MyClassï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š 12345678910111213#import &quot;MyClass.h&quot;@implementation MyClass-(instancetype)init&#123; if (self = [super init]) &#123; [self showUserName]; &#125; return self;&#125;-(void)showUserName&#123; NSLog(@&quot;Dave Ping&quot;);&#125; ä½¿ç”¨ clang é‡å†™å‘½ä»¤: 1$ clang -rewrite-objc MyClass.m ç„¶åŽåœ¨åŒä¸€ç›®å½•ä¸‹ä¼šå¤šå‡ºä¸€ä¸ª MyClass.cpp æ–‡ä»¶ï¼ŒåŒå‡»æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ° init æ–¹æ³•å·²ç»è¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸ºä¸‹é¢è¿™æ ·ï¼š 123456static instancetype _I_MyClass_init(MyClass * self, SEL _cmd) &#123; if (self = ((MyClass *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;MyClass&quot;))&#125;, sel_registerName(&quot;init&quot;))) &#123; ((void (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName(&quot;showUserName&quot;)); &#125; return self;&#125; æˆ‘ä»¬è¦æ‰¾çš„å°±æ˜¯å®ƒï¼š 1((void (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName(&quot;showUserName&quot;)) objc_msgSend å‡½æ•°è¢«å®šä¹‰åœ¨ objc/message.h ç›®å½•ä¸‹ï¼Œå…¶å‡½æ•°åŽŸåž‹æ˜¯é…±ç´«æ»´ï¼š 1OBJC_EXPORT void objc_msgSend(void /* id self, SEL op, ... */ ) ï¿½è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ª id ç±»åž‹ï¼Œä¸€ä¸ª SEL ç±»åž‹ã€‚ 2ã€SELSEL è¢«å®šä¹‰åœ¨ ï¿½objc/objc.h ç›®å½•ä¸‹ï¼š 1typedef struct objc_selector *SEL; å…¶å®žå®ƒå°±æ˜¯ä¸ªæ˜ å°„åˆ°æ–¹æ³•çš„Cå­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥ç”¨ Objective-C ç¼–è¯‘å™¨å‘½ä»¤ @selector() æˆ–è€… Runtime ç³»ç»Ÿçš„ sel_registerName å‡½æ•°æ¥èŽ·å¾—ä¸€ä¸ª SEL ç±»åž‹çš„æ–¹æ³•é€‰æ‹©å™¨ã€‚ 3ã€idä¸Ž SEL ä¸€æ ·ï¼Œid ä¹Ÿè¢«å®šä¹‰åœ¨ ï¿½objc/objc.h ç›®å½•ä¸‹ï¼š 1typedef struct objc_object *id; id æ˜¯ä¸€ä¸ªç»“æž„ä½“æŒ‡é’ˆç±»åž‹ï¼Œå®ƒå¯ä»¥æŒ‡å‘ Objective-C ä¸­çš„ä»»ä½•å¯¹è±¡ã€‚objc_object ç»“æž„ä½“å®šä¹‰å¦‚ä¸‹ï¼š 1struct objc_object &#123; Class isa OBJC_ISA_AVAILABILITY;&#125;; æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„å¯¹è±¡ï¼Œå°±é•¿è¿™ä¸ªæ ·å­ï¼Œè¿™ä¸ªç»“æž„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¿½ isaï¼Œï¿½å¯¹è±¡å¯ä»¥é€šè¿‡ ï¿½isa æŒ‡é’ˆæ‰¾åˆ°å…¶æ‰€å±žçš„ç±»ã€‚isa æ˜¯ä¸€ä¸ª ï¿½Class ç±»åž‹çš„æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆ Class åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ 4ã€ClassClass ä¹Ÿæ˜¯ä¸€ä¸ªç»“æž„ä½“æŒ‡é’ˆç±»åž‹ï¼š 1typedef struct objc_class *Class; objc_class ç»“æž„ä½“æ˜¯é…±ç´«æ»´ï¼š 12345678910111213141516struct objc_class &#123; Class isa OBJC_ISA_AVAILABILITY;#if !__OBJC2__ Class super_class OBJC2_UNAVAILABLE; const char *name OBJC2_UNAVAILABLE; long version OBJC2_UNAVAILABLE; long info OBJC2_UNAVAILABLE; long instance_size OBJC2_UNAVAILABLE; struct objc_ivar_list *ivars OBJC2_UNAVAILABLE; struct objc_method_list **methodLists OBJC2_UNAVAILABLE; struct objc_cache *cache OBJC2_UNAVAILABLE; struct objc_protocol_list *protocols OBJC2_UNAVAILABLE;#endif&#125; OBJC2_UNAVAILABLE; æˆ‘ä»¬é€šå¸¸è¯´çš„ï¿½ç±»å°±é•¿è¿™æ ·å­ï¼šÂ·Class ä¹Ÿæœ‰ä¸€ä¸ª isa æŒ‡é’ˆï¼ŒæŒ‡å‘å…¶æ‰€å±žçš„å…ƒç±»ï¼ˆmetaï¼‰.Â·super_classï¼šæŒ‡å‘å…¶è¶…ç±».Â·nameï¼šæ˜¯ç±»å.Â·versionï¼šæ˜¯ç±»çš„ç‰ˆæœ¬ä¿¡æ¯.Â·infoï¼šæ˜¯ç±»çš„è¯¦æƒ….Â·instance_sizeï¼šæ˜¯è¯¥ç±»çš„å®žä¾‹å¯¹è±¡çš„å¤§å°.Â·ivarsï¼šæŒ‡å‘è¯¥ç±»çš„æˆå‘˜å˜é‡åˆ—è¡¨.Â·methodListsï¼šæŒ‡å‘è¯¥ç±»çš„å®žä¾‹æ–¹æ³•åˆ—è¡¨ï¼Œå®ƒå°†æ–¹æ³•é€‰æ‹©å™¨å’Œæ–¹æ³•å®žçŽ°åœ°å€è”ç³»èµ·æ¥ã€‚methodLists æ˜¯æŒ‡å‘ Â·objc_method_list æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åŠ¨æ€ä¿®æ”¹ *methodLists çš„å€¼æ¥æ·»åŠ æˆå‘˜æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ Category å®žçŽ°çš„åŽŸç†ï¼ŒåŒæ ·è§£é‡Šäº† Category ä¸èƒ½æ·»åŠ å±žæ€§çš„åŽŸå› .Â·cacheï¼šRuntime ç³»ç»Ÿä¼šæŠŠè¢«è°ƒç”¨çš„æ–¹æ³•å­˜åˆ° ï¿½cache ä¸­ï¼ˆç†è®ºä¸Šè®²ä¸€ä¸ªæ–¹æ³•å¦‚æžœè¢«è°ƒç”¨ï¿½ï¼Œé‚£ä¹ˆå®ƒæœ‰å¯èƒ½ä»ŠåŽè¿˜ä¼šè¢«è°ƒç”¨ï¼‰ï¼Œä¸‹æ¬¡æŸ¥æ‰¾çš„æ—¶å€™æ•ˆçŽ‡æ›´é«˜.Â·protocolsï¼šæŒ‡å‘è¯¥ç±»çš„åè®®åˆ—è¡¨. è¯´åˆ°è¿™é‡Œæœ‰ç‚¹ä¹±äº†ï¼Œæˆ‘ä»¬æ¥æ‹ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå…¶è¿è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š é¦–å…ˆï¼ŒRuntime ç³»ç»Ÿä¼šæŠŠæ–¹æ³•è°ƒç”¨è½¬åŒ–ä¸ºæ¶ˆæ¯å‘é€ï¼Œå³ objc_msgSendï¼Œå¹¶ä¸”æŠŠæ–¹æ³•çš„è°ƒç”¨è€…ï¼Œå’Œæ–¹æ³•é€‰æ‹©å™¨ï¼Œå½“åšå‚æ•°ä¼ é€’è¿‡åŽ». æ­¤æ—¶ï¼Œæ–¹æ³•çš„è°ƒç”¨è€…ä¼šé€šè¿‡ isa æŒ‡é’ˆæ¥æ‰¾åˆ°å…¶æ‰€å±žçš„ç±»ï¼Œç„¶åŽåœ¨ cache æˆ–è€… methodLists ä¸­æŸ¥æ‰¾è¯¥æ–¹æ³•ï¼Œæ‰¾å¾—åˆ°å°±è·³åˆ°å¯¹åº”çš„æ–¹æ³•åŽ»æ‰§è¡Œ. å¦‚æžœåœ¨ç±»ä¸­æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•ï¼Œåˆ™é€šè¿‡ super_class å¾€ä¸Šä¸€çº§è¶…ç±»æŸ¥æ‰¾ï¼ˆå¦‚æžœä¸€ç›´æ‰¾åˆ° NSObject éƒ½æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•çš„è¯ï¼Œè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æ”¾åˆ°åŽé¢æ¶ˆæ¯è½¬å‘çš„æ—¶å€™å†è¯´ï¼‰. å‰é¢æˆ‘ä»¬è¯´ methodLists æŒ‡å‘è¯¥ç±»çš„å®žä¾‹æ–¹æ³•åˆ—è¡¨ï¼Œå®žä¾‹æ–¹æ³•å³-æ–¹æ³•ï¼Œé‚£ä¹ˆç±»æ–¹æ³•ï¼ˆ+æ–¹æ³•ï¼‰å­˜å‚¨åœ¨å“ªå„¿å‘¢ï¼Ÿç±»æ–¹æ³•è¢«å­˜å‚¨åœ¨å…ƒç±»ä¸­ï¼ŒClass é€šè¿‡ isa æŒ‡é’ˆå³å¯æ‰¾åˆ°å…¶æ‰€å±žçš„å…ƒç±». ä¸Šå›¾å®žçº¿æ˜¯ super_class æŒ‡é’ˆï¼Œè™šçº¿æ˜¯ isa æŒ‡é’ˆã€‚æ ¹å…ƒç±»çš„è¶…ç±»æ˜¯NSObjectï¼Œè€Œ isa æŒ‡å‘äº†è‡ªå·±ã€‚NSObject çš„è¶…ç±»ä¸º nilï¼Œä¹Ÿå°±æ˜¯å®ƒæ²¡æœ‰è¶…ç±»ã€‚ 5ã€ä½¿ç”¨objc_msgSendå‰é¢æˆ‘ä»¬ä½¿ç”¨ clang é‡å†™å‘½ä»¤ï¼Œçœ‹åˆ° Runtime æ˜¯å¦‚ä½•å°†æ–¹æ³•è°ƒç”¨è½¬åŒ–ä¸ºæ¶ˆæ¯å‘é€çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¾æ ·ç”»è‘«èŠ¦ï¼Œæ¥å­¦ä¹ ä½¿ç”¨ä¸€ä¸‹ objc_msgSendã€‚æ–°å»ºä¸€ä¸ªç±» TestClassï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š 12345678910111213141516171819-(void)showAge&#123; NSLog(@&quot;24&quot;);&#125;-(void)showName:(NSString *)aName&#123; NSLog(@&quot;name is %@&quot;,aName);&#125;-(void)showSizeWithWidth:(float)aWidth andHeight:(float)aHeight&#123; NSLog(@&quot;size is %.2f * %.2f&quot;,aWidth, aHeight);&#125;-(float)getHeight&#123; return 187.5f;&#125;-(NSString *)getInfo&#123; return @&quot;Hi, my name is Dave Ping, I&apos;m twenty-four years old in the year, I like apple, nice to meet you.&quot;;&#125; æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼Œä½¿ç”¨ objc_msgSend ä¾æ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•ï¼š 12345678910111213TestClass *objct = [[TestClass alloc] init];((void (*) (id, SEL)) objc_msgSend) (objct, sel_registerName(&quot;showAge&quot;));((void (*) (id, SEL, NSString *)) objc_msgSend) (objct, sel_registerName(&quot;showName:&quot;), @&quot;Dave Ping&quot;);((void (*) (id, SEL, float, float)) objc_msgSend) (objct, sel_registerName(&quot;showSizeWithWidth:andHeight:&quot;), 110.5f, 200.0f);float f = ((float (*) (id, SEL)) objc_msgSend_fpret) (objct, sel_registerName(&quot;getHeight&quot;));NSLog(@&quot;height is %.2f&quot;,f);NSString *info = ((NSString* (*) (id, SEL)) objc_msgSend) (objct, sel_registerName(&quot;getInfo&quot;));NSLog(@&quot;%@&quot;,info); ä¹Ÿè®¸ä½ å·²ç»æ³¨æ„åˆ°ï¼Œobjc_msgSend åœ¨ä½¿ç”¨æ—¶éƒ½è¢«å¼ºåˆ¶è½¬æ¢äº†ä¸€ä¸‹ï¼Œè¿™æ˜¯å› ä¸º objc_msgSend è¿™ä¸ªå‡½æ•°è‡³å°‘è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªidæ¶ˆæ¯æŽ¥å—è€…ï¼Œä¸€ä¸ªSELæ¶ˆæ¯åç§°ã€‚åŽé¢ä¸‰ä¸ªç‚¹ä»£è¡¨å‚æ•°ï¼Œæ˜¯å˜å‚ã€‚ä¹Ÿå°±æ˜¯è¯´æ–¹æ³•æºå¸¦çš„å‚æ•°ï¼Œå¯ä»¥æ²¡æœ‰ï¼Œå¯ä»¥æœ‰å¤šä¸ªã€‚å¦‚æžœæˆ‘ä»¬æŠŠè°ƒç”¨ showAge æ–¹æ³•æ”¹æˆè¿™æ ·ï¼š 1objc_msgSend(objct, sel_registerName(&quot;showAge&quot;)); Xcode å°±ä¼šæŠ¥é”™ï¼š 1Too many arguments to function call, expected 0, have 2. å®Œæ•´çš„ objc_msgSend ä½¿ç”¨ä»£ç åœ¨ï¿½è¿™é‡Œã€‚ 6ã€objc_msgSendSuperç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µåœ¨ objc_msgSendï¼Œobjc_msgSend_stretï¼Œobjc_msgSendSuperï¼Œobjc_msgSendSuper_stret æˆ– objc_msgSend_fpret äº”ä¸ªæ–¹æ³•ä¸­é€‰æ‹©ä¸€ä¸ªæ¥è°ƒç”¨ã€‚å¦‚æžœæ¶ˆæ¯æ˜¯ä¼ é€’ç»™è¶…ç±»ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ objc_msgSendSuper æ–¹æ³•ï¼Œå¦‚æžœæ¶ˆæ¯è¿”å›žå€¼æ˜¯æ•°æ®ç»“æž„ï¼Œå°±ä¼šè°ƒç”¨ objc_msgSendSuper_stret æ–¹æ³•ï¼Œå¦‚æžœè¿”å›žå€¼æ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™è°ƒç”¨ objc_msgSend_fpret æ–¹æ³•ã€‚ è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¯´ä¸€ä¸‹ objc_msgSendSuperï¼Œobjc_msgSendSuper å‡½æ•°åŽŸåž‹å¦‚ä¸‹ï¼š 1OBJC_EXPORT void objc_msgSendSuper(void /* struct objc_super *super, SEL op, ... */ ) ï¿½å½“æˆ‘ä»¬è°ƒç”¨ [super selector] æ—¶ï¼ŒRuntime ä¼šè°ƒç”¨ objc_msgSendSuper æ–¹æ³•ï¼Œobjc_msgSendSuper æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œsuper å’Œ opï¼ŒRuntime ä¼šæŠŠ selector æ–¹æ³•é€‰æ‹©å™¨èµ‹å€¼ç»™ opã€‚è€Œ super æ˜¯ä¸€ä¸ª objc_super ç»“æž„ä½“æŒ‡é’ˆï¼Œobjc_super ç»“æž„ä½“å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213struct objc_super &#123; /// Specifies an instance of a class. __unsafe_unretained id receiver; /// Specifies the particular superclass of the instance to message. #if !defined(__cplusplus) &amp;&amp; !__OBJC2__ /* For compatibility with old objc-runtime.h header */ __unsafe_unretained Class class;#else __unsafe_unretained Class super_class;#endif /* super_class is the first class to search */&#125;; Runtime ä¼šåˆ›å»ºä¸€ä¸ª objc_spuer ç»“æž„ä½“å˜é‡ï¼Œå°†å…¶åœ°å€ä½œä¸ºå‚æ•°ï¼ˆsuperï¼‰ä¼ é€’ç»™ objc_msgSendSuperï¼Œå¹¶ä¸”å°† self èµ‹å€¼ç»™ receiverï¼šsuperâ€”&gt;receiver=self.ä¸¾ä¸ªæ —å­ï¼Œé—®ä¸‹é¢çš„ä»£ç è¾“å‡ºä»€ä¹ˆï¼š 123456789101112@implementation Son : Father- (id)init&#123; self = [super init]; if (self) &#123; NSLog(@&quot;%@&quot;, NSStringFromClass([self class])); NSLog(@&quot;%@&quot;, NSStringFromClass([super class])); &#125; return self;&#125;@end ç­”æ¡ˆæ˜¯å…¨éƒ¨è¾“å‡º Son.ä½¿ç”¨ clang é‡å†™å‘½ä»¤ï¼Œå‘çŽ°ä¸Šè¿°ä»£ç è¢«è½¬åŒ–ä¸º: 12NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_gm_0jk35cwn1d3326x0061qym280000gn_T_main_a5cecc_mi_0, NSStringFromClass(((Class (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName(&quot;class&quot;))));NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_gm_0jk35cwn1d3326x0061qym280000gn_T_main_a5cecc_mi_1, NSStringFromClass(((Class (*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123; (id)self, (id)class_getSuperclass(objc_getClass(&quot;Son&quot;)) &#125;, sel_registerName(&quot;class&quot;)))); å½“è°ƒç”¨ [super class] æ—¶ï¼Œä¼šè½¬æ¢æˆ objc_msgSendSuper å‡½æ•°ï¼š ç¬¬ä¸€æ­¥å…ˆæž„é€  objc_super ç»“æž„ä½“ï¼Œç»“æž„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯ selfã€‚ç¬¬äºŒä¸ªæˆå‘˜æ˜¯ (id)class_getSuperclass(objc_getClass(â€œSonâ€)). ç¬¬äºŒæ­¥æ˜¯åŽ» Father è¿™ä¸ªç±»é‡ŒåŽ»æ‰¾ - (Class)classï¼Œæ²¡æœ‰ï¼Œç„¶åŽåŽ» NSObject ç±»åŽ»æ‰¾ï¼Œæ‰¾åˆ°äº†ã€‚æœ€åŽå†…éƒ¨æ˜¯ä½¿ç”¨ objc_msgSend(objc_super-&gt;receiver, @selector(class)) åŽ»è°ƒç”¨ï¼Œæ­¤æ—¶å·²ç»å’Œ [self class] è°ƒç”¨ç›¸åŒäº†ï¼Œæ‰€ä»¥ä¸¤ä¸ªè¾“å‡ºç»“æžœéƒ½æ˜¯ Sonã€‚ 7ã€ï¿½å¯¹è±¡å…³è”å¯¹è±¡å…³è”å…è®¸å¼€å‘è€…å¯¹å·²ç»å­˜åœ¨çš„ç±»åœ¨ Category ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å±žæ€§ï¼š 1OBJC_EXPORT void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy) __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_1); Â·object æ˜¯æºå¯¹è±¡.Â·value æ˜¯è¢«å…³è”çš„å¯¹è±¡.Â·key æ˜¯å…³è”çš„é”®ï¼Œobjc_getAssociatedObject æ–¹æ³•é€šè¿‡ä¸åŒçš„ key å³å¯å–å‡ºå¯¹åº”çš„è¢«å…³è”å¯¹è±¡.Â·policy æ˜¯ä¸€ä¸ªæžšä¸¾å€¼ï¼Œè¡¨ç¤ºå…³è”å¯¹è±¡çš„è¡Œä¸ºï¼Œä»Žå‘½åå°±èƒ½çœ‹å‡ºå„ä¸ªæžšä¸¾å€¼çš„å«ä¹‰ï¼š 1234567891011typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123; OBJC_ASSOCIATION_ASSIGN = 0, /**&lt; Specifies a weak reference to the associated object. */ OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object. * The association is not made atomically. */ OBJC_ASSOCIATION_COPY_NONATOMIC = 3, /**&lt; Specifies that the associated object is copied. * The association is not made atomically. */ OBJC_ASSOCIATION_RETAIN = 01401, /**&lt; Specifies a strong reference to the associated object. * The association is made atomically. */ OBJC_ASSOCIATION_COPY = 01403 /**&lt; Specifies that the associated object is copied. * The association is made atomically. */&#125;; è¦å–å‡ºè¢«å…³è”çš„å¯¹è±¡ä½¿ç”¨ objc_getAssociatedObject æ–¹æ³•å³å¯ï¼Œè¦åˆ é™¤ä¸€ä¸ªè¢«å…³è”çš„å¯¹è±¡ï¼Œä½¿ç”¨ objc_setAssociatedObject æ–¹æ³•å°†å¯¹åº”çš„ key è®¾ç½®æˆ nil å³å¯ï¼š 1objc_setAssociatedObject(self, associatedKey, nil, OBJC_ASSOCIATION_COPY_NONATOMIC); objc_removeAssociatedObjects æ–¹æ³•å°†ä¼šç§»é™¤æºå¯¹è±¡ä¸­æ‰€æœ‰çš„å…³è”å¯¹è±¡.ä¸¾ä¸ªæ —å­ï¼Œå‡å¦‚æˆ‘ä»¬è¦ç»™ UIButton æ·»åŠ ä¸€ä¸ªç›‘å¬å•å‡»äº‹ä»¶çš„ block å±žæ€§ï¼Œæ–°å»º UIButton çš„ Categoryï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728#import &quot;UIButton+ClickBlock.h&quot;#import &lt;objc/runtime.h&gt;static const void *associatedKey = &quot;associatedKey&quot;;@implementation UIButton (ClickBlock)//Categoryä¸­çš„å±žæ€§ï¼Œåªä¼šç”Ÿæˆsetterå’Œgetteræ–¹æ³•ï¼Œä¸ä¼šç”Ÿæˆæˆå‘˜å˜é‡-(void)setClick:(clickBlock)click&#123; objc_setAssociatedObject(self, associatedKey, click, OBJC_ASSOCIATION_COPY_NONATOMIC); [self removeTarget:self action:@selector(buttonClick) forControlEvents:UIControlEventTouchUpInside]; if (click) &#123; [self addTarget:self action:@selector(buttonClick) forControlEvents:UIControlEventTouchUpInside]; &#125;&#125;-(clickBlock)click&#123; return objc_getAssociatedObject(self, associatedKey);&#125;-(void)buttonClick&#123; if (self.click) &#123; self.click(); &#125;&#125;@end ç„¶åŽåœ¨ä»£ç ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ UIButton çš„å±žæ€§æ¥ç›‘å¬å•å‡»äº‹ä»¶äº†ï¼š 123456UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];button.frame = self.view.bounds;[self.view addSubview:button];button.click = ^&#123; NSLog(@&quot;buttonClicked&quot;);&#125;; å®Œæ•´çš„å¯¹è±¡å…³è”ä»£ç ç‚¹è¿™é‡Œ 8ã€ï¿½è‡ªåŠ¨å½’æ¡£åšä¸»åœ¨å­¦ä¹  Runtime ä¹‹å‰ï¼Œå½’æ¡£çš„æ—¶å€™æ˜¯é…±ç´«å†™çš„ï¼š 123456789101112- (void)encodeWithCoder:(NSCoder *)aCoder&#123; [aCoder encodeObject:self.name forKey:@&quot;name&quot;]; [aCoder encodeObject:self.ID forKey:@&quot;ID&quot;];&#125;- (id)initWithCoder:(NSCoder *)aDecoder&#123; if (self = [super init]) &#123; self.ID = [aDecoder decodeObjectForKey:@&quot;ID&quot;]; self.name = [aDecoder decodeObjectForKey:@&quot;name&quot;]; &#125; return self;&#125; é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æžœå½“å‰ Model æœ‰100ä¸ªå±žæ€§çš„è¯ï¼Œå°±éœ€è¦å†™100è¡Œè¿™ç§ä»£ç ï¼š 1[aCoder encodeObject:self.name forKey:@&quot;name&quot;]; æƒ³æƒ³éƒ½å¤´ç–¼ï¼Œé€šè¿‡ Runtime æˆ‘ä»¬å°±å¯ä»¥è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼šï¿½1.ä½¿ç”¨ class_copyIvarList æ–¹æ³•èŽ·å–å½“å‰ Model çš„æ‰€æœ‰æˆå‘˜å˜é‡.2.ä½¿ç”¨ ivar_getName æ–¹æ³•èŽ·å–æˆå‘˜å˜é‡çš„åç§°.3.é€šè¿‡ KVC æ¥è¯»å– Model çš„å±žæ€§å€¼ï¼ˆencodeWithCoder:ï¼‰ï¼Œä»¥åŠç»™ Model çš„å±žæ€§èµ‹å€¼ï¼ˆinitWithCoder:ï¼‰. ä¸¾ä¸ªæ —å­ï¼Œæ–°å»ºä¸€ä¸ª Model ç±»ï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536#import &quot;TestModel.h&quot;#import &lt;objc/runtime.h&gt;#import &lt;objc/message.h&gt;@implementation TestModel- (void)encodeWithCoder:(NSCoder *)aCoder&#123; unsigned int outCount = 0; Ivar *vars = class_copyIvarList([self class], &amp;outCount); for (int i = 0; i &lt; outCount; i ++) &#123; Ivar var = vars[i]; const char *name = ivar_getName(var); NSString *key = [NSString stringWithUTF8String:name]; // æ³¨æ„kvcçš„ç‰¹æ€§æ˜¯ï¼Œå¦‚æžœèƒ½æ‰¾åˆ°keyè¿™ä¸ªå±žæ€§çš„setteræ–¹æ³•ï¼Œåˆ™è°ƒç”¨setteræ–¹æ³• // å¦‚æžœæ‰¾ä¸åˆ°setteræ–¹æ³•ï¼Œåˆ™æŸ¥æ‰¾æˆå‘˜å˜é‡keyæˆ–è€…æˆå‘˜å˜é‡_keyï¼Œå¹¶ä¸”ä¸ºå…¶èµ‹å€¼ // æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å¦å¤–å¤„ç†æˆå‘˜å˜é‡åç§°çš„â€œ_â€å‰ç¼€ id value = [self valueForKey:key]; [aCoder encodeObject:value forKey:key]; &#125;&#125;- (nullable instancetype)initWithCoder:(NSCoder *)aDecoder&#123; if (self = [super init]) &#123; unsigned int outCount = 0; Ivar *vars = class_copyIvarList([self class], &amp;outCount); for (int i = 0; i &lt; outCount; i ++) &#123; Ivar var = vars[i]; const char *name = ivar_getName(var); NSString *key = [NSString stringWithUTF8String:name]; id value = [aDecoder decodeObjectForKey:key]; [self setValue:value forKey:key]; &#125; &#125; return self;&#125;@end å®Œæ•´çš„è‡ªåŠ¨å½’æ¡£ä»£ç åœ¨è¿™é‡Œ 9ã€å­—å…¸ä¸Žæ¨¡åž‹äº’è½¬æœ€å¼€å§‹åšä¸»æ˜¯è¿™æ ·ç”¨å­—å…¸ç»™ Model èµ‹å€¼çš„ï¼š 1234567-(instancetype)initWithDictionary:(NSDictionary *)dict&#123; if (self = [super init]) &#123; self.age = dict[@&quot;age&quot;]; self.name = dict[@&quot;name&quot;]; &#125; return self;&#125; å¯æƒ³è€ŒçŸ¥ï¼Œé‡åˆ°çš„é—®é¢˜è·Ÿå½’æ¡£æ—¶å€™ä¸€æ ·ï¼ˆåŽæ¥ä½¿ç”¨MJExtensionï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ç¨å¾®æ¥å­¦ä¹ ä¸€ä¸‹å…¶ä¸­åŽŸç†ï¼Œå­—å…¸è½¬æ¨¡åž‹çš„æ—¶å€™ï¼š1.ï¿½æ ¹æ®å­—å…¸çš„ key ç”Ÿæˆ setter æ–¹æ³•.2.ä½¿ç”¨ objc_msgSend è°ƒç”¨ setter æ–¹æ³•ä¸º Model çš„å±žæ€§èµ‹å€¼ï¼ˆæˆ–è€… KVCï¼‰. æ¨¡åž‹è½¬å­—å…¸çš„æ—¶å€™ï¼šï¿½1.è°ƒç”¨ class_copyPropertyList æ–¹æ³•èŽ·å–å½“å‰ Model çš„æ‰€æœ‰å±žæ€§.2.è°ƒç”¨ property_getName èŽ·å–å±žæ€§åç§°.3.æ ¹æ®å±žæ€§åç§°ç”Ÿæˆ getter æ–¹æ³•.4.ä½¿ç”¨ objc_msgSend è°ƒç”¨ getter æ–¹æ³•èŽ·å–å±žæ€§å€¼ï¼ˆæˆ–è€… KVCï¼‰. ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263#import &quot;NSObject+KeyValues.h&quot;#import &lt;objc/runtime.h&gt;#import &lt;objc/message.h&gt;@implementation NSObject (KeyValues)//å­—å…¸è½¬æ¨¡åž‹+(id)objectWithKeyValues:(NSDictionary *)aDictionary&#123; id objc = [[self alloc] init]; for (NSString *key in aDictionary.allKeys) &#123; id value = aDictionary[key]; /*åˆ¤æ–­å½“å‰å±žæ€§æ˜¯ä¸æ˜¯Model*/ objc_property_t property = class_getProperty(self, key.UTF8String); unsigned int outCount = 0; objc_property_attribute_t *attributeList = property_copyAttributeList(property, &amp;outCount); objc_property_attribute_t attribute = attributeList[0]; NSString *typeString = [NSString stringWithUTF8String:attribute.value]; if ([typeString isEqualToString:@&quot;@\&quot;TestModel\&quot;&quot;]) &#123; value = [self objectWithKeyValues:value]; &#125; /**********************/ //ç”Ÿæˆsetteræ–¹æ³•ï¼Œå¹¶ç”¨objc_msgSendè°ƒç”¨ NSString *methodName = [NSString stringWithFormat:@&quot;set%@%@:&quot;,[key substringToIndex:1].uppercaseString,[key substringFromIndex:1]]; SEL setter = sel_registerName(methodName.UTF8String); if ([objc respondsToSelector:setter]) &#123; ((void (*) (id,SEL,id)) objc_msgSend) (objc,setter,value); &#125; &#125; return objc;&#125;//æ¨¡åž‹è½¬å­—å…¸-(NSDictionary *)keyValuesWithObject&#123; unsigned int outCount = 0; objc_property_t *propertyList = class_copyPropertyList([self class], &amp;outCount); NSMutableDictionary *dict = [NSMutableDictionary dictionary]; for (int i = 0; i &lt; outCount; i ++) &#123; objc_property_t property = propertyList[i]; //ç”Ÿæˆgetteræ–¹æ³•ï¼Œå¹¶ç”¨objc_msgSendè°ƒç”¨ const char *propertyName = property_getName(property); SEL getter = sel_registerName(propertyName); if ([self respondsToSelector:getter]) &#123; id value = ((id (*) (id,SEL)) objc_msgSend) (self,getter); /*åˆ¤æ–­å½“å‰å±žæ€§æ˜¯ä¸æ˜¯Model*/ if ([value isKindOfClass:[self class]] &amp;&amp; value) &#123; value = [value keyValuesWithObject]; &#125; /**********************/ if (value) &#123; NSString *key = [NSString stringWithUTF8String:propertyName]; [dict setObject:value forKey:key]; &#125; &#125; &#125; return dict;&#125;@end å®Œæ•´ä»£ç åœ¨è¿™é‡Œ 10ã€ï¿½åŠ¨æ€æ–¹æ³•è§£æžå‰é¢æˆ‘ä»¬ç•™ä¸‹äº†ä¸€ç‚¹ä¸œè¥¿æ²¡è¯´ï¼Œé‚£å°±æ˜¯å¦‚æžœæŸä¸ªå¯¹è±¡è°ƒç”¨äº†ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶ä¼šæ€Žä¹ˆæ ·ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç¨‹åºä¼šcrashï¼Œé”™è¯¯ä¿¡æ¯ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š 1unrecognized selector sent to instance 0x7fd0a141afd0 ä½†æ˜¯åœ¨ç¨‹åºcrashä¹‹å‰ï¼ŒRuntime ä¼šç»™æˆ‘ä»¬åŠ¨æ€æ–¹æ³•è§£æžçš„æœºä¼šï¼Œæ¶ˆæ¯å‘é€çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š 1.æ£€æµ‹è¿™ä¸ª selector æ˜¯ä¸æ˜¯è¦å¿½ç•¥çš„ã€‚æ¯”å¦‚ Mac OS X å¼€å‘ï¼Œæœ‰äº†åžƒåœ¾å›žæ”¶å°±ä¸ç†ä¼š retainï¼Œrelease è¿™äº›å‡½æ•°äº†. 2.æ£€æµ‹è¿™ä¸ª target æ˜¯ä¸æ˜¯ nil å¯¹è±¡ã€‚ObjC çš„ç‰¹æ€§æ˜¯å…è®¸å¯¹ä¸€ä¸ª nil å¯¹è±¡æ‰§è¡Œä»»ä½•ä¸€ä¸ªæ–¹æ³•ä¸ä¼š Crashï¼Œå› ä¸ºä¼šè¢«å¿½ç•¥æŽ‰. 3.å¦‚æžœä¸Šé¢ä¸¤ä¸ªéƒ½è¿‡äº†ï¼Œé‚£å°±å¼€å§‹æŸ¥æ‰¾è¿™ä¸ªç±»çš„ IMPï¼Œå…ˆä»Ž cache é‡Œé¢æ‰¾ï¼Œå®Œäº†æ‰¾å¾—åˆ°å°±è·³åˆ°å¯¹åº”çš„å‡½æ•°åŽ»æ‰§è¡Œ.å¦‚æžœ cache æ‰¾ä¸åˆ°å°±æ‰¾ä¸€ä¸‹æ–¹æ³•åˆ†å‘è¡¨. 4.å¦‚æžœåˆ†å‘è¡¨æ‰¾ä¸åˆ°å°±åˆ°è¶…ç±»çš„åˆ†å‘è¡¨åŽ»æ‰¾ï¼Œä¸€ç›´æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°NSObjectç±»ä¸ºæ­¢. è¿™é‡Œå†™å›¾ç‰‡æè¿° 1.è¿›å…¥ resolveInstanceMethod: æ–¹æ³•ï¼ŒæŒ‡å®šæ˜¯å¦åŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚è‹¥è¿”å›žNOï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œè‹¥è¿”å›žYESï¼Œåˆ™é€šè¿‡ class_addMethod å‡½æ•°åŠ¨æ€åœ°æ·»åŠ æ–¹æ³•ï¼Œæ¶ˆæ¯å¾—åˆ°å¤„ç†ï¼Œæ­¤æµç¨‹å®Œæ¯•. 2.resolveInstanceMethod: æ–¹æ³•è¿”å›ž NO æ—¶ï¼Œå°±ä¼šè¿›å…¥ forwardingTargetForSelector: æ–¹æ³•ï¼Œè¿™æ˜¯ Runtime ç»™æˆ‘ä»¬çš„ç¬¬äºŒæ¬¡æœºä¼šï¼Œç”¨äºŽæŒ‡å®šå“ªä¸ªå¯¹è±¡å“åº”è¿™ä¸ª selectorã€‚è¿”å›žnilï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼Œè¿”å›žæŸä¸ªå¯¹è±¡ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•. 3.è‹¥ forwardingTargetForSelector: è¿”å›žçš„æ˜¯nilï¼Œåˆ™æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡ methodSignatureForSelector: æ¥æŒ‡å®šæ–¹æ³•ç­¾åï¼Œè¿”å›žnilï¼Œè¡¨ç¤ºä¸å¤„ç†ï¼Œè‹¥è¿”å›žæ–¹æ³•ç­¾åï¼Œåˆ™ä¼šè¿›å…¥ä¸‹ä¸€æ­¥. 4å½“ç¬¬ methodSignatureForSelector: æ–¹æ³•è¿”å›žæ–¹æ³•ç­¾ååŽï¼Œå°±ä¼šè°ƒç”¨ forwardInvocation: æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ anInvocation å¯¹è±¡åšå¾ˆå¤šå¤„ç†ï¼Œæ¯”å¦‚ä¿®æ”¹å®žçŽ°æ–¹æ³•ï¼Œä¿®æ”¹å“åº”å¯¹è±¡ç­‰. å¦‚æžœåˆ°æœ€åŽï¼Œæ¶ˆæ¯è¿˜æ˜¯æ²¡æœ‰å¾—åˆ°å“åº”ï¼Œç¨‹åºå°±ä¼šcrashï¼Œè¯¦ç»†ä»£ç åœ¨è¿™é‡Œã€‚ Objective-C Runtime [è½¬è‡ª æˆ´å°¼çŽ›]ï¼ˆhttps://www.jianshu.com/p/efeb33712445ï¼‰]]></content>
      <categories>
        <category>runtime</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[RunTimeåº”ç”¨å®žä¾‹--å…³äºŽåŸ‹ç‚¹çš„æ€è€ƒ]]></title>
    <url>%2F2018%2F09%2F13%2FRunTime%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B-%E5%85%B3%E4%BA%8E%E5%9F%8B%E7%82%B9%E7%9A%84%E6%80%9D%E8%80%83%2F</url>
    <content type="text"><![CDATA[åŸ‹ç‚¹æ˜¯çŽ°åœ¨å¾ˆå¤šAppä¸­éƒ½éœ€è¦ç”¨åˆ°çš„ï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½æ¯ä¸ªäººéƒ½èƒ½å¤„ç†ï¼Œä½†æ˜¯æ€Žæ ·æ¥å‡å°‘åŸ‹ç‚¹æ‰€å¸¦æ¥çš„ä¾µå…¥æ€§ï¼Œæ€Žæ ·ç”¨æ›´åŠ ç®€æ´çš„æ–¹å¼æ¥å¤„ç†åŸ‹ç‚¹é—®é¢˜ï¼Œæ€Žæ ·å‡å°‘è¯¯åŸ‹ï¼Œå¦‚æžœä¸Šçº¿äº†å‘çŽ°å°‘åŸ‹äº†æ€Žä¹ˆåŠžï¼Ÿä¸‹é¢æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼ˆæœ¬æ–‡Demoå·²ä¸Šä¼ GitHubï¼Œå¯ä»¥ä¸‹è½½è®¨è®ºï¼‰: ä»€ä¹ˆæ˜¯åŸ‹ç‚¹ï¼ŸåŸ‹ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå…¶å®žåŸ‹ç‚¹ä¹Ÿå«æ—¥å¿—ä¸ŠæŠ¥ï¼Œå…¶å®žå°±æ˜¯æ ¹æ®éœ€æ±‚ä¸ŠæŠ¥ä¸€ç³»åˆ—å…³äºŽç”¨æˆ·è¡Œä¸ºçš„æ•°æ®ï¼Œæ¯”å¦‚ï¼šç”¨æˆ·ç‚¹å‡»äº†å“ªä¸ªæŒ‰é’®ï¼Œç”¨æˆ·æµè§ˆäº†å“ªä¸ªç½‘ç«™ï¼Œç”¨æˆ·åœ¨æŸä¸ªé¡µé¢åœç•™äº†å¤šä¹…ç­‰æ•°æ®ã€‚è¿™äº›æ•°æ®å¯¹äºŽè¿è¥æ¥è¯´å¾ˆæœ‰ç”¨ï¼Œä»–ä»¬å¯ä»¥ç”¨æ¥åˆ†æžæŸä¸ªåŠŸèƒ½å¼€å‘çš„æ˜¯ä¸æ˜¯åˆç†ï¼Œæ˜¯ä¸æ˜¯å› ä¸ºæŸä¸ªåœ°æ–¹çš„ä¸åˆç†è€Œåˆ°å¯¼è‡´äº†è½¬åŒ–çŽ‡çš„ä¸‹é™ï¼Œä»Žè€Œå¯¹æˆ‘ä»¬çš„Appè¿›è¡Œç›¸åº”çš„æ”¹è¿›ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æŸä¸ªç¬¬ä¸‰æ–¹å¹³å°æä¾›çš„åŸ‹ç‚¹å®žä¾‹ã€‚ åŸ‹ç‚¹ç»Ÿè®¡å­—æ®µå®šä¹‰ ä¸Šå›¾ä¸­è¯´æ˜Žäº†ï¼ŒæŸä¸ªæ—¶é—´å¯¹åº”çš„äº‹ä»¶ID,ä»¥åŠé’ˆå¯¹è¿™ä¸ªäº‹ä»¶éœ€è¦å…³è”çš„å­—æ®µã€‚ä¸‹é¢æ˜¯åŽå°ç³»ç»Ÿå¯¹æŸä¸ªåŸ‹ç‚¹æ‰€åšçš„æ•°æ®ç»Ÿè®¡:[å›¾ç‰‡ä¸Šä¼ å¤±è´¥â€¦(image-5a9faa-1512050850766)] åŽå°ç³»ç»Ÿå¯¹åŸ‹ç‚¹çš„æ•°æ®åˆ†æž è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¯¦ç»†çš„åˆ†æžå‡ºç”¨æˆ·å¯¹äºŽAppçš„åé¦ˆï¼Œä»Žè€ŒåŠæ—¶çš„ä¿®æ”¹æˆ‘ä»¬çš„äº§å“ã€‚ å¸¸è§„çš„åŸ‹ç‚¹çš„å¤„ç†æ–¹å¼æ˜¯æ€Žæ ·çš„?å…¶å®žå¾ˆç®€å•ï¼Œæˆ‘ä»¬å°±åœ¨ç›¸åº”çš„äº‹ä»¶é‡Œé¢åŠ å…¥ç›¸å…³çš„ä»£ç ï¼Œç»™æœåŠ¡å™¨ä¸ŠæŠ¥æ•°æ®ä¸å°±å¾—äº†ã€‚å¦‚ä¸‹æ‰€ç¤º: 123456789101112// è¿™ä¸ªä¸€ä¸ªæŒ‰é’®çš„å“åº”äº‹ä»¶ - (void)someButtonAction:(UIButton *)someButton&#123;// è¯¥æŒ‰é’®éœ€è¦å¤„ç†çš„ä¸šåŠ¡[self upDateSomthing]// å¼€å§‹åŸ‹ç‚¹// eid:äº‹ä»¶idï¼Œsa:ç”¨æˆ·id, cI:å½“å‰æ—¶é—´NSDictionary *upLoadDic = @&#123;@&quot;eid&quot;:@&quot;311&quot;,@&quot;sa&quot;:@&quot;706976487532177&quot;,@&quot;cI&quot;:@&quot;2016-6-4 12:11:34&quot;&#125;;[ZHUpLoadManager upLoadWithDic:upLoadDic];&#125; è¿™æ ·ä¸€ä¸ªåŸ‹ç‚¹é—®é¢˜å°±è§£å†³äº†ï¼Œå•åŒæ—¶å´éšè—ç€å¾ˆå¤šé—®é¢˜:1.è¿™æ ·æ¯ç‚¹å‡»ä¸€ä¸ªä¸€ä¸‹æŒ‰é’®å°±è¯·æ±‚ä¸€æ¬¡ç½‘ç»œä¼šä¸ä¼šå‡ºçŽ°æ€§èƒ½é—®é¢˜ï¼Ÿ2.å¦‚æžœè¿™æ ·é¢‘ç¹çš„æ•°æ®ä¸ŠæŠ¥ä¼šä¸ä¼šæ¶ˆè€—æ›´å¤šçš„ç”¨æˆ·æµé‡ï¼Ÿ3.è¿™æ ·çš„ä»£ç èƒ½ç»å—ä½éœ€æ±‚çš„å˜æ›´å—ï¼Ÿæ¯”å¦‚å­—æ®µå˜äº†ï¼Œæˆ–è€…ä½ æŠŠcIçœ‹é”™äº†ï¼Œåº”è¯¥æ˜¯clã€‚4.è¿™æ ·çš„ä»£ç ä¼šä¸ä¼šé€ æˆéš¾ä»¥æµ‹è¯•ï¼Ÿ5.è¿™æ ·çš„é¢‘ç¹ä¸ŠæŠ¥ä¼šä¸ä¼šå¢žåŠ æœåŠ¡å™¨ç«¯çš„åŽ‹åŠ›ï¼Ÿ6.ä»£ç æ•´æ´å—ï¼Ÿâ€¦â€¦(ç¨‹åºå‘˜çš„ä¸€ä¸ªå¥½ä¹ æƒ¯æ˜¯:è¿™ä¸ªä»£ç èƒ½å¦ç»å—ä½éœ€æ±‚çš„å˜æ›´ã€‚) æˆ‘ä»¬å¯ä»¥æ€Žæ ·ä¼˜åŒ–ï¼Ÿ é¦–å…ˆæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç±»ï¼Œæ¥ä¸“é—¨å¤„ç†è¿™äº›éœ€è¦ä¸ŠæŠ¥çš„åŸ‹ç‚¹çš„å­—æ®µï¼Œå°†è¿™äº›å­—æ®µä½œä¸ºå¸¸é‡,ä¾‹å¦‚: 123456789// LogManager.hextern NSString * const kLogEventKey; //äº‹ä»¶idextern NSString * const kLogUserIdKey; //ç”¨æˆ·idextern NSString * const kLogOperationInterval; //æ“ä½œæ—¶é—´// LogManager.mNSString * const kLogEventKey = @&quot;co&quot;; //äº‹ä»¶idNSString * const kLogUserIdKey = @&quot;sa&quot;; //ç”¨æˆ·idNSString * const kLogOperationInterval = @&quot;cq&quot;; //æ“ä½œæ—¶é—´ å¯¹äºŽç”¨æˆ·idï¼Œå½“å‰æ—¶é—´ï¼Œç”¨æˆ·æ‰‹æœºåž‹å·ï¼Œæ‰‹æœºå“ç‰Œï¼Œç­‰ç­‰ä¸Žç”¨æˆ·æ‰€åœ¨é¡µé¢æ— å…³çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ç»Ÿä¸€çš„ä¸€ä¸ªç±»è¿›è¡Œå¤„ç†ï¼Œå°†å…¶ä½œä¸ºè¿™ä¸ªç±»çš„ä¸€ä¸ªå±žæ€§ï¼Œä½¿ç”¨getteræ–¹æ³•å°†å…¶ç›¸åº”çš„æ•°å€¼è¿”å›žå³å¯(å¯¹äºŽæ’å®šä¸å˜çš„å¯ä»¥ä½¿ç”¨æ‡’åŠ è½½)ã€‚ è¿™æ ·çš„æ•°æ®ä¼ è¾“ç­–ç•¥æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½ä¸ŠæŠ¥ï¼Œå¯èƒ½ä¸€ä¸ªé¢éœ€è¦ä¸ŠæŠ¥çš„åœ°æ–¹å¾ˆå¤šï¼Œè¿™å°±ä¼šé€ æˆå¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†éœ€è¦ä¸Šä¼ çš„æ•°æ®ç¼“å­˜èµ·æ¥ï¼Œç„¶åŽç¼“å­˜å¤Ÿ50æ¡æ•°æ®ä¸ŠæŠ¥ä¸€æ¬¡ï¼Œæˆ–è€…æ¯éš”5åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡; ä¸ºäº†èŠ‚çœæµé‡æˆ‘ä»¬å¯ä»¥ï¼Œ1ï¼‰å°†æ•°æ®åŽ‹ç¼©ä¹‹åŽå†ä¸ŠæŠ¥,å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼›2ï¼‰å’ŒæœåŠ¡ç«¯å•†é‡ï¼Œç”¨å°½å¯èƒ½çŸ­çš„å­—æ®µï¼Œå¦‚:cityName = @&quot;åŒ—äº¬&quot;;å˜ä¸ºcn = @&quot;åŒ—äº¬&quot;;3)å°½é‡ä¸è¦ä¸Šä¼ çš„é¢‘çŽ‡è¿‡é«˜ï¼Œå¦‚ç¬¬ä¸‰ç‚¹ã€‚ å¦‚ä½•è§£å†³ä»£ç çš„æ•´æ´ï¼Œæ˜“äºŽæµ‹è¯•çš„é—®é¢˜ï¼Ÿè¯·çœ‹ä¸‹é¢ã€‚ æ€Žæ ·ä½¿ç”¨RunTimeæ¥è¿›è¡Œä¼˜åŒ–ï¼Ÿæˆ‘ä¹ˆèƒ½ä¸èƒ½åˆ©ç”¨RunTimeæ¥ç»™æ¯ä¸€ä¸ªButtonçš„å“åº”äº‹ä»¶ä¸­æ·»åŠ ä¸€æ®µä»£ç ï¼Œåˆ©ç”¨è¿™æ®µä»£ç æ¥è¿›è¡ŒåŸ‹ç‚¹ä¸ŠæŠ¥å‘¢ï¼Ÿæˆ–è€…è¿›ä¸€æ­¥æ¥è¯´æˆ‘ä»¬èƒ½ä¸èƒ½ç»™æ‰€æœ‰ç»§æ‰¿è‡ªUIControlçš„å¯¹è±¡éƒ½æ·»åŠ è¿™æ ·ä¸€æ®µä»£ç å‘¢ï¼Ÿè¿™æ ·æˆ‘ä»¬ä¸æ˜¯å¯ä»¥æ•èŽ·æ‰€æœ‰çš„ç”¨æˆ·äº‹ä»¶äº†å—ï¼Ÿ(å…¶å®žç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œçœ‹ç¬¬äº”æ¡);è¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Mehod Swizzle,æˆ–è€…å«æ–¹æ³•æ³¨å…¥,æˆ–è€…å«hookä½äº†æŸä¸ªæ–¹æ³•ï¼Œå¬ç€æŒºçŽ„ä¹Žï¼Œå…¶å®žå°±æ˜¯RunTimeçš„ä¸€ä¸ªAPI,è¿™ä¸ªAPIèƒ½å¤Ÿäº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®žçŽ°ã€‚é€šè¿‡è¿™ä¸ªAPI,æˆ‘ä»¬å¯ä»¥è¿™æ ·å®žçŽ°æ–¹æ³•æ³¨å…¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º: æ–¹æ³•æ³¨å…¥çš„å®žçŽ°è¿‡ç¨‹ 1- (void)sendAction:(SEL)action to:(nullable id)target forEvent:(nullable UIEvent *)event; è¿™ä¸ªæ–¹æ³•é‡Œé¢åµŒå…¥ç›¸åº”çš„ä»£ç ç‰‡æ®µã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·:1.å°†äº’æ¢æ–¹æ³•å®žçŽ°çš„çš„è¿™ä¸ªæ–¹æ³•æ”¾åˆ°ä¸€ä¸ªå·¥å…·ç±»ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¸æ­¢ä¸€å¤„è¦ç”¨åˆ°è¿™ç§æ–¹æ³•ã€‚2.æˆ‘ä»¬ç»™UIControlæ·»åŠ ä¸€ä¸ªCategory,ç„¶åŽåœ¨é‡Œé¢è°ƒç”¨è¿™ä¸ªå·¥å…·ç±»ç„¶åŽå®žçŽ°æ‰€æ’å…¥çš„ä»£ç ç‰‡æ®µã€‚è¿™é‡Œæˆ‘ä»¬æ—¢ç„¶å¯ä»¥å¾—åˆ°targetè¿˜æœ‰action,é‚£ä¹ˆå¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥å”¯ä¸€ç¡®å®šè¿™ä¸ªåŸ‹ç‚¹äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€Žæ ·ä»Žè¿™ä¹ˆå¤šçš„åŸ‹ç‚¹ä¸­é€‰å‡ºè¿™ä¸ªè¿™ä¸ªåŸ‹ç‚¹å‘¢ï¼Ÿæˆ‘ä»¬å…¶å®žå¯ä»¥ç”¨å­—å…¸å’Œæ•°ç»„ç»“åˆçš„æ–¹å¼å°†è¿™äº›æ–¹æ³•çš„targetå’Œæ–¹æ³•çš„å‚æ•°ä¸€ä¸€å­˜èµ·æ¥ï¼Œç„¶åŽåœ¨åµŒå…¥çš„æ–¹æ³•å†…éƒ¨èŽ·å–å…¶å¯¹åº”çš„æ–¹æ³•ï¼Œä»¥åŠå…¶ç›¸åº”çš„ï¼Œè¿™ä¸ªäº‹å…ˆé…ç½®å¥½çš„å­—å…¸å’Œæ•°ç»„çš„ç»“åˆæ”¾åœ¨å“ªé‡Œæ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿplistã€‚ä¸‹é¢å°±ä»¥æœ€ç®€å•çš„å½¢å¼å±•ç¤ºè¿™ç§æ€è·¯: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586 // å·¥å…·ç±» @interface ZHSwizzleTool : NSObject + (void)zhSwizzleWithClass:(Class)processedClass originalSelector:(SEL)originSelector swizzleSelector:(SEL)swizzlSelector; @end @implementation ZHSwizzleTool +(void)zhSwizzleWithClass:(Class)processedClass originalSelector:(SEL)originSelector swizzleSelector:(SEL)swizzlSelector&#123;Method originMethod = class_getInstanceMethod(processedClass, originSelector);Method swizzleMethod = class_getInstanceMethod(processedClass, swizzlSelector);BOOL didAddMethod = class_addMethod(processedClass, originSelector, method_getImplementation(swizzleMethod), method_getTypeEncoding(swizzleMethod));if (didAddMethod) &#123; class_replaceMethod(processedClass, swizzlSelector, method_getImplementation(originMethod), method_getTypeEncoding(originMethod)); &#125;else&#123; method_exchangeImplementations(originMethod, swizzleMethod); &#125;&#125;@end // åˆ†ç±»@implementation UIControl (ZHSwizzle)+(void)load&#123;static dispatch_once_t onceToken;dispatch_once(&amp;onceToken, ^&#123; SEL originSEL = @selector(sendAction:to:forEvent:); SEL swizzleSEL = @selector(sendSwizzleAction:to:forEvent:); [ZHSwizzleTool zhSwizzleWithClass:[self class]originalSelector:originSEL swizzleSelector:swizzleSEL]; &#125;);&#125; - (void)sendSwizzleAction:(SEL)action to:(id)target forEvent:(UIEvent *)event&#123;// æ³¨æ„è¿™é‡Œè°ƒç”¨çš„æ˜¯åŽŸæ¥çš„ç³»ç»Ÿæ–¹æ³•[self sendSwizzleAction:action to:target forEvent:event];NSString *selectorName = NSStringFromSelector(action);// è¿™ä¸ªplistä¸­å­˜å‚¨çš„æ•°æ®æ ¼å¼æ˜¯è¿™æ ·çš„:@&#123;@&quot;someViewController&quot;:@&quot;selector0&quot;:@[para0,para1,para2],@&quot;selector1&quot;:@[para0,para1]]&#125;;NSString *pathString = [[NSBundle mainBundle]pathForResource:@&quot;ZHLogInfo&quot; ofType:@&quot;plist&quot;];NSDictionary *plistDic = [NSDictionary dictionaryWithContentsOfFile:pathString];//1. èŽ·å–Targetçš„åå­—NSDictionary *controllerDic = plistDic[NSStringFromClass([target class])];//2. èŽ·å–è¿™ä¸ªæ–¹æ³•å¯¹åº”çš„å‚æ•°åˆ—è¡¨NSArray *parameterArray = controllerDic[selectorName];//3. å®žä¾‹åŒ–æ•°æ®ä¸­å¿ƒZHLogDataCenter *logCenter = [[ZHLogDataCenter alloc]init];NSMutableDictionary *logInfoDic = [NSMutableDictionary dictionary];for (NSString *parameter in parameterArray) &#123; NSString *getSelector = [NSString stringWithFormat:@&quot;%@&quot;,parameter]; SEL getSeletor = NSSelectorFromString(getSelector); //4. ä»Žæ•°æ®ä¸­å¿ƒä¸­èŽ·å–ç›¸åº”çš„æ•°æ® id value = [logCenter performSelector:getSeletor withObject:nil]; //5.èŽ·å–æˆåŠŸåˆ™å°†å…¶å­˜å…¥éœ€è¦ä¸Šä¼ çš„å­—å…¸ if (value) [logInfoDic setObject:value forKey:parameter]; &#125; //6.å°†è¿™ä¸ªå­—å…¸å­˜å…¥åŸ‹ç‚¹ç®¡ç†ç±»ï¼Œå…¶ä¼šå°†å…¶å­˜å…¥ç¼“å­˜å¹¶ç­‰å¾…ä¸Šä¼ [ZHLogCenter zhLogWithInforDictionary:logInfoDic];&#125;@end ä¸‹é¢æ˜¯è¿™ä¸ªä»£ç ä¸­ç”¨åˆ°çš„Plistä¸­çš„é…ç½®: åŸ‹ç‚¹ç›¸å…³å­—æ®µçš„plisté…ç½® åœ¨å®žè·µä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Ÿ å¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹ä»¶éƒ½æ˜¯æœ‰ç»§æ‰¿è‡ªUIControlçš„æŽ§ä»¶æ¥å‘å‡ºçš„ï¼Œæ¯”å¦‚ï¼šæ‰‹åŠ¿ï¼Œç‚¹å‡»Cellã€‚ å¹¶ä¸æ˜¯æ‰€æœ‰çš„æŒ‰é’®ç‚¹å‡»äº†ä¹‹åŽå°±ç«‹é©¬éœ€è¦åŸ‹ç‚¹ä¸Šä¼ ï¼Ÿå¯èƒ½åœ¨æŒ‰é’®çš„å“åº”æ–¹æ³•ä¸­ç»è¿‡äº†å±‚å±‚çš„if(){ } else{ }æœ€åŽæ‰éœ€è¦åŸ‹ç‚¹ã€‚ å’Œäº‹ä»¶æ‰€åœ¨ç±»æ— å…³çš„åŸ‹ç‚¹æ•°æ®å¯ä»¥åŒæ„ä»ŽZHLogDataCenterè¿™ä¸ªç±»ä¸­ä¸­å–ï¼Œé‚£ä¹ˆå¦‚æžœè¿™ä¸ªæ•°æ®æ˜¯å’Œæ‰€åœ¨ç±»æœ‰å…³å‘¢ï¼Ÿ å¯¹äºŽä»£ç†æ–¹æ³•è¯¥æ€Žæ ·å¤„ç†ï¼Ÿ å¦‚æžœå¾ˆå¤šä¸ªæŒ‰é’®å¯¹åº”ç€ä¸€ä¸ªäº‹ä»¶è¯¥æ€Žæ ·å¤„ç†ï¼Ÿ é¡¹ç›®ä¸­äº‹ä»¶çš„å¤„ç†æ–¹æ³•ä¸å°½ç›¸åŒï¼Œæ–¹æ³•çš„å‚æ•°ä¸ªæ•°ä¸ä¸€æ ·ï¼Œå¹¶ä¸”æ–¹æ³•çš„è¿”å›žå€¼ä¹Ÿä¸ä¸€æ ·ï¼Œå¦‚ä½•å¯¹ä»–ä»¬è¿›è¡Œç»Ÿä¸€çš„å¤„ç†?ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€è§£å†³è¿™äº›é—®é¢˜ã€‚ é—®é¢˜1ï¼šå¯¹äºŽä¸æ˜¯æ¥è‡ªUIControlçš„å­ç±»å‘å‡ºçš„äº‹ä»¶ï¼Œæˆ‘ä»¬ä¸€æ ·æ˜¯å¯ä»¥è¿›è¡ŒhooKï¼Œåªä¸è¿‡æ–¹æ³•æœ‰æ‰€ä¸åŒã€‚æˆ‘ä»¬åœ¨UIControlçš„åˆ†ç±»ä¸­å†™äº†ä¸€æ®µåµŒå…¥çš„ä»£ç ï¼Œç¡®å®žhookä½äº†ç³»ç»ŸUIButtonçš„ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¯å› ä¸ºUIButtonè‡ªèº«ä¼šè°ƒç”¨UIControlçš„è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯å¯¹äºŽç‚¹å‡»äº‹ä»¶ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„çˆ¶ç±»UIViewControllerä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œæˆ‘ä»¬è‡ªå·±ç‚¹å‡»äº‹ä»¶çš„æ–¹æ³•æ—¶UIViewControlleråˆ†ç±»ä¸­è¦åµŒå…¥çš„æ–¹æ³•æ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ï¼Œè¿™æ—¶å€™æ€Žä¹ˆåŠžï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„ç»™æˆ‘ä»¬è‡ªå·±è¦hookçš„ViewControlleråŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åŽå°±å¯ä»¥hookäº†ï¼ˆè¿™ä¸€ç‚¹ä¸å¤ªå¥½ç†è§£ï¼‰ã€‚å…·ä½“çš„æ·»åŠ æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒæœ¬æ–‡çš„å®žä¾‹ä»£ç ã€‚ é—®é¢˜2ï¼šå¯¹äºŽæ˜¯å¦ä¸Šä¼ å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ–¹æ³•æ‰€åœ¨ç±»çš„ä¸€ä¸ªå±žæ€§å€¼è¿›è¡Œæ ‡è®°ï¼Œè¿™ä¸ªå±žæ€§å†™åœ¨.mæ–‡ä»¶ä¸­å³å¯(KVCå¯ä»¥èŽ·å–.mæ–‡ä»¶ä¸­çš„å±žæ€§å€¼ã€‚)ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œè¦hooké‚£ä¸ªç±»çš„æ–¹æ³•ï¼Œç„¶åŽæ ¹æ®plistä¸­é…ç½®çš„ç›¸å…³æ ‡è®°è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼ˆè¿™é‡Œçš„å±žæ€§å€¼å…¶å®žä¹Ÿæ˜¯ä¸å¿…è¦çš„ï¼Œæˆ‘ä¹ˆå¯ä»¥æ ¹æ®ç±»åå’Œæ–¹æ³•åå­—ç¬¦ä¸²çš„å“ˆå¸Œç”Ÿæˆå”¯ä¸€çš„keyï¼Œç„¶åŽåˆ©ç”¨runtimeè‡ªåŠ¨å…³è”åˆ°è¿™ä¸ªç±»çš„mf_conditionå±žæ€§ä¸Šï¼Œè¿™ä¸ªå±žæ€§æ˜¯ä¸€ä¸ªå­—å…¸å…¶keyå°±æ˜¯åˆšæ‰ç”Ÿæˆçš„ï¼Œvalueå°±æ˜¯è¿è¡Œå®Œè¿™ä¸ªæ–¹æ³•ä¹‹åŽå¾—åˆ°çš„å€¼ï¼Œç„¶åŽè¿™ä¸ªå€¼å†è·Ÿplistä¸­çš„é…ç½®åšä»¥æ¯”è¾ƒï¼‰ã€‚ é—®é¢˜3ï¼šå¯¹äºŽå’Œäº‹ä»¶æ‰€åœ¨ç±»æœ‰ç´§å¯†å…³è”çš„åŸ‹ç‚¹æ•°æ®ï¼Œæ¯”å¦‚æŸä¸ªé¡µé¢å¯¹åº”çš„äº§å“ID,æ¯”å¦‚æŸä¸ªé¡µé¢ç‚¹å‡»äº†cellï¼Œä¹‹åŽè¿™ä¸ªcellå¯¹åº”çš„modelçš„IDã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å‚è€ƒæ–¹æ³•2ï¼Œæ·»åŠ ä¸€ä¸ªå±žæ€§ï¼Œç”¨ä¸€ä¸ªå±žæ€§å€¼æ¥å­˜å‚¨è¿™äº›è¿™äº›éœ€è¦ä¸Šä¼ çš„å…·ä½“æ•°æ®ã€‚ é—®é¢˜4ï¼šä»£ç†æ–¹æ³•å’Œæ‰‹åŠ¿çš„å¤„ç†ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ—¢ç„¶ä¸€ä¸ªç±»å®žçŽ°äº†æŸä¸ªä»£ç†æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶[someInstance respondsToSelector:someSelector]æ‰€è¿”å›žçš„BOOLå€¼åº”è¯¥æ˜¯YESçš„ï¼Œç„¶åŽå…¶å®ƒçš„å°±å’Œæ‰‹åŠ¿çš„å¤„ç†æ˜¯ä¸€æ ·çš„äº†ã€‚ é—®é¢˜5ï¼šå¯¹äºŽå¾ˆå¤šæŒ‰é’®å¯¹åº”ä¸€ä¸ªå“åº”äº‹ä»¶çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨RunTimeåŠ¨æ€çš„ç»™æŒ‰é’®æ·»åŠ ä¸€ä¸ªå±žæ€§ï¼Œæ¯”å¦‚:buttonIdentifier,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨plistä¸­è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥è¿›è¡Œç›¸åº”çš„åŸ‹ç‚¹å¤„ç†ã€‚ é—®é¢˜6ï¼šè¿™ä¸ªé—®é¢˜å…¶å®žå°±æ˜¯hookä½æ‰€æœ‰çš„æ–¹æ³•ï¼Œç„¶åŽç»™ä»–ä»¬æ·»åŠ åŒä¸€ä¸ªä»£ç æ®µçš„é—®é¢˜ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Aspectsè¿™ä¸ªç¬¬ä¸‰æ–¹æ¡†æž¶ï¼š 123456+ (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector withOptions:(AspectOptions)options usingBlock:(id)block error:(NSError **)error &#123;return aspect_add((id)self, selector, options, block, error); &#125; è°ƒç”¨è¿™ä¸ªæŽ¥å£ï¼Œå› ä¸ºåœ¨UIViewControllerçš„åˆ†ç±»ä¸­è°ƒç”¨è¿™ä¸ªæŽ¥å£çš„å¯¹è±¡ä¸ä¸€æ ·ï¼Œå¹¶ä¸”æˆ‘ä»¬æ ¹æ®plistä¸­çš„é…ç½®hookçš„selectorä¸ä¸€æ ·ï¼Œç„¶è€Œæœ€åŽæ‰§è¡Œçš„blockå´æ˜¯ä¸€æ ·çš„ï¼Œè¿™å°±å¾ˆå¥½çš„è§£å†³äº†é—®é¢˜ã€‚ æœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿæœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯åŠ¨æ€çš„ï¼Œå°±æ˜¯PMç»™æˆ‘ä»¬è¯´éœ€è¦å“ªäº›åŸ‹ç‚¹ï¼Œç„¶åŽæœåŠ¡å™¨ç»™æˆ‘ä»¬å‘ä¸€ä¸ªç±»ä¼¼ä¸Žä¸Šæ–‡ä¸­æåˆ°çš„plistä¸€æ ·çš„æ–‡ä»¶ï¼Œæˆ–è€…ä¸€ä¸ªjson,æˆ‘ä»¬å­˜åˆ°æœ¬åœ°ï¼Œå¦‚æžœè¿™äº›åŸ‹ç‚¹æ²¡æœ‰æ›´æ–°ï¼Œæˆ‘ä»¬å°±ä»Žæœ¬åœ°ä¸­è¯»å–ç›¸åº”çš„æ–‡ä»¶ï¼Œåšç›¸åº”çš„åŸ‹ç‚¹ï¼Œå¦‚æžœæœ‰æ›´æ–°ï¼Œæˆ‘ä»¬é‡æ–°ä»ŽæœåŠ¡å™¨èŽ·å–æœ€æ–°çš„éœ€è¦åŸ‹çš„ç‚¹ï¼Œç„¶åŽè¿›è¡Œç›¸åº”åŸ‹ç‚¹ã€‚è¿™æ ·å°±è§£å†³äº†å°‘åŸ‹ï¼Œæˆ–è€…åŸ‹ç‚¹ä¸æ°å½“ï¼Œéœ€è¦æ·»åŠ åŸ‹ç‚¹çš„é—®é¢˜ã€‚ å…¶ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿå½“ç„¶è¿™é‡Œé¢ä¹Ÿæœ‰å…¶éš¾ä»¥å¤„ç†çš„é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹æŽ§ä»¶ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹æŽ§ä»¶çš„äº‹ä»¶å›žè°ƒä¸æ˜¯ç”¨delegateå®žçŽ°çš„ï¼Œè€Œæ˜¯ç”¨blockå®žçŽ°çš„ï¼Œå¹¶ä¸”è¿™ä¸ªåŸ‹ç‚¹å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘æœ‰å…³ç³»ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•å°±éš¾ä»¥å¤„ç†äº†ã€‚ å¦‚æžœå¾ˆå¤šäº‹ä»¶çš„é€»è¾‘å¤„ç†æ”¾åˆ°äº†blockä¸­è¿›è¡Œï¼Œé‚£ä¹ˆä¹Ÿå°†é€ éš¾ä»¥å¤„ç†ã€‚ [è½¬è‡ª å‡»æ°´æ¹˜æ±Ÿ]]]></content>
      <categories>
        <category>runtime</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[Objective-C isa æŒ‡é’ˆ ä¸Ž runtime æœºåˆ¶]]></title>
    <url>%2F2018%2F09%2F13%2FObjective-C-isa-%E6%8C%87%E9%92%88-%E4%B8%8E-runtime-%E6%9C%BA%E5%88%B6%2F</url>
    <content type="text"><![CDATA[ä¸€.isaæŒ‡é’ˆè¦è®¤è¯†ä»€ä¹ˆæ˜¯isaæŒ‡é’ˆï¼Œæˆ‘ä»¬å¾—å…ˆæ˜Žç¡®ä¸€ç‚¹ï¼š åœ¨Objective-Cä¸­ï¼Œä»»ä½•ç±»çš„å®šä¹‰éƒ½æ˜¯å¯¹è±¡ã€‚ç±»å’Œç±»çš„å®žä¾‹ï¼ˆå¯¹è±¡ï¼‰æ²¡æœ‰ä»»ä½•æœ¬è´¨ä¸Šçš„åŒºåˆ«ã€‚ä»»ä½•å¯¹è±¡éƒ½æœ‰isaæŒ‡é’ˆã€‚ é‚£ä¹ˆä»€ä¹ˆæ˜¯ç±»å‘¢ï¼Ÿåœ¨xcodeä¸­ç”¨å¿«æ·é”®Shiftï¼‹Cmdï¼‹O æ‰“å¼€æ–‡ä»¶objc.h èƒ½çœ‹åˆ°ç±»çš„å®šä¹‰ï¼š å¯ä»¥çœ‹å‡º: Class æ˜¯ä¸€ä¸ª objc_class ç»“æž„ç±»åž‹çš„æŒ‡é’ˆ, idæ˜¯ä¸€ä¸ª objc_object ç»“æž„ç±»åž‹çš„æŒ‡é’ˆ. æˆ‘ä»¬å†æ¥çœ‹çœ‹ objc_class çš„å®šä¹‰ï¼š ç¨å¾®è§£é‡Šä¸€ä¸‹å„ä¸ªå‚æ•°çš„æ„æ€ï¼š isaï¼šæ˜¯ä¸€ä¸ªClass ç±»åž‹çš„æŒ‡é’ˆ. æ¯ä¸ªå®žä¾‹å¯¹è±¡æœ‰ä¸ªisaçš„æŒ‡é’ˆ,ä»–æŒ‡å‘å¯¹è±¡çš„ç±»ï¼Œè€ŒClassé‡Œä¹Ÿæœ‰ä¸ªisaçš„æŒ‡é’ˆ, æŒ‡å‘meteClass(å…ƒç±»)ã€‚å…ƒç±»ä¿å­˜äº†ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚å½“ç±»æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå…ˆä¼šä»Žæœ¬èº«æŸ¥æ‰¾ç±»æ–¹æ³•çš„å®žçŽ°ï¼Œå¦‚æžœæ²¡æœ‰ï¼Œå…ƒç±»ä¼šå‘ä»–çˆ¶ç±»æŸ¥æ‰¾è¯¥æ–¹æ³•ã€‚åŒæ—¶æ³¨æ„çš„æ˜¯ï¼šå…ƒç±»ï¼ˆmeteClassï¼‰ä¹Ÿæ˜¯ç±»ï¼Œå®ƒä¹Ÿæ˜¯å¯¹è±¡ã€‚å…ƒç±»ä¹Ÿæœ‰isaæŒ‡é’ˆ,å®ƒçš„isaæŒ‡é’ˆæœ€ç»ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ ¹å…ƒç±»(root meteClass).æ ¹å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘æœ¬èº«ï¼Œè¿™æ ·å½¢æˆäº†ä¸€ä¸ªå°é—­çš„å†…å¾ªçŽ¯ã€‚ super_classï¼šçˆ¶ç±»ï¼Œå¦‚æžœè¯¥ç±»å·²ç»æ˜¯æœ€é¡¶å±‚çš„æ ¹ç±»,é‚£ä¹ˆå®ƒä¸ºNULLã€‚ versionï¼šç±»çš„ç‰ˆæœ¬ä¿¡æ¯,é»˜è®¤ä¸º0 infoï¼šä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†ã€‚ instance_sizeï¼šè¯¥ç±»çš„å®žä¾‹å˜é‡å¤§å° ivarsï¼šæˆå‘˜å˜é‡çš„æ•°ç»„ å†æ¥çœ‹çœ‹å„ä¸ªç±»å®žä¾‹å˜é‡çš„ç»§æ‰¿å…³ç³»ï¼š æ¯ä¸€ä¸ªå¯¹è±¡æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªç±»çš„å®žä¾‹ã€‚å…¶ä¸­ç±»å®šä¹‰äº†æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•çš„åˆ—è¡¨ã€‚å¯¹è±¡é€šè¿‡å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘ç±»ã€‚ æ¯ä¸€ä¸ªç±»æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç±»å…¶å®žæ˜¯å…ƒç±»ï¼ˆmeteClassï¼‰çš„å®žä¾‹ã€‚å…ƒç±»å®šä¹‰äº†ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚ç±»é€šè¿‡ç±»çš„isaæŒ‡é’ˆæŒ‡å‘å…ƒç±»ã€‚ æ‰€æœ‰çš„å…ƒç±»æœ€ç»ˆç»§æ‰¿ä¸€ä¸ªæ ¹å…ƒç±»ï¼Œæ ¹å…ƒç±»isaæŒ‡é’ˆæŒ‡å‘æœ¬èº«ï¼Œå½¢æˆä¸€ä¸ªå°é—­çš„å†…å¾ªçŽ¯ã€‚ äºŒ.runtime æœºåˆ¶runtimeï¼šæŒ‡ä¸€ä¸ªç¨‹åºåœ¨è¿è¡Œï¼ˆæˆ–è€…åœ¨è¢«æ‰§è¡Œï¼‰çš„çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ æ‰“å¼€ä¸€ä¸ªç¨‹åºä½¿å®ƒåœ¨ç”µè„‘ä¸Šè¿è¡Œçš„æ—¶å€™ï¼Œé‚£ä¸ªç¨‹åºå°±æ˜¯å¤„äºŽè¿è¡Œæ—¶åˆ»ã€‚åœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒæŠŠæŸäº›å¯ä»¥é‡ç”¨çš„ç¨‹åºæˆ–è€…å®žä¾‹æ‰“åŒ…æˆ–è€…é‡å»ºæˆä¸ºâ€œè¿è¡Œåº“â€ã€‚è¿™äº›å®žä¾‹å¯ä»¥åœ¨å®ƒä»¬è¿è¡Œçš„æ—¶å€™è¢«è¿žæŽ¥æˆ–è€…è¢«ä»»ä½•ç¨‹åºè°ƒç”¨ã€‚ objective-cä¸­runtimeï¼šæ˜¯ä¸€å¥—æ¯”è¾ƒåº•å±‚çš„çº¯Cè¯­è¨€API, å±žäºŽ1ä¸ªCè¯­è¨€åº“, åŒ…å«äº†å¾ˆå¤šåº•å±‚çš„Cè¯­è¨€APIã€‚ åœ¨æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„OCä»£ç ä¸­, ç¨‹åºè¿è¡Œè¿‡ç¨‹æ—¶, å…¶å®žæœ€ç»ˆéƒ½æ˜¯è½¬æˆäº†runtimeçš„Cè¯­è¨€ä»£ç ã€‚ runtimeçš„åº”ç”¨ï¼š 1.åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»(æ¯”å¦‚KVOçš„åº•å±‚å®žçŽ°) 2.åŠ¨æ€åœ°ä¸ºæŸä¸ªç±»æ·»åŠ å±žæ€§\æ–¹æ³•, ä¿®æ”¹å±žæ€§å€¼\æ–¹æ³• 3.éåŽ†ä¸€ä¸ªç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡(å±žæ€§)\æ‰€æœ‰æ–¹æ³• å®žè´¨ä¸Šï¼Œä»¥ä¸Šçš„æ˜¯é€šè¿‡ç›¸å…³æ–¹æ³•æ¥èŽ·å–å¯¹è±¡æˆ–è€…ç±»çš„isaæŒ‡é’ˆæ¥å®žçŽ°çš„ã€‚ ç›¸å…³å‡½æ•° å¢žåŠ  å¢žåŠ å‡½æ•°:class_addMethod å¢žåŠ å®žä¾‹å˜é‡:class_addIvar å¢žåŠ å±žæ€§:@dynamicæ ‡ç­¾ï¼Œæˆ–è€…class_addMethodï¼Œå› ä¸ºå±žæ€§å…¶å®žå°±æ˜¯ç”±getterå’Œsetterå‡½æ•°ç»„æˆ å¢žåŠ Protocol:classaddProtocol (è¯´å®žè¯æˆ‘çœŸä¸çŸ¥é“åŠ¨æ€å¢žåŠ ä¸€ä¸ªprotocolæœ‰ä»€ä¹ˆç”¨,--!!) èŽ·å– èŽ·å–å‡½æ•°åˆ—è¡¨åŠæ¯ä¸ªå‡½æ•°çš„ä¿¡æ¯(å‡½æ•°æŒ‡é’ˆã€å‡½æ•°åç­‰ç­‰):class_getClassMethod method_getName â€¦ èŽ·å–å±žæ€§åˆ—è¡¨åŠæ¯ä¸ªå±žæ€§çš„ä¿¡æ¯:class_copyPropertyList property_getName èŽ·å–ç±»æœ¬èº«çš„ä¿¡æ¯,å¦‚ç±»åç­‰ï¼šclass_getName class_getInstanceSize èŽ·å–å˜é‡åˆ—è¡¨åŠå˜é‡ä¿¡æ¯ï¼šclass_copyIvarList èŽ·å–å˜é‡çš„å€¼ æ›¿æ¢ å°†å®žä¾‹æ›¿æ¢æˆå¦ä¸€ä¸ªç±»ï¼šobject_setClass æ›¿æ¢ç±»æ–¹æ³•çš„å®šä¹‰ï¼šclass_replaceMethod 4.å…¶ä»–å¸¸ç”¨æ–¹æ³•ï¼š äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®žçŽ°ï¼šmethod_exchangeImplementations. è®¾ç½®ä¸€ä¸ªæ–¹æ³•çš„å®žçŽ°ï¼šmethod_setImplementation. [è½¬è‡ª æ›²å¹´]]]></content>
      <categories>
        <category>runtime</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[Objective-C-æ¶ˆæ¯å‘é€ä¸Žè½¬å‘æœºåˆ¶åŽŸç†]]></title>
    <url>%2F2018%2F09%2F13%2FObjective-C-%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E4%B8%8E%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%2F</url>
    <content type="text"><![CDATA[æ¶ˆæ¯å‘é€å’Œè½¬å‘æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šæ¶ˆæ¯å‘é€ï¼ˆMessagingï¼‰æ˜¯ Runtime é€šè¿‡ selector å¿«é€ŸæŸ¥æ‰¾ IMP çš„è¿‡ç¨‹ï¼Œæœ‰äº†å‡½æ•°æŒ‡é’ˆå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å®žçŽ°ï¼›æ¶ˆæ¯è½¬å‘ï¼ˆMessage Forwardingï¼‰æ˜¯åœ¨æŸ¥æ‰¾ IMP å¤±è´¥åŽæ‰§è¡Œä¸€ç³»åˆ—è½¬å‘æµç¨‹çš„æ…¢é€Ÿé€šé“ï¼Œå¦‚æžœä¸ä½œè½¬å‘å¤„ç†ï¼Œåˆ™ä¼šæ‰“æ—¥å¿—å’ŒæŠ›å‡ºå¼‚å¸¸ã€‚ æœ¬æ–‡ä¸è®²è¿°å¼€å‘è€…åœ¨æ¶ˆæ¯å‘é€å’Œè½¬å‘æµç¨‹ä¸­éœ€è¦åšçš„äº‹ï¼Œè€Œæ˜¯è®²è¿°åŽŸç†ã€‚èƒ½å¤Ÿå¾ˆå¥½åœ°é˜…è¯»æœ¬æ–‡çš„å‰ææ˜¯ä½ å¯¹ Objective-C Runtime å·²ç»æœ‰ä¸€å®šçš„äº†è§£ï¼Œå…³äºŽä»€ä¹ˆæ˜¯æ¶ˆæ¯ï¼ŒClass çš„ç»“æž„ï¼Œselectorã€IMPã€å…ƒç±»ç­‰æ¦‚å¿µå°†ä¸å†èµ˜è¿°ã€‚æœ¬æ–‡ç”¨åˆ°çš„æºç ä¸º objc4-680 å’Œ CF-1153.18ï¼Œé€†å‘ CoreFoundation.framework çš„ç³»ç»Ÿç‰ˆæœ¬ä¸º macOS 10.11.5ï¼Œæ±‡ç¼–è¯­è¨€æž¶æž„ä¸º x86_64ã€‚ å…«é¢çŽ²ç‘çš„ objc_msgSendæ­¤å‡½æ•°æ˜¯æ¶ˆæ¯å‘é€å¿…ç»ä¹‹è·¯ï¼Œä½†åªè¦ä¸€æ objc_msgSendï¼Œéƒ½ä¼šè¯´å®ƒçš„ä¼ªä»£ç å¦‚ä¸‹æˆ–ç±»ä¼¼çš„é€»è¾‘ï¼Œåæ­£å°±æ˜¯èŽ·å– IMP å¹¶è°ƒç”¨ï¼š 12345id objc_msgSend(id self, SEL _cmd, ...) &#123; Class class = object_getClass(self); IMP imp = class_getMethodImplementation(class, _cmd); return imp ? imp(self, _cmd, ...) : 0;&#125; æºç è§£æžä¸ºå•¥è€ç”¨ä¼ªä»£ç ï¼Ÿå› ä¸º objc_msgSend æ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼Œé’ˆå¯¹ä¸åŒæž¶æž„æœ‰ä¸åŒçš„å®žçŽ°ã€‚å¦‚ä¸‹ä¸º x86_64 æž¶æž„ä¸‹çš„æºç ï¼Œå¯ä»¥åœ¨ objc-msg-x86_64.s æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920 ENTRY _objc_msgSend MESSENGER_START NilTest NORMAL GetIsaFast NORMAL // r11 = self-&gt;isa CacheLookup NORMAL // calls IMP on success NilTestSupport NORMAL GetIsaSupport NORMAL// cache miss: go search the method listsLCacheMiss: // isa still in r11 MethodTableLookup %a1, %a2 // r11 = IMP cmp %r11, %r11 // set eq (nonstret) for forwarding jmp *%r11 // goto *imp END_ENTRY _objc_msgSend è¿™é‡Œé¢åŒ…å«ä¸€äº›æœ‰æ„ä¹‰çš„å®ï¼š NilTest å®ï¼Œåˆ¤æ–­è¢«å‘é€æ¶ˆæ¯çš„å¯¹è±¡æ˜¯å¦ä¸º nil çš„ã€‚å¦‚æžœä¸º nilï¼Œé‚£å°±ç›´æŽ¥è¿”å›ž nilã€‚è¿™å°±æ˜¯ä¸ºå•¥ä¹Ÿå¯ä»¥å¯¹ nilå‘æ¶ˆæ¯ã€‚ GetIsaFast å®å¯ä»¥ã€Žå¿«é€Ÿåœ°ã€èŽ·å–åˆ°å¯¹è±¡çš„ isa æŒ‡é’ˆåœ°å€ï¼ˆæ”¾åˆ° r11 å¯„å­˜å™¨ï¼Œr10 ä¼šè¢«é‡å†™ï¼›åœ¨ arm æž¶æž„ä¸Šæ˜¯ç›´æŽ¥èµ‹å€¼åˆ° r9ï¼‰ CacheLookup è¿™ä¸ªå®æ˜¯åœ¨ç±»çš„ç¼“å­˜ä¸­æŸ¥æ‰¾ selector å¯¹åº”çš„ IMPï¼ˆæ”¾åˆ° r10ï¼‰å¹¶æ‰§è¡Œã€‚å¦‚æžœç¼“å­˜æ²¡ä¸­ï¼Œé‚£å°±å¾—åˆ° Class çš„æ–¹æ³•è¡¨ä¸­æŸ¥æ‰¾äº†ã€‚ MethodTableLookup å®æ˜¯é‡ç‚¹ï¼Œè´Ÿè´£åœ¨ç¼“å­˜æ²¡å‘½ä¸­æ—¶åœ¨æ–¹æ³•è¡¨ä¸­è´Ÿè´£æŸ¥æ‰¾ IMPï¼š 12345678910111213141516171819.macro MethodTableLookup MESSENGER_END_SLOW SaveRegisters // _class_lookupMethodAndLoadCache3(receiver, selector, class) movq $0, %a1 movq $1, %a2 movq %r11, %a3 call __class_lookupMethodAndLoadCache3 // IMP is now in %rax movq %rax, %r11 RestoreRegisters.endmacro ä»Žä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºæ–¹æ³•æŸ¥æ‰¾ IMP çš„å·¥ä½œäº¤ç»™äº† OC ä¸­çš„ _class_lookupMethodAndLoadCache3 å‡½æ•°ï¼Œå¹¶å°† IMP è¿”å›žï¼ˆä»Ž r11 æŒªåˆ° raxï¼‰ã€‚æœ€åŽåœ¨ objc_msgSend ä¸­è°ƒç”¨ IMPã€‚ ä¸ºä»€ä¹ˆä½¿ç”¨æ±‡ç¼–è¯­è¨€å…¶å®žåœ¨ objc-msg-x86_64.s ä¸­åŒ…å«äº†å¤šä¸ªç‰ˆæœ¬çš„ objc_msgSend æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯æ ¹æ®è¿”å›žå€¼çš„ç±»åž‹å’Œè°ƒç”¨è€…çš„ç±»åž‹åˆ†åˆ«å¤„ç†çš„ï¼š objc_msgSendSuper:å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œè¿”å›žå€¼ç±»åž‹ä¸º id objc_msgSend_fpret:è¿”å›žå€¼ç±»åž‹ä¸º floating-pointï¼Œå…¶ä¸­åŒ…å« objc_msgSend_fp2ret å…¥å£å¤„ç†è¿”å›žå€¼ç±»åž‹ä¸º long double çš„æƒ…å†µ objc_msgSend_stret:è¿”å›žå€¼ä¸ºç»“æž„ä½“ objc_msgSendSuper_stret:å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œè¿”å›žå€¼ç±»åž‹ä¸ºç»“æž„ä½“ å½“éœ€è¦å‘é€æ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸­é—´ä»£ç ï¼Œæ ¹æ®æƒ…å†µåˆ†åˆ«è°ƒç”¨ objc_msgSend, objc_msgSend_stret, objc_msgSendSuper, æˆ– objc_msgSendSuper_stret å…¶ä¸­ä¹‹ä¸€ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ objc_msgSend è¦ç”¨æ±‡ç¼–è¯­è¨€è€Œä¸æ˜¯ OCã€C æˆ– C++ è¯­è¨€æ¥å®žçŽ°ï¼Œå› ä¸ºå•ç‹¬ä¸€ä¸ªæ–¹æ³•å®šä¹‰æ»¡è¶³ä¸äº†å¤šç§ç±»åž‹è¿”å›žå€¼ï¼Œæœ‰çš„æ–¹æ³•è¿”å›ž idï¼Œæœ‰çš„è¿”å›ž intã€‚è€ƒè™‘åˆ°ä¸åŒç±»åž‹å‚æ•°è¿”å›žå€¼æŽ’åˆ—ç»„åˆæ˜ å°„ä¸åŒæ–¹æ³•ç­¾åï¼ˆmethod signatureï¼‰çš„é—®é¢˜ï¼Œé‚£ switch è¯­å¥å¾—è€é•¿äº†ã€‚ã€‚ã€‚è¿™äº›åŽŸå› å¯ä»¥æ€»ç»“ä¸º Calling Conventionï¼Œä¹Ÿå°±æ˜¯è¯´å‡½æ•°è°ƒç”¨è€…ä¸Žè¢«è°ƒç”¨è€…å¿…é¡»çº¦å®šå¥½å‚æ•°ä¸Žè¿”å›žå€¼åœ¨ä¸åŒæž¶æž„å¤„ç†å™¨ä¸Šçš„å­˜å–è§„åˆ™ï¼Œæ¯”å¦‚å‚æ•°æ˜¯ä»¥ä½•ç§é¡ºåºå­˜å‚¨åœ¨æ ˆä¸Šï¼Œæˆ–æ˜¯å­˜å‚¨åœ¨å“ªäº›å¯„å­˜å™¨ä¸Šã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å…¶ä»–åŽŸå› ï¼Œæ¯”å¦‚å…¶å¯å˜å‚æ•°ç”¨æ±‡ç¼–å¤„ç†èµ·æ¥æœ€æ–¹ä¾¿ï¼Œå› ä¸ºæ‰¾åˆ° IMP åœ°å€åŽå‚æ•°éƒ½åœ¨æ ˆä¸Šã€‚è¦æ˜¯ç”¨ C++ ä¼ é€’å¯å˜å‚æ•°é‚£å°±æ‚²å‰§äº†ï¼Œprologue æœºåˆ¶ä¼šå¼„ä¹±åœ°å€ï¼ˆæ¯”å¦‚ i386 ä¸Šä¸ºäº†å­˜å‚¨ ebp å‘åŽç§»ä½ 4byteï¼‰ï¼Œæœ€åŽè¿˜è¦ç”¨ epilogue æ‰“æ‰«æˆ˜åœºã€‚è€Œä¸”æ±‡ç¼–ç¨‹åºæ‰§è¡Œæ•ˆçŽ‡é«˜ï¼Œåœ¨ Objective-C Runtime ä¸­è°ƒç”¨é¢‘çŽ‡è¾ƒé«˜çš„å‡½æ•°å¥½å¤šéƒ½ç”¨æ±‡ç¼–å†™çš„ã€‚ ä½¿ç”¨ lookUpImpOrForward å¿«é€ŸæŸ¥æ‰¾ IMPä¸Šä¸€èŠ‚ä¸­è¯´åˆ°çš„ _class_lookupMethodAndLoadCache3 å‡½æ•°å…¶å®žåªæ˜¯ç®€å•çš„è°ƒç”¨äº† lookUpImpOrForward å‡½æ•°ï¼š 12345IMP _class_lookupMethodAndLoadCache3(id obj, SEL sel, Class cls)&#123; return lookUpImpOrForward(cls, sel, obj, YES/*initialize*/, NO/*cache*/, YES/*resolver*/);&#125; æ³¨æ„ lookUpImpOrForward è°ƒç”¨æ—¶ä½¿ç”¨ç¼“å­˜å‚æ•°ä¼ å…¥ä¸º NOï¼Œå› ä¸ºä¹‹å‰å·²ç»å°è¯•è¿‡æŸ¥æ‰¾ç¼“å­˜äº†ã€‚IMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver)å®žçŽ°äº†ä¸€å¥—æŸ¥æ‰¾ IMP çš„æ ‡å‡†è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¶ˆæ¯è½¬å‘ï¼ˆForwardï¼‰ä¹‹å‰çš„é€»è¾‘ã€‚ ä¼˜åŒ–ç¼“å­˜æŸ¥æ‰¾&amp;ç±»çš„åˆå§‹åŒ–å…ˆå¯¹ debug æ¨¡å¼ä¸‹çš„ assert è¿›è¡Œ unlockï¼š 1runtimeLock.assertUnlocked(); runtimeLock æœ¬è´¨ä¸Šæ˜¯å¯¹ Darwin æä¾›çš„çº¿ç¨‹è¯»å†™é” pthread_rwlock_t çš„ä¸€å±‚å°è£…ï¼Œæä¾›äº†ä¸€äº›ä¾¿æ·çš„æ–¹æ³•ã€‚ lookUpImpOrForward æŽ¥ç€åšäº†å¦‚ä¸‹ä¸¤ä»¶äº‹ï¼š å¦‚æžœä½¿ç”¨ç¼“å­˜ï¼ˆcache å‚æ•°ä¸º YESï¼‰ï¼Œé‚£å°±è°ƒç”¨ cache_getImp æ–¹æ³•ä»Žç¼“å­˜æŸ¥æ‰¾ IMPã€‚cache_getImp æ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼Œä¹Ÿå¯ä»¥åœ¨ objc-msg-x86_64.s æ‰¾åˆ°ï¼Œå…¶ä¾ç„¶ç”¨äº†ä¹‹å‰è¯´è¿‡çš„ CacheLookup å®ã€‚å› ä¸º _class_lookupMethodAndLoadCache3 è°ƒç”¨ lookUpImpOrForward æ—¶ cache å‚æ•°ä¸º NOï¼Œè¿™æ­¥ç›´æŽ¥ç•¥è¿‡ã€‚ å¦‚æžœæ˜¯ç¬¬ä¸€æ¬¡ç”¨åˆ°è¿™ä¸ªç±»ä¸” initialize å‚æ•°ä¸º YESï¼ˆinitialize &amp;&amp; !cls-&gt;isInitialized()ï¼‰ï¼Œéœ€è¦è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œä¹Ÿå°±æ˜¯å¼€è¾Ÿä¸€ä¸ªç”¨äºŽè¯»å†™æ•°æ®çš„ç©ºé—´ã€‚å…ˆå¯¹ runtimeLock å†™æ“ä½œåŠ é”ï¼Œç„¶åŽè°ƒç”¨ cls çš„ initializeæ–¹æ³•ã€‚å¦‚æžœ sel == initialize ä¹Ÿæ²¡å…³ç³»ï¼Œè™½ç„¶ initialize è¿˜ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä½†ä¸ä¼šèµ·ä½œç”¨å•¦ï¼Œå› ä¸º cls-&gt;isInitialized() å·²ç»æ˜¯ YES å•¦ã€‚ ç»§ç»­åœ¨ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­æŸ¥æ‰¾è€ƒè™‘åˆ°è¿è¡Œæ—¶ç±»ä¸­çš„æ–¹æ³•å¯èƒ½ä¼šå¢žåŠ ï¼Œéœ€è¦å…ˆåšè¯»æ“ä½œåŠ é”ï¼Œä½¿å¾—æ–¹æ³•æŸ¥æ‰¾å’Œç¼“å­˜å¡«å……æˆä¸ºåŽŸå­æ“ä½œã€‚æ·»åŠ  category ä¼šåˆ·æ–°ç¼“å­˜ï¼Œä¹‹åŽå¦‚æžœæ—§æ•°æ®åˆè¢«é‡å¡«åˆ°ç¼“å­˜ä¸­ï¼Œcategory æ·»åŠ æ“ä½œå°±ä¼šè¢«å¿½ç•¥æŽ‰ã€‚ 1runtimeLock.read(); ä¹‹åŽçš„é€»è¾‘æ•´ç†å¦‚ä¸‹ï¼š å¦‚æžœ selector æ˜¯éœ€è¦è¢«å¿½ç•¥çš„åžƒåœ¾å›žæ”¶ç”¨åˆ°çš„æ–¹æ³•ï¼Œåˆ™å°† IMP ç»“æžœè®¾ä¸º _objc_ignored_methodï¼Œè¿™æ˜¯ä¸ªæ±‡ç¼–ç¨‹åºå…¥å£ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ ‡è®°ã€‚å¯¹æ­¤ç§æƒ…å†µè¿›è¡Œç¼“å­˜å¡«å……æ“ä½œåŽï¼Œè·³åˆ°ç¬¬ 7 æ­¥ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚ æŸ¥æ‰¾å½“å‰ç±»ä¸­çš„ç¼“å­˜ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ï¼Œä½¿ç”¨ cache_getImp æ±‡ç¼–ç¨‹åºå…¥å£ã€‚å¦‚æžœå‘½ä¸­ç¼“å­˜èŽ·å–åˆ°äº† IMPï¼Œåˆ™ç›´æŽ¥è·³åˆ°ç¬¬ 7 æ­¥ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚ åœ¨å½“å‰ç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨ï¼ˆmethod listï¼‰ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¹Ÿå°±æ˜¯æ ¹æ® selector æŸ¥æ‰¾åˆ° Method åŽï¼ŒèŽ·å– Method ä¸­çš„ IMPï¼ˆä¹Ÿå°±æ˜¯ method_imp å±žæ€§ï¼‰ï¼Œå¹¶å¡«å……åˆ°ç¼“å­˜ä¸­ã€‚æŸ¥æ‰¾è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¼šé’ˆå¯¹å·²ç»æŽ’åºçš„åˆ—è¡¨ä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾ï¼ŒæœªæŽ’åºçš„åˆ—è¡¨åˆ™æ˜¯çº¿æ€§éåŽ†ã€‚å¦‚æžœæˆåŠŸæŸ¥æ‰¾åˆ° Method å¯¹è±¡ï¼Œå°±ç›´æŽ¥è·³åˆ°ç¬¬ 7 æ­¥ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚ åœ¨ç»§æ‰¿å±‚çº§ä¸­é€’å½’å‘çˆ¶ç±»ä¸­æŸ¥æ‰¾ï¼Œæƒ…å†µè·Ÿä¸Šä¸€æ­¥ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å…ˆæŸ¥æ‰¾ç¼“å­˜ï¼Œç¼“å­˜æ²¡ä¸­å°±æŸ¥æ‰¾æ–¹æ³•åˆ—è¡¨ã€‚è¿™é‡Œè·Ÿä¸Šä¸€æ­¥ä¸åŒçš„åœ°æ–¹åœ¨äºŽç¼“å­˜ç­–ç•¥ï¼Œæœ‰ä¸ª _objc_msgForward_impcache æ±‡ç¼–ç¨‹åºå…¥å£ä½œä¸ºç¼“å­˜ä¸­æ¶ˆæ¯è½¬å‘çš„æ ‡è®°ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æžœåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº† IMPï¼Œä½†å¦‚æžœå‘çŽ°å…¶å†…å®¹æ˜¯ _objc_msgForward_impcacheï¼Œé‚£å°±ç»ˆæ­¢åœ¨ç±»çš„ç»§æ‰¿å±‚çº§ä¸­é€’å½’æŸ¥æ‰¾ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼›å¦åˆ™è·³åˆ°ç¬¬ 7 æ­¥ã€‚ å½“ä¼ å…¥ lookUpImpOrForward çš„å‚æ•° resolver ä¸º YES å¹¶ä¸”æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥ç¬¬ 5 æ­¥æ—¶ï¼Œæ—¶è¿›å…¥åŠ¨æ€æ–¹æ³•è§£æžï¼›å¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚è¿™æ­¥æ¶ˆæ¯è½¬å‘å‰çš„æœ€åŽä¸€æ¬¡æœºä¼šã€‚æ­¤æ—¶é‡Šæ”¾è¯»å…¥é”ï¼ˆruntimeLock.unlockRead()ï¼‰ï¼ŒæŽ¥ç€é—´æŽ¥åœ°å‘é€ +resolveInstanceMethod æˆ– +resolveClassMethod æ¶ˆæ¯ã€‚è¿™ç›¸å½“äºŽå‘Šè¯‰ç¨‹åºå‘˜ã€Žèµ¶ç´§ç”¨ Runtime ç»™ç±»é‡Œè¿™ä¸ª selector å¼„ä¸ªå¯¹åº”çš„ IMP å§ã€ï¼Œå› ä¸ºæ­¤æ—¶é”å·²ç» unlock äº†æ‰€ä»¥ä¸ä¼šç¼“å­˜ç»“æžœï¼Œç”šè‡³è¿˜éœ€è¦è½¯æ€§åœ°å¤„ç†ç¼“å­˜è¿‡æœŸé—®é¢˜å¯èƒ½å¸¦æ¥çš„é”™è¯¯ã€‚è¿™é‡Œçš„ä¸šåŠ¡é€»è¾‘ç¨å¾®å¤æ‚äº›ï¼ŒåŽé¢ä¼šæ€»ç»“ã€‚å› ä¸ºè¿™äº›å·¥ä½œéƒ½æ˜¯åœ¨éžçº¿ç¨‹å®‰å…¨ä¸‹è¿›è¡Œçš„ï¼Œå®ŒæˆåŽéœ€è¦å›žåˆ°ç¬¬ 1 æ­¥å†æ¬¡æŸ¥æ‰¾ IMPã€‚ æ­¤æ—¶ä¸ä»…æ²¡æŸ¥æ‰¾åˆ° IMPï¼ŒåŠ¨æ€æ–¹æ³•è§£æžä¹Ÿä¸å¥æ•ˆï¼Œåªèƒ½å°† _objc_msgForward_impcache å½“åš IMP å¹¶å†™å…¥ç¼“å­˜ã€‚è¿™ä¹Ÿå°±æ˜¯ä¹‹å‰ç¬¬ 4 æ­¥ä¸­ä¸ºä½•æŸ¥æ‰¾åˆ° _objc_msgForward_impcache å°±è¡¨æ˜Žäº†è¦è¿›å…¥æ¶ˆæ¯è½¬å‘äº†ã€‚ è¯»æ“ä½œè§£é”ï¼Œå¹¶å°†ä¹‹å‰æ‰¾åˆ°çš„ IMP è¿”å›žã€‚ï¼ˆæ— è®ºæ˜¯æ­£ç» IMP è¿˜æ˜¯ä¸æ­£ç»çš„ _objc_msgForward_impcacheï¼‰è¿™æ­¥è¿˜åæ‰§åœ°åšäº†ä¸€äº›è„‘æ´žç•¥å¤§çš„ assertï¼Œå¾ˆæœ‰è¶£ã€‚ å¯¹äºŽç¬¬ 5 æ­¥ï¼Œå…¶å®žæ˜¯ç›´æŽ¥è°ƒç”¨ _class_resolveMethod å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å®žçŽ°äº†å¤æ‚çš„æ–¹æ³•è§£æžé€»è¾‘ã€‚å¦‚æžœ cls æ˜¯å…ƒç±»åˆ™ä¼šå‘é€ +resolveClassMethodï¼Œç„¶åŽæ ¹æ® lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/) å‡½æ•°çš„ç»“æžœæ¥åˆ¤æ–­æ˜¯å¦å‘é€ +resolveInstanceMethodï¼›å¦‚æžœä¸æ˜¯å…ƒç±»ï¼Œåˆ™åªéœ€è¦å‘é€ +resolveInstanceMethod æ¶ˆæ¯ã€‚è¿™é‡Œè°ƒç”¨ +resolveInstanceMethod æˆ– +resolveClassMethod æ—¶å†æ¬¡ç”¨åˆ°äº† objc_msgSendï¼Œè€Œä¸”ç¬¬ä¸‰ä¸ªå‚æ•°æ­£æ˜¯ä¼ å…¥ lookUpImpOrForward çš„é‚£ä¸ª selã€‚åœ¨å‘é€æ–¹æ³•è§£æžæ¶ˆæ¯ä¹‹åŽè¿˜ä¼šè°ƒç”¨ lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/) æ¥åˆ¤æ–­æ˜¯å¦å·²ç»æ·»åŠ ä¸Š sel å¯¹åº”çš„ IMP äº†ï¼Œæ‰“å°å‡ºç»“æžœã€‚ æœ€åŽ lookUpImpOrForward æ–¹æ³•ä¹Ÿä¼šæŠŠçœŸæ­£çš„ IMP æˆ–è€…éœ€è¦æ¶ˆæ¯è½¬å‘çš„ _objc_msgForward_impcache è¿”å›žï¼Œå¹¶æœ€ç»ˆä¸“é€’åˆ° objc_msgSend ä¸­ã€‚è€Œ _objc_msgForward_impcache ä¼šåœ¨è½¬åŒ–æˆ _objc_msgForward æˆ– _objc_msgForward_stretã€‚è¿™ä¸ªåŽé¢ä¼šè®²è§£åŽŸç†ã€‚ å›žé¡¾ objc_msgSend ä¼ªä»£ç å›žè¿‡å¤´æ¥ä¼šå‘çŽ° objc_msgSend çš„ä¼ªä»£ç æè¿°å¾—å¾ˆä¼ ç¥žå•Šï¼Œå› ä¸ºclass_getMethodImplementation çš„å®žçŽ°å¦‚ä¸‹ï¼š 1234567891011IMP class_getMethodImplementation(Class cls, SEL sel)&#123; IMP imp; if (!cls || !sel) return nil; imp = lookUpImpOrNil(cls, sel, nil, YES/*initialize*/, YES/*cache*/, YES/*resolver*/); // Translate forwarding function to C-callable external version if (!imp) &#123; return _objc_msgForward; &#125; return imp;&#125; lookUpImpOrNil å‡½æ•°èŽ·å–ä¸åˆ° IMP æ—¶å°±è¿”å›ž _objc_msgForwardï¼ŒåŽé¢ä¼šè®²åˆ°å®ƒã€‚lookUpImpOrNil è·Ÿ lookUpImpOrForward çš„åŠŸèƒ½å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯å°† lookUpImpOrForward å®žçŽ°ä¸­çš„ _objc_msgForward_impcache æ›¿æ¢æˆäº† nil: 1234567IMP lookUpImpOrNil(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver)&#123; IMP imp = lookUpImpOrForward(cls, sel, inst, initialize, cache, resolver); if (imp == _objc_msgForward_impcache) return nil; else return imp;&#125; lookUpImpOrNil æ–¹æ³•å¯ä»¥æŸ¥æ‰¾åˆ° selector å¯¹åº”çš„ IMP æˆ–æ˜¯ nilï¼Œæ‰€ä»¥å¦‚æžœä¸è€ƒè™‘è¿”å›žå€¼ç±»åž‹ä¸ºç»“æž„ä½“çš„æƒ…å†µï¼Œç”¨é‚£å‡ è¡Œä¼ªä»£ç æ¥è¡¨ç¤ºå¤æ‚çš„æ±‡ç¼–å®žçŽ°è¿˜æ˜¯æŒºæ°å½“çš„ã€‚ forwarding ä¸­è·¯æ¼«æ¼«çš„æ¶ˆæ¯è½¬å‘objc_msgForward_impcache çš„è½¬æ¢_objc_msgForward_impcache åªæ˜¯ä¸ªå†…éƒ¨çš„å‡½æ•°æŒ‡é’ˆï¼Œåªå­˜å‚¨äºŽä¸ŠèŠ‚æåˆ°çš„ç±»çš„æ–¹æ³•ç¼“å­˜ä¸­ï¼Œéœ€è¦è¢«è½¬åŒ–ä¸º _objc_msgForward å’Œ _objc_msgForward_stret æ‰èƒ½è¢«å¤–éƒ¨è°ƒç”¨ã€‚ä½†åœ¨ Mac OS X macOS 10.6 åŠæ›´æ—©ç‰ˆæœ¬çš„ libobjc.A.dylib ä¸­æ˜¯ä¸èƒ½ç›´æŽ¥è°ƒç”¨çš„ï¼Œå†µä¸”æˆ‘ä»¬æ ¹æœ¬ä¸ä¼šç›´æŽ¥ç”¨åˆ°å®ƒã€‚å¸¦ stret åŽç¼€çš„å‡½æ•°ä¾æ—§æ˜¯è¿”å›žå€¼ä¸ºç»“æž„ä½“çš„ç‰ˆæœ¬ã€‚ ä¸Šä¸€èŠ‚æœ€åŽè®²åˆ°å¦‚æžœæ²¡æ‰¾åˆ° IMPï¼Œå°±ä¼šå°† _objc_msgForward_impcache è¿”å›žåˆ° objc_msgSend å‡½æ•°ï¼Œè€Œæ­£æ˜¯å› ä¸ºå®ƒæ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼Œæ‰€ä»¥å°†å†…éƒ¨ä½¿ç”¨çš„ _objc_msgForward_impcache è½¬åŒ–æˆå¤–éƒ¨å¯è°ƒç”¨çš„ _objc_msgForward æˆ– _objc_msgForward_stret ä¹Ÿæ˜¯ç”±æ±‡ç¼–ä»£ç æ¥å®Œæˆã€‚å®žçŽ°åŽŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å¢žåŠ ä¸ªé™æ€å…¥å£ __objc_msgForward_impcacheï¼Œç„¶åŽæ ¹æ®æ­¤æ—¶ CPU çš„çŠ¶æ€å¯„å­˜å™¨çš„å†…å®¹æ¥å†³å®šè½¬æ¢æˆå“ªä¸ªã€‚å¦‚æžœæ˜¯ NE(Not Equal) åˆ™è½¬æ¢æˆ _objc_msgForward_stretï¼Œåä¹‹æ˜¯ EQ(Equal) åˆ™è½¬æ¢æˆ _objc_msgForward: 12jne __objc_msgForward_stretjmp __objc_msgForward ä¸ºä½•æ ¹æ®çŠ¶æ€å¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­è½¬æ¢æˆå“ªä¸ªå‡½æ•°æŒ‡é’ˆå‘¢ï¼Ÿå›žè¿‡å¤´æ¥çœ‹çœ‹ objc_msgSend ä¸­è°ƒç”¨å®Œ MethodTableLookupä¹‹åŽå¹²äº†ä»€ä¹ˆï¼š 123MethodTableLookup %a1, %a2 // r11 = IMPcmp %r11, %r11 // set eq (nonstret) for forwardingjmp *%r11 // goto *imp å†çœ‹çœ‹è¿”å›žå€¼ä¸ºç»“æž„ä½“çš„ objc_msgSend_stret è¿™é‡Œçš„é€»è¾‘ï¼š 123MethodTableLookup %a2, %a3 // r11 = IMPtest %r11, %r11 // set ne (stret) for forward; r11!=0jmp *%r11 // goto *imp ç¨å¾®æ‡‚æ±‡ç¼–çš„äººä¸€çœ¼å°±çœ‹æ˜Žç™½äº†ï¼Œä¸æ‡‚çš„çœ‹æ³¨é‡Šä¹Ÿæ‡‚äº†ï¼Œæˆ‘å°±ä¸å¢¨è¿¹äº†ã€‚çŽ°åœ¨æ€»ç®—æ˜¯æŠŠæ¶ˆæ¯è½¬å‘å‰çš„é€»è¾‘ç»•å›žæ¥æž„æˆé—­çŽ¯äº†ã€‚ ä¸Šä¸€èŠ‚ä¸­æåˆ° class_getMethodImplementation å‡½æ•°çš„å®žçŽ°ï¼Œåœ¨æŸ¥æ‰¾ä¸åˆ° IMP æ—¶è¿”å›ž _objc_msgForwardï¼Œè€Œ _objc_msgForward_stret æ­£å¥½å¯¹åº”ç€ class_getMethodImplementation_stret: 123456789IMP class_getMethodImplementation_stret(Class cls, SEL sel)&#123; IMP imp = class_getMethodImplementation(cls, sel); // Translate forwarding function to struct-returning version if (imp == (IMP)&amp;_objc_msgForward /* not _internal! */) &#123; return (IMP)&amp;_objc_msgForward_stret; &#125; return imp;&#125; ä¹Ÿå°±æ˜¯è¯´ _objc_msgForward* ç³»åˆ—æœ¬è´¨éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œéƒ½ç”¨æ±‡ç¼–è¯­è¨€å®žçŽ°ï¼Œéƒ½å¯ä»¥ä¸Ž IMP ç±»åž‹çš„å€¼ä½œæ¯”è¾ƒã€‚_objc_msgForward å’Œ _objc_msgForward_stret å£°æ˜Žåœ¨ message.h æ–‡ä»¶ä¸­ã€‚_objc_msgForward_impcache åœ¨æ—©æœŸç‰ˆæœ¬çš„ Runtime ä¸­å«åš _objc_msgForward_internalã€‚ objc_msgForward ä¹Ÿåªæ˜¯ä¸ªå…¥å£ä»Žæ±‡ç¼–æºç å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡º _objc_msgForward å’Œ _objc_msgForward_stret ä¼šåˆ†åˆ«è°ƒç”¨ _objc_forward_handler å’Œ _objc_forward_handler_stretï¼š 12345678910111213141516ENTRY __objc_msgForward// Non-stret versionmovq __objc_forward_handler(%rip), %r11jmp *%r11END_ENTRY __objc_msgForwardENTRY __objc_msgForward_stret// Struct-return versionmovq __objc_forward_stret_handler(%rip), %r11jmp *%r11END_ENTRY __objc_msgForward_stret è¿™ä¸¤ä¸ª handler å‡½æ•°çš„åŒºåˆ«ä»Žå­—é¢ä¸Šå°±èƒ½çœ‹å‡ºæ¥ï¼Œä¸å†èµ˜è¿°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆæ¯è½¬å‘è¿‡ç¨‹æ˜¯çŽ°å°† _objc_msgForward_impcache å¼ºè½¬æˆ _objc_msgForward æˆ– _objc_msgForward_stretï¼Œå†åˆ†åˆ«è°ƒç”¨ _objc_forward_handler æˆ– _objc_forward_handler_stretã€‚ objc_setForwardHandler è®¾ç½®äº†æ¶ˆæ¯è½¬å‘çš„å›žè°ƒåœ¨ Objective-C 2.0 ä¹‹å‰ï¼Œé»˜è®¤çš„ _objc_forward_handler æˆ– _objc_forward_handler_stret éƒ½æ˜¯ nilï¼Œè€Œæ–°ç‰ˆæœ¬çš„é»˜è®¤å®žçŽ°æ˜¯è¿™æ ·çš„ï¼š 1234567891011121314151617181920// Default forward handler halts the process.__attribute__((noreturn)) void objc_defaultForwardHandler(id self, SEL sel)&#123; _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot; &quot;(no message forward handler is installed)&quot;, class_isMetaClass(object_getClass(self)) ? &apos;+&apos; : &apos;-&apos;, object_getClassName(self), sel_getName(sel), self);&#125;void *_objc_forward_handler = (void*)objc_defaultForwardHandler;#if SUPPORT_STRETstruct stret &#123; int i[100]; &#125;;__attribute__((noreturn)) struct stret objc_defaultForwardStretHandler(id self, SEL sel)&#123; objc_defaultForwardHandler(self, sel);&#125;void *_objc_forward_stret_handler = (void*)objc_defaultForwardStretHandler;#endif objc_defaultForwardHandler ä¸­çš„ _objc_fatal ä½œç”¨å°±æ˜¯æ‰“æ—¥å¿—å¹¶è°ƒç”¨ __builtin_trap() è§¦å‘ crashï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„é‚£å¥ â€œunrecognized selector sent to instanceâ€ æ—¥å¿—ã€‚__builtin_trap() åœ¨æ€æŽ‰è¿›ç¨‹çš„åŒæ—¶è¿˜èƒ½ç”Ÿæˆæ—¥å¿—ï¼Œæ¯”è°ƒç”¨ exit() æ›´å¥½ã€‚objc_defaultForwardStretHandler å°±æ˜¯è£…æ¨¡ä½œæ ·æžä¸ªå½¢å¼ä¸»ä¹‰ï¼ŒæŠŠ objc_defaultForwardHandler åŒ…äº†ä¸€å±‚ã€‚__attribute__((noreturn)) å±žæ€§é€šçŸ¥ç¼–è¯‘å™¨å‡½æ•°ä»Žä¸è¿”å›žå€¼ï¼Œå½“é‡åˆ°ç±»ä¼¼å‡½æ•°éœ€è¦è¿”å›žå€¼è€Œå´ä¸å¯èƒ½è¿è¡Œåˆ°è¿”å›žå€¼å¤„å°±å·²ç»é€€å‡ºæ¥çš„æƒ…å†µï¼Œè¯¥å±žæ€§å¯ä»¥é¿å…å‡ºçŽ°é”™è¯¯ä¿¡æ¯ã€‚è¿™é‡Œæ­£é€‚åˆæ­¤å±žæ€§ï¼Œå› ä¸ºè¦æ±‚è¿”å›žç»“æž„ä½“å“’ã€‚ å› ä¸ºé»˜è®¤çš„ Handler å¹²çš„äº‹å„¿å°±æ˜¯æ‰“æ—¥å¿—è§¦å‘ crashï¼Œæˆ‘ä»¬æƒ³è¦å®žçŽ°æ¶ˆæ¯è½¬å‘ï¼Œå°±éœ€è¦æ›¿æ¢æŽ‰ Handler å¹¶èµ‹å€¼ç»™ _objc_forward_handler æˆ– _objc_forward_handler_stretï¼Œèµ‹å€¼çš„è¿‡ç¨‹å°±éœ€è¦ç”¨åˆ° objc_setForwardHandlerå‡½æ•°ï¼Œå®žçŽ°ä¹Ÿæ˜¯ç®€å•ç²—æš´ï¼Œå°±æ˜¯èµ‹å€¼å•Šï¼š 1234567void objc_setForwardHandler(void *fwd, void *fwd_stret)&#123; _objc_forward_handler = fwd;#if SUPPORT_STRET _objc_forward_stret_handler = fwd_stret;#endif&#125; é€†å‘å·¥ç¨‹åŠ©åŠ›åˆ¨æ ¹é—®åº•é‡å¤´æˆåœ¨äºŽå¯¹ objc_setForwardHandler çš„è°ƒç”¨ï¼Œä»¥åŠä¹‹åŽçš„æ¶ˆæ¯è½¬å‘è°ƒç”¨æ ˆã€‚è¿™å›žä¸æ˜¯åœ¨ Objective-C Runtime ï¼ˆlibobjc.dylibï¼‰ä¸­å•¦ï¼Œè€Œæ˜¯åœ¨ Core Foundationï¼ˆCoreFoundation.frameworkï¼‰ä¸­ã€‚è™½ç„¶ CF æ˜¯å¼€æºçš„ï¼Œä½†æœ‰æ„æ€çš„æ˜¯è‹¹æžœæ•…æ„åœ¨å¼€æºçš„ä»£ç ä¸­åˆ é™¤äº†åœ¨ CFRuntime.c æ–‡ä»¶ __CFInitialize() ä¸­è°ƒç”¨ objc_setForwardHandler çš„ä»£ç ã€‚__CFInitialize() å‡½æ•°æ˜¯åœ¨ CF runtime è¿žæŽ¥åˆ°è¿›ç¨‹æ—¶åˆå§‹åŒ–è°ƒç”¨çš„ã€‚ä»Žåç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç ä¸­å¯ä»¥å¾ˆå®¹æ˜“è·Ÿ C æºç å¯¹æ¯”å‡ºæ¥ï¼Œæˆ‘ç”¨çº¢è‰²æ ‡å‡ºäº†åŒä¸€æ®µä»£ç çš„å·®å¼‚ã€‚ æ±‡ç¼–è¯­è¨€è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œçº¢è‰²æ ‡å‡ºçš„é‚£ä¸‰ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠ __CF_forwarding_prep_0 å’Œ ___forwarding_prep_1___ä½œä¸ºå‚æ•°è°ƒç”¨ objc_setForwardHandler æ–¹æ³•ï¼ˆé‚£ä¹ˆä¹‹å‰é‚£ä¸¤ä¸ª DefaultHandler åµç”¨éƒ½æ²¡æœ‰å’¯ï¼Œåæ­£ä¸å‡ºæ„å¤–ä¼šè¢« CF æ›¿æ¢æŽ‰ï¼‰ï¼š åç¼–è¯‘åŽçš„ __CFInitialize() æ±‡ç¼–ä»£ç  ç„¶è€Œåœ¨æºç ä¸­å¯¹åº”çš„ä»£ç å´è¢«åˆ æŽ‰å•¦ï¼š è‹¹æžœæä¾›çš„ __CFInitialize() å‡½æ•°æºç  åœ¨æ—©æœŸç‰ˆæœ¬çš„ CF æºç ä¸­ï¼Œè¿˜æ˜¯å¯ä»¥çœ‹åˆ° __CF_forwarding_prep_0 å’Œ ___forwarding_prep_1___ çš„å£°æ˜Žçš„ï¼Œä½†æ˜¯ä¸ä¼šæœ‰å®žçŽ°æºç ï¼Œä¹Ÿæ²¡æœ‰å¯¹ objc_setForwardHandler çš„è°ƒç”¨ã€‚è¿™äº›ç»†èŠ‚ä»Žå‡½æ•°è°ƒç”¨æ ˆä¸­æ— æ³•çœ‹å‡ºï¼Œåªèƒ½é€†å‘å·¥ç¨‹çœ‹æ±‡ç¼–æŒ‡ä»¤ã€‚ä½†ä»Žå‡½æ•°è°ƒç”¨æ ˆå¯ä»¥çœ‹å‡º __CF_forwarding_prep_0 å’Œ ___forwarding_prep_1___ è¿™ä¸¤ä¸ª Forward Handler åšäº†å•¥ï¼š 12345678910111213142016-06-14 12:50:15.385 MessageForward[67364:7174239] -[MFObject sendMessage]: unrecognized selector sent to instance 0x1006001a02016-06-14 12:50:15.387 MessageForward[67364:7174239] *** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;-[MFObject sendMessage]: unrecognized selector sent to instance 0x1006001a0&apos;*** First throw call stack:( 0 CoreFoundation 0x00007fff8fa554f2 __exceptionPreprocess + 178 1 libobjc.A.dylib 0x00007fff98396f7e objc_exception_throw + 48 2 CoreFoundation 0x00007fff8fabf1ad -[NSObject(NSObject) doesNotRecognizeSelector:] + 205 3 CoreFoundation 0x00007fff8f9c5571 ___forwarding___ + 1009 4 CoreFoundation 0x00007fff8f9c50f8 _CF_forwarding_prep_0 + 120 5 MessageForward 0x0000000100000f1f main + 79 6 libdyld.dylib 0x00007fff8bc2c5ad start + 1 7 ??? 0x0000000000000001 0x0 + 1)libc++abi.dylib: terminating with uncaught exception of type NSException è¿™ä¸ªæ—¥å¿—åœºæ™¯ç†Ÿæ‚‰å¾—ä¸èƒ½å†ç†Ÿæ‚‰äº†ï¼Œå¯ä»¥çœ‹å‡º _CF_forwarding_prep_0 å‡½æ•°è°ƒç”¨äº† ___forwarding___ å‡½æ•°ï¼ŒæŽ¥ç€åˆè°ƒç”¨äº† doesNotRecognizeSelector æ–¹æ³•ï¼Œæœ€åŽæŠ›å‡ºå¼‚å¸¸ã€‚ä½†æ˜¯é è¿™äº›æ˜¯æ— æ³•è¯´æœçœ‹å®¢çš„ï¼Œè¿˜å¾—é é€†å‘å·¥ç¨‹åç¼–è¯‘åŽå†åæ±‡ç¼–æˆä¼ªä»£ç æ¥ä¸€æŽ¢ç©¶ç«Ÿï¼Œåˆ¨æ ¹é—®åº•ã€‚ __CF_forwarding_prep_0 å’Œ ___forwarding_prep_1___ å‡½æ•°éƒ½è°ƒç”¨äº† ___forwarding___ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸åŒã€‚___forwarding___ æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå°†è¦è¢«è½¬å‘æ¶ˆæ¯çš„æ ˆæŒ‡é’ˆï¼ˆå¯ä»¥ç®€å•ç†è§£æˆ IMPï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ ‡è®°æ˜¯å¦è¿”å›žç»“æž„ä½“ã€‚__CF_forwarding_prep_0 ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ 0ï¼Œ___forwarding_prep_1___ ä¼ å…¥çš„æ˜¯ 1ï¼Œä»Žå‡½æ•°åéƒ½èƒ½çœ‹å¾—å‡ºæ¥ã€‚ä¸‹é¢æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°çš„ä¼ªä»£ç ï¼š 12345678910111213141516171819202122232425int __CF_forwarding_prep_0(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) &#123; rax = ____forwarding___(rsp, 0x0); if (rax != 0x0) &#123; // è½¬å‘ç»“æžœä¸ä¸ºç©ºï¼Œå°†å†…å®¹è¿”å›ž rax = *rax; &#125; else &#123; // è½¬å‘ç»“æžœä¸ºç©ºï¼Œè°ƒç”¨ objc_msgSend(id self, SEL _cmd,...); rsi = *(rsp + 0x8); rdi = *rsp; rax = objc_msgSend(rdi, rsi); &#125; return rax;&#125;int ___forwarding_prep_1___(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) &#123; rax = ____forwarding___(rsp, 0x1); if (rax != 0x0) &#123;// è½¬å‘ç»“æžœä¸ä¸ºç©ºï¼Œå°†å†…å®¹è¿”å›ž rax = *rax; &#125; else &#123;// è½¬å‘ç»“æžœä¸ºç©ºï¼Œè°ƒç”¨ objc_msgSend_stret(void * st_addr, id self, SEL _cmd, ...); rdx = *(rsp + 0x10); rsi = *(rsp + 0x8); rdi = *rsp; rax = objc_msgSend_stret(rdi, rsi, rdx); &#125; return rax;&#125; åœ¨ x86_64 æž¶æž„ä¸­ï¼Œrax å¯„å­˜å™¨ä¸€èˆ¬æ˜¯ä½œä¸ºè¿”å›žå€¼ï¼Œrsp å¯„å­˜å™¨æ˜¯æ ˆæŒ‡é’ˆã€‚åœ¨è°ƒç”¨ objc_msgSend å‡½æ•°æ—¶ï¼Œå‚æ•° arg0(self), arg1(_cmd), arg2, arg3, arg4, arg5 åˆ†åˆ«ä½¿ç”¨å¯„å­˜å™¨ rdi, rsi, rdx, rcx, r8, r9 çš„å€¼ã€‚åœ¨è°ƒç”¨ objc_msgSend_stret æ—¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸º st_addrï¼Œå…¶ä½™å‚æ•°ä¾æ¬¡åŽç§»ã€‚ä¸ºäº†èƒ½å¤Ÿæ‰“åŒ…å‡º NSInvocation å®žä¾‹å¹¶ä¼ å…¥åŽç»­çš„ forwardInvocation: æ–¹æ³•ï¼Œåœ¨è°ƒç”¨ ___forwarding___ å‡½æ•°ä¹‹å‰ä¼šå…ˆå°†æ‰€æœ‰å‚æ•°åŽ‹å…¥æ ˆä¸­ã€‚å› ä¸ºå¯„å­˜å™¨ rspä¸ºæ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œæ‰€ä»¥ rsp çš„å†…å®¹å°±æ˜¯ self å•¦ï¼Œå› ä¸º x86_64 æ˜¯å°ç«¯ï¼Œæ ˆå¢žé•¿æ–¹å‘æ˜¯ç”±é«˜åœ°å€åˆ°ä½Žåœ°å€ï¼Œæ‰€ä»¥ä»Žæ ˆé¡¶å¾€ä¸‹ç§»åŠ¨ä¸€ä¸ªæŒ‡é’ˆéœ€è¦åŠ  0x8ï¼ˆ64bitï¼‰ã€‚è€Œå°†å‚æ•°å…¥æ ˆçš„é¡ºåºæ˜¯ä»ŽåŽå¾€å‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ arg0 æ˜¯æœ€åŽä¸€ä¸ªå…¥æ ˆçš„ï¼Œä½äºŽæ ˆé¡¶ï¼š 12345678910111213141516171819202122 __CF_forwarding_prep_0:0000000000085080 push rbp ; XREF=___CFInitialize+1380000000000085081 mov rbp, rsp0000000000085084 sub rsp, 0xd0000000000008508b mov qword [ss:rsp+0xb0], rax0000000000085093 movq qword [ss:rsp+0xa0], xmm7000000000008509c movq qword [ss:rsp+0x90], xmm600000000000850a5 movq qword [ss:rsp+0x80], xmm500000000000850ae movq qword [ss:rsp+0x70], xmm400000000000850b4 movq qword [ss:rsp+0x60], xmm300000000000850ba movq qword [ss:rsp+0x50], xmm200000000000850c0 movq qword [ss:rsp+0x40], xmm100000000000850c6 movq qword [ss:rsp+0x30], xmm000000000000850cc mov qword [ss:rsp+0x28], r900000000000850d1 mov qword [ss:rsp+0x20], r800000000000850d6 mov qword [ss:rsp+0x18], rcx00000000000850db mov qword [ss:rsp+0x10], rdx00000000000850e0 mov qword [ss:rsp+0x8], rsi00000000000850e5 mov qword [ss:rsp], rdi00000000000850e9 mov rdi, rsp ; argument #1 for method ____forwarding___00000000000850ec mov rsi, 0x0 ; argument #2 for method ____forwarding___00000000000850f3 call ____forwarding___ æ¶ˆæ¯è½¬å‘çš„é€»è¾‘å‡ ä¹Žéƒ½å†™åœ¨ ___forwarding___ å‡½æ•°ä¸­äº†ï¼Œå®žçŽ°æ¯”è¾ƒå¤æ‚ï¼Œåç¼–è¯‘å‡ºçš„ä¼ªä»£ç ä¹Ÿä¸æ˜¯å¾ˆç›´è§‚ã€‚æˆ‘å¯¹ arigrant.com çš„ç»“æžœå®Œå–„å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485int __forwarding__(void *frameStackPointer, int isStret) &#123; id receiver = *(id *)frameStackPointer; SEL sel = *(SEL *)(frameStackPointer + 8); const char *selName = sel_getName(sel); Class receiverClass = object_getClass(receiver); // è°ƒç”¨ forwardingTargetForSelector: if (class_respondsToSelector(receiverClass, @selector(forwardingTargetForSelector:))) &#123; id forwardingTarget = [receiver forwardingTargetForSelector:sel]; if (forwardingTarget &amp;&amp; forwarding != receiver) &#123; if (isStret == 1) &#123; int ret; objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...); return ret; &#125; return objc_msgSend(forwardingTarget, sel, ...); &#125; &#125; // åƒµå°¸å¯¹è±¡ const char *className = class_getName(receiverClass); const char *zombiePrefix = &quot;_NSZombie_&quot;; size_t prefixLen = strlen(zombiePrefix); // 0xa if (strncmp(className, zombiePrefix, prefixLen) == 0) &#123; CFLog(kCFLogLevelError, @&quot;*** -[%s %s]: message sent to deallocated instance %p&quot;, className + prefixLen, selName, receiver); &lt;breakpoint-interrupt&gt; &#125; // è°ƒç”¨ methodSignatureForSelector èŽ·å–æ–¹æ³•ç­¾ååŽå†è°ƒç”¨ forwardInvocation if (class_respondsToSelector(receiverClass, @selector(methodSignatureForSelector:))) &#123; NSMethodSignature *methodSignature = [receiver methodSignatureForSelector:sel]; if (methodSignature) &#123; BOOL signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct; if (signatureIsStret != isStret) &#123; CFLog(kCFLogLevelWarning , @&quot;*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of &apos;%s&apos;. Signature thinks it does%s return a struct, and compiler thinks it does%s.&quot;, selName, signatureIsStret ? &quot;&quot; : not, isStret ? &quot;&quot; : not); &#125; if (class_respondsToSelector(receiverClass, @selector(forwardInvocation:))) &#123; NSInvocation *invocation = [NSInvocation _invocationWithMethodSignature:methodSignature frame:frameStackPointer]; [receiver forwardInvocation:invocation]; void *returnValue = NULL; [invocation getReturnValue:&amp;value]; return returnValue; &#125; else &#123; CFLog(kCFLogLevelWarning , @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement forwardInvocation: -- dropping message&quot;, receiver, className); return 0; &#125; &#125; &#125; SEL *registeredSel = sel_getUid(selName); // selector æ˜¯å¦å·²ç»åœ¨ Runtime æ³¨å†Œè¿‡ if (sel != registeredSel) &#123; CFLog(kCFLogLevelWarning , @&quot;*** NSForwarding: warning: selector (%p) for message &apos;%s&apos; does not match selector known to Objective C runtime (%p)-- abort&quot;, sel, selName, registeredSel); &#125; // doesNotRecognizeSelector else if (class_respondsToSelector(receiverClass,@selector(doesNotRecognizeSelector:))) &#123; [receiver doesNotRecognizeSelector:sel]; &#125; else &#123; CFLog(kCFLogLevelWarning , @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement doesNotRecognizeSelector: -- abort&quot;, receiver, className); &#125; // The point of no return. kill(getpid(), 9);&#125; è¿™ä¹ˆä¸€å¤§å¨ä»£ç å°±æ˜¯æ•´ä¸ªæ¶ˆæ¯è½¬å‘è·¯å¾„çš„é€»è¾‘ï¼Œæ¦‚æ‹¬å¦‚ä¸‹ï¼š å…ˆè°ƒç”¨ forwardingTargetForSelector æ–¹æ³•èŽ·å–æ–°çš„ target ä½œä¸º receiver é‡æ–°æ‰§è¡Œ selectorï¼Œå¦‚æžœè¿”å›žçš„å†…å®¹ä¸åˆæ³•ï¼ˆä¸º nil æˆ–è€…è·Ÿæ—§ receiver ä¸€æ ·ï¼‰ï¼Œé‚£å°±è¿›å…¥ç¬¬äºŒæ­¥ã€‚ è°ƒç”¨ methodSignatureForSelector èŽ·å–æ–¹æ³•ç­¾ååŽï¼Œåˆ¤æ–­è¿”å›žç±»åž‹ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œå†è°ƒç”¨ forwardInvocationæ‰§è¡Œ NSInvocation å¯¹è±¡ï¼Œå¹¶å°†ç»“æžœè¿”å›žã€‚å¦‚æžœå¯¹è±¡æ²¡å®žçŽ° methodSignatureForSelector æ–¹æ³•ï¼Œè¿›å…¥ç¬¬ä¸‰æ­¥ã€‚ è°ƒç”¨ doesNotRecognizeSelector æ–¹æ³•ã€‚ doesNotRecognizeSelector ä¹‹å‰å…¶å®žè¿˜æœ‰ä¸ªåˆ¤æ–­ selector åœ¨ Runtime ä¸­æ˜¯å¦æ³¨å†Œè¿‡çš„é€»è¾‘ï¼Œä½†åœ¨æˆ‘ä»¬æ­£å¸¸å‘æ¶ˆæ¯çš„æ—¶å€™ä¸ä¼šå‡ºæ­¤é—®é¢˜ã€‚ä½†å¦‚æžœæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª NSInvocation å¯¹è±¡å¹¶è°ƒç”¨ invokeï¼Œå¹¶å°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®æˆä¸€ä¸ªä¸å­˜åœ¨çš„ selectorï¼Œé‚£å°±ä¼šå¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œå¹¶è¾“å…¥æ—¥å¿— â€œdoes not match selector known to Objective C runtimeâ€ã€‚è¾ƒçœŸå„¿çš„è¯»è€…å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šä½•è¿™æ®µé€»è¾‘åˆ¤æ–­å¹²è„†ç”¨ä¸åˆ°å´è¿˜å­˜åœ¨ç€ï¼Ÿéš¾é“é™¤äº† __CF_forwarding_prep_0 å’Œ ___forwarding_prep_1___ å‡½æ•°è¿˜æœ‰å…¶ä»–å‡½æ•°ä¹Ÿè°ƒç”¨ ___forwarding___ ä¹ˆï¼ŸèŽ«éžæ¶ˆæ¯è½¬å‘è¿˜æœ‰å…¶ä»–è·¯å¾„ï¼Ÿå…¶å®žå¹¶ä¸æ˜¯ï¼åŽŸå› æ˜¯ ___forwarding___ è°ƒç”¨äº† ___invoking___ å‡½æ•°ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¼ªä»£ç ç›´æŽ¥æŠŠ ___invoking___ å‡½æ•°çš„é€»è¾‘ä¹Ÿã€Žç¿»è¯‘ã€è¿‡æ¥äº†ã€‚é™¤äº† ___forwarding___ å‡½æ•°ï¼Œä»¥ä¸‹æ–¹æ³•ä¹Ÿä¼šè°ƒç”¨___invoking___ å‡½æ•°: 123-[NSInvocation invoke]-[NSInvocation invokeUsingIMP:]-[NSInvocation invokeSuper] doesNotRecognizeSelector æ–¹æ³•å…¶å®žåœ¨ libobj.A.dylib ä¸­å·²ç»åºŸå¼ƒäº†ï¼Œè€Œæ˜¯åœ¨ CF æ¡†æž¶ä¸­å®žçŽ°ï¼Œè€Œä¸”ä¹Ÿä¸æ˜¯å¼€æºçš„ã€‚ä»Žå‡½æ•°è°ƒç”¨æ ˆå¯ä»¥å‘çŽ° doesNotRecognizeSelector ä¹‹åŽä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ Runtime ä¸­åºŸå¼ƒçš„å®žçŽ°åªæ˜¯æ‰“æ—¥å¿—åŽç›´æŽ¥æ€æŽ‰è¿›ç¨‹ï¼ˆ__builtin_trap()ï¼‰ã€‚ä¸‹é¢æ˜¯ CF ä¸­å®žçŽ°çš„ä¼ªä»£ç ï¼š 123456789101112131415161718192021222324void -[NSObject doesNotRecognizeSelector:](void * self, void * _cmd, void * arg2) &#123; r14 = ___CFFullMethodName([self class], self, arg2); _CFLog(0x3, @&quot;%@: unrecognized selector sent to instance %p&quot;, r14, self, r8, r9, stack[2048]); rbx = _CFMakeCollectable(_CFStringCreateWithFormat(___kCFAllocatorSystemDefault, 0x0, @&quot;%@: unrecognized selector sent to instance %p&quot;)); if (*(int8_t *)___CFOASafe != 0x0) &#123; ___CFRecordAllocationEvent(); &#125; rax = _objc_rootAutorelease(rbx); rax = [NSException exceptionWithName:@&quot;NSInvalidArgumentException&quot; reason:rax userInfo:0x0]; objc_exception_throw(rax); return;&#125;void +[NSObject doesNotRecognizeSelector:](void * self, void * _cmd, void * arg2) &#123; r14 = ___CFFullMethodName([self class], self, arg2); _CFLog(0x3, @&quot;%@: unrecognized selector sent to class %p&quot;, r14, self, r8, r9, stack[2048]); rbx = _CFMakeCollectable(_CFStringCreateWithFormat(___kCFAllocatorSystemDefault, 0x0, @&quot;%@: unrecognized selector sent to class %p&quot;)); if (*(int8_t *)___CFOASafe != 0x0) &#123; ___CFRecordAllocationEvent(); &#125; rax = _objc_rootAutorelease(rbx); rax = [NSException exceptionWithName:@&quot;NSInvalidArgumentException&quot; reason:rax userInfo:0x0]; objc_exception_throw(rax); return;&#125; ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ override doesNotRecognizeSelector æˆ–è€…æ•èŽ·å…¶æŠ›å‡ºçš„å¼‚å¸¸ã€‚åœ¨è¿™é‡Œè¿˜æ˜¯å¤§æœ‰æ–‡ç« å¯åšçš„ã€‚ æ€»ç»“æˆ‘å°†æ•´ä¸ªå®žçŽ°æµç¨‹ç»˜åˆ¶å‡ºæ¥ï¼Œè¿‡æ»¤äº†ä¸€äº›ä¸ä¼šè¿›å…¥çš„åˆ†æ”¯è·¯å¾„å’Œè·Ÿä¸»é¢˜æ— å…³çš„ç»†èŠ‚ï¼š æ¶ˆæ¯å‘é€ä¸Žè½¬å‘è·¯å¾„æµç¨‹å›¾ ä»‹äºŽå›½å†…å…³äºŽè¿™å—çŸ¥è¯†çš„å¥½å¤šæ–‡ç« æè¿°ä¸å¤Ÿå‡†ç¡®å’Œè¯¦ç»†ï¼Œæˆ–æ˜¯å¯¹æ¶ˆæ¯è½¬å‘çš„åŽŸç†æè¿°ç†è§£ä¸å¤Ÿæ·±åˆ»ï¼Œæˆ–æ˜¯ä¾§é‡è´´æºç è€Œæ¬ æ€è€ƒï¼Œæ‰€ä»¥æˆ‘åšäº†ä¸€ä¸ªæ¯”è¾ƒå…¨é¢è¯¦ç»†çš„è®²è§£ã€‚ è½¬è‡ª çŽ‰ä»¤å¤©ä¸‹çš„åšå®¢]]></content>
      <categories>
        <category>runtime</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[runtimeç†è§£]]></title>
    <url>%2F2018%2F09%2F13%2Fruntime%E7%90%86%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯Runtime æˆ‘ä»¬å†™çš„ä»£ç åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šè¢«è½¬åŒ–æˆruntimeçš„Cä»£ç æ‰§è¡Œï¼Œä¾‹å¦‚[target doSomething];ä¼šè¢«è½¬åŒ–æˆobjc_msgSend(target, @selector(doSomething));ã€‚ OCä¸­ä¸€åˆ‡éƒ½è¢«è®¾è®¡æˆäº†å¯¹è±¡ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªç±»è¢«åˆå§‹åŒ–æˆä¸€ä¸ªå®žä¾‹ï¼Œè¿™ä¸ªå®žä¾‹æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å®žé™…ä¸Šä¸€ä¸ªç±»æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨runtimeä¸­ç”¨ç»“æž„ä½“è¡¨ç¤ºã€‚ ç›¸å…³çš„å®šä¹‰ï¼š 1234567891011/// æè¿°ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•typedef struct objc_method *Method;/// å®žä¾‹å˜é‡typedef struct objc_ivar *Ivar;/// ç±»åˆ«Categorytypedef struct objc_category *Category;/// ç±»ä¸­å£°æ˜Žçš„å±žæ€§typedef struct objc_property *objc_property_t; ç±»åœ¨runtimeä¸­çš„è¡¨ç¤º 12345678910111213141516171819//ç±»åœ¨runtimeä¸­çš„è¡¨ç¤ºstruct objc_class &#123; Class isa;//æŒ‡é’ˆï¼Œé¡¾åæ€ä¹‰ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªä»€ä¹ˆï¼Œ //å®žä¾‹çš„isaæŒ‡å‘ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡çš„isaæŒ‡å‘å…ƒç±»#if !__OBJC2__ Class super_class; //æŒ‡å‘çˆ¶ç±» const char *name; //ç±»å long version; long info; long instance_size struct objc_ivar_list *ivars //æˆå‘˜å˜é‡åˆ—è¡¨ struct objc_method_list **methodLists; //æ–¹æ³•åˆ—è¡¨ struct objc_cache *cache;//ç¼“å­˜ //ä¸€ç§ä¼˜åŒ–ï¼Œè°ƒç”¨è¿‡çš„æ–¹æ³•å­˜å…¥ç¼“å­˜åˆ—è¡¨ï¼Œä¸‹æ¬¡è°ƒç”¨å…ˆæ‰¾ç¼“å­˜ struct objc_protocol_list *protocols //åè®®åˆ—è¡¨ #endif&#125; OBJC2_UNAVAILABLE;/* Use `Class` instead of `struct objc_class *` */ èŽ·å–åˆ—è¡¨æœ‰æ—¶å€™ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰ç±»ä¸­æ¯ä¸ªå±žæ€§çš„åå­—ï¼ˆæ¯”å¦‚å­—å…¸è½¬æ¨¡åž‹ï¼Œå­—å…¸çš„Keyå’Œæ¨¡åž‹å¯¹è±¡çš„å±žæ€§åå­—ä¸åŒ¹é…ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡runtimeçš„ä¸€ç³»åˆ—æ–¹æ³•èŽ·å–ç±»çš„ä¸€äº›ä¿¡æ¯ï¼ˆåŒ…æ‹¬å±žæ€§åˆ—è¡¨ï¼Œæ–¹æ³•åˆ—è¡¨ï¼Œæˆå‘˜å˜é‡åˆ—è¡¨ï¼Œå’Œéµå¾ªçš„åè®®åˆ—è¡¨ï¼‰ã€‚ 123456789101112131415161718192021222324252627282930unsigned int count; //èŽ·å–å±žæ€§åˆ—è¡¨ objc_property_t *propertyList = class_copyPropertyList([self class], &amp;count); for (unsigned int i=0; i&lt;count; i++) &#123; const char *propertyName = property_getName(propertyList[i]); NSLog(@&quot;property----&gt;%@&quot;, [NSString stringWithUTF8String:propertyName]); &#125; //èŽ·å–æ–¹æ³•åˆ—è¡¨ Method *methodList = class_copyMethodList([self class], &amp;count); for (unsigned int i; i&lt;count; i++) &#123; Method method = methodList[i]; NSLog(@&quot;method----&gt;%@&quot;, NSStringFromSelector(method_getName(method))); &#125; //èŽ·å–æˆå‘˜å˜é‡åˆ—è¡¨ Ivar *ivarList = class_copyIvarList([self class], &amp;count); for (unsigned int i; i&lt;count; i++) &#123; Ivar myIvar = ivarList[i]; const char *ivarName = ivar_getName(myIvar); NSLog(@&quot;Ivar----&gt;%@&quot;, [NSString stringWithUTF8String:ivarName]); &#125; //èŽ·å–åè®®åˆ—è¡¨ __unsafe_unretained Protocol **protocolList = class_copyProtocolList([self class], &amp;count); for (unsigned int i; i&lt;count; i++) &#123; Protocol *myProtocal = protocolList[i]; const char *protocolName = protocol_getName(myProtocal); NSLog(@&quot;protocol----&gt;%@&quot;, [NSString stringWithUTF8String:protocolName]); &#125; åœ¨Xcodeä¸Šè·‘ä¸€ä¸‹çœ‹çœ‹è¾“å‡ºå§ï¼Œéœ€è¦ç»™ä½ å½“å‰çš„ç±»å†™å‡ ä¸ªå±žæ€§ï¼Œæˆå‘˜å˜é‡ï¼Œæ–¹æ³•å’Œåè®®ï¼Œä¸ç„¶èŽ·å–çš„åˆ—è¡¨æ˜¯æ²¡æœ‰ä¸œè¥¿çš„ã€‚æ³¨æ„ï¼Œè°ƒç”¨è¿™äº›èŽ·å–åˆ—è¡¨çš„æ–¹æ³•åˆ«å¿˜è®°å¯¼å…¥å¤´æ–‡ä»¶#import &lt;objc/runtime.h&gt;ã€‚ æ–¹æ³•è°ƒç”¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ–¹æ³•è°ƒç”¨åœ¨è¿è¡Œæ—¶çš„è¿‡ç¨‹ï¼ˆå‚ç…§å‰æ–‡ç±»åœ¨runtimeä¸­çš„è¡¨ç¤ºï¼‰ å¦‚æžœç”¨å®žä¾‹å¯¹è±¡è°ƒç”¨å®žä¾‹æ–¹æ³•ï¼Œä¼šåˆ°å®žä¾‹çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯ç±»å¯¹è±¡ï¼‰æ“ä½œã€‚å¦‚æžœè°ƒç”¨çš„æ˜¯ç±»æ–¹æ³•ï¼Œå°±ä¼šåˆ°ç±»å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯å…ƒç±»å¯¹è±¡ï¼‰ä¸­æ“ä½œã€‚ é¦–å…ˆï¼Œåœ¨ç›¸åº”æ“ä½œçš„å¯¹è±¡ä¸­çš„ç¼“å­˜æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾è°ƒç”¨çš„æ–¹æ³•ï¼Œå¦‚æžœæ‰¾åˆ°ï¼Œè½¬å‘ç›¸åº”å®žçŽ°å¹¶æ‰§è¡Œã€‚ å¦‚æžœæ²¡æ‰¾åˆ°ï¼Œåœ¨ç›¸åº”æ“ä½œçš„å¯¹è±¡ä¸­çš„æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾è°ƒç”¨çš„æ–¹æ³•ï¼Œå¦‚æžœæ‰¾åˆ°ï¼Œè½¬å‘ç›¸åº”å®žçŽ°æ‰§è¡Œ å¦‚æžœæ²¡æ‰¾åˆ°ï¼ŒåŽ»çˆ¶ç±»æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡ä¸­æ‰§è¡Œ1ï¼Œ2. ä»¥æ­¤ç±»æŽ¨ï¼Œå¦‚æžœä¸€ç›´åˆ°æ ¹ç±»è¿˜æ²¡æ‰¾åˆ°ï¼Œè½¬å‘æ‹¦æˆªè°ƒç”¨ã€‚ å¦‚æžœæ²¡æœ‰é‡å†™æ‹¦æˆªè°ƒç”¨çš„æ–¹æ³•ï¼Œç¨‹åºæŠ¥é”™ã€‚ ä»¥ä¸Šçš„è¿‡ç¨‹ç»™æˆ‘å¸¦æ¥çš„å¯å‘ï¼š é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰è¦†ç›–æŽ‰çˆ¶ç±»çš„æ–¹æ³•ï¼Œåªæ˜¯åœ¨å½“å‰ç±»å¯¹è±¡ä¸­æ‰¾åˆ°äº†è¿™ä¸ªæ–¹æ³•åŽå°±ä¸ä¼šå†åŽ»çˆ¶ç±»ä¸­æ‰¾äº†ã€‚ å¦‚æžœæƒ³è°ƒç”¨å·²ç»é‡å†™è¿‡çš„æ–¹æ³•çš„çˆ¶ç±»çš„å®žçŽ°ï¼Œåªéœ€ä½¿ç”¨superè¿™ä¸ªç¼–è¯‘å™¨æ ‡è¯†ï¼Œå®ƒä¼šåœ¨è¿è¡Œæ—¶è·³è¿‡åœ¨å½“å‰çš„ç±»å¯¹è±¡ä¸­å¯»æ‰¾æ–¹æ³•çš„è¿‡ç¨‹ã€‚ æ‹¦æˆªè°ƒç”¨åœ¨æ–¹æ³•è°ƒç”¨ä¸­è¯´åˆ°äº†ï¼Œå¦‚æžœæ²¡æœ‰æ‰¾åˆ°æ–¹æ³•å°±ä¼šè½¬å‘æ‹¦æˆªè°ƒç”¨ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯æ‹¦æˆªè°ƒç”¨å‘¢ã€‚æ‹¦æˆªè°ƒç”¨å°±æ˜¯ï¼Œåœ¨æ‰¾ä¸åˆ°è°ƒç”¨çš„æ–¹æ³•ç¨‹åºå´©æºƒä¹‹å‰ï¼Œä½ æœ‰æœºä¼šé€šè¿‡é‡å†™NSObjectçš„å››ä¸ªæ–¹æ³•æ¥å¤„ç†ã€‚ 12345+ (BOOL)resolveClassMethod:(SEL)sel;+ (BOOL)resolveInstanceMethod:(SEL)sel;//åŽä¸¤ä¸ªæ–¹æ³•éœ€è¦è½¬å‘åˆ°å…¶ä»–çš„ç±»å¤„ç†- (id)forwardingTargetForSelector:(SEL)aSelector;- (void)forwardInvocation:(NSInvocation *)anInvocation; ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯å½“ä½ è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„ç±»æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œé»˜è®¤è¿”å›žNOï¼Œä½ å¯ä»¥åŠ ä¸Šè‡ªå·±çš„å¤„ç†ç„¶åŽè¿”å›žYESã€‚ ç¬¬äºŒä¸ªæ–¹æ³•å’Œç¬¬ä¸€ä¸ªæ–¹æ³•ç›¸ä¼¼ï¼Œåªä¸è¿‡å¤„ç†çš„æ˜¯å®žä¾‹æ–¹æ³•ã€‚ ç¬¬ä¸‰ä¸ªæ–¹æ³•æ˜¯å°†ä½ è°ƒç”¨çš„ä¸å­˜åœ¨çš„æ–¹æ³•é‡å®šå‘åˆ°ä¸€ä¸ªå…¶ä»–å£°æ˜Žäº†è¿™ä¸ªæ–¹æ³•çš„ç±»ï¼Œåªéœ€è¦ä½ è¿”å›žä¸€ä¸ªæœ‰è¿™ä¸ªæ–¹æ³•çš„targetã€‚ ç¬¬å››ä¸ªæ–¹æ³•æ˜¯å°†ä½ è°ƒç”¨çš„ä¸å­˜åœ¨çš„æ–¹æ³•æ‰“åŒ…æˆNSInvocationä¼ ç»™ä½ ã€‚åšå®Œä½ è‡ªå·±çš„å¤„ç†åŽï¼Œè°ƒç”¨invokeWithTarget:æ–¹æ³•è®©æŸä¸ªtargetè§¦å‘è¿™ä¸ªæ–¹æ³•ã€‚ åŠ¨æ€æ·»åŠ æ–¹æ³•é‡å†™äº†æ‹¦æˆªè°ƒç”¨çš„æ–¹æ³•å¹¶ä¸”è¿”å›žäº†YESï¼Œæˆ‘ä»¬è¦æ€Žä¹ˆå¤„ç†å‘¢ï¼Ÿæœ‰ä¸€ä¸ªåŠžæ³•æ˜¯æ ¹æ®ä¼ è¿›æ¥çš„SELç±»åž‹çš„selectoråŠ¨æ€æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚ é¦–å…ˆä»Žå¤–éƒ¨éšå¼è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•ï¼š 12//éšå¼è°ƒç”¨æ–¹æ³•[target performSelector:@selector(resolveAdd:) withObject:@&quot;test&quot;]; ç„¶åŽï¼Œåœ¨targetå¯¹è±¡å†…éƒ¨é‡å†™æ‹¦æˆªè°ƒç”¨çš„æ–¹æ³•ï¼ŒåŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚ 1234567891011void runAddMethod(id self, SEL _cmd, NSString *string)&#123; NSLog(@&quot;add C IMP &quot;, string);&#125;+ (BOOL)resolveInstanceMethod:(SEL)sel&#123; //ç»™æœ¬ç±»åŠ¨æ€æ·»åŠ ä¸€ä¸ªæ–¹æ³• if ([NSStringFromSelector(sel) isEqualToString:@&quot;resolveAdd:&quot;]) &#123; class_addMethod(self, sel, (IMP)runAddMethod, &quot;v@:*&quot;); &#125; return YES;&#125; å…¶ä¸­class_addMethodçš„å››ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š Class clsç»™å“ªä¸ªç±»æ·»åŠ æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­æ˜¯self SEL nameæ·»åŠ çš„æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­æ˜¯é‡å†™çš„æ‹¦æˆªè°ƒç”¨ä¼ è¿›æ¥çš„selectorã€‚ IMP impæ–¹æ³•çš„å®žçŽ°ï¼ŒCæ–¹æ³•çš„æ–¹æ³•å®žçŽ°å¯ä»¥ç›´æŽ¥èŽ·å¾—ã€‚å¦‚æžœæ˜¯OCæ–¹æ³•ï¼Œå¯ä»¥ç”¨+ (IMP)instanceMethodForSelector:(SEL)aSelector;èŽ·å¾—æ–¹æ³•çš„å®žçŽ°ã€‚ &quot;v@:*&quot;æ–¹æ³•çš„ç­¾åï¼Œä»£è¡¨æœ‰ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•ã€‚ å…³è”å¯¹è±¡çŽ°åœ¨ä½ å‡†å¤‡ç”¨ä¸€ä¸ªç³»ç»Ÿçš„ç±»ï¼Œä½†æ˜¯ç³»ç»Ÿçš„ç±»å¹¶ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ éœ€è¦é¢å¤–æ·»åŠ ä¸€ä¸ªå±žæ€§ã€‚è¿™ç§æƒ…å†µçš„ä¸€èˆ¬è§£å†³åŠžæ³•å°±æ˜¯ç»§æ‰¿ã€‚ä½†æ˜¯ï¼Œåªå¢žåŠ ä¸€ä¸ªå±žæ€§ï¼Œå°±åŽ»ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œæ€»æ˜¯è§‰å¾—å¤ªéº»çƒ¦ç±»ã€‚è¿™ä¸ªæ—¶å€™ï¼Œruntimeçš„å…³è”å±žæ€§å°±å‘æŒ¥å®ƒçš„ä½œç”¨äº†ã€‚ 123456//é¦–å…ˆå®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨å®ƒçš„åœ°å€ä½œä¸ºå…³è”å¯¹è±¡çš„keystatic char associatedObjectKey;//è®¾ç½®å…³è”å¯¹è±¡objc_setAssociatedObject(target, &amp;associatedObjectKey, @&quot;æ·»åŠ çš„å­—ç¬¦ä¸²å±žæ€§&quot;, OBJC_ASSOCIATION_RETAIN_NONATOMIC); //èŽ·å–å…³è”å¯¹è±¡NSString *string = objc_getAssociatedObject(target, &amp;associatedObjectKey);NSLog(@&quot;AssociatedObject = %@&quot;, string); objc_setAssociatedObjectçš„å››ä¸ªå‚æ•°ï¼š id objectç»™è°è®¾ç½®å…³è”å¯¹è±¡ã€‚ const void *keyå…³è”å¯¹è±¡å”¯ä¸€çš„keyï¼ŒèŽ·å–æ—¶ä¼šç”¨åˆ°ã€‚ id valueå…³è”å¯¹è±¡ã€‚ objc_AssociationPolicyå…³è”ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š 1234567enum &#123; OBJC_ASSOCIATION_ASSIGN = 0, OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, OBJC_ASSOCIATION_COPY_NONATOMIC = 3, OBJC_ASSOCIATION_RETAIN = 01401, OBJC_ASSOCIATION_COPY = 01403 &#125;; å¦‚æžœä½ ç†Ÿæ‚‰OCï¼Œçœ‹åå­—åº”è¯¥çŸ¥é“è¿™å‡ ç§ç­–ç•¥çš„æ„æ€äº†å§ã€‚ objc_getAssociatedObjectçš„ä¸¤ä¸ªå‚æ•°ã€‚ id objectèŽ·å–è°çš„å…³è”å¯¹è±¡ã€‚ const void *keyæ ¹æ®è¿™ä¸ªå”¯ä¸€çš„keyèŽ·å–å…³è”å¯¹è±¡ã€‚ å…¶å®žï¼Œä½ è¿˜å¯ä»¥æŠŠæ·»åŠ å’ŒèŽ·å–å…³è”å¯¹è±¡çš„æ–¹æ³•å†™åœ¨ä½ éœ€è¦ç”¨åˆ°è¿™ä¸ªåŠŸèƒ½çš„ç±»çš„ç±»åˆ«ä¸­ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚ 12345678//æ·»åŠ å…³è”å¯¹è±¡- (void)addAssociatedObject:(id)object&#123; objc_setAssociatedObject(self, @selector(getAssociatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);&#125;//èŽ·å–å…³è”å¯¹è±¡- (id)getAssociatedObject&#123; return objc_getAssociatedObject(self, _cmd);&#125; æ³¨æ„ï¼šè¿™é‡Œé¢æˆ‘ä»¬æŠŠgetAssociatedObjectæ–¹æ³•çš„åœ°å€ä½œä¸ºå”¯ä¸€çš„keyï¼Œ_cmdä»£è¡¨å½“å‰è°ƒç”¨æ–¹æ³•çš„åœ°å€ã€‚ æ–¹æ³•äº¤æ¢æ–¹æ³•äº¤æ¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†ä¸¤ä¸ªæ–¹æ³•çš„å®žçŽ°äº¤æ¢ã€‚ä¾‹å¦‚ï¼Œå°†Aæ–¹æ³•å’ŒBæ–¹æ³•äº¤æ¢ï¼Œè°ƒç”¨Aæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡ŒBæ–¹æ³•ä¸­çš„ä»£ç ï¼Œåä¹‹äº¦ç„¶ã€‚è¯ä¸å¤šè¯´ï¼Œè¿™æ˜¯å‚è€ƒMatttå¤§ç¥žåœ¨NSHipsterä¸Šçš„æ–‡ç« è‡ªå·±å†™çš„ä»£ç ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142#import &quot;UIViewController+swizzling.h&quot;#import &lt;objc/runtime.h&gt;@implementation UIViewController (swizzling)//loadæ–¹æ³•ä¼šåœ¨ç±»ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™è¢«è°ƒç”¨//è°ƒç”¨çš„æ—¶é—´æ¯”è¾ƒé å‰ï¼Œé€‚åˆåœ¨è¿™ä¸ªæ–¹æ³•é‡Œåšæ–¹æ³•äº¤æ¢+ (void)load&#123; //æ–¹æ³•äº¤æ¢åº”è¯¥è¢«ä¿è¯ï¼Œåœ¨ç¨‹åºä¸­åªä¼šæ‰§è¡Œä¸€æ¬¡ static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; //èŽ·å¾—viewControllerçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„selector SEL systemSel = @selector(viewWillAppear:); //è‡ªå·±å®žçŽ°çš„å°†è¦è¢«äº¤æ¢çš„æ–¹æ³•çš„selector SEL swizzSel = @selector(swiz_viewWillAppear:); //ä¸¤ä¸ªæ–¹æ³•çš„Method Method systemMethod = class_getInstanceMethod([self class], systemSel); Method swizzMethod = class_getInstanceMethod([self class], swizzSel); //é¦–å…ˆåŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œå®žçŽ°æ˜¯è¢«äº¤æ¢çš„æ–¹æ³•ï¼Œè¿”å›žå€¼è¡¨ç¤ºæ·»åŠ æˆåŠŸè¿˜æ˜¯å¤±è´¥ BOOL isAdd = class_addMethod(self, systemSel, method_getImplementation(swizzMethod), method_getTypeEncoding(swizzMethod)); if (isAdd) &#123; //å¦‚æžœæˆåŠŸï¼Œè¯´æ˜Žç±»ä¸­ä¸å­˜åœ¨è¿™ä¸ªæ–¹æ³•çš„å®žçŽ° //å°†è¢«äº¤æ¢æ–¹æ³•çš„å®žçŽ°æ›¿æ¢åˆ°è¿™ä¸ªå¹¶ä¸å­˜åœ¨çš„å®žçŽ° class_replaceMethod(self, swizzSel, method_getImplementation(systemMethod), method_getTypeEncoding(systemMethod)); &#125;else&#123; //å¦åˆ™ï¼Œäº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®žçŽ° method_exchangeImplementations(systemMethod, swizzMethod); &#125; &#125;);&#125;- (void)swiz_viewWillAppear:(BOOL)animated&#123; //è¿™æ—¶å€™è°ƒç”¨è‡ªå·±ï¼Œçœ‹èµ·æ¥åƒæ˜¯æ­»å¾ªçŽ¯ //ä½†æ˜¯å…¶å®žè‡ªå·±çš„å®žçŽ°å·²ç»è¢«æ›¿æ¢äº† [self swiz_viewWillAppear:animated]; NSLog(@&quot;swizzle&quot;);&#125;@end åœ¨ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„viewControllerä¸­é‡å†™viewWillAppear 1234- (void)viewWillAppear:(BOOL)animated&#123; [super viewWillAppear:animated]; NSLog(@&quot;viewWillAppear&quot;);&#125; Runèµ·æ¥çœ‹çœ‹è¾“å‡ºå§ï¼ æˆ‘çš„ç†è§£ï¼š æ–¹æ³•äº¤æ¢å¯¹äºŽæˆ‘æ¥è¯´æ›´åƒæ˜¯å®žçŽ°ä¸€ç§æ€æƒ³çš„æœ€ä½³æŠ€æœ¯ï¼šAOPé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚ æ—¢ç„¶æ˜¯åˆ‡é¢ï¼Œå°±ä¸€å®šä¸è¦å¿˜è®°ï¼Œäº¤æ¢å®Œå†è°ƒå›žè‡ªå·±ã€‚ ä¸€å®šè¦ä¿è¯åªäº¤æ¢ä¸€æ¬¡ï¼Œå¦åˆ™å°±ä¼šå¾ˆä¹±ã€‚ æœ€åŽï¼Œæ®è¯´è¿™ä¸ªæŠ€æœ¯å¾ˆå±é™©ï¼Œè°¨æ…Žä½¿ç”¨ã€‚ [è½¬è‡ª å…´å®‡æ˜¯è°]]]></content>
      <categories>
        <category>runtime</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[äº‹ä»¶çš„ä¼ é€’å’Œå“åº”æœºåˆ¶]]></title>
    <url>%2F2018%2F09%2F12%2F%E4%BA%8B%E4%BB%B6%E7%9A%84%E4%BC%A0%E9%80%92%E5%92%8C%E5%93%8D%E5%BA%94%E6%9C%BA%E5%88%B6%2F</url>
    <content type="text"><![CDATA[äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’ï¼ˆäº‹ä»¶å¦‚ä½•ä»Žçˆ¶æŽ§ä»¶ä¼ é€’åˆ°å­æŽ§ä»¶å¹¶å¯»æ‰¾åˆ°æœ€åˆé€‚çš„viewã€å¯»æ‰¾æœ€åˆé€‚çš„viewçš„åº•å±‚å®žçŽ°ã€æ‹¦æˆªäº‹ä»¶çš„å¤„ç†ï¼‰-&gt;æ‰¾åˆ°æœ€åˆé€‚çš„viewåŽäº‹ä»¶çš„å¤„ç†ï¼ˆtouchesæ–¹æ³•çš„é‡å†™ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶çš„å“åº”ï¼‰ â€‹ å…¶ä¸­é‡ç‚¹å’Œéš¾ç‚¹æ˜¯ï¼š 1.å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„view 2.å¯»æ‰¾æœ€åˆé€‚çš„viewçš„åº•å±‚å®žçŽ°ï¼ˆhitTest:withEvent:åº•å±‚å®žçŽ°ï¼‰ iOSä¸­çš„äº‹ä»¶iOSä¸­çš„äº‹ä»¶å¯ä»¥åˆ†ä¸º3å¤§ç±»åž‹ï¼š è§¦æ‘¸äº‹ä»¶ åŠ é€Ÿè®¡äº‹ä»¶ è¿œç¨‹æŽ§åˆ¶äº‹ä»¶ æœ¬æ–‡åªè®¨è®ºæŽ¥è§¦äº‹ä»¶ å“åº”è€…å¯¹è±¡(UIResponder)å­¦ä¹ è§¦æ‘¸äº‹ä»¶é¦–å…ˆè¦äº†è§£ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µ-å“åº”è€…å¯¹è±¡ï¼ˆUIResponderï¼‰ã€‚ åœ¨iOSä¸­ä¸æ˜¯ä»»ä½•å¯¹è±¡éƒ½èƒ½å¤„ç†äº‹ä»¶ï¼Œåªæœ‰ç»§æ‰¿äº†UIResponderçš„å¯¹è±¡æ‰èƒ½æŽ¥å—å¹¶å¤„ç†äº‹ä»¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå“åº”è€…å¯¹è±¡â€ã€‚ä»¥ä¸‹éƒ½æ˜¯ç»§æ‰¿è‡ªUIResponderçš„ï¼Œæ‰€ä»¥éƒ½èƒ½æŽ¥æ”¶å¹¶å¤„ç†äº‹ä»¶ã€‚ UIApplication UIViewController UIView é‚£ä¹ˆä¸ºä»€ä¹ˆç»§æ‰¿è‡ªUIResponderçš„ç±»å°±èƒ½å¤ŸæŽ¥æ”¶å¹¶å¤„ç†äº‹ä»¶å‘¢ï¼Ÿ å› ä¸ºUIResponderä¸­æä¾›äº†ä»¥ä¸‹4ä¸ªå¯¹è±¡æ–¹æ³•æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ã€‚ 12345678910111213141516UIResponderå†…éƒ¨æä¾›äº†ä»¥ä¸‹æ–¹æ³•æ¥å¤„ç†äº‹ä»¶è§¦æ‘¸äº‹ä»¶- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event;- (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event;- (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event;- (void)touchesCancelled:(NSSet *)touches withEvent:(UIEvent *)event;åŠ é€Ÿè®¡äº‹ä»¶- (void)motionBegan:(UIEventSubtype)motion withEvent:(UIEvent *)event;- (void)motionEnded:(UIEventSubtype)motion withEvent:(UIEvent *)event;- (void)motionCancelled:(UIEventSubtype)motion withEvent:(UIEvent *)event;è¿œç¨‹æŽ§åˆ¶äº‹ä»¶- (void)remoteControlReceivedWithEvent:(UIEvent *)event;ä½œè€…ï¼šVVæœ¨å…¬å­é“¾æŽ¥ï¼šhttps://www.jianshu.com/p/2e074db792baä¾†æºï¼šç®€ä¹¦ç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…èŽ·å¾—æŽˆæƒå¹¶æ³¨æ˜Žå‡ºå¤„ã€‚ iOSä¸­çš„äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’äº‹ä»¶çš„äº§ç”Ÿå‘ç”Ÿè§¦æ‘¸äº‹ä»¶åŽï¼Œç³»ç»Ÿä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°ä¸€ä¸ªç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­,ä¸ºä»€ä¹ˆæ˜¯é˜Ÿåˆ—è€Œä¸æ˜¯æ ˆï¼Ÿå› ä¸ºé˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯FIFOï¼Œå³å…ˆè¿›å…ˆå‡ºï¼Œå…ˆäº§ç”Ÿçš„äº‹ä»¶å…ˆå¤„ç†æ‰ç¬¦åˆå¸¸ç†ï¼Œæ‰€ä»¥æŠŠäº‹ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—ã€‚ UIApplicationä¼šä»Žäº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼Œå¹¶å°†äº‹ä»¶åˆ†å‘ä¸‹åŽ»ä»¥ä¾¿å¤„ç†ï¼Œé€šå¸¸ï¼Œå…ˆå‘é€äº‹ä»¶ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰ã€‚ ä¸»çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æž„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªäº‹ä»¶å¤„ç†è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ã€‚æ‰¾åˆ°åˆé€‚çš„è§†å›¾æŽ§ä»¶åŽï¼Œå°±ä¼šè°ƒç”¨è§†å›¾æŽ§ä»¶çš„touchesæ–¹æ³•æ¥ä½œå…·ä½“çš„äº‹ä»¶å¤„ç†ã€‚ äº‹ä»¶çš„ä¼ é€’ è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’æ˜¯ä»Žçˆ¶æŽ§ä»¶ä¼ é€’åˆ°å­æŽ§ä»¶ ä¹Ÿå°±æ˜¯UIApplication-&gt;window-&gt;å¯»æ‰¾å¤„ç†äº‹ä»¶æœ€åˆé€‚çš„view æ³¨ æ„: å¦‚æžœçˆ¶æŽ§ä»¶ä¸èƒ½æŽ¥å—è§¦æ‘¸äº‹ä»¶ï¼Œé‚£ä¹ˆå­æŽ§ä»¶å°±ä¸å¯èƒ½æŽ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶ åº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æŽ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ1.é¦–å…ˆåˆ¤æ–­ä¸»çª—å£ï¼ˆkeyWindowï¼‰è‡ªå·±æ˜¯å¦èƒ½æŽ¥å—è§¦æ‘¸äº‹ä»¶ 2.åˆ¤æ–­è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è‡ªå·±èº«ä¸Š 3.å­æŽ§ä»¶æ•°ç»„ä¸­ä»ŽåŽå¾€å‰éåŽ†å­æŽ§ä»¶ï¼Œé‡å¤å‰é¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆæ‰€è°“ä»ŽåŽå¾€å‰éåŽ†å­æŽ§ä»¶ï¼Œå°±æ˜¯é¦–å…ˆæŸ¥æ‰¾å­æŽ§ä»¶æ•°ç»„ä¸­æœ€åŽä¸€ä¸ªå…ƒç´ ï¼Œç„¶åŽæ‰§è¡Œ1ã€2æ­¥éª¤ï¼‰ 4.viewï¼Œæ¯”å¦‚å«åšfitViewï¼Œé‚£ä¹ˆä¼šæŠŠè¿™ä¸ªäº‹ä»¶äº¤ç»™è¿™ä¸ªfitViewï¼Œå†éåŽ†è¿™ä¸ªfitViewçš„å­æŽ§ä»¶ï¼Œç›´è‡³æ²¡æœ‰æ›´åˆé€‚çš„viewä¸ºæ­¢ã€‚ 5.å¦‚æžœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­æŽ§ä»¶ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè‡ªå·±æœ€åˆé€‚å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±æ˜¯æœ€åˆé€‚çš„viewã€‚ UIViewä¸èƒ½æŽ¥æ”¶è§¦æ‘¸äº‹ä»¶çš„ä¸‰ç§æƒ…å†µï¼š ä¸å…è®¸äº¤äº’ï¼šuserInteractionEnabled = NO éšè—ï¼šå¦‚æžœæŠŠçˆ¶æŽ§ä»¶éšè—ï¼Œé‚£ä¹ˆå­æŽ§ä»¶ä¹Ÿä¼šéšè—ï¼Œéšè—çš„æŽ§ä»¶ä¸èƒ½æŽ¥å—äº‹ä»¶ é€æ˜Žåº¦ï¼šå¦‚æžœè®¾ç½®ä¸€ä¸ªæŽ§ä»¶çš„é€æ˜Žåº¦&lt;0.01ï¼Œä¼šç›´æŽ¥å½±å“å­æŽ§ä»¶çš„é€æ˜Žåº¦ã€‚alphaï¼š0.0~0.01ä¸ºé€æ˜Žã€‚ æ³¨ æ„:é»˜è®¤UIImageViewä¸èƒ½æŽ¥å—è§¦æ‘¸äº‹ä»¶ï¼Œå› ä¸ºä¸å…è®¸äº¤äº’ï¼Œå³userInteractionEnabled = NOã€‚æ‰€ä»¥å¦‚æžœå¸Œæœ›UIImageViewå¯ä»¥äº¤äº’ï¼Œéœ€è¦è®¾ç½®UIImageViewçš„userInteractionEnabled = YESã€‚ æ€»ç»“ä¸€ä¸‹1.ç‚¹å‡»ä¸€ä¸ªUIViewæˆ–äº§ç”Ÿä¸€ä¸ªè§¦æ‘¸äº‹ä»¶Aï¼Œè¿™ä¸ªè§¦æ‘¸äº‹ä»¶Aä¼šè¢«æ·»åŠ åˆ°ç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼ˆå³ï¼Œé¦–å…ˆæŽ¥æ”¶åˆ°äº‹ä»¶çš„æ˜¯UIApplicationï¼‰ã€‚2.UIApplicationä¼šä»Žäº‹ä»¶å¯¹åˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼ˆæ­¤å¤„å‡è®¾ä¸ºè§¦æ‘¸äº‹ä»¶Aï¼‰ï¼ŒæŠŠäº‹ä»¶Aä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰ã€‚3.çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æž„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ã€‚ï¼ˆè‡³æ­¤ï¼Œç¬¬ä¸€æ­¥å·²å®Œæˆï¼‰ (é‡éš¾ç‚¹ï¼‰å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„viewåº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æŽ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ1.é¦–å…ˆåˆ¤æ–­ä¸»çª—å£ï¼ˆkeyWindowï¼‰è‡ªå·±æ˜¯å¦èƒ½æŽ¥å—è§¦æ‘¸äº‹ä»¶2.è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è‡ªå·±èº«ä¸Š3.ä»ŽåŽå¾€å‰éåŽ†å­æŽ§ä»¶ï¼Œé‡å¤å‰é¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆé¦–å…ˆæŸ¥æ‰¾æ•°ç»„ä¸­æœ€åŽä¸€ä¸ªå…ƒç´ ï¼‰4.å¦‚æžœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­æŽ§ä»¶ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè‡ªå·±æœ€åˆé€‚å¤„ç† è¯¦è¿°ï¼š1.ä¸»çª—å£æŽ¥æ”¶åˆ°åº”ç”¨ç¨‹åºä¼ é€’è¿‡æ¥çš„äº‹ä»¶åŽï¼Œé¦–å…ˆåˆ¤æ–­è‡ªå·±èƒ½å¦æŽ¥æ‰‹è§¦æ‘¸äº‹ä»¶ã€‚å¦‚æžœèƒ½ï¼Œé‚£ä¹ˆåœ¨åˆ¤æ–­è§¦æ‘¸ç‚¹åœ¨ä¸åœ¨çª—å£è‡ªå·±èº«ä¸Š 2.å¦‚æžœè§¦æ‘¸ç‚¹ä¹Ÿåœ¨çª—å£èº«ä¸Šï¼Œé‚£ä¹ˆçª—å£ä¼šä»ŽåŽå¾€å‰éåŽ†è‡ªå·±çš„å­æŽ§ä»¶ï¼ˆéåŽ†è‡ªå·±çš„å­æŽ§ä»¶åªæ˜¯ä¸ºäº†å¯»æ‰¾å‡ºæ¥æœ€åˆé€‚çš„viewï¼‰ 3.éåŽ†åˆ°æ¯ä¸€ä¸ªå­æŽ§ä»¶åŽï¼Œåˆä¼šé‡å¤ä¸Šé¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆä¼ é€’äº‹ä»¶ç»™å­æŽ§ä»¶ï¼Œ1.åˆ¤æ–­å­æŽ§ä»¶èƒ½å¦æŽ¥å—äº‹ä»¶ï¼Œ2.ç‚¹åœ¨ä¸åœ¨å­æŽ§ä»¶ä¸Šï¼‰ 4.å¦‚æ­¤å¾ªçŽ¯éåŽ†å­æŽ§ä»¶ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åˆé€‚çš„viewï¼Œå¦‚æžœæ²¡æœ‰æ›´åˆé€‚çš„å­æŽ§ä»¶ï¼Œé‚£ä¹ˆè‡ªå·±å°±æˆä¸ºæœ€åˆé€‚çš„viewã€‚æ‰¾åˆ°æœ€åˆé€‚çš„viewåŽï¼Œå°±ä¼šè°ƒç”¨è¯¥viewçš„touchesæ–¹æ³•å¤„ç†å…·ä½“çš„äº‹ä»¶ã€‚æ‰€ä»¥ï¼Œåªæœ‰æ‰¾åˆ°æœ€åˆé€‚çš„viewï¼ŒæŠŠäº‹ä»¶ä¼ é€’ç»™æœ€åˆé€‚çš„viewåŽï¼Œæ‰ä¼šè°ƒç”¨touchesæ–¹æ³•è¿›è¡ŒæŽ¥ä¸‹æ¥çš„äº‹ä»¶å¤„ç†ã€‚æ‰¾ä¸åˆ°æœ€åˆé€‚çš„viewï¼Œå°±ä¸ä¼šè°ƒç”¨touchesæ–¹æ³•è¿›è¡Œäº‹ä»¶å¤„ç†ã€‚æ³¨æ„ï¼šä¹‹æ‰€ä»¥ä¼šé‡‡å–ä»ŽåŽå¾€å‰éåŽ†å­æŽ§ä»¶çš„æ–¹å¼å¯»æ‰¾æœ€åˆé€‚çš„viewåªæ˜¯ä¸ºäº†åšä¸€äº›å¾ªçŽ¯ä¼˜åŒ–ã€‚å› ä¸ºç›¸æ¯”è¾ƒä¹‹ä¸‹ï¼ŒåŽæ·»åŠ çš„viewåœ¨ä¸Šé¢ï¼Œé™ä½Žå¾ªçŽ¯æ¬¡æ•°ã€‚ å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æžä¸¤ä¸ªé‡è¦çš„æ–¹æ³•ï¼šhitTest:withEvent:æ–¹æ³•pointInsideæ–¹æ³• 3.3.1.1.hitTestï¼šwithEventï¼šæ–¹æ³•ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Ÿ åªè¦äº‹ä»¶ä¸€ä¼ é€’ç»™ä¸€ä¸ªæŽ§ä»¶,è¿™ä¸ªæŽ§ä»¶å°±ä¼šè°ƒç”¨ä»–è‡ªå·±çš„hitTestï¼šwithEventï¼šæ–¹æ³• ä½œç”¨ å¯»æ‰¾å¹¶è¿”å›žæœ€åˆé€‚çš„view(èƒ½å¤Ÿå“åº”äº‹ä»¶çš„é‚£ä¸ªæœ€åˆé€‚çš„view) æ³¨ æ„ï¼šä¸ç®¡è¿™ä¸ªæŽ§ä»¶èƒ½ä¸èƒ½å¤„ç†äº‹ä»¶ï¼Œä¹Ÿä¸ç®¡è§¦æ‘¸ç‚¹åœ¨ä¸åœ¨è¿™ä¸ªæŽ§ä»¶ä¸Šï¼Œäº‹ä»¶éƒ½ä¼šå…ˆä¼ é€’ç»™è¿™ä¸ªæŽ§ä»¶ï¼ŒéšåŽå†è°ƒç”¨hitTest:withEvent:æ–¹æ³• æ‹¦æˆªäº‹ä»¶çš„å¤„ç† æ­£å› ä¸ºhitTestï¼šwithEventï¼šæ–¹æ³•å¯ä»¥è¿”å›žæœ€åˆé€‚çš„viewï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡é‡å†™hitTestï¼šwithEventï¼šæ–¹æ³•ï¼Œè¿”å›žæŒ‡å®šçš„viewä½œä¸ºæœ€åˆé€‚çš„viewã€‚ ä¸ç®¡ç‚¹å‡»å“ªé‡Œï¼Œæœ€åˆé€‚çš„viewéƒ½æ˜¯hitTestï¼šwithEventï¼šæ–¹æ³•ä¸­è¿”å›žçš„é‚£ä¸ªviewã€‚ é€šè¿‡é‡å†™hitTestï¼šwithEventï¼šï¼Œå°±å¯ä»¥æ‹¦æˆªäº‹ä»¶çš„ä¼ é€’è¿‡ç¨‹ï¼Œæƒ³è®©è°å¤„ç†äº‹ä»¶è°å°±å¤„ç†äº‹ä»¶ã€‚ äº‹ä»¶ä¼ é€’ç»™è°ï¼Œå°±ä¼šè°ƒç”¨è°çš„hitTest:withEvent:æ–¹æ³•ã€‚æ³¨ æ„ï¼šå¦‚æžœhitTest:withEvent:æ–¹æ³•ä¸­è¿”å›žnilï¼Œé‚£ä¹ˆè°ƒç”¨è¯¥æ–¹æ³•çš„æŽ§ä»¶æœ¬èº«å’Œå…¶å­æŽ§ä»¶éƒ½ä¸æ˜¯æœ€åˆé€‚çš„viewï¼Œä¹Ÿå°±æ˜¯åœ¨è‡ªå·±èº«ä¸Šæ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„viewã€‚é‚£ä¹ˆæœ€åˆé€‚çš„viewå°±æ˜¯è¯¥æŽ§ä»¶çš„çˆ¶æŽ§ä»¶ã€‚æ‰€ä»¥äº‹ä»¶çš„ä¼ é€’é¡ºåºæ˜¯è¿™æ ·çš„ï¼š äº§ç”Ÿè§¦æ‘¸äº‹ä»¶-&gt;UIApplicationäº‹ä»¶é˜Ÿåˆ—-&gt;[UIWindow hitTest:withEvent:]-&gt;è¿”å›žæ›´åˆé€‚çš„view-&gt;[å­æŽ§ä»¶ hitTest:withEvent:]-&gt;è¿”å›žæœ€åˆé€‚çš„view äº‹ä»¶ä¼ é€’ç»™çª—å£æˆ–æŽ§ä»¶çš„åŽï¼Œå°±è°ƒç”¨hitTest:withEvent:æ–¹æ³•å¯»æ‰¾æ›´åˆé€‚çš„viewã€‚æ‰€ä»¥æ˜¯ï¼Œå…ˆä¼ é€’äº‹ä»¶ï¼Œå†æ ¹æ®äº‹ä»¶åœ¨è‡ªå·±èº«ä¸Šæ‰¾æ›´åˆé€‚çš„viewã€‚ä¸ç®¡å­æŽ§ä»¶æ˜¯ä¸æ˜¯æœ€åˆé€‚çš„viewï¼Œç³»ç»Ÿé»˜è®¤éƒ½è¦å…ˆæŠŠäº‹ä»¶ä¼ é€’ç»™å­æŽ§ä»¶ï¼Œç»è¿‡å­æŽ§ä»¶è°ƒç”¨å­æŽ§ä»¶è‡ªå·±çš„hitTest:withEvent:æ–¹æ³•éªŒè¯åŽæ‰çŸ¥é“æœ‰æ²¡æœ‰æ›´åˆé€‚çš„viewã€‚å³ä¾¿çˆ¶æŽ§ä»¶æ˜¯æœ€åˆé€‚çš„viewäº†ï¼Œå­æŽ§ä»¶çš„hitTest:withEvent:æ–¹æ³•è¿˜æ˜¯ä¼šè°ƒç”¨ï¼Œä¸ç„¶æ€Žä¹ˆçŸ¥é“æœ‰æ²¡æœ‰æ›´åˆé€‚çš„ï¼å³ï¼Œå¦‚æžœç¡®å®šæœ€ç»ˆçˆ¶æŽ§ä»¶æ˜¯æœ€åˆé€‚çš„viewï¼Œé‚£ä¹ˆè¯¥çˆ¶æŽ§ä»¶çš„å­æŽ§ä»¶çš„hitTest:withEvent:æ–¹æ³•ä¹Ÿæ˜¯ä¼šè¢«è°ƒç”¨çš„ã€‚æŠ€å·§ï¼šæƒ³è®©è°æˆä¸ºæœ€åˆé€‚çš„viewå°±é‡å†™è°è‡ªå·±çš„çˆ¶æŽ§ä»¶çš„hitTest:withEvent:æ–¹æ³•è¿”å›žæŒ‡å®šçš„å­æŽ§ä»¶ï¼Œæˆ–è€…é‡å†™è‡ªå·±çš„hitTest:withEvent:æ–¹æ³• return selfã€‚ä½†æ˜¯ï¼Œå»ºè®®åœ¨çˆ¶æŽ§ä»¶çš„hitTest:withEvent:ä¸­è¿”å›žå­æŽ§ä»¶ä½œä¸ºæœ€åˆé€‚çš„viewï¼ åŽŸå› åœ¨äºŽåœ¨è‡ªå·±çš„hitTest:withEvent:æ–¹æ³•ä¸­è¿”å›žè‡ªå·±æœ‰æ—¶å€™ä¼šå‡ºçŽ°é—®é¢˜ã€‚å› ä¸ºä¼šå­˜åœ¨è¿™ä¹ˆä¸€ç§æƒ…å†µï¼šå½“éåŽ†å­æŽ§ä»¶æ—¶ï¼Œå¦‚æžœè§¦æ‘¸ç‚¹ä¸åœ¨å­æŽ§ä»¶Aè‡ªå·±èº«ä¸Šè€Œæ˜¯åœ¨å­æŽ§ä»¶Bèº«ä¸Šï¼Œè¿˜è¦è¦æ±‚è¿”å›žå­æŽ§ä»¶Aä½œä¸ºæœ€åˆé€‚çš„viewï¼Œé‡‡ç”¨è¿”å›žè‡ªå·±çš„æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´è¿˜æ²¡æœ‰æ¥å¾—åŠéåŽ†Aè‡ªå·±ï¼Œå°±æœ‰å¯èƒ½å·²ç»éåŽ†äº†ç‚¹çœŸæ­£æ‰€åœ¨çš„viewï¼Œä¹Ÿå°±æ˜¯Bã€‚è¿™å°±å¯¼è‡´äº†è¿”å›žçš„ä¸æ˜¯è‡ªå·±è€Œæ˜¯è§¦æ‘¸ç‚¹çœŸæ­£æ‰€åœ¨çš„viewã€‚æ‰€ä»¥è¿˜æ˜¯å»ºè®®åœ¨çˆ¶æŽ§ä»¶çš„hitTest:withEvent:ä¸­è¿”å›žå­æŽ§ä»¶ä½œä¸ºæœ€åˆé€‚çš„viewï¼ä¾‹å¦‚ï¼šwhiteViewæœ‰redViewå’ŒgreenViewä¸¤ä¸ªå­æŽ§ä»¶ã€‚redViewå…ˆæ·»åŠ ï¼ŒgreenViewåŽæ·»åŠ ã€‚å¦‚æžœè¦æ±‚æ— è®ºç‚¹å‡»é‚£é‡Œéƒ½è¦è®©redViewä½œä¸ºæœ€åˆé€‚çš„viewï¼ˆæŠŠäº‹ä»¶äº¤ç»™redViewæ¥å¤„ç†ï¼‰é‚£ä¹ˆåªèƒ½åœ¨whiteViewçš„hitTest:withEvent:æ–¹æ³•ä¸­return self.subViews[0];è¿™ç§æƒ…å†µä¸‹åœ¨redViewçš„hitTest:withEvent:æ–¹æ³•ä¸­return self;æ˜¯ä¸å¥½ä½¿çš„ï¼ 123456789101112131415161718192021// è¿™é‡ŒredViewæ˜¯whiteViewçš„ç¬¬0ä¸ªå­æŽ§ä»¶#import &quot;redView.h&quot;@implementation redView- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123; return self;&#125;- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; NSLog(@&quot;red-touch&quot;);&#125;@end// æˆ–è€…#import &quot;whiteView.h&quot;@implementation whiteView- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123; return self.subviews[0];&#125;- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; NSLog(@&quot;white-touch&quot;);&#125;@end ç‰¹æ®Šæƒ…å†µï¼šè°éƒ½ä¸èƒ½å¤„ç†äº‹ä»¶ï¼Œçª—å£ä¹Ÿä¸èƒ½å¤„ç†ã€‚ é‡å†™windowçš„hitTestï¼šwithEventï¼šæ–¹æ³•return nil åªèƒ½æœ‰çª—å£å¤„ç†äº‹ä»¶ã€‚ æŽ§åˆ¶å™¨çš„viewçš„hitTestï¼šwithEventï¼šæ–¹æ³•return nilæˆ–è€…windowçš„hitTestï¼šwithEventï¼šæ–¹æ³•return self return nilçš„å«ä¹‰ï¼šhitTestï¼šwithEventï¼šä¸­return nilçš„æ„æ€æ˜¯è°ƒç”¨å½“å‰hitTestï¼šwithEventï¼šæ–¹æ³•çš„viewä¸æ˜¯åˆé€‚çš„viewï¼Œå­æŽ§ä»¶ä¹Ÿä¸æ˜¯åˆé€‚çš„viewã€‚å¦‚æžœåŒçº§çš„å…„å¼ŸæŽ§ä»¶ä¹Ÿæ²¡æœ‰åˆé€‚çš„viewï¼Œé‚£ä¹ˆæœ€åˆé€‚çš„viewå°±æ˜¯çˆ¶æŽ§ä»¶ã€‚ å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æžä¹‹hitTestï¼šwithEventï¼šæ–¹æ³•åº•å±‚åšæ³•/** hitTest:withEvent:æ–¹æ³•åº•å±‚å®žçŽ°**/ 12345678910111213141516171819202122232425262728293031323334353637383940#import &quot;WSWindow.h&quot;@implementation WSWindow// ä»€ä¹ˆæ—¶å€™è°ƒç”¨:åªè¦äº‹ä»¶ä¸€ä¼ é€’ç»™ä¸€ä¸ªæŽ§ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæŽ§ä»¶å°±ä¼šè°ƒç”¨è‡ªå·±çš„è¿™ä¸ªæ–¹æ³•// ä½œç”¨:å¯»æ‰¾å¹¶è¿”å›žæœ€åˆé€‚çš„view// UIApplication -&gt; [UIWindow hitTest:withEvent:]å¯»æ‰¾æœ€åˆé€‚çš„viewå‘Šè¯‰ç³»ç»Ÿ// point:å½“å‰æ‰‹æŒ‡è§¦æ‘¸çš„ç‚¹// point:æ˜¯æ–¹æ³•è°ƒç”¨è€…åæ ‡ç³»ä¸Šçš„ç‚¹- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123; // 1.åˆ¤æ–­ä¸‹çª—å£èƒ½å¦æŽ¥æ”¶äº‹ä»¶ if (self.userInteractionEnabled == NO || self.hidden == YES || self.alpha &lt;= 0.01) return nil; // 2.åˆ¤æ–­ä¸‹ç‚¹åœ¨ä¸åœ¨çª—å£ä¸Š // ä¸åœ¨çª—å£ä¸Š if ([self pointInside:point withEvent:event] == NO) return nil; // 3.ä»ŽåŽå¾€å‰éåŽ†å­æŽ§ä»¶æ•°ç»„ int count = (int)self.subviews.count; for (int i = count - 1; i &gt;= 0; i--) &#123; // èŽ·å–å­æŽ§ä»¶ UIView *childView = self.subviews[i]; // åæ ‡ç³»çš„è½¬æ¢,æŠŠçª—å£ä¸Šçš„ç‚¹è½¬æ¢ä¸ºå­æŽ§ä»¶ä¸Šçš„ç‚¹ // æŠŠè‡ªå·±æŽ§ä»¶ä¸Šçš„ç‚¹è½¬æ¢æˆå­æŽ§ä»¶ä¸Šçš„ç‚¹ CGPoint childP = [self convertPoint:point toView:childView]; UIView *fitView = [childView hitTest:childP withEvent:event]; if (fitView) &#123; // å¦‚æžœèƒ½æ‰¾åˆ°æœ€åˆé€‚çš„view return fitView; &#125; &#125; // 4.æ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„viewï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ¯”è‡ªå·±æ›´åˆé€‚çš„view return self; &#125; // ä½œç”¨:åˆ¤æ–­ä¸‹ä¼ å…¥è¿‡æ¥çš„ç‚¹åœ¨ä¸åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Š // point:æ˜¯æ–¹æ³•è°ƒç”¨è€…åæ ‡ç³»ä¸Šçš„ç‚¹ //- (BOOL)pointInside:(CGPoint)point withEvent:(UIEvent *)event //&#123; // return NO; //&#125; - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; NSLog(@&quot;%s&quot;,__func__); &#125; @end hit:withEvent:æ–¹æ³•åº•å±‚ä¼šè°ƒç”¨pointInside:withEvent:æ–¹æ³•åˆ¤æ–­ç‚¹åœ¨ä¸åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Šã€‚ 3.3.1.2.pointInside:withEvent:æ–¹æ³•pointInside:withEvent:æ–¹æ³•åˆ¤æ–­ç‚¹åœ¨ä¸åœ¨å½“å‰viewä¸Šï¼ˆæ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Šï¼‰å¦‚æžœè¿”å›žYESï¼Œä»£è¡¨ç‚¹åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Š;è¿”å›žNOä»£è¡¨ç‚¹ä¸åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Šï¼Œé‚£ä¹ˆæ–¹æ³•è°ƒç”¨è€…ä¹Ÿå°±ä¸èƒ½å¤„ç†äº‹ä»¶ã€‚ 3.3.2.ç»ƒä¹ å±å¹•ä¸ŠçŽ°åœ¨æœ‰ä¸€ä¸ªviewAï¼ŒviewAæœ‰ä¸€ä¸ªsubViewå«åšviewBï¼Œè¦æ±‚è§¦æ‘¸viewBæ—¶,viewBä¼šå“åº”äº‹ä»¶ï¼Œè€Œè§¦æ‘¸viewAæœ¬èº«ï¼Œä¸ä¼šå“åº”è¯¥äº‹ä»¶ã€‚å¦‚ä½•å®žçŽ°ï¼Ÿ 1234567- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123; UIView *view = [super hitTest:point withEvent:event]; if (view == self) &#123; return nil; &#125; return view;&#125; äº‹ä»¶çš„å“åº”è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹1&gt;ç”¨æˆ·ç‚¹å‡»å±å¹•åŽäº§ç”Ÿçš„ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„ä¼ é€’è¿‡ç¨‹åŽï¼Œä¼šæ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾æŽ§ä»¶æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶2&gt;æ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾æŽ§ä»¶åŽï¼Œå°±ä¼šè°ƒç”¨æŽ§ä»¶çš„touchesæ–¹æ³•æ¥ä½œå…·ä½“çš„äº‹ä»¶å¤„ç†touchesBeganâ€¦touchesMovedâ€¦touchedEndedâ€¦3&gt;è¿™äº›touchesæ–¹æ³•çš„é»˜è®¤åšæ³•æ˜¯å°†äº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å‘ä¸Šä¼ é€’ï¼ˆä¹Ÿå°±æ˜¯touchæ–¹æ³•é»˜è®¤ä¸å¤„ç†äº‹ä»¶ï¼Œåªä¼ é€’äº‹ä»¶ï¼‰ï¼Œå°†äº‹ä»¶äº¤ç»™ä¸Šä¸€ä¸ªå“åº”è€…è¿›è¡Œå¤„ç† å“åº”è€…é“¾æ¡ç¤ºæ„å›¾å“åº”è€…é“¾æ¡ï¼šåœ¨iOSç¨‹åºä¸­æ— è®ºæ˜¯æœ€åŽé¢çš„UIWindowè¿˜æ˜¯æœ€å‰é¢çš„æŸä¸ªæŒ‰é’®ï¼Œå®ƒä»¬çš„æ‘†æ”¾æ˜¯æœ‰å‰åŽå…³ç³»çš„ï¼Œä¸€ä¸ªæŽ§ä»¶å¯ä»¥æ”¾åˆ°å¦ä¸€ä¸ªæŽ§ä»¶ä¸Šé¢æˆ–ä¸‹é¢ï¼Œé‚£ä¹ˆç”¨æˆ·ç‚¹å‡»æŸä¸ªæŽ§ä»¶æ—¶æ˜¯è§¦å‘ä¸Šé¢çš„æŽ§ä»¶è¿˜æ˜¯ä¸‹é¢çš„æŽ§ä»¶å‘¢ï¼Œè¿™ç§å…ˆåŽå…³ç³»æž„æˆä¸€ä¸ªé“¾æ¡å°±å«â€œå“åº”è€…é“¾â€ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå“åº”è€…é“¾æ˜¯ç”±å¤šä¸ªå“åº”è€…å¯¹è±¡è¿žæŽ¥èµ·æ¥çš„é“¾æ¡ã€‚åœ¨iOSä¸­å“åº”è€…é“¾çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š å“åº”è€…å¯¹è±¡ï¼š ä½œç”¨ï¼š å¦‚ä½•åˆ¤æ–­ä¸Šä¸€ä¸ªå“åº”è€… 1&gt; å¦‚æžœå½“å‰è¿™ä¸ªviewæ˜¯æŽ§åˆ¶å™¨çš„view,é‚£ä¹ˆæŽ§åˆ¶å™¨å°±æ˜¯ä¸Šä¸€ä¸ªå“åº”è€… 2&gt; å¦‚æžœå½“å‰è¿™ä¸ªviewä¸æ˜¯æŽ§åˆ¶å™¨çš„view,é‚£ä¹ˆçˆ¶æŽ§ä»¶å°±æ˜¯ä¸Šä¸€ä¸ªå“åº”è€… å“åº”è€…é“¾çš„äº‹ä»¶ä¼ é€’è¿‡ç¨‹: 1&gt;å¦‚æžœå½“å‰viewæ˜¯æŽ§åˆ¶å™¨çš„viewï¼Œé‚£ä¹ˆæŽ§åˆ¶å™¨å°±æ˜¯ä¸Šä¸€ä¸ªå“åº”è€…ï¼Œäº‹ä»¶å°±ä¼ é€’ç»™æŽ§åˆ¶å™¨ï¼›å¦‚æžœå½“å‰viewä¸æ˜¯æŽ§åˆ¶å™¨çš„viewï¼Œé‚£ä¹ˆçˆ¶è§†å›¾å°±æ˜¯å½“å‰viewçš„ä¸Šä¸€ä¸ªå“åº”è€…ï¼Œäº‹ä»¶å°±ä¼ é€’ç»™å®ƒçš„çˆ¶è§†å›¾ 2&gt;åœ¨è§†å›¾å±‚æ¬¡ç»“æž„çš„æœ€é¡¶çº§è§†å›¾ï¼Œå¦‚æžœä¹Ÿä¸èƒ½å¤„ç†æ”¶åˆ°çš„äº‹ä»¶æˆ–æ¶ˆæ¯ï¼Œåˆ™å…¶å°†äº‹ä»¶æˆ–æ¶ˆæ¯ä¼ é€’ç»™windowå¯¹è±¡è¿›è¡Œå¤„ç† 3&gt;å¦‚æžœwindowå¯¹è±¡ä¹Ÿä¸å¤„ç†ï¼Œåˆ™å…¶å°†äº‹ä»¶æˆ–æ¶ˆæ¯ä¼ é€’ç»™UIApplicationå¯¹è±¡ 4&gt;å¦‚æžœUIApplicationä¹Ÿä¸èƒ½å¤„ç†è¯¥äº‹ä»¶æˆ–æ¶ˆæ¯ï¼Œåˆ™å°†å…¶ä¸¢å¼ƒ äº‹ä»¶å¤„ç†çš„æ•´ä¸ªæµç¨‹æ€»ç»“ï¼š 1.è§¦æ‘¸å±å¹•äº§ç”Ÿè§¦æ‘¸äº‹ä»¶åŽï¼Œè§¦æ‘¸äº‹ä»¶ä¼šè¢«æ·»åŠ åˆ°ç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼ˆå³ï¼Œé¦–å…ˆæŽ¥æ”¶åˆ°äº‹ä»¶çš„æ˜¯UIApplicationï¼‰ã€‚ 2.UIApplicationä¼šä»Žäº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼ŒæŠŠäº‹ä»¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰ã€‚ 3.ä¸»çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æž„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ã€‚ï¼ˆè‡³æ­¤ï¼Œç¬¬ä¸€æ­¥å·²å®Œæˆ) 4.æœ€åˆé€‚çš„viewä¼šè°ƒç”¨è‡ªå·±çš„touchesæ–¹æ³•å¤„ç†äº‹ä»¶ 5.touchesé»˜è®¤åšæ³•æ˜¯æŠŠäº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å‘ä¸ŠæŠ›ã€‚touchesçš„é»˜è®¤åšæ³•ï¼š 1234567891011#import &quot;WSView.h&quot;@implementation WSView //åªè¦ç‚¹å‡»æŽ§ä»¶,å°±ä¼šè°ƒç”¨touchBegin,å¦‚æžœæ²¡æœ‰é‡å†™è¿™ä¸ªæ–¹æ³•,è‡ªå·±å¤„ç†ä¸äº†è§¦æ‘¸äº‹ä»¶// ä¸Šä¸€ä¸ªå“åº”è€…å¯èƒ½æ˜¯çˆ¶æŽ§ä»¶- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; // é»˜è®¤ä¼šæŠŠäº‹ä»¶ä¼ é€’ç»™ä¸Šä¸€ä¸ªå“åº”è€…,ä¸Šä¸€ä¸ªå“åº”è€…æ˜¯çˆ¶æŽ§ä»¶,äº¤ç»™çˆ¶æŽ§ä»¶å¤„ç†[super touchesBegan:touches withEvent:event]; // æ³¨æ„ä¸æ˜¯è°ƒç”¨çˆ¶æŽ§ä»¶çš„touchesæ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨çˆ¶ç±»çš„touchesæ–¹æ³•// superæ˜¯çˆ¶ç±» superviewæ˜¯çˆ¶æŽ§ä»¶ &#125;@end äº‹ä»¶çš„ä¼ é€’ä¸Žå“åº”ï¼š1ã€å½“ä¸€ä¸ªäº‹ä»¶å‘ç”ŸåŽï¼Œäº‹ä»¶ä¼šä»Žçˆ¶æŽ§ä»¶ä¼ ç»™å­æŽ§ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ç”±UIApplication -&gt; UIWindow -&gt; UIView -&gt; initial view,ä»¥ä¸Šå°±æ˜¯äº‹ä»¶çš„ä¼ é€’ï¼Œä¹Ÿå°±æ˜¯å¯»æ‰¾æœ€åˆé€‚çš„viewçš„è¿‡ç¨‹ã€‚ 2ã€æŽ¥ä¸‹æ¥æ˜¯äº‹ä»¶çš„å“åº”ã€‚é¦–å…ˆçœ‹initial viewèƒ½å¦å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œå¦‚æžœä¸èƒ½åˆ™ä¼šå°†äº‹ä»¶ä¼ é€’ç»™å…¶ä¸Šçº§è§†å›¾ï¼ˆinital viewçš„superViewï¼‰ï¼›å¦‚æžœä¸Šçº§è§†å›¾ä»ç„¶æ— æ³•å¤„ç†åˆ™ä¼šç»§ç»­å¾€ä¸Šä¼ é€’ï¼›ä¸€ç›´ä¼ é€’åˆ°è§†å›¾æŽ§åˆ¶å™¨view controllerï¼Œé¦–å…ˆåˆ¤æ–­è§†å›¾æŽ§åˆ¶å™¨çš„æ ¹è§†å›¾viewæ˜¯å¦èƒ½å¤„ç†æ­¤äº‹ä»¶ï¼›å¦‚æžœä¸èƒ½åˆ™æŽ¥ç€åˆ¤æ–­è¯¥è§†å›¾æŽ§åˆ¶å™¨èƒ½å¦å¤„ç†æ­¤äº‹ä»¶ï¼Œå¦‚æžœè¿˜æ˜¯ä¸èƒ½åˆ™ç»§ç»­å‘ä¸Šä¼  é€’ï¼›ï¼ˆå¯¹äºŽç¬¬äºŒä¸ªå›¾è§†å›¾æŽ§åˆ¶å™¨æœ¬èº«è¿˜åœ¨å¦ä¸€ä¸ªè§†å›¾æŽ§åˆ¶å™¨ä¸­ï¼Œåˆ™ç»§ç»­äº¤ç»™çˆ¶è§†å›¾æŽ§åˆ¶å™¨çš„æ ¹è§†å›¾ï¼Œå¦‚æžœæ ¹è§†å›¾ä¸èƒ½å¤„ç†åˆ™äº¤ç»™çˆ¶è§†å›¾æŽ§åˆ¶å™¨å¤„ç†ï¼‰ï¼›ä¸€ç›´åˆ° windowï¼Œå¦‚æžœwindowè¿˜æ˜¯ä¸èƒ½å¤„ç†æ­¤äº‹ä»¶åˆ™ç»§ç»­äº¤ç»™applicationå¤„ç†ï¼Œå¦‚æžœæœ€åŽapplicationè¿˜æ˜¯ä¸èƒ½å¤„ç†æ­¤äº‹ä»¶åˆ™å°†å…¶ä¸¢å¼ƒ 3ã€åœ¨äº‹ä»¶çš„å“åº”ä¸­ï¼Œå¦‚æžœæŸä¸ªæŽ§ä»¶å®žçŽ°äº†touchesâ€¦æ–¹æ³•ï¼Œåˆ™è¿™ä¸ªäº‹ä»¶å°†ç”±è¯¥æŽ§ä»¶æ¥æŽ¥å—ï¼Œå¦‚æžœè°ƒç”¨äº†[supertouchesâ€¦.];å°±ä¼šå°†äº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å¾€ä¸Šä¼ é€’ï¼Œä¼ é€’ç»™ä¸Šä¸€ä¸ªå“åº”è€…ï¼›æŽ¥ç€å°±ä¼šè°ƒç”¨ä¸Šä¸€ä¸ªå“åº”è€…çš„touchesâ€¦.æ–¹æ³• å¦‚ä½•åšåˆ°ä¸€ä¸ªäº‹ä»¶å¤šä¸ªå¯¹è±¡å¤„ç†ï¼šå› ä¸ºç³»ç»Ÿé»˜è®¤åšæ³•æ˜¯æŠŠäº‹ä»¶ä¸ŠæŠ›ç»™çˆ¶æŽ§ä»¶ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡é‡å†™è‡ªå·±çš„touchesæ–¹æ³•å’Œçˆ¶æŽ§ä»¶çš„touchesæ–¹æ³•æ¥è¾¾åˆ°ä¸€ä¸ªäº‹ä»¶å¤šä¸ªå¯¹è±¡å¤„ç†çš„ç›®çš„ã€‚ 123456- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; // 1.è‡ªå·±å…ˆå¤„ç†äº‹ä»¶...NSLog(@&quot;do somthing...&quot;);// 2.å†è°ƒç”¨ç³»ç»Ÿçš„é»˜è®¤åšæ³•ï¼Œå†æŠŠäº‹ä»¶äº¤ç»™ä¸Šä¸€ä¸ªå“åº”è€…å¤„ç†[super touchesBegan:touches withEvent:event]; &#125; äº‹ä»¶çš„ä¼ é€’å’Œå“åº”çš„åŒºåˆ«ï¼šäº‹ä»¶çš„ä¼ é€’æ˜¯ä»Žä¸Šåˆ°ä¸‹ï¼ˆçˆ¶æŽ§ä»¶åˆ°å­æŽ§ä»¶ï¼‰ï¼Œäº‹ä»¶çš„å“åº”æ˜¯ä»Žä¸‹åˆ°ä¸Šï¼ˆé¡ºç€å“åº”è€…é“¾æ¡å‘ä¸Šä¼ é€’ï¼šå­æŽ§ä»¶åˆ°çˆ¶æŽ§ä»¶ã€‚ è½¬è‡ªVVæœ¨å…¬å­ï¼ˆç®€ä¹¦ä½œè€…ï¼‰]]></content>
      <categories>
        <category>UIè§†å›¾</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[UITableViewç›¸å…³]]></title>
    <url>%2F2018%2F09%2F11%2FUITableView%E7%9B%B8%E5%85%B3%2F</url>
    <content type="text"><![CDATA[å‰è¨€å…ˆæ¥ç‚¹æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œ å¡é¡¿&amp;æŽ‰å¸§ æ¦‚å¿µï¼šåœ¨è§„å®šçš„16.7msä¹‹å†…ï¼Œä¸‹ä¸€å¸§VSyncä¿¡å·åˆ°æ¥ä¹‹å‰ï¼Œå¹¶æ²¡æœ‰CPUå’ŒGPUå…±åŒå®Œæˆä¸‹ä¸€å¸§ç”»é¢çš„åˆæˆï¼ŒäºŽæ˜¯å°±ä¼šé€ æˆå¡é¡¿å’ŒæŽ‰å¸§ æ»‘åŠ¨ä¼˜åŒ–æ–¹æ¡ˆ CPU å¯¹è±¡åˆ›å»ºã€è°ƒæ•´ã€é”€æ¯ é¢„æŽ’ç‰ˆï¼ˆå¸ƒå±€è®¡ç®—ã€æ–‡æœ¬è®¡ç®—ï¼‰ é¢„æ¸²æŸ“ï¼ˆæ–‡æœ¬ç­‰å¼‚æ­¥ç»˜åˆ¶ï¼Œå›¾ç‰‡ç¼–è§£ç ç­‰ï¼‰ GPU çº¹ç†æ¸²æŸ“ è§†å›¾æ··åˆ ç¦»å±æ¸²æŸ“ æ¦‚å¿µï¼šå½“æˆ‘ä»¬å¤„ç†å›¾å±‚çš„å±žæ€§åœ¨è¢«æŒ‡å®šä¸ºæœªè¢«é¢„åˆæˆä¹‹å‰ä¸èƒ½ç›´æŽ¥åœ¨å±å¹•ä¸Šæ˜¾ç¤ºï¼Œå°±è§¦å‘äº†ç¦»å±æ¸²æŸ“ã€‚ç¦»å±æ¸²æŸ“çš„æ¦‚å¿µèµ·æºä¸ŽGPUå±‚é¢ï¼ŒæŒ‡çš„æ˜¯GPUåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–æ–°å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œ ä½•æ—¶ä¼šè§¦å‘ åœ†è§’ï¼ˆå½“å’ŒmaskToBoundsä¸€èµ·ä½¿ç”¨æ—¶ï¼‰ å›¾å±‚è’™ç‰ˆ é˜´å½± å…‰æ …åŒ– ä¸ºä½•è¦é¿å… ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒGPUé¢å¤–çš„å¼€é”€ åˆ›å»ºæ–°çš„æ¸²æŸ“ç¼“å†²åŒºï¼Œå†…å­˜æŸè€— é«˜çº§å›žç­”ï¼šè§¦å‘ç¦»å±æ¸²æŸ“ä¼šå¢žåŠ GPUçš„å·¥ä½œé‡ï¼Œè€Œå¢žåŠ äº†GPUçš„å·¥ä½œé‡å¾ˆæœ‰å¯èƒ½å¯¼è‡´CPUå’ŒGPUçš„å·¥ä½œæ€»è€—æ—¶è¶…è¿‡äº†16.67msï¼Œæœ‰å¯èƒ½å¯¼è‡´UIçš„å¡é¡¿å’ŒæŽ‰å¸§ UITableViewæ€§èƒ½ä¼˜åŒ–å½“èŽ·å–åˆ° API JSON æ•°æ®åŽï¼Œæˆ‘ä¼šæŠŠæ¯æ¡ Cell éœ€è¦çš„æ•°æ®éƒ½åœ¨åŽå°çº¿ç¨‹è®¡ç®—å¹¶å°è£…ä¸ºä¸€ä¸ªå¸ƒå±€å¯¹è±¡ CellLayoutã€‚CellLayout åŒ…å«æ‰€æœ‰æ–‡æœ¬çš„ CoreText æŽ’ç‰ˆç»“æžœã€Cell å†…éƒ¨æ¯ä¸ªæŽ§ä»¶çš„é«˜åº¦ã€Cell çš„æ•´ä½“é«˜åº¦ã€‚æ¯ä¸ª CellLayout çš„å†…å­˜å ç”¨å¹¶ä¸å¤šï¼Œæ‰€ä»¥å½“ç”ŸæˆåŽï¼Œå¯ä»¥å…¨éƒ¨ç¼“å­˜åˆ°å†…å­˜ï¼Œä»¥ä¾›ç¨åŽä½¿ç”¨ã€‚è¿™æ ·ï¼ŒTableView åœ¨è¯·æ±‚å„ä¸ªé«˜åº¦å‡½æ•°æ—¶ï¼Œä¸ä¼šæ¶ˆè€—ä»»ä½•å¤šä½™è®¡ç®—é‡ï¼›å½“æŠŠ CellLayout è®¾ç½®åˆ° Cell å†…éƒ¨æ—¶ï¼ŒCell å†…éƒ¨ä¹Ÿä¸ç”¨å†è®¡ç®—å¸ƒå±€äº†ã€‚ ç¼“å­˜é«˜åº¦å¯¹äºŽé€šå¸¸çš„ TableView æ¥è¯´ï¼Œæå‰åœ¨åŽå°è®¡ç®—å¥½å¸ƒå±€ç»“æžœæ˜¯éžå¸¸é‡è¦çš„ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–ç‚¹ã€‚ä¸ºäº†è¾¾åˆ°æœ€é«˜æ€§èƒ½ï¼Œä½ å¯èƒ½éœ€è¦ç‰ºç‰²ä¸€äº›å¼€å‘é€Ÿåº¦ï¼Œä¸è¦ç”¨ Autolayout ç­‰æŠ€æœ¯ï¼Œå°‘ç”¨ UILabel ç­‰æ–‡æœ¬æŽ§ä»¶ã€‚ä½†å¦‚æžœä½ å¯¹æ€§èƒ½çš„è¦æ±‚å¹¶ä¸é‚£ä¹ˆé«˜ï¼Œå¯ä»¥å°è¯•ç”¨ TableView çš„é¢„ä¼°é«˜åº¦çš„åŠŸèƒ½ï¼Œå¹¶æŠŠæ¯ä¸ª Cell é«˜åº¦ç¼“å­˜ä¸‹æ¥ã€‚è¿™é‡Œæœ‰ä¸ªæ¥è‡ªç™¾åº¦çŸ¥é“å›¢é˜Ÿçš„å¼€æºé¡¹ç›®å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¸®ä½ å®žçŽ°è¿™ä¸€ç‚¹ï¼šFDTemplateLayoutCellã€‚ tableviewcellé«˜åº¦ç¼“å­˜å…·ä½“å®žçŽ°æ–¹å¼ é¢„æ¸²æŸ“å¾®åšçš„å¤´åƒåœ¨æŸæ¬¡æ”¹ç‰ˆä¸­æ¢æˆäº†åœ†å½¢ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿè·Ÿè¿›äº†ä¸€ä¸‹ã€‚å½“å¤´åƒä¸‹è½½ä¸‹æ¥åŽï¼Œæˆ‘ä¼šåœ¨åŽå°çº¿ç¨‹å°†å¤´åƒé¢„å…ˆæ¸²æŸ“ä¸ºåœ†å½¢å¹¶å•ç‹¬ä¿å­˜åˆ°ä¸€ä¸ª ImageCache ä¸­åŽ»ã€‚ å¯¹äºŽ TableView æ¥è¯´ï¼ŒCell å†…å®¹çš„ç¦»å±æ¸²æŸ“ä¼šå¸¦æ¥è¾ƒå¤§çš„ GPU æ¶ˆè€—ã€‚åœ¨ Twitter Demo ä¸­ï¼Œæˆ‘ä¸ºäº†å›¾çœäº‹å„¿ç”¨åˆ°äº†ä¸å°‘ layer çš„åœ†è§’å±žæ€§ï¼Œä½ å¯ä»¥åœ¨ä½Žæ€§èƒ½çš„è®¾å¤‡ï¼ˆæ¯”å¦‚ iPad 3ï¼‰ä¸Šå¿«é€Ÿæ»‘åŠ¨ä¸€ä¸‹è¿™ä¸ªåˆ—è¡¨ï¼Œèƒ½æ„Ÿå—åˆ°è™½ç„¶åˆ—è¡¨å¹¶æ²¡æœ‰è¾ƒå¤§çš„å¡é¡¿ï¼Œä½†æ˜¯æ•´ä½“çš„å¹³å‡å¸§æ•°é™äº†ä¸‹æ¥ã€‚ç”¨ Instument æŸ¥çœ‹æ—¶èƒ½å¤Ÿçœ‹åˆ° GPU å·²ç»æ»¡è´Ÿè·è¿è½¬ï¼Œè€Œ CPU å´æ¯”è¾ƒæ¸…é—²ã€‚ä¸ºäº†é¿å…ç¦»å±æ¸²æŸ“ï¼Œä½ åº”å½“å°½é‡é¿å…ä½¿ç”¨ layer çš„ borderã€cornerã€shadowã€mask ç­‰æŠ€æœ¯ï¼Œè€Œå°½é‡åœ¨åŽå°çº¿ç¨‹é¢„å…ˆç»˜åˆ¶å¥½å¯¹åº”å†…å®¹ã€‚ ç¦»å±æ¸²æŸ“â€‹ åœ¨ä½¿ç”¨åœ†è§’ã€é˜´å½±å’Œé®ç½©ç­‰è§†å›¾åŠŸèƒ½çš„æ—¶å€™ï¼Œå›¾å±‚å±žæ€§çš„æ··åˆä½“è¢«æŒ‡å®šä¸ºåœ¨æœªé¢„åˆæˆä¹‹å‰ä¸èƒ½ç›´æŽ¥åœ¨å±å¹•ä¸­ç»˜åˆ¶ï¼Œæ‰€æœ‰å°±éœ€è¦åœ¨å±å¹•å¤–çš„ä¸Šä¸‹æ–‡ä¸­æ¸²æŸ“ï¼Œå³ç¦»å±æ¸²æŸ“ã€‚ ç¦»å±æ¸²æŸ“äº§ç”ŸåŽŸå› ç¦»å±æ¸²æŸ“ä¹‹æ‰€ä»¥ä¼šç‰¹åˆ«æ¶ˆè€—æ€§èƒ½ï¼Œæ˜¯å› ä¸ºè¦åˆ›å»ºä¸€ä¸ªå±å¹•å¤–çš„ç¼“å†²åŒºï¼Œç„¶åŽä»Žå½“å±ç¼“å†²åŒºåˆ‡æ¢åˆ°å±å¹•å¤–çš„ç¼“å†²åŒºï¼Œç„¶åŽå†å®Œæˆæ¸²æŸ“ï¼›å…¶ä¸­ï¼Œåˆ›å»ºç¼“å†²åŒºå’Œåˆ‡æ¢ä¸Šä¸‹æ–‡æœ€æ¶ˆè€—æ€§èƒ½ï¼Œè€Œç»˜åˆ¶å…¶å®žä¸æ˜¯æ€§èƒ½æŸè€—çš„ä¸»è¦åŽŸå› ã€‚ è®¾ç½®äº†ä»¥ä¸‹å±žæ€§æ—¶ï¼Œå°±ä¼šè§¦å‘ç¦»å±ç»˜åˆ¶ï¼š shouldRasterizeï¼ˆå…‰æ …åŒ–ï¼‰ masksï¼ˆé®ç½©ï¼‰ shadowsï¼ˆé˜´å½±ï¼‰ edge antialiasingï¼ˆæŠ—é”¯é½¿ï¼‰ group opacityï¼ˆä¸é€æ˜Žï¼‰ å¤æ‚å½¢çŠ¶è®¾ç½®åœ†è§’ç­‰ æ¸å˜ å…‰æ …åŒ–å…‰æ …åŒ–æ¦‚å¿µ:å°†å›¾è½¬åŒ–ä¸ºä¸€ä¸ªä¸ªæ …æ ¼ç»„æˆçš„å›¾è±¡ã€‚ å…‰æ …åŒ–ç‰¹ç‚¹:æ¯ä¸ªå…ƒç´ å¯¹åº”å¸§ç¼“å†²åŒºä¸­çš„ä¸€åƒç´ ã€‚ â€‹ shouldRasterize = YESåœ¨å…¶ä»–å±žæ€§è§¦å‘ç¦»å±æ¸²æŸ“çš„åŒæ—¶,ä¼šå°†å…‰æ …åŒ–åŽçš„å†…å®¹ç¼“å­˜èµ·æ¥,å¦‚æžœå¯¹åº”çš„layeråŠå…¶sublayersæ²¡æœ‰å‘ç”Ÿæ”¹å˜,åœ¨ä¸‹ä¸€å¸§çš„æ—¶å€™å¯ä»¥ç›´æŽ¥å¤ç”¨ã€‚shouldRasterize = YES,è¿™å°†éšå¼çš„åˆ›å»ºä¸€ä¸ªä½å›¾,å„ç§é˜´å½±é®ç½©ç­‰æ•ˆæžœä¹Ÿä¼šä¿å­˜åˆ°ä½å›¾ä¸­å¹¶ç¼“å­˜èµ·æ¥,ä»Žè€Œå‡å°‘æ¸²æŸ“çš„é¢‘åº¦ å½“ä½ ä½¿ç”¨å…‰æ …åŒ–æ—¶,ä½ å¯ä»¥å¼€å¯â€œColor Hits Green and Misses Redâ€æ¥æ£€æŸ¥è¯¥åœºæ™¯ä¸‹å…‰æ …åŒ–æ“ä½œæ˜¯å¦æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚ç»¿è‰²è¡¨ç¤ºç¼“å­˜è¢«å¤ç”¨,çº¢è‰²è¡¨ç¤ºç¼“å­˜åœ¨è¢«é‡å¤åˆ›å»ºã€‚ å¦‚æžœå…‰æ …åŒ–çš„å±‚å˜çº¢å¾—å¤ªé¢‘ç¹é‚£ä¹ˆå…‰æ …åŒ–å¯¹ä¼˜åŒ–å¯èƒ½æ²¡æœ‰å¤šå°‘ç”¨å¤„ã€‚ä½å›¾ç¼“å­˜ä»Žå†…å­˜ä¸­åˆ é™¤åˆé‡æ–°åˆ›å»ºå¾—å¤ªè¿‡é¢‘ç¹,çº¢è‰²è¡¨æ˜Žç¼“å­˜é‡å»ºå¾—å¤ªè¿Ÿã€‚å¯ä»¥é’ˆå¯¹æ€§çš„é€‰æ‹©æŸä¸ªè¾ƒå°è€Œè¾ƒæ·±çš„å±‚ç»“æž„è¿›è¡Œå…‰æ …åŒ–,æ¥å°è¯•å‡å°‘æ¸²æŸ“æ—¶é—´ã€‚ æˆ‘ä»¬ç»å¸¸çš„TableViewCell,å› ä¸ºTableViewCellçš„é‡ç»˜æ˜¯å¾ˆé¢‘ç¹çš„(å› ä¸ºCellçš„å¤ç”¨),å¦‚æžœCellçš„å†…å®¹ä¸æ–­å˜åŒ–,åˆ™Celléœ€è¦ä¸æ–­é‡ç»˜,å¦‚æžœæ­¤æ—¶è®¾ç½®äº†cell.layerå¯å…‰æ …åŒ–ã€‚åˆ™ä¼šé€ æˆå¤§é‡çš„ç¦»å±æ¸²æŸ“,é™ä½Žå›¾å½¢æ€§èƒ½ã€‚ æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥æŠŠé‚£äº›éœ€è¦å±å¹•å¤–ç»˜åˆ¶çš„å›¾å±‚å¼€å¯å…‰æ …åŒ–ä»¥ä½œä¸ºä¸€ä¸ªä¼˜åŒ–æ–¹å¼,å‰ææ˜¯è¿™äº›å›¾å±‚å¹¶ä¸ä¼šè¢«é¢‘ç¹åœ°é‡ç»˜ã€‚ é’ˆå¯¹å…‰æ …åŒ–å¤„ç† 12345678910//ç¦»å±æ¸²æŸ“ - å¼‚æ­¥ç»˜åˆ¶ è€—ç”µself.layer.drawsAsynchronously = true //æ …æ ¼åŒ– - å¼‚æ­¥ç»˜åˆ¶ä¹‹åŽ ï¼Œä¼šç”Ÿæˆä¸€å¼ ç‹¬ç«‹çš„å›¾ç‰‡ cell åœ¨å±å¹•ä¸Šæ»šåŠ¨çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ»šåŠ¨çš„æ˜¯è¿™å¼ å›¾ç‰‡ //cell ä¼˜åŒ–ï¼Œè¦å°½é‡å‡å°‘å›¾å±‚çš„æ•°é‡ï¼Œæƒ³å½“äºŽåªæœ‰ä¸€å±‚//åœæ­¢æ»šåŠ¨ä¹‹åŽï¼Œå¯ä»¥æŽ¥å—ç›‘å¬self.layer.shouldRasterize = true //ä½¿ç”¨ â€œæ …æ ¼åŒ–â€ å¿…é¡»æŒ‡å®šåˆ†è¾¨çŽ‡self.layer.rasterizationScale = UIScreen.main.scale é˜´å½±å¤„ç† 12// æŒ‡å®šé˜´å½±æ›²çº¿ï¼Œé˜²æ­¢é˜´å½±æ•ˆæžœå¸¦æ¥çš„ç¦»å±æ¸²æŸ“ imageView.layer.shadowPath = UIBezierPath(rect: imageView.bounds).cgPath â€‹ é®ç½©masks(é®ç½©) maskæ˜¯layerçš„ä¸€ä¸ªå±žæ€§. å½“é€æ˜Žåº¦æ”¹å˜çš„æ—¶å€™,è¿™ä¸ª mask å°±æ˜¯è¦†ç›–ä¸ŠåŽ»çš„é‚£ä¸ªé˜´å½±ã€‚è¯¥å±‚çš„layerçš„alphaå†³å®šäº†å¤šå°‘å±‚èƒŒæ™¯è·Ÿå†…å®¹é€šè¿‡å¹¶æ˜¾ç¤º,å®Œå…¨æˆ–è€…éƒ¨åˆ†ä¸é€æ˜Žçš„åƒç´ å…è®¸æ½œåœ¨çš„å†…å®¹ é€šè¿‡å¹¶æ˜¾ç¤ºã€‚ é»˜è®¤æ˜¯nil,å½“é…ç½®ä¸€ä¸ªé®ç½©çš„æ—¶å€™,è®°å¾—è®¾ç½®é®ç½©çš„å¤§å°ã€ä½ç½®ã€‚å·²ç¡®ä¿è·Ÿç›–å›¾å±‚å¯¹é½ã€‚å¦‚æžœä½ æƒ³ç»™è¿™ä¸ªå±žæ€§èµ‹å€¼,å‰ææ˜¯å¿…é¡»æ²¡æœ‰ superLayer,å¦‚æžœæœ‰superLayer,è¿™ä¸ªè¡Œä¸ºåˆ™æ˜¯æ— æ•ˆçš„ã€‚ shadows(é˜´å½±)åœ¨é¡¹ç›®ä¸­,å½“æˆ‘ä»¬æƒ³è¦è®¾ç½®Viewçš„é˜´å½±æ•ˆæžœæ—¶,å¯ä»¥é€šè¿‡shadow*ç›¸å…³æ–¹æ³•å®žçŽ°,å¦‚: self.layer.shadowOffset = CGSizeMake(4, -2); self.layer.shadowOpacity = 0.5; self.layer.shadowColor = [[UIColor blackColor] colorWithAlphaComponent:0.5].CGColor; shadowså¯ä»¥ç»™è§†å›¾å‘¨è¾¹æ·»åŠ é˜´å½±,å½“ç»™ä¸€äº›æ»‘åŠ¨è§†å›¾åŠ é˜´å½±æ—¶,æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°åœ¨åŠ¨ç”»ä¸æ˜¯å¾ˆæµç•…,æœ‰å¡é¡¿ã€‚è¿™æ˜¯å› ä¸ºè®¡ç®—é˜´å½±éœ€è¦Core Animationåšä¸€ä¸ªç¦»å±æ¸²æŸ“,ä»¥Viewå‡†ç¡®çš„å½¢çŠ¶ç¡®å®šæ¸…æ¥šå¦‚ä½•å‘ˆçŽ°å…¶é˜´å½±ã€‚ ####å±å¹•æ¸²æŸ“æœ‰å¦‚ä¸‹ä¸‰ç§ GPUä¸­çš„å±å¹•æ¸²æŸ“ï¼š 1ã€On-Screen Rendering æ„ä¸ºå½“å‰å±å¹•æ¸²æŸ“ï¼ŒæŒ‡çš„æ˜¯GPUçš„æ¸²æŸ“æ“ä½œæ˜¯åœ¨å½“å‰ç”¨äºŽæ˜¾ç¤ºçš„å±å¹•ç¼“å†²åŒºä¸­è¿›è¡Œ 2ã€Off-Screen Rendering æ„ä¸ºç¦»å±æ¸²æŸ“ï¼ŒæŒ‡çš„æ˜¯GPUåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–æ–°å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œ 3ã€CPUä¸­çš„ç¦»å±æ¸²æŸ“ï¼ˆç‰¹æ®Šç¦»å±æ¸²æŸ“ï¼Œå³ä¸åœ¨GPUä¸­çš„æ¸²æŸ“ï¼‰ å¦‚æžœæˆ‘ä»¬é‡å†™äº†drawRectæ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨ä»»ä½•Core Graphicsçš„æŠ€æœ¯è¿›è¡Œäº†ç»˜åˆ¶æ“ä½œï¼Œå°±æ¶‰åŠåˆ°äº†CPUæ¸²æŸ“ åˆ‡åœ†è§’ä¼˜åŒ–åˆ‡åœ†è§’æ˜¯å¼€å‘appè¿‡ç¨‹ä¸­ç»å¸¸ä¼šç”¨åˆ°çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä½¿ç”¨ä¸åŒçš„æ–¹å¼ï¼Œæ€§èƒ½æŸè€—ä¹Ÿä¼šä¸åŒï¼Œä¸‹é¢ä¼šä»‹ç»3ç§åˆ‡åœ†è§’çš„æ–¹æ³•ï¼›å…¶ä¸­ï¼Œæ–¹æ³•ä¸‰çš„æ€§èƒ½ç›¸å¯¹æœ€å¥½ã€‚ æ–¹æ³•ä¸€ä½¿ç”¨cornerRadiusè¿›è¡Œåˆ‡åœ†è§’ï¼Œåœ¨iOS9ä¹‹å‰ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ï¼Œæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œè€Œä¹‹åŽç³»ç»Ÿåšäº†ä¼˜åŒ–ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ï¼Œä½†æ˜¯æ“ä½œæœ€ç®€å• 12iv.layer.cornerRadius = 30;iv.layer.masksToBounds = YES; æ–¹æ³•äºŒåˆ©ç”¨maskè®¾ç½®åœ†è§’ï¼Œåˆ©ç”¨çš„æ˜¯UIBezierPathå’ŒCAShapeLayeræ¥å®Œæˆ 1234CAShapeLayer *mask1 = [[CAShapeLayer alloc] init];mask1.opacity = 0.5;mask1.path = [UIBezierPath bezierPathWithOvalInRect:iv.bounds].CGPath;iv.layer.mask = mask1; æ–¹æ³•ä¸‰åˆ©ç”¨CoreGraphicsç”»ä¸€ä¸ªåœ†å½¢ä¸Šä¸‹æ–‡ï¼Œç„¶åŽæŠŠå›¾ç‰‡ç»˜åˆ¶ä¸ŠåŽ»ï¼Œå¾—åˆ°ä¸€ä¸ªåœ†å½¢çš„å›¾ç‰‡ï¼Œè¾¾åˆ°åˆ‡åœ†è§’çš„ç›®çš„ã€‚ 12345678910111213141516171819- (UIImage *)drawCircleImage:(UIImage*)image&#123; CGFloat side = MIN(image.size.width, image.size.height); UIGraphicsBeginImageContextWithOptions(CGSizeMake(side, side), false, [UIScreen mainScreen].scale); CGContextAddPath(UIGraphicsGetCurrentContext(), [UIBezierPath bezierPathWithOvalInRect:CGRectMake(0, 0, side, side)].CGPath); CGContextClip(UIGraphicsGetCurrentContext()); CGFloat marginX = -(image.size.width - side) * 0.5; CGFloat marginY = -(image.size.height - side) * 0.5; [image drawInRect:CGRectMake(marginX, marginY, image.size.width, image.size.height)]; CGContextDrawPath(UIGraphicsGetCurrentContext(), kCGPathFillStroke); UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext(); UIGraphicsEndImageContext(); return newImage;&#125; å¼‚æ­¥ç»˜åˆ¶å½“æƒ³è¿›ä¸€æ­¥ä¼˜åŒ–tableviewæ€§èƒ½æ—¶å¯ä»¥è€ƒè™‘å¼‚æ­¥ç»˜åˆ¶cellåŠæ–‡æœ¬æŽ§ä»¶ç­‰ã€‚å¤§ç¥žçš„YYAsyncLayerå®žçŽ°äº†å¼‚æ­¥ç»˜åˆ¶çš„æŽ§ä»¶ã€‚ UITableViewä¼˜åŒ–æ€»ç»“UITableViewçš„ä¼˜åŒ–ä¸»è¦ä»Žä¸‰ä¸ªæ–¹é¢å…¥æ‰‹ï¼š 123æå‰è®¡ç®—å¹¶ç¼“å­˜å¥½é«˜åº¦ï¼ˆå¸ƒå±€ï¼‰ï¼Œå› ä¸ºheightForRowAtIndexPath:æ˜¯è°ƒç”¨æœ€é¢‘ç¹çš„æ–¹æ³•ï¼›å¼‚æ­¥ç»˜åˆ¶ï¼Œé‡åˆ°å¤æ‚ç•Œé¢ï¼Œé‡åˆ°æ€§èƒ½ç“¶é¢ˆæ—¶ï¼Œå¯èƒ½å°±æ˜¯çªç ´å£ï¼›æ»‘åŠ¨æ—¶æŒ‰éœ€åŠ è½½ï¼Œè¿™ä¸ªåœ¨å¤§é‡å›¾ç‰‡å±•ç¤ºï¼Œç½‘ç»œåŠ è½½çš„æ—¶å€™å¾ˆç®¡ç”¨ï¼ï¼ˆSDWebImageå·²ç»å®žçŽ°å¼‚æ­¥åŠ è½½ï¼Œé…åˆè¿™æ¡æ€§èƒ½æ æ çš„ï¼‰ã€‚ é™¤äº†ä¸Šé¢æœ€ä¸»è¦çš„ä¸‰ä¸ªæ–¹é¢å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå‡ ä¹Žå¤§ä¼™éƒ½å¾ˆç†ŸçŸ¥çš„ä¼˜åŒ–ç‚¹ï¼š 1234567æ­£ç¡®ä½¿ç”¨reuseIdentifieræ¥é‡ç”¨Cellså°½é‡ä½¿æ‰€æœ‰çš„view opaqueï¼ŒåŒ…æ‹¬Cellè‡ªèº«å°½é‡å°‘ç”¨æˆ–ä¸ç”¨é€æ˜Žå›¾å±‚å¦‚æžœCellå†…çŽ°å®žçš„å†…å®¹æ¥è‡ªwebï¼Œä½¿ç”¨å¼‚æ­¥åŠ è½½ï¼Œç¼“å­˜è¯·æ±‚ç»“æžœå‡å°‘subviewsçš„æ•°é‡åœ¨heightForRowAtIndexPath:ä¸­å°½é‡ä¸ä½¿ç”¨cellForRowAtIndexPath:ï¼Œå¦‚æžœä½ éœ€è¦ç”¨åˆ°å®ƒï¼Œåªç”¨ä¸€æ¬¡ç„¶åŽç¼“å­˜ç»“æžœå°½é‡å°‘ç”¨addViewç»™CellåŠ¨æ€æ·»åŠ Viewï¼Œå¯ä»¥åˆå§‹åŒ–æ—¶å°±æ·»åŠ ï¼Œç„¶åŽé€šè¿‡hideæ¥æŽ§åˆ¶æ˜¯å¦æ˜¾ç¤º å‚è€ƒ: ibiremeiOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ mo_xiao_moUITableViewçš„ä¼˜åŒ–æŠ€å·§ï¼å¼‚æ­¥ç»˜åˆ¶Cell iOS_å°æ¾å“¥UITableViewè‡ªåŠ¨è®¡ç®—cellé«˜åº¦å¹¶ç¼“å­˜ï¼Œå†ä¹Ÿä¸ç”¨ç®¡é«˜åº¦å•¦]]></content>
      <categories>
        <category>UIè§†å›¾</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[iOS runtimeåº”ç”¨ï¼šå…³è”å¯¹è±¡]]></title>
    <url>%2F2018%2F01%2F23%2FiOS-runtime%E5%BA%94%E7%94%A8%EF%BC%9A%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%2F</url>
    <content type="text"><![CDATA[å‰è¨€ç»™å·²æœ‰ç±»æ·»åŠ æ–¹æ³•ä½¿ç”¨Categoryå°±å¯ä»¥äº†ï¼Œä½†å¦‚æžœå‘åˆ†ç±»é‡Œæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå±žæ€§çš„è¯ä¼šæŠ¥é”™ï¼Œä½¿ç”¨å±žæ€§ä¸èƒ½æ­£ç¡®åˆ›å»ºå®žä¾‹åŠå­˜å–æ–¹æ³•ã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å®žçŽ°runtimeçš„Associated Objects(å…³è”å¯¹è±¡)ï¼Œå®ƒå¯ä»¥è®©å¯¹è±¡åœ¨è¿è¡Œæ—¶å…³è”ä»»ä½•å€¼ã€‚ runtimeä¸­æä¾›ç»™æˆ‘ä»¬çš„æ–¹æ³•ï¼š123456//å…³è”å¯¹è±¡void objc_setAssociatedObject(id object,const void *key,id value,objc_AssociationPolicy policy);//èŽ·å–å…³è”çš„å¯¹è±¡id objc_getAssociatedObject(id object,const void *key);//ç§»é™¤å…³è”çš„å¯¹è±¡void objc_removeAssociatedObjects(id object); å˜é‡è¯´æ˜Žï¼š1234id object:è¢«å…³è”çš„å¯¹è±¡const void *key:å…³è”çš„keyï¼Œè¦æ±‚å”¯ä¸€id value:å…³è”çš„å¯¹è±¡Objc_AssociationPolicy poliy:å†…å­˜ç®¡ç†ç­–ç•¥ Objc_AssociationPolicy policyçš„enumå€¼æœ‰:1234567891011typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123; OBJC_ASSOCIATION_ASSIGN = 0, /**&lt; Specifies a weak reference to the associated object. */ OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object. * The association is not made atomically. */ OBJC_ASSOCIATION_COPY_NONATOMIC = 3, /**&lt; Specifies that the associated object is copied. * The association is not made atomically. */ OBJC_ASSOCIATION_RETAIN = 01401, /**&lt; Specifies a strong reference to the associated object. * The association is made atomically. */ OBJC_ASSOCIATION_COPY = 01403 /**&lt; Specifies that the associated object is copied. * The association is made atomically. */&#125;; ä¸åŒçš„objc_AssociationPolicyå¯¹åº”äº†ä¸åŒçš„å±žæ€§ä¿®é¥°ç¬¦ã€‚ Objc_AssociationPolicyåº”ç”¨:UIButtonæ‰©å±•ä¹‹åŠ¨æ€æ·»åŠ å±žæ€§.hæ–‡ä»¶ 1234567#import &lt;UIKit/UIKit.h&gt;typedef void (^block)(void);@interface UIButton (Block)@property(nonatomic,assign) NSString *name;@end .mæ–‡ä»¶ 1234567891011121314151617#import &lt;objc/runtime.h&gt;static const char myKey;@implementation UIButton (Block)- (void)setName:(NSString *)name&#123; //å…³è”å¯¹è±¡ objc_setAssociatedObject(self, &amp;myKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);&#125;- (NSString *)name&#123; //èŽ·å–å…³è”å¯¹è±¡ return objc_getAssociatedObject(self, &amp;myKey);&#125;@end Viewcontroller.m 123456789101112131415161718192021222324#import &quot;ViewController.h&quot;#import &quot;UIButton+Block.h&quot;@interface ViewController ()@end@implementation ViewController- (void)viewDidLoad &#123; [super viewDidLoad]; UIButton *btn = [UIButton buttonWithType:UIButtonTypeCustom]; [self.view addSubview:btn]; btn.backgroundColor = [UIColor redColor]; btn.frame = CGRectMake(100, 100, 100, 50); btn.name = @&quot;darling&quot;; [btn addTarget:self action:@selector(message:) forControlEvents:UIControlEventTouchUpInside ]; // Do any additional setup after loading the view, typically from a nib.&#125;- (void)message:(UIButton *)btn&#123; NSLog(@&quot;name = %@&quot;,btn.name);&#125; UIButtonæ‰©å±•ä¹‹åŠ¨æ€æ·»åŠ æ–¹æ³•.hæ–‡ä»¶ 123456#import &lt;UIKit/UIKit.h&gt;typedef void (^btnBlock)(void);@interface UIButton (Block)- (void)handelWithBlock:(btnBlock)block;@end .mæ–‡ä»¶ 12345678910111213141516#import &quot;UIButton+Block.h&quot;#import &lt;objc/runtime.h&gt;static const char myKey;@implementation UIButton (Block)- (void)handelWithBlock:(block)block&#123; if (block) &#123; objc_setAssociatedObject(self, &amp;myKey, block, OBJC_ASSOCIATION_COPY_NONATOMIC); &#125; [self addTarget:self action:@selector(btnAction) forControlEvents:UIControlEventTouchUpInside];&#125;- (void)btnAction&#123; block block = objc_getAssociatedObject(self, &amp;myKey); block();&#125;@end ViewController.mæ–‡ä»¶ 1234567891011121314151617181920#import &quot;ViewController.h&quot;#import &quot;UIButton+Block.h&quot;@interface ViewController ()@end@implementation ViewController- (void)viewDidLoad &#123; [super viewDidLoad]; UIButton *btn = [UIButton buttonWithType:UIButtonTypeCustom]; [self.view addSubview:btn]; btn.backgroundColor = [UIColor redColor]; btn.frame = CGRectMake(100, 100, 100, 50); [btn handelWithBlock:^&#123; NSLog(@&quot;darling&quot;); &#125;]; // Do any additional setup after loading the view, typically from a nib.&#125; å‚è€ƒæ–‡çŒ® objc_setAssociatedObjectä¸ŽBlockçš„ç®€å•ä½¿ç”¨ objc_setAssociatedObject/objc_getAssociatedObject]]></content>
      <categories>
        <category>runtime</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[iOS DESæ€»ç»“]]></title>
    <url>%2F2018%2F01%2F15%2FiOS-DES%E6%80%BB%E7%BB%93%2F</url>
    <content type="text"><![CDATA[iOSä¸­ä½¿ç”¨DESåŠ å¯†æ€»ç»“ å¸¸è§çš„å¯¹ç§°åŠ å¯†æœ‰:DESã€3DESã€RC4ã€AESç­‰ï¼›åŠ å¯†ç®—æ³•éƒ½æœ‰å‡ ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼š1.ç§˜é’¥é•¿åº¦ï¼›2.åŠ å¯†æ¨¡å¼ï¼›3.å—åŠ å¯†ç®—æ³•é‡Œçš„å¡«å……åŒºåˆ†ï¼›ä»¥ä¸‹æ˜¯æˆ‘å¯¹åšé¡¹ç›®æ—¶é‡åˆ°çš„é—®é¢˜æ‰€åšçš„å°ç»“ 1234567891011ccStatus = CCCrypt(encryptOperation, kCCAlgorithmDES, kCCOptionPKCS7Padding|kCCOptionECBMode, vkey, kCCKeySizeDES, iv, dataIn, dataInLength, (void *)dataOut, dataOutAvailable, &amp;dataOutMoved); ç¬¬ä¸€ä¸ªå‚æ•°encryptOperationï¼šå‘Šè¯‰å‡½æ•°åŠ å¯†è¿˜æ˜¯è§£å¯† ç¬¬äºŒä¸ªå‚æ•°kCCAlgorithmDESï¼šä½¿ç”¨DESåŠ å¯† ç¬¬ä¸‰ä¸ªå‚æ•° kCCOptionPKCS7Padding|kCCOptionECBModeä½¿ç”¨ECBåŠ å¯†æ¨¡å¼å’ŒPKCS7Paddingå¡«å……æ¨¡å¼ï¼Œå¦‚æžœä½¿ç”¨kCCOptionPKCS7Paddingå°±ä»£è¡¨ä½¿ç”¨CBCåŠ å¯†æ¨¡å¼å¹¶ä¸”ä½¿ç”¨PKCS7Paddingçš„å¡«å……æ¨¡å¼ã€‚ åœ¨DESä¸­åŠ å¯†æ•°æ®åŒ…å•ä½é•¿åº¦æ˜¯8å­—èŠ‚ï¼Œåœ¨8è‡ªå·±çš„æƒ…å†µä¸‹PKCS7Paddingç­‰ä»·äºŽPKCS5Paddingã€‚ åŽå°å¤§å“¥ç»™äº†ä¸€ä¸ªçº¿ä¸ŠåŠ å¯†çš„åœ°å€è®©æˆ‘å¯¹ã€‚ http://tool.chacuo.net/cryptdes è°ƒè¯•äº†åŠå¤©åŽŸæ¥æ˜¯æˆ‘è‡ªå·±çš„åŠ å¯†æ¨¡å¼ä¸å¯¹ï¼Œä½¿ç”¨äº†CBCæ¨¡å¼ï¼Œè€ŒåŽå°ç”¨çš„æ˜¯ECBã€‚ å‚è€ƒèµ„æ–™ï¼š http://blog.csdn.net/u010184533/article/details/38975871]]></content>
      <categories>
        <category>åŠ å¯†</category>
      </categories>
  </entry>
</search>
