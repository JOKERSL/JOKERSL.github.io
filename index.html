<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
<meta property="og:type" content="website">
<meta property="og:title" content="Man Tou Pu&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/iOSé¢è¯•/index.html">
<meta property="og:site_name" content="Man Tou Pu&#39;s Blog">
<meta property="og:description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Man Tou Pu&#39;s Blog">
<meta name="twitter:description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">






  <link rel="canonical" href="http://yoursite.com/iOSé¢è¯•/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Man Tou Pu's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Man Tou Pu's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">æŠ€æœ¯ã€ç”Ÿæ´»ä¸ªäººåšå®¢</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />é¦–é¡µ</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />åˆ†ç±»</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />å½’æ¡£</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/KVOçš„åº•å±‚å®ç°åŸç†/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/KVOçš„åº•å±‚å®ç°åŸç†/" itemprop="url">
                  KVOçš„åº•å±‚å®ç°åŸç†
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 18:07:43" itemprop="dateCreated datePublished" datetime="2018-09-13T18:07:43+08:00">2018-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2018-09-14 11:21:02" itemprop="dateModified" datetime="2018-09-14T11:21:02+08:00">2018-09-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Objective-Cè¯­è¨€ç‰¹æ€§/" itemprop="url" rel="index"><span itemprop="name">Objective-Cè¯­è¨€ç‰¹æ€§</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="addObserver-forKeyPath-options-context-å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ-observerä¸­éœ€è¦å®ç°å“ªä¸ªæ–¹æ³•æ‰èƒ½è·å¾—KVOå›è°ƒï¼Ÿ"><a href="#addObserver-forKeyPath-options-context-å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ-observerä¸­éœ€è¦å®ç°å“ªä¸ªæ–¹æ³•æ‰èƒ½è·å¾—KVOå›è°ƒï¼Ÿ" class="headerlink" title="addObserver:forKeyPath:options:context:å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ, observerä¸­éœ€è¦å®ç°å“ªä¸ªæ–¹æ³•æ‰èƒ½è·å¾—KVOå›è°ƒï¼Ÿ"></a>addObserver:forKeyPath:options:context:å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ, observerä¸­éœ€è¦å®ç°å“ªä¸ªæ–¹æ³•æ‰èƒ½è·å¾—KVOå›è°ƒï¼Ÿ</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> 1. self.personï¼šè¦ç›‘å¬çš„å¯¹è±¡</span><br><span class="line"> 2. å‚æ•°è¯´æ˜ï¼š</span><br><span class="line">    * @param addObserver  è§‚å¯Ÿè€…ï¼Œè´Ÿè´£å¤„ç†ç›‘å¬äº‹ä»¶çš„å¯¹è±¡</span><br><span class="line">    * @param forKeyPath è¦ç›‘å¬çš„å±æ€§</span><br><span class="line">    * @param  options è§‚å¯Ÿçš„é€‰é¡¹ï¼ˆè§‚å¯Ÿæ–°ã€æ—§å€¼ï¼Œä¹Ÿå¯ä»¥éƒ½è§‚å¯Ÿï¼‰</span><br><span class="line">    * @param context ä¸Šä¸‹æ–‡ï¼Œç”¨äºä¼ é€’æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨ä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„ç›‘å¬</span><br><span class="line"> */</span><br><span class="line">[self.person addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:@&quot;Person Name&quot;];</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  å½“ç›‘æ§çš„æŸä¸ªå±æ€§çš„å€¼æ”¹å˜äº†å°±ä¼šè°ƒç”¨</span><br><span class="line"> *</span><br><span class="line"> *  @param keyPath ç›‘å¬çš„å±æ€§å</span><br><span class="line"> *  @param object  å±æ€§æ‰€å±çš„å¯¹è±¡</span><br><span class="line"> *  @param change  å±æ€§çš„ä¿®æ”¹æƒ…å†µï¼ˆå±æ€§åŸæ¥çš„å€¼`oldValue`ã€å±æ€§æœ€æ–°çš„å€¼`newValue`ï¼‰</span><br><span class="line"> *  @param context ä¼ é€’çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¸ç›‘å¬çš„æ—¶å€™ä¼ é€’çš„ä¸€è‡´ï¼Œå¯ä»¥åˆ©ç”¨ä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„ç›‘å¬</span><br><span class="line"> */</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;%@å¯¹è±¡çš„%@å±æ€§æ”¹å˜äº†ï¼š%@&quot;, object, keyPath, change);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="KVO-Key-Value-Observing"><a href="#KVO-Key-Value-Observing" class="headerlink" title="KVO (Key-Value Observing)"></a>KVO (Key-Value Observing)</h2><p>KVO æ˜¯ Objective-C å¯¹è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰çš„å®ç°ã€‚ä¹Ÿæ˜¯ Cocoa Binding çš„åŸºç¡€ã€‚å½“è¢«è§‚å¯Ÿå¯¹è±¡çš„æŸä¸ªå±æ€§å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œè§‚å¯Ÿè€…å¯¹è±¡ä¼šè·å¾—é€šçŸ¥ã€‚</p>
<p>æœ‰æ„æ€çš„æ˜¯ï¼Œä½ ä¸éœ€è¦ç»™è¢«è§‚å¯Ÿçš„å¯¹è±¡æ·»åŠ ä»»ä½•é¢å¤–ä»£ç ï¼Œå°±èƒ½ä½¿ç”¨ KVO ã€‚è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p>
<h1 id="KVOå†…éƒ¨å®ç°åŸç†"><a href="#KVOå†…éƒ¨å®ç°åŸç†" class="headerlink" title="KVOå†…éƒ¨å®ç°åŸç†"></a>KVOå†…éƒ¨å®ç°åŸç†</h1><ul>
<li><p>KVOæ˜¯åŸºäºruntimeæœºåˆ¶å®ç°çš„</p>
</li>
<li><p>å½“æŸä¸ªç±»çš„å±æ€§å¯¹è±¡<code>ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿ</code>æ—¶ï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿è¡ŒæœŸ<code>åŠ¨æ€</code>åœ°åˆ›å»º<code>è¯¥ç±»çš„ä¸€ä¸ªæ´¾ç”Ÿç±»</code>ï¼Œåœ¨è¿™ä¸ªæ´¾ç”Ÿç±»ä¸­é‡å†™åŸºç±»ä¸­ä»»ä½•è¢«è§‚å¯Ÿå±æ€§çš„setter æ–¹æ³•ã€‚æ´¾ç”Ÿç±»åœ¨è¢«é‡å†™çš„setteræ–¹æ³•å†…å®ç°çœŸæ­£çš„<code>é€šçŸ¥æœºåˆ¶</code></p>
</li>
<li><p>å¦‚æœåŸç±»ä¸ºPersonï¼Œé‚£ä¹ˆç”Ÿæˆçš„æ´¾ç”Ÿç±»åä¸º<code>NSKVONotifying_Person</code></p>
</li>
<li><p>æ¯ä¸ªç±»å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆæŒ‡å‘å½“å‰ç±»ï¼Œå½“ä¸€ä¸ªç±»å¯¹è±¡çš„ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šå·å·å°†isaæŒ‡é’ˆæŒ‡å‘åŠ¨æ€ç”Ÿæˆçš„æ´¾ç”Ÿç±»ï¼Œä»è€Œåœ¨ç»™è¢«ç›‘æ§å±æ€§èµ‹å€¼æ—¶æ‰§è¡Œçš„æ˜¯æ´¾ç”Ÿç±»çš„setteræ–¹æ³•</p>
</li>
<li><p>é”®å€¼è§‚å¯Ÿé€šçŸ¥ä¾èµ–äºNSObject çš„ä¸¤ä¸ªæ–¹æ³•: <code>willChangeValueForKey:</code>å’Œ <code>didChangevlueForKey:</code>ï¼›åœ¨ä¸€ä¸ªè¢«è§‚å¯Ÿå±æ€§å‘ç”Ÿæ”¹å˜ä¹‹å‰ï¼Œ <code>willChangeValueForKey:</code>ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿™å°± ä¼šè®°å½•æ—§çš„å€¼ã€‚è€Œå½“æ”¹å˜å‘ç”Ÿåï¼Œ<code>didChangeValueForKey:</code>ä¼šè¢«è°ƒç”¨ï¼Œç»§è€Œ <code>observeValueForKey:ofObject:change:context:</code>ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚</p>
</li>
<li><p>è¡¥å……ï¼šKVOçš„è¿™å¥—å®ç°æœºåˆ¶ä¸­è‹¹æœè¿˜å·å·é‡å†™äº†classæ–¹æ³•ï¼Œè®©æˆ‘ä»¬è¯¯è®¤ä¸ºè¿˜æ˜¯ä½¿ç”¨çš„å½“å‰ç±»ï¼Œä»è€Œè¾¾åˆ°éšè—ç”Ÿæˆçš„æ´¾ç”Ÿç±»</p>
<p>â€‹</p>
<p>â€‹</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1429890-b28e010d3a7dbdb8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/953" alt="img"></p>
<p>KVOå†…éƒ¨å®ç°åŸç†.png</p>
<h1 id="å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO"><a href="#å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO" class="headerlink" title="å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO"></a>å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO</h1></li>
</ul>
<ul>
<li>è‡ªåŠ¨è§¦å‘çš„åœºæ™¯ï¼šåœ¨æ³¨å†ŒKVOä¹‹å‰è®¾ç½®ä¸€ä¸ªåˆå§‹å€¼ï¼Œæ³¨å†Œä¹‹åï¼Œè®¾ç½®ä¸€ä¸ªä¸ä¸€æ ·çš„å€¼ï¼Œå°±å¯ä»¥è§¦å‘äº†</li>
<li>æƒ³çŸ¥é“å¦‚ä½•æ‰‹åŠ¨è§¦å‘ï¼Œå¿…é¡»çŸ¥é“è‡ªåŠ¨è§¦å‘ KVO çš„åŸç†ï¼Œè§ä¸Šé¢çš„æè¿°</li>
<li>æ‰‹åŠ¨è§¦å‘æ¼”ç¤º</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong) NSDate *now;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚</span><br><span class="line">    [self willChangeValueForKey:@&quot;now&quot;];</span><br><span class="line"></span><br><span class="line">    // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚</span><br><span class="line">    [self didChangeValueForKey:@&quot;now&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/1429890-41421e825e153835.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/521" alt="img"></p>
<p>æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO.png    </p>
<h1 id="è¡¥å……ï¼š-å¦‚ä½•å…³é—­é»˜è®¤çš„KVOçš„é»˜è®¤å®ç°ï¼Œå¹¶è¿›å…¥è‡ªå®šä¹‰çš„KVOå®ç°ï¼Ÿï¼ˆçœ‹é“¾æ¥ï¼‰"><a href="#è¡¥å……ï¼š-å¦‚ä½•å…³é—­é»˜è®¤çš„KVOçš„é»˜è®¤å®ç°ï¼Œå¹¶è¿›å…¥è‡ªå®šä¹‰çš„KVOå®ç°ï¼Ÿï¼ˆçœ‹é“¾æ¥ï¼‰" class="headerlink" title="è¡¥å……ï¼š å¦‚ä½•å…³é—­é»˜è®¤çš„KVOçš„é»˜è®¤å®ç°ï¼Œå¹¶è¿›å…¥è‡ªå®šä¹‰çš„KVOå®ç°ï¼Ÿï¼ˆçœ‹é“¾æ¥ï¼‰"></a>è¡¥å……ï¼š å¦‚ä½•å…³é—­é»˜è®¤çš„KVOçš„é»˜è®¤å®ç°ï¼Œå¹¶è¿›å…¥è‡ªå®šä¹‰çš„KVOå®ç°ï¼Ÿï¼ˆçœ‹é“¾æ¥ï¼‰</h1><ul>
<li><a href="https://link.jianshu.com/?t=http://tech.glowing.com/cn/implement-kvo/" target="_blank" rel="noopener">å¦‚ä½•è‡ªå·±åŠ¨æ‰‹å®ç° KVO</a></li>
</ul>
<h1 id="é™„æ³¨-KVCåº•å±‚å®ç°åŸç†-å¦‚ä¸‹"><a href="#é™„æ³¨-KVCåº•å±‚å®ç°åŸç†-å¦‚ä¸‹" class="headerlink" title="é™„æ³¨: KVCåº•å±‚å®ç°åŸç†(å¦‚ä¸‹)"></a>é™„æ³¨: KVCåº•å±‚å®ç°åŸç†(å¦‚ä¸‹)</h1><p>KVCè¿ç”¨äº†ä¸€ä¸ªisa-swizzlingæŠ€æœ¯. isa-swizzlingå°±æ˜¯ç±»å‹æ··åˆæŒ‡é’ˆæœºåˆ¶, å°†2ä¸ªå¯¹è±¡çš„isaæŒ‡é’ˆäº’ç›¸è°ƒæ¢, å°±æ˜¯ä¿—ç§°çš„é»‘é­”æ³•.<br>KVCä¸»è¦é€šè¿‡isa-swizzling, æ¥å®ç°å…¶å†…éƒ¨æŸ¥æ‰¾å®šä½çš„. é»˜è®¤çš„å®ç°æ–¹æ³•ï¿½ç”±NSOjectæä¾›isaæŒ‡é’ˆ, å¦‚å…¶åç§°æ‰€æŒ‡,(å°±æ˜¯is a kind ofçš„æ„æ€), æŒ‡å‘åˆ†å‘è¡¨å¯¹è±¡çš„ç±». è¯¥åˆ†å‘è¡¨å®é™…ä¸ŠåŒ…å«äº†æŒ‡å‘å®ç°ç±»ä¸­çš„æ–¹æ³•çš„æŒ‡é’ˆ, å’Œå…¶å®ƒæ•°æ®ã€‚</p>
<blockquote>
<ul>
<li>å…·ä½“ä¸»è¦åˆ†ä¸ºä¸‰å¤§æ­¥</li>
</ul>
</blockquote>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šå¯»æ‰¾è¯¥å±æ€§æœ‰æ²¡æœ‰setsetteræ–¹æ³•ï¼Ÿæœ‰ï¼Œå°±ç›´æ¥èµ‹å€¼</li>
<li>ç¬¬äºŒæ­¥ï¼šå¯»æ‰¾æœ‰æ²¡æœ‰è¯¥å±æ€§å¸¦ä¸‹åˆ’çº¿çš„æˆå‘˜å±æ€§ï¼Ÿæœ‰ï¼Œå°±ç›´æ¥èµ‹å€¼</li>
<li>ç¬¬ä¸‰æ­¥ï¼šå¯»æ‰¾æœ‰æ²¡æœ‰è¯¥å±æ€§çš„æˆå‘˜å±æ€§ï¼Ÿæœ‰ï¼Œå°±ç›´æ¥èµ‹å€¼</li>
</ul>
<blockquote>
<ul>
<li>æˆ–è€…è¿™ä¹ˆè¯´</li>
</ul>
</blockquote>
<ul>
<li>1ã€é¦–å…ˆæœç´¢setKey:æ–¹æ³•.(keyæŒ‡æˆå‘˜å˜é‡å, é¦–å­—æ¯å¤§å†™)</li>
<li>2ã€ä¸Šé¢çš„setteræ–¹æ³•æ²¡æ‰¾åˆ°, å¦‚æœç±»æ–¹æ³•accessInstanceVariablesDirectlyè¿”å›YES. é‚£ä¹ˆæŒ‰ _key, _isKeyï¼Œkey, iskeyçš„é¡ºåºæœç´¢æˆå‘˜å.(NSKeyValueCodingCatogeryä¸­å®ç°çš„ç±»æ–¹æ³•, é»˜è®¤å®ç°ä¸ºè¿”å›YES)</li>
<li>3ã€å¦‚æœæ²¡æœ‰æ‰¾åˆ°æˆå‘˜å˜é‡, è°ƒç”¨setValue:forUnderfinedKey:</li>
</ul>
<p>æ¯”å¦‚è¯´å¦‚ä¸‹çš„ä¸€è¡ŒKVCçš„ä»£ç ï¼š</p>
<h1 id="ä¸¾ä¸ªğŸŒ°e-g"><a href="#ä¸¾ä¸ªğŸŒ°e-g" class="headerlink" title="ä¸¾ä¸ªğŸŒ°e.g:"></a>ä¸¾ä¸ªğŸŒ°e.g:</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[object setValue:@&quot;13123&quot; forKey:@&quot;uuid&quot;];</span><br><span class="line"></span><br><span class="line">å°±ä¼šè¢«ç¼–è¯‘å™¨å¤„ç†æˆ:</span><br><span class="line">// é¦–å…ˆæ‰¾åˆ°å¯¹åº”sel</span><br><span class="line">SEL sel = sel_get_ uuid(&quot;setValue:forKey:&quot;);</span><br><span class="line">// æ ¹æ®object-&gt;isaæ‰¾åˆ°selå¯¹åº”çš„IMPå®ç°æŒ‡é’ˆ</span><br><span class="line">IMP method = objc_msg_lookup (object-&gt;isa,sel);</span><br><span class="line">// è°ƒç”¨æŒ‡é’ˆå®ŒæˆKVCèµ‹å€¼</span><br><span class="line">method(object, sel, @&quot;13123&quot;, @&quot;uuid&quot;);</span><br></pre></td></tr></table></figure>
<p><a href="https://link.jianshu.com/?t=http://blog.csdn.net/iunion/article/details/46890809" target="_blank" rel="noopener"><strong>å¯ä¾›å‚è€ƒæ–‡ç« </strong></a></p>
<p>ä¸‹é¢è¿™ç¯‡ä¹Ÿä¸é”™</p>
<p> <a href="https://www.jianshu.com/p/e59bb8f59302" target="_blank" rel="noopener">KVOçš„å®ç°åŸç†ä¸å…·ä½“åº”ç”¨</a></p>
<p>[è½¬è‡ª <a href="https://www.jianshu.com/p/829864680648" target="_blank" rel="noopener">æ¢ç©¶KVOçš„åº•å±‚å®ç°åŸç†</a>]</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/é€šçŸ¥/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/é€šçŸ¥/" itemprop="url">
                  é€šçŸ¥
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 17:18:02 / ä¿®æ”¹æ—¶é—´ï¼š18:02:50" itemprop="dateCreated datePublished" datetime="2018-09-13T17:18:02+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Objective-Cè¯­è¨€ç‰¹æ€§/" itemprop="url" rel="index"><span itemprop="name">Objective-Cè¯­è¨€ç‰¹æ€§</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ç›®å½• </span><br><span class="line">    ä¸€ã€é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨</span><br><span class="line">    1ã€åŸºæœ¬æ¦‚å¿µ</span><br><span class="line">    2ã€ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥</span><br><span class="line">    3ã€å¦‚ä½•ä½¿ç”¨é€šçŸ¥</span><br><span class="line">    4ã€ä½¿ç”¨é€šçŸ¥éœ€è¦æ³¨æ„å“ªäº›ç»†èŠ‚</span><br><span class="line">    äºŒã€é€šçŸ¥çš„å®ç°åŸç†</span><br><span class="line">    1ã€æ¦‚è¿°</span><br><span class="line">    2ã€å®ç°</span><br></pre></td></tr></table></figure>
<h1 id="é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨"><a href="#é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨"></a>é€šçŸ¥çš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>NSNotification æ˜¯iOSä¸­ä¸€ä¸ªè°ƒåº¦æ¶ˆæ¯é€šçŸ¥çš„ç±»,é‡‡ç”¨å•ä¾‹æ¨¡å¼è®¾è®¡,åœ¨ç¨‹åºä¸­å®ç°ä¼ å€¼ã€å›è°ƒç­‰åœ°æ–¹åº”ç”¨å¾ˆå¹¿ã€‚åœ¨iOSä¸­ï¼ŒNSNotification &amp; NSNotificationCenteræ˜¯ä½¿ç”¨<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>æ¥å®ç°çš„ç”¨äºè·¨å±‚ä¼ é€’æ¶ˆæ¯ã€‚</p>
<h2 id="ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥"><a href="#ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥" class="headerlink" title="ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥"></a>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨é€šçŸ¥</h2><p>è§‚å¯Ÿè€…æ¨¡å¼ ï¼š å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨æ›´æ–°ã€‚ </p>
<p>åº”ç”¨åœºæ™¯ : </p>
<p>1&gt; å¯¹ä¸€ä¸ªå¯¹è±¡çš„æ”¹å˜éœ€è¦åŒæ—¶æ”¹å˜å…¶ä»–å¯¹è±¡ï¼Œè€Œä¸çŸ¥é“å…·ä½“æœ‰å¤šå°‘å¯¹è±¡æœ‰å¾…æ”¹å˜ã€‚</p>
<p>2&gt; ä¸€ä¸ªå¯¹è±¡å¿…é¡»é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œè€Œå®ƒåˆä¸éœ€è¦çŸ¥é“å…¶ä»–å¯¹è±¡æ˜¯ä»€ä¹ˆ</p>
<p>3ã€å¦‚ä½•ä½¿ç”¨é€šçŸ¥</p>
<p>1&gt; å‘è§‚å¯Ÿè€…ä¸­å¿ƒæ·»åŠ è§‚å¯Ÿè€…(2ç§æ–¹å¼)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//è§‚å¯Ÿè€…æ¥æ”¶åˆ°é€šçŸ¥åæ‰§è¡Œä»»åŠ¡çš„ä»£ç åœ¨å‘é€é€šçŸ¥çš„çº¿ç¨‹ä¸­æ‰§è¡Œ</span><br><span class="line">addObserver:selector:name:object:</span><br><span class="line"></span><br><span class="line">//è§‚å¯Ÿè€…æ¥æ”¶åˆ°é€šçŸ¥åæ‰§è¡Œä»»åŠ¡çš„ä»£ç åœ¨æŒ‡å®šçš„æ“ä½œé˜Ÿåˆ—ä¸­æ‰§è¡Œ</span><br><span class="line">addObserverForName:object:queue:usingBlock:</span><br></pre></td></tr></table></figure>
<p>2&gt; é€šçŸ¥ä¸­å¿ƒå‘è§‚å¯Ÿè€…å‘é€æ¶ˆæ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">postNotification:</span><br><span class="line">postNotificationName:object:</span><br><span class="line">postNotificationName:object:userInfo:</span><br></pre></td></tr></table></figure>
<p>3&gt; è§‚å¯Ÿè€…æ¥æ”¶åˆ°æ¶ˆæ¯æ‰§è¡Œç›¸åº”çš„è¡Œä¸º</p>
<p>4&gt; åœ¨é€šçŸ¥ä¸­å¿ƒç§»é™¤è§‚å¯Ÿè€…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">removeObserver:</span><br><span class="line">removeObserver:name:object:</span><br></pre></td></tr></table></figure>
<p>4ã€ä½¿ç”¨é€šçŸ¥éœ€è¦æ³¨æ„å“ªäº›ç»†èŠ‚</p>
<p>1&gt; é€šçŸ¥ä¸€å®šè¦ç§»é™¤ï¼Œåœ¨deallocæ–¹æ³•é‡Œé¢ç§»é™¤<br>2&gt; é€šçŸ¥æœ‰åŒæ­¥é€šçŸ¥å’Œå¼‚æ­¥é€šçŸ¥ï¼Œåªä¸è¿‡æˆ‘ä»¬åŒæ­¥é€šçŸ¥ç”¨å¾—æ¯”è¾ƒå¤šã€‚<br>3&gt; ä¸èƒ½ç”¨<code>- (instancetype)init</code> åˆå§‹åŒ–ä¸€ä¸ªé€šçŸ¥</p>
<h1 id="é€šçŸ¥çš„å®ç°åŸç†"><a href="#é€šçŸ¥çš„å®ç°åŸç†" class="headerlink" title="é€šçŸ¥çš„å®ç°åŸç†"></a>é€šçŸ¥çš„å®ç°åŸç†</h1><p>1ã€æ¦‚è¿° ï¼š é¦–å…ˆï¼Œä¿¡æ¯çš„ä¼ é€’å°±ä¾é é€šçŸ¥(NSNotification),ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šçŸ¥å°±æ˜¯ä¿¡æ¯(æ‰§è¡Œçš„æ–¹æ³•ï¼Œè§‚å¯Ÿè€…æœ¬èº«(self),å‚æ•°)çš„åŒ…è£…ã€‚é€šçŸ¥ä¸­å¿ƒ(NSNotificationCenter)æ˜¯ä¸ªå•ä¾‹ï¼Œå‘é€šçŸ¥ä¸­å¿ƒæ³¨å†Œè§‚å¯Ÿè€…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªé€šçŸ¥ä¸­å¿ƒæœ‰ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆå­˜æ”¾ç€è§‚å¯Ÿè€…ã€‚é‚£ä¹ˆè¿™ä¸ªé›†åˆæ˜¯ä»€ä¹ˆæ ·çš„æ•°æ®ç±»å‹ ï¼Ÿ å¯ä»¥è¿™ä¹ˆæ€è€ƒï¼š å‘é€é€šçŸ¥éœ€è¦nameå‚æ•°ï¼Œæ·»åŠ è§‚å¯Ÿè€…ä¹Ÿæœ‰ä¸ªnameå‚æ•°ï¼Œè¿™ä¸¤ä¸ªnameä¸€æ ·çš„æ—¶å€™ï¼Œå½“å‘é€é€šçŸ¥æ—¶å€™ï¼Œè§‚å¯Ÿè€…å¯¹è±¡å°±èƒ½æ¥å—åˆ°ä¿¡æ¯ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚é‚£ä¹ˆè¿™ä¸ªé›†åˆå¾ˆå®¹æ˜“æƒ³åˆ°å°±æ˜¯NSDictionary!<br>keyå°±æ˜¯nameï¼Œvalueå°±æ˜¯NSArray(å­˜æ”¾æ•°æ®æ¨¡å‹)ï¼Œé‡Œé¢å­˜æ”¾è§‚å¯Ÿè€…å¯¹è±¡ã€‚å¦‚ä¸‹å›¾<br><img src="http://ovwhbnlx7.bkt.clouddn.com/20170727145827579.png" alt="avatar"><br>å½“å‘é€é€šçŸ¥æ—¶ï¼Œåœ¨é€šçŸ¥é€šçŸ¥çš„å­—å…¸ï¼Œæ ¹æ®nameæ‰¾åˆ°valueï¼Œè¿™ä¸ªvalueå°±æ˜¯ä¸€æ•°ç»„ï¼Œæ•°ç»„é‡Œé¢å­˜æ”¾æ•°æ®æ¨¡å‹(observerã€SEL)ã€‚å³å¯æ‰§è¡Œå¯¹åº”çš„è¡Œä¸ºã€‚</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>æ ¹æ®NSNotification&amp;NSNotificationCenteræ¥å£ç»™å‡ºå®ç°ä»£ç ,åˆ›å»ºä¸¤ä¸ªæ–°ç±»YFLNotification,YFLNotificationCenterï¼Œè¿™ä¸¤ä¸ªç±»çš„æ¥å£å’Œè‹¹æœæä¾›çš„æ¥å£å®Œå…¨ä¸€æ ·ï¼Œæˆ‘å°†æ ¹æ®æ¥å£æä¾›çš„åŠŸèƒ½ç»™å‡ºå®ç°ä»£ç ã€‚<br>è¦ç‚¹æ˜¯é€šçŸ¥ä¸­å¿ƒæ˜¯å•ä¾‹ç±»ï¼Œå¹¶ä¸”é€šçŸ¥ä¸­å¿ƒç»´æŠ¤äº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ³¨å†Œçš„è§‚å¯Ÿè€…çš„é›†åˆï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº†åŠ¨æ€æ•°ç»„æ¥å­˜å‚¨æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">+(YFLNotificationCenter*)defaultCenter</span><br><span class="line">&#123;</span><br><span class="line">    static YFLNotificationCenter *singleton;</span><br><span class="line"></span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line"></span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line"></span><br><span class="line">        singleton = [[self alloc] initSingleton];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return singleton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (instancetype)initSingleton</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    if ([super init]) &#123;</span><br><span class="line"></span><br><span class="line">        _obsetvers = [[NSMutableDictionary alloc]init];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return self;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜å®šä¹‰äº†ä¸€ä¸ªè§‚å¯Ÿè€…æ¨¡å‹ç”¨äºä¿å­˜è§‚å¯Ÿè€…ï¼Œé€šçŸ¥æ¶ˆæ¯åï¼Œè§‚å¯Ÿè€…æ”¶åˆ°é€šçŸ¥åæ‰§è¡Œä»£ç æ‰€åœ¨çš„æ“ä½œé˜Ÿåˆ—å’Œæ‰§è¡Œä»£ç çš„å›è°ƒï¼Œæ¨¡å‹æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@interface YFLObserverModel : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) id observer;  //è§‚å¯Ÿè€…å¯¹è±¡</span><br><span class="line">@property (nonatomic, assign) SEL selector;  //æ‰§è¡Œçš„æ–¹æ³•</span><br><span class="line">@property (nonatomic, copy) NSString *notificationName; //é€šçŸ¥åå­—</span><br><span class="line">@property (nonatomic, strong) id object;  //æºå¸¦å‚æ•°</span><br><span class="line">@property (nonatomic, strong) NSOperationQueue *operationQueue;//é˜Ÿåˆ—</span><br><span class="line">@property (nonatomic, copy) OperationBlock block;  //å›è°ƒ</span><br><span class="line">@end12345678910</span><br></pre></td></tr></table></figure>
<p>å‘é€šçŸ¥ä¸­å¿ƒæ³¨å†Œè§‚å¯Ÿè€…ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">- (void)addObserver:(id)observer selector:(SEL)aSelector name:(nullable NSString*)aName object:(nullable id)anObject</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    //å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå³åˆ›å»º</span><br><span class="line">    if (![self.obsetvers objectForKey:aName]) &#123;</span><br><span class="line"></span><br><span class="line">        NSMutableArray *arrays = [[NSMutableArray alloc]init];</span><br><span class="line"></span><br><span class="line">        // åˆ›å»ºæ•°ç»„æ¨¡å‹</span><br><span class="line">        YFLObserverModel *observerModel = [[YFLObserverModel alloc]init];</span><br><span class="line">        observerModel.observer = observer;</span><br><span class="line">        observerModel.selector = aSelector;</span><br><span class="line">        observerModel.notificationName = aName;</span><br><span class="line">        observerModel.object = anObject;</span><br><span class="line">        [arrays addObject:observerModel];</span><br><span class="line"></span><br><span class="line">        //å¡«å……è¿›å…¥æ•°ç»„</span><br><span class="line">        [self.obsetvers setObject:arrays forKey:aName];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line"></span><br><span class="line">        //å¦‚æœå­˜åœ¨ï¼Œå–å‡ºæ¥ï¼Œç»§ç»­æ·»åŠ å‡å»å³å¯</span><br><span class="line">        NSMutableArray *arrays = (NSMutableArray*)[self.obsetvers objectForKey:aName];</span><br><span class="line">        // åˆ›å»ºæ•°ç»„æ¨¡å‹</span><br><span class="line">        YFLObserverModel *observerModel = [[YFLObserverModel alloc]init];</span><br><span class="line">        observerModel.observer = observer;</span><br><span class="line">        observerModel.selector = aSelector;</span><br><span class="line">        observerModel.notificationName = aName;</span><br><span class="line">        observerModel.object = anObject;</span><br><span class="line">        [arrays addObject:observerModel];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (id &lt;NSObject&gt;)addObserverForName:(nullable NSString *)name object:(nullable id)obj queue:(nullable NSOperationQueue *)queue usingBlock:(void (^)(YFLNotification *note))block</span><br><span class="line">&#123;</span><br><span class="line">    //å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå³åˆ›å»º</span><br><span class="line">    if (![self.obsetvers objectForKey:name]) &#123;</span><br><span class="line"></span><br><span class="line">        NSMutableArray *arrays = [[NSMutableArray alloc]init];</span><br><span class="line"></span><br><span class="line">        // åˆ›å»ºæ•°ç»„æ¨¡å‹</span><br><span class="line">        YFLObserverModel *observerModel = [[YFLObserverModel alloc]init];</span><br><span class="line">        observerModel.block = block;</span><br><span class="line">        observerModel.notificationName = name;</span><br><span class="line">        observerModel.object = obj;</span><br><span class="line">        observerModel.operationQueue = queue;</span><br><span class="line">        [arrays addObject:observerModel];</span><br><span class="line"></span><br><span class="line">        //å¡«å……è¿›å…¥æ•°ç»„</span><br><span class="line">        [self.obsetvers setObject:arrays forKey:name];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //å¦‚æœå­˜åœ¨ï¼Œå–å‡ºæ¥ï¼Œç»§ç»­æ·»åŠ å³å¯</span><br><span class="line">        NSMutableArray *arrays = (NSMutableArray*)[self.obsetvers objectForKey:name];</span><br><span class="line"></span><br><span class="line">        // åˆ›å»ºæ•°ç»„æ¨¡å‹</span><br><span class="line">        YFLObserverModel *observerModel = [[YFLObserverModel alloc]init];</span><br><span class="line">        observerModel.block = block;</span><br><span class="line">        observerModel.notificationName = name;</span><br><span class="line">        observerModel.object = obj;</span><br><span class="line">        observerModel.operationQueue = queue;</span><br><span class="line">        [arrays addObject:observerModel];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘é€é€šçŸ¥æœ‰ä¸‰ç§æ–¹å¼ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨- (void)postNotification:(YFLNotification *)notificationï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- (void)postNotification:(YFLNotification *)notification</span><br><span class="line">&#123;</span><br><span class="line">    //name å–å‡ºæ¥å¯¹åº”è§‚å¯Ÿè€…æ•°ç»„ï¼Œæ‰§è¡Œä»»åŠ¡</span><br><span class="line">    NSMutableArray *arrays = (NSMutableArray*)[self.obsetvers objectForKey:notification.name];</span><br><span class="line"></span><br><span class="line">    [arrays enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line"></span><br><span class="line">        //å–å‡ºæ•°æ®æ¨¡å‹</span><br><span class="line">        YFLObserverModel *observerModel = obj;</span><br><span class="line">        id observer = observerModel.observer;</span><br><span class="line">        SEL secector = observerModel.selector;</span><br><span class="line"></span><br><span class="line">        if (!observerModel.operationQueue) &#123; </span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">            [observer performSelector:secector withObject:notification];</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line">        &#125;else&#123;</span><br><span class="line"></span><br><span class="line">            //åˆ›å»ºä»»åŠ¡</span><br><span class="line">            NSBlockOperation *operation = [NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line"></span><br><span class="line">                //è¿™é‡Œç”¨blockå›è°ƒå‡ºå»</span><br><span class="line">                observerModel.block(notification);</span><br><span class="line"></span><br><span class="line">            &#125;];</span><br><span class="line"></span><br><span class="line">            // å¦‚æœæ·»åŠ è§‚å¯Ÿè€… ä¼ å…¥ é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡æ”¾åœ¨é˜Ÿåˆ—ä¸­æ‰§è¡Œ(å­çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ)</span><br><span class="line">            NSOperationQueue *operationQueue = observerModel.operationQueue;</span><br><span class="line">            [operationQueue addOperation:operation];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç§»é™¤è§‚å¯Ÿè€…çš„ä»£ç æˆ‘å°±ä¸è´´äº†ï¼Œä¸€æ ·çš„æ€è·¯ã€‚</p>
<p><a href="http://download.csdn.net/download/qq_18505715/9912596" target="_blank" rel="noopener">è¦çœ‹æºç ç‚¹å‡»è¿™é‡Œ</a><br>[è½¬è‡ª <a href="https://blog.csdn.net/qq_18505715/article/details/76146575" target="_blank" rel="noopener">YFL_iOS</a>]</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/iOSåˆ†ç±»/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/iOSåˆ†ç±»/" itemprop="url">
                  iOSåˆ†ç±»
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 14:39:45 / ä¿®æ”¹æ—¶é—´ï¼š17:02:26" itemprop="dateCreated datePublished" datetime="2018-09-13T14:39:45+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Objective-Cè¯­è¨€ç‰¹æ€§/" itemprop="url" rel="index"><span itemprop="name">Objective-Cè¯­è¨€ç‰¹æ€§</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Categoryæ˜¯Objective-C 2.0ä¹‹åæ·»åŠ çš„è¯­è¨€ç‰¹æ€§ï¼ŒCategoryåˆå«åˆ†ç±»ã€ç±»åˆ«ã€ç±»ç›®ï¼Œèƒ½å¤Ÿåœ¨ä¸æ”¹å˜åŸæ¥ç±»å†…å®¹çš„åŸºç¡€ä¸Šï¼Œä¸ºç±»å¢åŠ ä¸€äº›æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒCategoryè¿˜æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<p>ï¼ˆ1ï¼‰å°†ç±»çš„å®ç°åˆ†å¼€å†™åœ¨å‡ ä¸ªåˆ†ç±»é‡Œé¢ã€‚<br>è¿™æ ·åšçš„å¥½å¤„:</p>
<ul>
<li>å¯ä»¥å‡å°‘å•ä¸ªæ–‡ä»¶çš„ä½“ç§¯</li>
<li>å¯ä»¥æŠŠä¸åŒçš„åŠŸèƒ½ç»„ç»‡åˆ°ä¸åŒçš„Categoryé‡Œ</li>
<li>å¯ä»¥ç”±å¤šä¸ªå¼€å‘è€…å…±åŒå®Œæˆä¸€ä¸ªç±»</li>
<li>å¯ä»¥æŒ‰éœ€åŠ è½½æƒ³è¦çš„category</li>
</ul>
<p>ï¼ˆ2ï¼‰å£°æ˜ç§æœ‰çš„æ–¹æ³•ã€‚</p>
<p>ï¼ˆ3ï¼‰æ¨¡æ‹Ÿå¤šç»§æ‰¿ã€‚</p>
<h1 id="Categoryçš„å®šä¹‰ä¸ä½¿ç”¨"><a href="#Categoryçš„å®šä¹‰ä¸ä½¿ç”¨" class="headerlink" title="Categoryçš„å®šä¹‰ä¸ä½¿ç”¨"></a>Categoryçš„å®šä¹‰ä¸ä½¿ç”¨</h1><p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œè¿™é‡Œç›´æ¥é€šè¿‡ä¸€ä¸ªå°ä¾‹å­å»è®²è§£å…¶ç”¨æ³•ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªPersonç±»ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºä¸€ä¸ªCategoryå‘½åä¸ºMyCategoryã€‚åˆ›å»ºCategoryå¾ˆç®€å•ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/1/19/a129eff572b96c5d40342a2491620d07?imageView2/0/w/1280/h/960/ignore-error/1" alt="snip20170109_5"></p>
<p><img src="https://user-gold-cdn.xitu.io/2017/1/19/1648e30865a84419a4e69e1441d3ae45?imageView2/0/w/1280/h/960/ignore-error/1" alt="snip20170109_8"></p>
<p>ä¸ºPersonåˆ›å»ºä¸€ä¸ªåä¸ºMyCategoryçš„Categoryåï¼Œä¼šè‡ªåŠ¨ç”ŸæˆPerson+MyCategory.hå’ŒPerson+MyCategory.mæ–‡ä»¶ã€‚æˆ‘ä»¬åœ¨MyCategoryä¸­å£°æ˜å’Œå®ç°ä¸€ä¸ªreadæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//  Person+MyCategory.h</span><br><span class="line">#import &quot;Person.h&quot;</span><br><span class="line"></span><br><span class="line">@interface Person (MyCategory)</span><br><span class="line"></span><br><span class="line">-(void)read;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//  Person+MyCategory.m</span><br><span class="line">#import &quot;Person+MyCategory.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation Person (MyCategory)</span><br><span class="line"></span><br><span class="line">-(void)read&#123;</span><br><span class="line">    NSLog(@&quot;è°ƒç”¨äº†MyCategoryçš„readæ–¹æ³•ï¼&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ä¹‹åæˆ‘ä»¬å¯ä»¥åœ¨ViewControlleræˆ–å…¶ä»–åœ°æ–¹ä½¿ç”¨åˆ†ç±»ä¸­æ·»åŠ çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//  ViewController.m</span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &quot;Person+MyCategory.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    Person *p = [[Person alloc] init];</span><br><span class="line">    [p read];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2017-01-09 16:27:39.089 Test[5347:483009] è°ƒç”¨äº†MyCategoryçš„readæ–¹æ³•ï¼</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>1</th>
<th>2017-01-09 16:27:39.089 Test [5347:483009] è°ƒç”¨äº†MyCategoryçš„ readæ–¹æ³•ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="ä½¿"><a href="#ä½¿" class="headerlink" title="ä½¿"></a>ä½¿</h3><h3 id="ç”¨æ³¨æ„"><a href="#ç”¨æ³¨æ„" class="headerlink" title="ç”¨æ³¨æ„"></a>ç”¨æ³¨æ„</h3><ol>
<li>åˆ†ç±»åªèƒ½å¢åŠ æ–¹æ³•ï¼Œä¸èƒ½å¢åŠ æˆå‘˜å˜é‡ã€‚</li>
<li>åˆ†ç±»æ–¹æ³•å®ç°ä¸­å¯ä»¥è®¿é—®åŸæ¥ç±»ä¸­å£°æ˜çš„æˆå‘˜å˜é‡ã€‚</li>
<li>åˆ†ç±»å¯ä»¥é‡æ–°å®ç°åŸæ¥ç±»ä¸­çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¼šè¦†ç›–æ‰åŸæ¥çš„æ–¹æ³•ï¼Œä¼šå¯¼è‡´åŸæ¥çš„æ–¹æ³•æ²¡æ³•å†ä½¿ç”¨ï¼ˆå®é™…ä¸Šå¹¶æ²¡æœ‰çœŸçš„æ›¿æ¢ï¼Œè€Œæ˜¯Categoryçš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œè€ŒåŸæ¥ç±»çš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„åé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„Categoryçš„æ–¹æ³•ä¼šâ€œè¦†ç›–â€æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºè¿è¡Œæ—¶åœ¨æŸ¥æ‰¾æ–¹æ³•çš„æ—¶å€™æ˜¯é¡ºç€æ–¹æ³•åˆ—è¡¨çš„é¡ºåºæŸ¥æ‰¾çš„ï¼Œå®ƒåªè¦ä¸€æ‰¾åˆ°å¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±ä¼šç½¢ä¼‘ï¼Œæ®Šä¸çŸ¥åé¢å¯èƒ½è¿˜æœ‰ä¸€æ ·åå­—çš„æ–¹æ³•ï¼‰ã€‚</li>
<li>å½“åˆ†ç±»ã€åŸæ¥ç±»ã€åŸæ¥ç±»çš„çˆ¶ç±»ä¸­æœ‰ç›¸åŒæ–¹æ³•æ—¶ï¼Œæ–¹æ³•è°ƒç”¨çš„ä¼˜å…ˆçº§ï¼šåˆ†ç±»(æœ€åå‚ä¸ç¼–è¯‘çš„åˆ†ç±»ä¼˜å…ˆ) â€“&gt; åŸæ¥ç±»  â€“&gt; çˆ¶ç±»ï¼Œå³å…ˆå»è°ƒç”¨åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼Œåˆ†ç±»ä¸­æ²¡è¿™ä¸ªæ–¹æ³•å†å»åŸæ¥ç±»ä¸­æ‰¾ï¼ŒåŸæ¥ç±»ä¸­æ²¡æœ‰å†å»çˆ¶ç±»ä¸­æ‰¾ã€‚</li>
<li>Categoryæ˜¯åœ¨runtimeæ—¶å€™åŠ è½½ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™ã€‚</li>
</ol>
<h2 id="Categoryä¸æˆå‘˜å˜é‡ã€å±æ€§"><a href="#Categoryä¸æˆå‘˜å˜é‡ã€å±æ€§" class="headerlink" title="Categoryä¸æˆå‘˜å˜é‡ã€å±æ€§"></a>Categoryä¸æˆå‘˜å˜é‡ã€å±æ€§</h2><p>å¦‚æœä½ åœ¨ä½ Categoryçš„.hæ–‡ä»¶ä¸­å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    NSString *str1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xcodeä¼šæŠ¥å¦‚ä¸‹é”™è¯¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Instance variable may not be placed in categories</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™å¥è¯æˆ‘ä»¬çŸ¥é“Xcodeæ˜¯ä¸å…è®¸æˆ‘ä»¬åœ¨Categoryä¸­æ·»åŠ æˆå‘˜å˜é‡çš„ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡å‘¢ï¼Ÿ</p>
<p>Objective-Cç±»æ˜¯ç”±Classç±»å‹æ¥è¡¨ç¤ºçš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘objc_classç»“æ„ä½“çš„æŒ‡é’ˆã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_class *Class;</span><br></pre></td></tr></table></figure>
<p>objc_classç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">#if !__OBJC2__</span><br><span class="line">    Class super_class                       OBJC2_UNAVAILABLE;  // çˆ¶ç±»</span><br><span class="line">    const char *name                        OBJC2_UNAVAILABLE;  // ç±»å</span><br><span class="line">    long version                            OBJC2_UNAVAILABLE;  // ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0</span><br><span class="line">    long info                               OBJC2_UNAVAILABLE;  // ç±»ä¿¡æ¯ï¼Œä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†</span><br><span class="line">    long instance_size                      OBJC2_UNAVAILABLE;  // è¯¥ç±»çš„å®ä¾‹å˜é‡å¤§å°</span><br><span class="line">    struct objc_ivar_list *ivars            OBJC2_UNAVAILABLE;  // è¯¥ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨</span><br><span class="line">    struct objc_method_list **methodLists   OBJC2_UNAVAILABLE;  // æ–¹æ³•å®šä¹‰çš„é“¾è¡¨</span><br><span class="line">    struct objc_cache *cache                OBJC2_UNAVAILABLE;  // æ–¹æ³•ç¼“å­˜</span><br><span class="line">    struct objc_protocol_list *protocols    OBJC2_UNAVAILABLE;  // åè®®é“¾è¡¨</span><br><span class="line">#endif</span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„objc_classç»“æ„ä½“ä¸­ï¼Œivarsæ˜¯objc_ivar_listï¼ˆæˆå‘˜å˜é‡åˆ—è¡¨ï¼‰æŒ‡é’ˆï¼›methodListsæ˜¯æŒ‡å‘objc_method_listæŒ‡é’ˆçš„æŒ‡é’ˆã€‚åœ¨Runtimeä¸­ï¼Œobjc_classç»“æ„ä½“å¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸å¯èƒ½å¾€è¿™ä¸ªç»“æ„ä½“ä¸­æ·»åŠ æ•°æ®ï¼Œåªèƒ½ä¿®æ”¹ã€‚æ‰€ä»¥ivarsæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå›ºå®šåŒºåŸŸï¼Œåªèƒ½ä¿®æ”¹æˆå‘˜å˜é‡å€¼ï¼Œä¸èƒ½å¢åŠ æˆå‘˜å˜é‡ä¸ªæ•°ã€‚methodListæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹*methodListsçš„å€¼æ¥å¢åŠ æˆå‘˜æ–¹æ³•ï¼Œè™½æ²¡åŠæ³•æ‰©å±•methodListsæŒ‡å‘çš„å†…å­˜åŒºåŸŸï¼Œå´å¯ä»¥æ”¹å˜è¿™ä¸ªå†…å­˜åŒºåŸŸçš„å€¼ï¼ˆå­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼‰ã€‚å› æ­¤ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ã€‚</p>
<p>Categoryä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡ï¼ˆinstance variablesï¼‰ï¼Œé‚£åˆ°åº•èƒ½ä¸èƒ½æ·»åŠ å±æ€§ï¼ˆpropertyï¼‰å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªæˆ‘ä»¬è¦ä»Categoryçš„ç»“æ„ä½“å¼€å§‹åˆ†æï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct category_t &#123;</span><br><span class="line">    const char *name;  //ç±»çš„åå­—</span><br><span class="line">    classref_t cls;  //ç±»</span><br><span class="line">    struct method_list_t *instanceMethods;  //categoryä¸­æ‰€æœ‰ç»™ç±»æ·»åŠ çš„å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨</span><br><span class="line">    struct method_list_t *classMethods;  //categoryä¸­æ‰€æœ‰æ·»åŠ çš„ç±»æ–¹æ³•çš„åˆ—è¡¨</span><br><span class="line">    struct protocol_list_t *protocols;  //categoryå®ç°çš„æ‰€æœ‰åè®®çš„åˆ—è¡¨</span><br><span class="line">    struct property_list_t *instanceProperties;  //categoryä¸­æ·»åŠ çš„æ‰€æœ‰å±æ€§</span><br><span class="line">&#125; category_t;</span><br></pre></td></tr></table></figure>
<p>ä»Categoryçš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºCategoryçš„å¯ä¸ºï¼ˆå¯ä»¥æ·»åŠ å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å®ç°åè®®ï¼Œæ·»åŠ å±æ€§ï¼‰å’Œä¸å¯ä¸ºï¼ˆæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼‰ã€‚</p>
<p>ä½†æ˜¯ä¸ºä»€ä¹ˆç½‘ä¸Šå¾ˆå¤šäººéƒ½è¯´Categoryä¸èƒ½æ·»åŠ å±æ€§å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šï¼ŒCategoryå®é™…ä¸Šå…è®¸æ·»åŠ å±æ€§çš„ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨@propertyï¼Œä½†æ˜¯ä¸ä¼šç”Ÿæˆ_å˜é‡ï¼ˆå¸¦ä¸‹åˆ’çº¿çš„æˆå‘˜å˜é‡ï¼‰ï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ·»åŠ å±æ€§çš„getterå’Œsetteræ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œå°½ç®¡æ·»åŠ äº†å±æ€§ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨ç‚¹è¯­æ³•è°ƒç”¨getterå’Œsetteræ–¹æ³•ã€‚ä½†å®é™…ä¸Šå¯ä»¥ä½¿ç”¨runtimeå»å®ç°Categoryä¸ºå·²æœ‰çš„ç±»æ·»åŠ æ–°çš„å±æ€§å¹¶ç”Ÿæˆgetterå’Œsetteræ–¹æ³•ã€‚è¯¦ç»†å†…å®¹å¯ä»¥çœ‹å³°å“¥ä¹‹å‰çš„æ–‡ç« ï¼šã€Š<a href="https://link.juejin.im/?target=http%3A%2F%2Fwww.imlifengfeng.com%2Fblog%2F%3Fp%3D397" target="_blank" rel="noopener"><em>iOS Runtimeä¹‹å››ï¼šå…³è”å¯¹è±¡</em></a>ã€‹</p>
<p>å››ã€<strong>Categoryä¸Extension</strong></p>
<p>1ã€Extensionçš„åŸºæœ¬ç”¨æ³•</p>
<p>Extensionçš„åˆ›å»ºæ–¹æ³•ä¸Categoryä¸€æ ·ï¼Œåªè¦åœ¨åŸæ¥é€‰æ‹©Categoryé€‰æ‹©Extensionå³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸ºPersonåˆ›å»ºä¸€ä¸ªåä¸ºMyExtensionçš„Extensionï¼Œåˆ™æœ€ç»ˆä¼šç”Ÿæˆä¸€ä¸ªPerson_MyExtension.hæ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//  Person_MyExtension.h</span><br><span class="line"></span><br><span class="line">#import &quot;Person.h&quot;</span><br><span class="line"></span><br><span class="line">@interface Person ()</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ä½†è¦æ³¨æ„çš„æ˜¯å’ŒCategoryä¸åŒçš„æ˜¯å®ƒä¸ä¼šç”ŸæˆPerson_MyExtension.mæ–‡ä»¶ã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥åœ¨Person_MyExtension.hä¸­<strong>ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡ã€å±æ€§å’Œæ–¹æ³•</strong>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//  Person_MyExtension.h</span><br><span class="line"></span><br><span class="line">#import &quot;Person.h&quot;</span><br><span class="line"></span><br><span class="line">@interface Person ()</span><br><span class="line">&#123;</span><br><span class="line">    NSString * _address;</span><br><span class="line">&#125;</span><br><span class="line">@property (nonatomic) NSInteger age;</span><br><span class="line"></span><br><span class="line">-(NSString*)WhereAmI;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ä»–å¸¸ç”¨çš„å½¢å¼ä¸æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨å®ç°æ–‡ä»¶ä¸­æ·»åŠ ç§æœ‰çš„æˆå‘˜å˜é‡ã€å±æ€§å’Œæ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//  Person.m</span><br><span class="line"></span><br><span class="line">#import &quot;Person.h&quot;</span><br><span class="line"></span><br><span class="line">/////////Extension start///////////</span><br><span class="line"></span><br><span class="line">@interface Person ()</span><br><span class="line">&#123;</span><br><span class="line">    NSString * _address;</span><br><span class="line">&#125;</span><br><span class="line">@property (nonatomic) NSInteger age;</span><br><span class="line"></span><br><span class="line">-(NSString*)WhereAmI;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">/////////Extension end///////////</span><br><span class="line"></span><br><span class="line">@implementation Person</span><br><span class="line"></span><br><span class="line">-(NSString*)WhereAmI&#123;</span><br><span class="line">    return @&quot;è°çŸ¥é“ä½ åœ¨å“ªé‡Œ&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>2ã€Extensionä¸CategoryåŒºåˆ«</p>
<ul>
<li>Extension<ul>
<li>åœ¨ç¼–è¯‘å™¨å†³è®®ï¼Œæ˜¯ç±»çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç¼–è¯‘å™¨å’Œå¤´æ–‡ä»¶çš„@interfaceå’Œå®ç°æ–‡ä»¶é‡Œçš„@implementä¸€èµ·å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„ç±»ã€‚</li>
<li>ä¼´éšç€ç±»çš„äº§ç”Ÿè€Œäº§ç”Ÿï¼Œä¹Ÿéšç€ç±»çš„æ¶ˆå¤±è€Œæ¶ˆå¤±ã€‚</li>
<li>Extensionä¸€èˆ¬ç”¨æ¥éšè—ç±»çš„ç§æœ‰æ¶ˆæ¯ï¼Œä½ å¿…é¡»æœ‰ä¸€ä¸ªç±»çš„æºç æ‰èƒ½æ·»åŠ ä¸€ä¸ªç±»çš„Extensionï¼Œæ‰€ä»¥å¯¹äºç³»ç»Ÿä¸€äº›ç±»ï¼Œå¦‚NSStringï¼Œå°±æ— æ³•æ·»åŠ ç±»æ‰©å±•</li>
</ul>
</li>
<li>Category<ul>
<li>æ˜¯è¿è¡ŒæœŸå†³è®®çš„</li>
<li>ç±»æ‰©å±•å¯ä»¥æ·»åŠ å®ä¾‹å˜é‡ï¼Œåˆ†ç±»ä¸èƒ½æ·»åŠ å®ä¾‹å˜é‡</li>
<li>åŸå› ï¼šå› ä¸ºåœ¨è¿è¡ŒæœŸï¼Œå¯¹è±¡çš„å†…å­˜å¸ƒå±€å·²ç»ç¡®å®šï¼Œå¦‚æœæ·»åŠ å®ä¾‹å˜é‡ä¼šç ´åç±»çš„å†…éƒ¨å¸ƒå±€ï¼Œè¿™å¯¹ç¼–è¯‘æ€§è¯­è¨€æ˜¯ç¾éš¾æ€§çš„ã€‚</li>
</ul>
</li>
</ul>
<p><strong>åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ï¼š</strong> è½¬è½½è‡ª<a href="https://link.juejin.im/?target=http%3A%2F%2Fwww.imlifengfeng.com%2Fblog%2F" target="_blank" rel="noopener">æå³°å³°åšå®¢</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/Runtimeå…¨æ–¹ä½è£…é€¼æŒ‡å—/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/Runtimeå…¨æ–¹ä½è£…é€¼æŒ‡å—/" itemprop="url">
                  Runtimeå…¨æ–¹ä½è£…é€¼æŒ‡å—
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 12:16:02 / ä¿®æ”¹æ—¶é—´ï¼š12:21:09" itemprop="dateCreated datePublished" datetime="2018-09-13T12:16:02+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/runtime/" itemprop="url" rel="index"><span itemprop="name">runtime</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>ï¿½æ¥”å­</strong><br><a href="https://link.jianshu.com/?t=http://opensource.apple.com//source/objc4/" target="_blank" rel="noopener">Runtime</a>æ˜¯ä»€ä¹ˆï¼Ÿè§åçŸ¥æ„ï¼Œå…¶æ¦‚å¿µæ— éå°±æ˜¯â€œå› ä¸º Objective-C æ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œæ‰€ä»¥å®ƒéœ€è¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿâ€¦â€¦è¿™å°±æ˜¯ Runtime ç³»ç»Ÿâ€äº‘äº‘ã€‚å¯¹åšä¸»è¿™ç§èœé¸Ÿè€Œè¨€ï¼ŒRuntime åœ¨å®é™…å¼€å‘ä¸­ï¼Œå…¶å®å°±æ˜¯ä¸€ç»„Cè¯­è¨€çš„å‡½æ•°ã€‚èƒ¡é€‚è¯´ï¼šâ€œå¤šç ”ç©¶äº›é—®é¢˜ï¼Œå°‘è°ˆäº›ä¸»ä¹‰â€ï¼Œäº‘å±±é›¾ç½©çš„æ¦‚å¿µå¬å¤šäº†æ€»æ˜¯å®¹æ˜“å¤´æ™•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥ä»ä»£ç å…¥æ‰‹å­¦ä¹  Runtimeã€‚<br>ï¿½</p>
<h1 id="1ã€ç”±objc-msgSendè¯´å¼€å»ï¼š"><a href="#1ã€ç”±objc-msgSendè¯´å¼€å»ï¼š" class="headerlink" title="1ã€ç”±objc_msgSendè¯´å¼€å»ï¼š"></a>1ã€ç”±objc_msgSendè¯´å¼€å»ï¼š</h1><p>Objective-C ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œä¸æ˜¯ç®€å•çš„æ–¹æ³•è°ƒç”¨ï¼Œè€Œæ˜¯å‘é€æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶å® [receiver message] ä¼šè¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸º: objc_msgSend(receiver, selector)ï¼Œä½•ä»¥è¯æ˜ï¼Ÿæ–°å»ºä¸€ä¸ªç±» MyClassï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;MyClass.h&quot;</span><br><span class="line">@implementation MyClass</span><br><span class="line"></span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        [self showUserName];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)showUserName&#123;</span><br><span class="line">    NSLog(@&quot;Dave Ping&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ clang é‡å†™å‘½ä»¤:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -rewrite-objc MyClass.m</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨åŒä¸€ç›®å½•ä¸‹ä¼šå¤šå‡ºä¸€ä¸ª MyClass.cpp æ–‡ä»¶ï¼ŒåŒå‡»æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ° init æ–¹æ³•å·²ç»è¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸ºä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static instancetype _I_MyClass_init(MyClass * self, SEL _cmd) &#123;</span><br><span class="line">    if (self = ((MyClass *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;MyClass&quot;))&#125;, sel_registerName(&quot;init&quot;))) &#123;</span><br><span class="line">        ((void (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName(&quot;showUserName&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¦æ‰¾çš„å°±æ˜¯å®ƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((void (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName(&quot;showUserName&quot;))</span><br></pre></td></tr></table></figure>
<p>objc_msgSend å‡½æ•°è¢«å®šä¹‰åœ¨ objc/message.h ç›®å½•ä¸‹ï¼Œå…¶å‡½æ•°åŸå‹æ˜¯é…±ç´«æ»´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void objc_msgSend(void /* id self, SEL op, ... */ )</span><br></pre></td></tr></table></figure>
<p>ï¿½è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ª id ç±»å‹ï¼Œä¸€ä¸ª SEL ç±»å‹ã€‚</p>
<h1 id="2ã€SEL"><a href="#2ã€SEL" class="headerlink" title="2ã€SEL"></a>2ã€SEL</h1><p>SEL è¢«å®šä¹‰åœ¨ ï¿½objc/objc.h ç›®å½•ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_selector *SEL;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å®ƒå°±æ˜¯ä¸ªæ˜ å°„åˆ°æ–¹æ³•çš„Cå­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥ç”¨ Objective-C ç¼–è¯‘å™¨å‘½ä»¤ @selector() æˆ–è€… Runtime ç³»ç»Ÿçš„ sel_registerName å‡½æ•°æ¥è·å¾—ä¸€ä¸ª SEL ç±»å‹çš„æ–¹æ³•é€‰æ‹©å™¨ã€‚</p>
<h1 id="3ã€id"><a href="#3ã€id" class="headerlink" title="3ã€id"></a>3ã€id</h1><p>ä¸ SEL ä¸€æ ·ï¼Œid ä¹Ÿè¢«å®šä¹‰åœ¨ ï¿½objc/objc.h ç›®å½•ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_object *id;</span><br></pre></td></tr></table></figure>
<p>id æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼Œå®ƒå¯ä»¥æŒ‡å‘ Objective-C ä¸­çš„ä»»ä½•å¯¹è±¡ã€‚objc_object ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct objc_object &#123; Class isa OBJC_ISA_AVAILABILITY;&#125;;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„<strong>å¯¹è±¡</strong>ï¼Œå°±é•¿è¿™ä¸ªæ ·å­ï¼Œè¿™ä¸ªç»“æ„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¿½ isaï¼Œ<strong>ï¿½å¯¹è±¡</strong>å¯ä»¥é€šè¿‡ ï¿½isa æŒ‡é’ˆæ‰¾åˆ°å…¶æ‰€å±çš„ç±»ã€‚isa æ˜¯ä¸€ä¸ª ï¿½Class ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆ Class åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h1 id="4ã€Class"><a href="#4ã€Class" class="headerlink" title="4ã€Class"></a>4ã€Class</h1><p>Class ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_class *Class;</span><br></pre></td></tr></table></figure>
<p>objc_class ç»“æ„ä½“æ˜¯é…±ç´«æ»´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line">#if !__OBJC2__</span><br><span class="line">    Class super_class                                        OBJC2_UNAVAILABLE;</span><br><span class="line">    const char *name                                         OBJC2_UNAVAILABLE;</span><br><span class="line">    long version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    long info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    long instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€šå¸¸è¯´çš„<strong>ï¿½ç±»</strong>å°±é•¿è¿™æ ·å­ï¼š<br>Â·Class ä¹Ÿæœ‰ä¸€ä¸ª isa æŒ‡é’ˆï¼ŒæŒ‡å‘å…¶æ‰€å±çš„<strong>å…ƒç±»</strong>ï¼ˆmetaï¼‰.<br>Â·super_classï¼šæŒ‡å‘å…¶<strong>è¶…ç±»</strong>.<br>Â·nameï¼šæ˜¯<strong>ç±»å</strong>.<br>Â·versionï¼šæ˜¯ç±»çš„<strong>ç‰ˆæœ¬ä¿¡æ¯</strong>.<br>Â·infoï¼šæ˜¯ç±»çš„<strong>è¯¦æƒ…</strong>.<br>Â·instance_sizeï¼šæ˜¯è¯¥ç±»çš„<strong>å®ä¾‹å¯¹è±¡çš„å¤§å°</strong>.<br>Â·ivarsï¼šæŒ‡å‘è¯¥ç±»çš„<strong>æˆå‘˜å˜é‡åˆ—è¡¨</strong>.<br>Â·methodListsï¼šæŒ‡å‘è¯¥ç±»çš„<strong>å®ä¾‹æ–¹æ³•åˆ—è¡¨</strong>ï¼Œå®ƒå°†æ–¹æ³•é€‰æ‹©å™¨å’Œæ–¹æ³•å®ç°åœ°å€è”ç³»èµ·æ¥ã€‚methodLists æ˜¯æŒ‡å‘ Â·objc_method_list æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åŠ¨æ€ä¿®æ”¹ *methodLists çš„å€¼æ¥æ·»åŠ æˆå‘˜æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ Category å®ç°çš„åŸç†ï¼ŒåŒæ ·è§£é‡Šäº† Category ä¸èƒ½æ·»åŠ å±æ€§çš„åŸå› .<br>Â·cacheï¼šRuntime ç³»ç»Ÿä¼šæŠŠè¢«è°ƒç”¨çš„æ–¹æ³•å­˜åˆ° ï¿½cache ä¸­ï¼ˆç†è®ºä¸Šè®²ä¸€ä¸ªæ–¹æ³•å¦‚æœè¢«è°ƒç”¨ï¿½ï¼Œé‚£ä¹ˆå®ƒæœ‰å¯èƒ½ä»Šåè¿˜ä¼šè¢«è°ƒç”¨ï¼‰ï¼Œä¸‹æ¬¡æŸ¥æ‰¾çš„æ—¶å€™æ•ˆç‡æ›´é«˜.<br>Â·protocolsï¼šæŒ‡å‘è¯¥ç±»çš„åè®®åˆ—è¡¨.</p>
<hr>
<p>è¯´åˆ°è¿™é‡Œæœ‰ç‚¹ä¹±äº†ï¼Œæˆ‘ä»¬æ¥æ‹ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå…¶è¿è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆï¼ŒRuntime ç³»ç»Ÿä¼šæŠŠæ–¹æ³•è°ƒç”¨è½¬åŒ–ä¸ºæ¶ˆæ¯å‘é€ï¼Œå³ objc_msgSendï¼Œå¹¶ä¸”æŠŠ<strong>æ–¹æ³•çš„è°ƒç”¨è€…</strong>ï¼Œå’Œ<strong>æ–¹æ³•é€‰æ‹©å™¨</strong>ï¼Œå½“åšå‚æ•°ä¼ é€’è¿‡å».</p>
<p>æ­¤æ—¶ï¼Œæ–¹æ³•çš„è°ƒç”¨è€…ä¼šé€šè¿‡ isa æŒ‡é’ˆæ¥æ‰¾åˆ°å…¶æ‰€å±çš„ç±»ï¼Œç„¶ååœ¨ cache æˆ–è€… methodLists ä¸­æŸ¥æ‰¾è¯¥æ–¹æ³•ï¼Œæ‰¾å¾—åˆ°å°±è·³åˆ°å¯¹åº”çš„æ–¹æ³•å»æ‰§è¡Œ.</p>
<p>å¦‚æœåœ¨<strong>ç±»</strong>ä¸­æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•ï¼Œåˆ™é€šè¿‡ super_class å¾€ä¸Šä¸€çº§<strong>è¶…ç±»</strong>æŸ¥æ‰¾ï¼ˆå¦‚æœä¸€ç›´æ‰¾åˆ° NSObject éƒ½æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•çš„è¯ï¼Œè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æ”¾åˆ°åé¢<strong>æ¶ˆæ¯è½¬å‘</strong>çš„æ—¶å€™å†è¯´ï¼‰.</p>
<p>å‰é¢æˆ‘ä»¬è¯´ methodLists æŒ‡å‘è¯¥ç±»çš„<strong>å®ä¾‹æ–¹æ³•åˆ—è¡¨</strong>ï¼Œ<strong>å®ä¾‹æ–¹æ³•</strong>å³<strong>-æ–¹æ³•</strong>ï¼Œé‚£ä¹ˆ<strong>ç±»æ–¹æ³•</strong>ï¼ˆ+æ–¹æ³•ï¼‰å­˜å‚¨åœ¨å“ªå„¿å‘¢ï¼Ÿç±»æ–¹æ³•è¢«å­˜å‚¨åœ¨<strong>å…ƒç±»</strong>ä¸­ï¼ŒClass é€šè¿‡ isa æŒ‡é’ˆå³å¯æ‰¾åˆ°å…¶æ‰€å±çš„<strong>å…ƒç±»</strong>.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1396900-1b94ff9a3905ba68?imageMogr2/auto-orient/strip%7CimageView2/2/w/550" alt="img"></p>
<p>ä¸Šå›¾å®çº¿æ˜¯ super_class æŒ‡é’ˆï¼Œè™šçº¿æ˜¯ isa æŒ‡é’ˆã€‚æ ¹å…ƒç±»çš„è¶…ç±»æ˜¯NSObjectï¼Œè€Œ isa æŒ‡å‘äº†è‡ªå·±ã€‚NSObject çš„è¶…ç±»ä¸º nilï¼Œä¹Ÿå°±æ˜¯å®ƒæ²¡æœ‰è¶…ç±»ã€‚</p>
<h1 id="5ã€ä½¿ç”¨objc-msgSend"><a href="#5ã€ä½¿ç”¨objc-msgSend" class="headerlink" title="5ã€ä½¿ç”¨objc_msgSend"></a>5ã€ä½¿ç”¨objc_msgSend</h1><p>å‰é¢æˆ‘ä»¬ä½¿ç”¨ clang é‡å†™å‘½ä»¤ï¼Œçœ‹åˆ° Runtime æ˜¯å¦‚ä½•å°†æ–¹æ³•è°ƒç”¨è½¬åŒ–ä¸ºæ¶ˆæ¯å‘é€çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¾æ ·ç”»è‘«èŠ¦ï¼Œæ¥å­¦ä¹ ä½¿ç”¨ä¸€ä¸‹ objc_msgSendã€‚æ–°å»ºä¸€ä¸ªç±» TestClassï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-(void)showAge&#123;</span><br><span class="line">    NSLog(@&quot;24&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)showName:(NSString *)aName&#123;</span><br><span class="line">    NSLog(@&quot;name is %@&quot;,aName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)showSizeWithWidth:(float)aWidth andHeight:(float)aHeight&#123;</span><br><span class="line">    NSLog(@&quot;size is %.2f * %.2f&quot;,aWidth, aHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(float)getHeight&#123;</span><br><span class="line">    return 187.5f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(NSString *)getInfo&#123;</span><br><span class="line">    return @&quot;Hi, my name is Dave Ping, I&apos;m twenty-four years old in the year, I like apple, nice to meet you.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼Œä½¿ç”¨ objc_msgSend ä¾æ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TestClass *objct = [[TestClass alloc] init];</span><br><span class="line"></span><br><span class="line">((void (*) (id, SEL)) objc_msgSend) (objct, sel_registerName(&quot;showAge&quot;));</span><br><span class="line"></span><br><span class="line">((void (*) (id, SEL, NSString *)) objc_msgSend) (objct, sel_registerName(&quot;showName:&quot;), @&quot;Dave Ping&quot;);</span><br><span class="line"></span><br><span class="line">((void (*) (id, SEL, float, float)) objc_msgSend) (objct, sel_registerName(&quot;showSizeWithWidth:andHeight:&quot;), 110.5f, 200.0f);</span><br><span class="line"></span><br><span class="line">float f = ((float (*) (id, SEL)) objc_msgSend_fpret) (objct, sel_registerName(&quot;getHeight&quot;));</span><br><span class="line">NSLog(@&quot;height is %.2f&quot;,f);</span><br><span class="line"></span><br><span class="line">NSString *info = ((NSString* (*) (id, SEL)) objc_msgSend) (objct, sel_registerName(&quot;getInfo&quot;));</span><br><span class="line">NSLog(@&quot;%@&quot;,info);</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿè®¸ä½ å·²ç»æ³¨æ„åˆ°ï¼Œobjc_msgSend åœ¨ä½¿ç”¨æ—¶éƒ½è¢«å¼ºåˆ¶è½¬æ¢äº†ä¸€ä¸‹ï¼Œè¿™æ˜¯å› ä¸º objc_msgSend è¿™ä¸ªå‡½æ•°è‡³å°‘è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªidæ¶ˆæ¯æ¥å—è€…ï¼Œä¸€ä¸ªSELæ¶ˆæ¯åç§°ã€‚åé¢ä¸‰ä¸ªç‚¹ä»£è¡¨å‚æ•°ï¼Œæ˜¯å˜å‚ã€‚ä¹Ÿå°±æ˜¯è¯´æ–¹æ³•æºå¸¦çš„å‚æ•°ï¼Œå¯ä»¥æ²¡æœ‰ï¼Œå¯ä»¥æœ‰å¤šä¸ªã€‚å¦‚æœæˆ‘ä»¬æŠŠè°ƒç”¨ showAge æ–¹æ³•æ”¹æˆè¿™æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend(objct, sel_registerName(&quot;showAge&quot;));</span><br></pre></td></tr></table></figure>
<p>Xcode å°±ä¼šæŠ¥é”™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Too many arguments to function call, expected 0, have 2.</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„ objc_msgSend ä½¿ç”¨ä»£ç åœ¨<a href="https://link.jianshu.com/?t=https://github.com/daiweiping/RuntimeLearn" target="_blank" rel="noopener">ï¿½è¿™é‡Œ</a>ã€‚</p>
<h1 id="6ã€objc-msgSendSuper"><a href="#6ã€objc-msgSendSuper" class="headerlink" title="6ã€objc_msgSendSuper"></a>6ã€objc_msgSendSuper</h1><p>ç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µåœ¨ objc_msgSendï¼Œobjc_msgSend_stretï¼Œobjc_msgSendSuperï¼Œobjc_msgSendSuper_stret æˆ– objc_msgSend_fpret äº”ä¸ªæ–¹æ³•ä¸­é€‰æ‹©ä¸€ä¸ªæ¥è°ƒç”¨ã€‚å¦‚æœæ¶ˆæ¯æ˜¯ä¼ é€’ç»™è¶…ç±»ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ objc_msgSendSuper æ–¹æ³•ï¼Œå¦‚æœæ¶ˆæ¯è¿”å›å€¼æ˜¯æ•°æ®ç»“æ„ï¼Œå°±ä¼šè°ƒç”¨ objc_msgSendSuper_stret æ–¹æ³•ï¼Œå¦‚æœè¿”å›å€¼æ˜¯æµ®ç‚¹æ•°ï¼Œåˆ™è°ƒç”¨ objc_msgSend_fpret æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹è¯´ä¸€ä¸‹ objc_msgSendSuperï¼Œobjc_msgSendSuper å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void objc_msgSendSuper(void /* struct objc_super *super, SEL op, ... */ )</span><br></pre></td></tr></table></figure>
<p>ï¿½å½“æˆ‘ä»¬è°ƒç”¨ [super selector] æ—¶ï¼ŒRuntime ä¼šè°ƒç”¨ objc_msgSendSuper æ–¹æ³•ï¼Œobjc_msgSendSuper æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œsuper å’Œ opï¼ŒRuntime ä¼šæŠŠ selector <strong>æ–¹æ³•é€‰æ‹©å™¨</strong>èµ‹å€¼ç»™ opã€‚è€Œ super æ˜¯ä¸€ä¸ª objc_super ç»“æ„ä½“æŒ‡é’ˆï¼Œobjc_super ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct objc_super &#123;</span><br><span class="line">    /// Specifies an instance of a class.</span><br><span class="line">    __unsafe_unretained id receiver;</span><br><span class="line"></span><br><span class="line">    /// Specifies the particular superclass of the instance to message. </span><br><span class="line">#if !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span><br><span class="line">    /* For compatibility with old objc-runtime.h header */</span><br><span class="line">    __unsafe_unretained Class class;</span><br><span class="line">#else</span><br><span class="line">    __unsafe_unretained Class super_class;</span><br><span class="line">#endif</span><br><span class="line">    /* super_class is the first class to search */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Runtime ä¼šåˆ›å»ºä¸€ä¸ª objc_spuer ç»“æ„ä½“å˜é‡ï¼Œå°†å…¶åœ°å€ä½œä¸ºå‚æ•°ï¼ˆsuperï¼‰ä¼ é€’ç»™ objc_msgSendSuperï¼Œå¹¶ä¸”å°† self èµ‹å€¼ç»™ receiverï¼šsuperâ€”&gt;receiver=self.<br>ä¸¾ä¸ªæ —å­ï¼Œé—®ä¸‹é¢çš„ä»£ç è¾“å‡ºä»€ä¹ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@implementation Son : Father</span><br><span class="line">- (id)init</span><br><span class="line">&#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self)</span><br><span class="line">    &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, NSStringFromClass([self class]));</span><br><span class="line">        NSLog(@&quot;%@&quot;, NSStringFromClass([super class]));</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ç­”æ¡ˆæ˜¯å…¨éƒ¨è¾“å‡º Son.<br>ä½¿ç”¨ clang é‡å†™å‘½ä»¤ï¼Œå‘ç°ä¸Šè¿°ä»£ç è¢«è½¬åŒ–ä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_gm_0jk35cwn1d3326x0061qym280000gn_T_main_a5cecc_mi_0, NSStringFromClass(((Class (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName(&quot;class&quot;))));</span><br><span class="line">NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_gm_0jk35cwn1d3326x0061qym280000gn_T_main_a5cecc_mi_1, NSStringFromClass(((Class (*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123; (id)self, (id)class_getSuperclass(objc_getClass(&quot;Son&quot;)) &#125;, sel_registerName(&quot;class&quot;))));</span><br></pre></td></tr></table></figure>
<p>å½“è°ƒç”¨ [super class] æ—¶ï¼Œä¼šè½¬æ¢æˆ objc_msgSendSuper å‡½æ•°ï¼š</p>
<p>ç¬¬ä¸€æ­¥å…ˆæ„é€  objc_super ç»“æ„ä½“ï¼Œç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯ selfã€‚ç¬¬äºŒä¸ªæˆå‘˜æ˜¯ (id)class_getSuperclass(objc_getClass(â€œSonâ€)).</p>
<p>ç¬¬äºŒæ­¥æ˜¯å» Father è¿™ä¸ªç±»é‡Œå»æ‰¾ - (Class)classï¼Œæ²¡æœ‰ï¼Œç„¶åå» NSObject ç±»å»æ‰¾ï¼Œæ‰¾åˆ°äº†ã€‚æœ€åå†…éƒ¨æ˜¯ä½¿ç”¨ objc_msgSend(objc_super-&gt;receiver, @selector(class)) å»è°ƒç”¨ï¼Œæ­¤æ—¶å·²ç»å’Œ [self class] è°ƒç”¨ç›¸åŒäº†ï¼Œæ‰€ä»¥ä¸¤ä¸ªè¾“å‡ºç»“æœéƒ½æ˜¯ Sonã€‚</p>
<h1 id="7ã€ï¿½å¯¹è±¡å…³è”"><a href="#7ã€ï¿½å¯¹è±¡å…³è”" class="headerlink" title="7ã€ï¿½å¯¹è±¡å…³è”"></a>7ã€ï¿½å¯¹è±¡å…³è”</h1><p>å¯¹è±¡å…³è”<strong>å…è®¸å¼€å‘è€…å¯¹å·²ç»å­˜åœ¨çš„ç±»åœ¨ Category ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å±æ€§</strong>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy) __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_1);</span><br></pre></td></tr></table></figure>
<p>Â·object æ˜¯æºå¯¹è±¡.<br>Â·value æ˜¯è¢«å…³è”çš„å¯¹è±¡.<br>Â·key æ˜¯å…³è”çš„é”®ï¼Œobjc_getAssociatedObject æ–¹æ³•é€šè¿‡ä¸åŒçš„ key å³å¯å–å‡ºå¯¹åº”çš„è¢«å…³è”å¯¹è±¡.<br>Â·policy æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œè¡¨ç¤º<strong>å…³è”å¯¹è±¡çš„è¡Œä¸º</strong>ï¼Œä»å‘½åå°±èƒ½çœ‹å‡ºå„ä¸ªæšä¸¾å€¼çš„å«ä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = 0,           /**&lt; Specifies a weak reference to the associated object. */</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object. </span><br><span class="line">                                            *   The association is not made atomically. */</span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,   /**&lt; Specifies that the associated object is copied. </span><br><span class="line">                                            *   The association is not made atomically. */</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = 01401,       /**&lt; Specifies a strong reference to the associated object.</span><br><span class="line">                                            *   The association is made atomically. */</span><br><span class="line">    OBJC_ASSOCIATION_COPY = 01403          /**&lt; Specifies that the associated object is copied.</span><br><span class="line">                                            *   The association is made atomically. */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¦å–å‡ºè¢«å…³è”çš„å¯¹è±¡ä½¿ç”¨ objc_getAssociatedObject æ–¹æ³•å³å¯ï¼Œè¦åˆ é™¤ä¸€ä¸ªè¢«å…³è”çš„å¯¹è±¡ï¼Œä½¿ç”¨ objc_setAssociatedObject æ–¹æ³•å°†å¯¹åº”çš„ key è®¾ç½®æˆ nil å³å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_setAssociatedObject(self, associatedKey, nil, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br></pre></td></tr></table></figure>
<p>objc_removeAssociatedObjects æ–¹æ³•å°†ä¼š<strong>ç§»é™¤æºå¯¹è±¡ä¸­æ‰€æœ‰çš„å…³è”å¯¹è±¡.</strong><br>ä¸¾ä¸ªæ —å­ï¼Œå‡å¦‚æˆ‘ä»¬è¦ç»™ UIButton æ·»åŠ ä¸€ä¸ªç›‘å¬å•å‡»äº‹ä»¶çš„ block å±æ€§ï¼Œæ–°å»º UIButton çš„ Categoryï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;UIButton+ClickBlock.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line">static const void *associatedKey = &quot;associatedKey&quot;;</span><br><span class="line"></span><br><span class="line">@implementation UIButton (ClickBlock)</span><br><span class="line"></span><br><span class="line">//Categoryä¸­çš„å±æ€§ï¼Œåªä¼šç”Ÿæˆsetterå’Œgetteræ–¹æ³•ï¼Œä¸ä¼šç”Ÿæˆæˆå‘˜å˜é‡</span><br><span class="line"></span><br><span class="line">-(void)setClick:(clickBlock)click&#123;</span><br><span class="line">    objc_setAssociatedObject(self, associatedKey, click, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">    [self removeTarget:self action:@selector(buttonClick) forControlEvents:UIControlEventTouchUpInside];</span><br><span class="line">    if (click) &#123;</span><br><span class="line">        [self addTarget:self action:@selector(buttonClick) forControlEvents:UIControlEventTouchUpInside];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(clickBlock)click&#123;</span><br><span class="line">    return objc_getAssociatedObject(self, associatedKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)buttonClick&#123;</span><br><span class="line">    if (self.click) &#123;</span><br><span class="line">        self.click();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ä»£ç ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ UIButton çš„å±æ€§æ¥ç›‘å¬å•å‡»äº‹ä»¶äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];</span><br><span class="line">button.frame = self.view.bounds;</span><br><span class="line">[self.view addSubview:button];</span><br><span class="line">button.click = ^&#123;</span><br><span class="line">    NSLog(@&quot;buttonClicked&quot;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„å¯¹è±¡å…³è”ä»£ç ç‚¹<a href="https://link.jianshu.com/?t=https://github.com/daiweiping/RuntimeLearn" target="_blank" rel="noopener">è¿™é‡Œ</a></p>
<h1 id="8ã€ï¿½è‡ªåŠ¨å½’æ¡£"><a href="#8ã€ï¿½è‡ªåŠ¨å½’æ¡£" class="headerlink" title="8ã€ï¿½è‡ªåŠ¨å½’æ¡£"></a>8ã€ï¿½è‡ªåŠ¨å½’æ¡£</h1><p>åšä¸»åœ¨å­¦ä¹  Runtime ä¹‹å‰ï¼Œå½’æ¡£çš„æ—¶å€™æ˜¯é…±ç´«å†™çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (void)encodeWithCoder:(NSCoder *)aCoder&#123;</span><br><span class="line">    [aCoder encodeObject:self.name forKey:@&quot;name&quot;];</span><br><span class="line">    [aCoder encodeObject:self.ID forKey:@&quot;ID&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)initWithCoder:(NSCoder *)aDecoder&#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        self.ID = [aDecoder decodeObjectForKey:@&quot;ID&quot;];</span><br><span class="line">        self.name = [aDecoder decodeObjectForKey:@&quot;name&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœå½“å‰ Model æœ‰100ä¸ªå±æ€§çš„è¯ï¼Œå°±éœ€è¦å†™100è¡Œè¿™ç§ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[aCoder encodeObject:self.name forKey:@&quot;name&quot;];</span><br></pre></td></tr></table></figure>
<p>æƒ³æƒ³éƒ½å¤´ç–¼ï¼Œé€šè¿‡ Runtime æˆ‘ä»¬å°±å¯ä»¥è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼š<br>ï¿½1.ä½¿ç”¨ class_copyIvarList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰æˆå‘˜å˜é‡.<br>2.ä½¿ç”¨ ivar_getName æ–¹æ³•è·å–æˆå‘˜å˜é‡çš„åç§°.<br>3.é€šè¿‡ KVC æ¥è¯»å– Model çš„å±æ€§å€¼ï¼ˆencodeWithCoder:ï¼‰ï¼Œä»¥åŠç»™ Model çš„å±æ€§èµ‹å€¼ï¼ˆinitWithCoder:ï¼‰.</p>
<p>ä¸¾ä¸ªæ —å­ï¼Œæ–°å»ºä¸€ä¸ª Model ç±»ï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;TestModel.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">#import &lt;objc/message.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation TestModel</span><br><span class="line">- (void)encodeWithCoder:(NSCoder *)aCoder&#123;</span><br><span class="line">    unsigned int outCount = 0;</span><br><span class="line">    Ivar *vars = class_copyIvarList([self class], &amp;outCount);</span><br><span class="line">    for (int i = 0; i &lt; outCount; i ++) &#123;</span><br><span class="line">        Ivar var = vars[i];</span><br><span class="line">        const char *name = ivar_getName(var);</span><br><span class="line">        NSString *key = [NSString stringWithUTF8String:name];</span><br><span class="line">        </span><br><span class="line">        // æ³¨æ„kvcçš„ç‰¹æ€§æ˜¯ï¼Œå¦‚æœèƒ½æ‰¾åˆ°keyè¿™ä¸ªå±æ€§çš„setteræ–¹æ³•ï¼Œåˆ™è°ƒç”¨setteræ–¹æ³•</span><br><span class="line">        // å¦‚æœæ‰¾ä¸åˆ°setteræ–¹æ³•ï¼Œåˆ™æŸ¥æ‰¾æˆå‘˜å˜é‡keyæˆ–è€…æˆå‘˜å˜é‡_keyï¼Œå¹¶ä¸”ä¸ºå…¶èµ‹å€¼</span><br><span class="line">        // æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å¦å¤–å¤„ç†æˆå‘˜å˜é‡åç§°çš„â€œ_â€å‰ç¼€</span><br><span class="line">        id value = [self valueForKey:key];</span><br><span class="line">        [aCoder encodeObject:value forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (nullable instancetype)initWithCoder:(NSCoder *)aDecoder&#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        unsigned int outCount = 0;</span><br><span class="line">        Ivar *vars = class_copyIvarList([self class], &amp;outCount);</span><br><span class="line">        for (int i = 0; i &lt; outCount; i ++) &#123;</span><br><span class="line">            Ivar var = vars[i];</span><br><span class="line">            const char *name = ivar_getName(var);</span><br><span class="line">            NSString *key = [NSString stringWithUTF8String:name];</span><br><span class="line">            id value = [aDecoder decodeObjectForKey:key];</span><br><span class="line">            [self setValue:value forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„è‡ªåŠ¨å½’æ¡£ä»£ç åœ¨<a href="https://link.jianshu.com/?t=https://github.com/daiweiping/RuntimeLearn" target="_blank" rel="noopener">è¿™é‡Œ</a></p>
<h1 id="9ã€å­—å…¸ä¸æ¨¡å‹äº’è½¬"><a href="#9ã€å­—å…¸ä¸æ¨¡å‹äº’è½¬" class="headerlink" title="9ã€å­—å…¸ä¸æ¨¡å‹äº’è½¬"></a>9ã€å­—å…¸ä¸æ¨¡å‹äº’è½¬</h1><p>æœ€å¼€å§‹åšä¸»æ˜¯è¿™æ ·ç”¨å­—å…¸ç»™ Model èµ‹å€¼çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-(instancetype)initWithDictionary:(NSDictionary *)dict&#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        self.age = dict[@&quot;age&quot;];</span><br><span class="line">        self.name = dict[@&quot;name&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯æƒ³è€ŒçŸ¥ï¼Œé‡åˆ°çš„é—®é¢˜è·Ÿå½’æ¡£æ—¶å€™ä¸€æ ·ï¼ˆåæ¥ä½¿ç”¨<a href="https://link.jianshu.com/?t=https://github.com/CoderMJLee/MJExtension" target="_blank" rel="noopener">MJExtension</a>ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ç¨å¾®æ¥å­¦ä¹ ä¸€ä¸‹å…¶ä¸­åŸç†ï¼Œå­—å…¸è½¬æ¨¡å‹çš„æ—¶å€™ï¼š<br>1.ï¿½æ ¹æ®å­—å…¸çš„ key ç”Ÿæˆ setter æ–¹æ³•.<br>2.ä½¿ç”¨ objc_msgSend è°ƒç”¨ setter æ–¹æ³•ä¸º Model çš„å±æ€§èµ‹å€¼ï¼ˆæˆ–è€… KVCï¼‰.</p>
<p>æ¨¡å‹è½¬å­—å…¸çš„æ—¶å€™ï¼š<br>ï¿½1.è°ƒç”¨ class_copyPropertyList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰å±æ€§.<br>2.è°ƒç”¨ property_getName è·å–å±æ€§åç§°.<br>3.æ ¹æ®å±æ€§åç§°ç”Ÿæˆ getter æ–¹æ³•.<br>4.ä½¿ç”¨ objc_msgSend è°ƒç”¨ getter æ–¹æ³•è·å–å±æ€§å€¼ï¼ˆæˆ–è€… KVCï¼‰.</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;NSObject+KeyValues.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">#import &lt;objc/message.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation NSObject (KeyValues)</span><br><span class="line"></span><br><span class="line">//å­—å…¸è½¬æ¨¡å‹</span><br><span class="line">+(id)objectWithKeyValues:(NSDictionary *)aDictionary&#123;</span><br><span class="line">    id objc = [[self alloc] init];</span><br><span class="line">    for (NSString *key in aDictionary.allKeys) &#123;</span><br><span class="line">        id value = aDictionary[key];</span><br><span class="line">        </span><br><span class="line">        /*åˆ¤æ–­å½“å‰å±æ€§æ˜¯ä¸æ˜¯Model*/</span><br><span class="line">        objc_property_t property = class_getProperty(self, key.UTF8String);</span><br><span class="line">        unsigned int outCount = 0;</span><br><span class="line">        objc_property_attribute_t *attributeList = property_copyAttributeList(property, &amp;outCount);</span><br><span class="line">        objc_property_attribute_t attribute = attributeList[0];</span><br><span class="line">        NSString *typeString = [NSString stringWithUTF8String:attribute.value];</span><br><span class="line">        if ([typeString isEqualToString:@&quot;@\&quot;TestModel\&quot;&quot;]) &#123;</span><br><span class="line">            value = [self objectWithKeyValues:value];</span><br><span class="line">        &#125;</span><br><span class="line">        /**********************/</span><br><span class="line">        </span><br><span class="line">        //ç”Ÿæˆsetteræ–¹æ³•ï¼Œå¹¶ç”¨objc_msgSendè°ƒç”¨</span><br><span class="line">        NSString *methodName = [NSString stringWithFormat:@&quot;set%@%@:&quot;,[key substringToIndex:1].uppercaseString,[key substringFromIndex:1]];</span><br><span class="line">        SEL setter = sel_registerName(methodName.UTF8String);</span><br><span class="line">        if ([objc respondsToSelector:setter]) &#123;</span><br><span class="line">            ((void (*) (id,SEL,id)) objc_msgSend) (objc,setter,value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return objc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//æ¨¡å‹è½¬å­—å…¸</span><br><span class="line">-(NSDictionary *)keyValuesWithObject&#123;</span><br><span class="line">    unsigned int outCount = 0;</span><br><span class="line">    objc_property_t *propertyList = class_copyPropertyList([self class], &amp;outCount);</span><br><span class="line">    NSMutableDictionary *dict = [NSMutableDictionary dictionary];</span><br><span class="line">    for (int i = 0; i &lt; outCount; i ++) &#123;</span><br><span class="line">        objc_property_t property = propertyList[i];</span><br><span class="line">        </span><br><span class="line">        //ç”Ÿæˆgetteræ–¹æ³•ï¼Œå¹¶ç”¨objc_msgSendè°ƒç”¨</span><br><span class="line">        const char *propertyName = property_getName(property);</span><br><span class="line">        SEL getter = sel_registerName(propertyName);</span><br><span class="line">        if ([self respondsToSelector:getter]) &#123;</span><br><span class="line">            id value = ((id (*) (id,SEL)) objc_msgSend) (self,getter);</span><br><span class="line">            </span><br><span class="line">            /*åˆ¤æ–­å½“å‰å±æ€§æ˜¯ä¸æ˜¯Model*/</span><br><span class="line">            if ([value isKindOfClass:[self class]] &amp;&amp; value) &#123;</span><br><span class="line">                value = [value keyValuesWithObject];</span><br><span class="line">            &#125;</span><br><span class="line">            /**********************/</span><br><span class="line">            </span><br><span class="line">            if (value) &#123;</span><br><span class="line">                NSString *key = [NSString stringWithUTF8String:propertyName];</span><br><span class="line">                [dict setObject:value forKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    return dict;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´ä»£ç åœ¨<a href="https://link.jianshu.com/?t=https://github.com/daiweiping/RuntimeLearn" target="_blank" rel="noopener">è¿™é‡Œ</a></p>
<h1 id="10ã€ï¿½åŠ¨æ€æ–¹æ³•è§£æ"><a href="#10ã€ï¿½åŠ¨æ€æ–¹æ³•è§£æ" class="headerlink" title="10ã€ï¿½åŠ¨æ€æ–¹æ³•è§£æ"></a>10ã€ï¿½åŠ¨æ€æ–¹æ³•è§£æ</h1><p>å‰é¢æˆ‘ä»¬ç•™ä¸‹äº†ä¸€ç‚¹ä¸œè¥¿æ²¡è¯´ï¼Œé‚£å°±æ˜¯å¦‚æœæŸä¸ªå¯¹è±¡è°ƒç”¨äº†ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶ä¼šæ€ä¹ˆæ ·ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç¨‹åºä¼šcrashï¼Œé”™è¯¯ä¿¡æ¯ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unrecognized selector sent to instance 0x7fd0a141afd0</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ç¨‹åºcrashä¹‹å‰ï¼ŒRuntime ä¼šç»™æˆ‘ä»¬<strong>åŠ¨æ€æ–¹æ³•è§£æ</strong>çš„æœºä¼šï¼Œæ¶ˆæ¯å‘é€çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>1.æ£€æµ‹è¿™ä¸ª selector æ˜¯ä¸æ˜¯è¦å¿½ç•¥çš„ã€‚æ¯”å¦‚ Mac OS X å¼€å‘ï¼Œæœ‰äº†åƒåœ¾å›æ”¶å°±ä¸ç†ä¼š retainï¼Œrelease è¿™äº›å‡½æ•°äº†.</p>
<p>2.æ£€æµ‹è¿™ä¸ª target æ˜¯ä¸æ˜¯ nil å¯¹è±¡ã€‚ObjC çš„ç‰¹æ€§æ˜¯å…è®¸å¯¹ä¸€ä¸ª nil å¯¹è±¡æ‰§è¡Œä»»ä½•ä¸€ä¸ªæ–¹æ³•ä¸ä¼š Crashï¼Œå› ä¸ºä¼šè¢«å¿½ç•¥æ‰.</p>
<p>3.å¦‚æœä¸Šé¢ä¸¤ä¸ªéƒ½è¿‡äº†ï¼Œé‚£å°±å¼€å§‹æŸ¥æ‰¾è¿™ä¸ªç±»çš„ IMPï¼Œå…ˆä» cache é‡Œé¢æ‰¾ï¼Œå®Œäº†æ‰¾å¾—åˆ°å°±è·³åˆ°å¯¹åº”çš„å‡½æ•°å»æ‰§è¡Œ.<br>å¦‚æœ cache æ‰¾ä¸åˆ°å°±æ‰¾ä¸€ä¸‹æ–¹æ³•åˆ†å‘è¡¨.</p>
<p>4.å¦‚æœåˆ†å‘è¡¨æ‰¾ä¸åˆ°å°±åˆ°è¶…ç±»çš„åˆ†å‘è¡¨å»æ‰¾ï¼Œä¸€ç›´æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°NSObjectç±»ä¸ºæ­¢.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1396900-19c5eb4913f49e33?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt="img"></p>
<p>è¿™é‡Œå†™å›¾ç‰‡æè¿°</p>
<p>1.è¿›å…¥ resolveInstanceMethod: æ–¹æ³•ï¼ŒæŒ‡å®šæ˜¯å¦åŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚è‹¥è¿”å›NOï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œè‹¥è¿”å›YESï¼Œåˆ™é€šè¿‡ class_addMethod å‡½æ•°åŠ¨æ€åœ°æ·»åŠ æ–¹æ³•ï¼Œæ¶ˆæ¯å¾—åˆ°å¤„ç†ï¼Œæ­¤æµç¨‹å®Œæ¯•.</p>
<p>2.resolveInstanceMethod: æ–¹æ³•è¿”å› NO æ—¶ï¼Œå°±ä¼šè¿›å…¥ forwardingTargetForSelector: æ–¹æ³•ï¼Œè¿™æ˜¯ Runtime ç»™æˆ‘ä»¬çš„ç¬¬äºŒæ¬¡æœºä¼šï¼Œç”¨äºæŒ‡å®šå“ªä¸ªå¯¹è±¡å“åº”è¿™ä¸ª selectorã€‚è¿”å›nilï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼Œè¿”å›æŸä¸ªå¯¹è±¡ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•.</p>
<p>3.è‹¥ forwardingTargetForSelector: è¿”å›çš„æ˜¯nilï¼Œåˆ™æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡ methodSignatureForSelector: æ¥æŒ‡å®šæ–¹æ³•ç­¾åï¼Œè¿”å›nilï¼Œè¡¨ç¤ºä¸å¤„ç†ï¼Œè‹¥è¿”å›æ–¹æ³•ç­¾åï¼Œåˆ™ä¼šè¿›å…¥ä¸‹ä¸€æ­¥.</p>
<p>4å½“ç¬¬ methodSignatureForSelector: æ–¹æ³•è¿”å›æ–¹æ³•ç­¾ååï¼Œå°±ä¼šè°ƒç”¨ forwardInvocation: æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ anInvocation å¯¹è±¡åšå¾ˆå¤šå¤„ç†ï¼Œæ¯”å¦‚ä¿®æ”¹å®ç°æ–¹æ³•ï¼Œä¿®æ”¹å“åº”å¯¹è±¡ç­‰.</p>
<p>å¦‚æœåˆ°æœ€åï¼Œæ¶ˆæ¯è¿˜æ˜¯æ²¡æœ‰å¾—åˆ°å“åº”ï¼Œç¨‹åºå°±ä¼šcrashï¼Œè¯¦ç»†ä»£ç åœ¨<a href="https://link.jianshu.com/?t=https://github.com/daiweiping/RuntimeLearn" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p>
<hr>
<p><a href="https://link.jianshu.com/?t=http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="noopener">Objective-C Runtime</a></p>
<p>[è½¬è‡ª <a href="https://www.jianshu.com/u/abb266389fd0" target="_blank" rel="noopener">æˆ´å°¼ç›</a>]ï¼ˆ<a href="https://www.jianshu.com/p/efeb33712445ï¼‰" target="_blank" rel="noopener">https://www.jianshu.com/p/efeb33712445ï¼‰</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/RunTimeåº”ç”¨å®ä¾‹-å…³äºåŸ‹ç‚¹çš„æ€è€ƒ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/RunTimeåº”ç”¨å®ä¾‹-å…³äºåŸ‹ç‚¹çš„æ€è€ƒ/" itemprop="url">
                  RunTimeåº”ç”¨å®ä¾‹--å…³äºåŸ‹ç‚¹çš„æ€è€ƒ
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 11:54:41 / ä¿®æ”¹æ—¶é—´ï¼š12:01:06" itemprop="dateCreated datePublished" datetime="2018-09-13T11:54:41+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/runtime/" itemprop="url" rel="index"><span itemprop="name">runtime</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åŸ‹ç‚¹æ˜¯ç°åœ¨å¾ˆå¤šAppä¸­éƒ½éœ€è¦ç”¨åˆ°çš„ï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½æ¯ä¸ªäººéƒ½èƒ½å¤„ç†ï¼Œä½†æ˜¯æ€æ ·æ¥å‡å°‘åŸ‹ç‚¹æ‰€å¸¦æ¥çš„ä¾µå…¥æ€§ï¼Œæ€æ ·ç”¨æ›´åŠ ç®€æ´çš„æ–¹å¼æ¥å¤„ç†åŸ‹ç‚¹é—®é¢˜ï¼Œæ€æ ·å‡å°‘è¯¯åŸ‹ï¼Œå¦‚æœä¸Šçº¿äº†å‘ç°å°‘åŸ‹äº†æ€ä¹ˆåŠï¼Ÿä¸‹é¢æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼ˆ<a href="https://link.jianshu.com/?t=https://github.com/MikeFighting/LogByRunTime" target="_blank" rel="noopener">æœ¬æ–‡Demoå·²ä¸Šä¼ GitHubï¼Œå¯ä»¥ä¸‹è½½è®¨è®º</a>ï¼‰:</p>
<h1 id="ä»€ä¹ˆæ˜¯åŸ‹ç‚¹ï¼ŸåŸ‹ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åŸ‹ç‚¹ï¼ŸåŸ‹ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åŸ‹ç‚¹ï¼ŸåŸ‹ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åŸ‹ç‚¹ï¼ŸåŸ‹ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h1><p>å…¶å®åŸ‹ç‚¹ä¹Ÿå«æ—¥å¿—ä¸ŠæŠ¥ï¼Œå…¶å®å°±æ˜¯æ ¹æ®éœ€æ±‚ä¸ŠæŠ¥ä¸€ç³»åˆ—å…³äºç”¨æˆ·è¡Œä¸ºçš„æ•°æ®ï¼Œæ¯”å¦‚ï¼šç”¨æˆ·ç‚¹å‡»äº†å“ªä¸ªæŒ‰é’®ï¼Œç”¨æˆ·æµè§ˆäº†å“ªä¸ªç½‘ç«™ï¼Œç”¨æˆ·åœ¨æŸä¸ªé¡µé¢åœç•™äº†å¤šä¹…ç­‰æ•°æ®ã€‚è¿™äº›æ•°æ®å¯¹äºè¿è¥æ¥è¯´å¾ˆæœ‰ç”¨ï¼Œä»–ä»¬å¯ä»¥ç”¨æ¥åˆ†ææŸä¸ªåŠŸèƒ½å¼€å‘çš„æ˜¯ä¸æ˜¯åˆç†ï¼Œæ˜¯ä¸æ˜¯å› ä¸ºæŸä¸ªåœ°æ–¹çš„ä¸åˆç†è€Œåˆ°å¯¼è‡´äº†è½¬åŒ–ç‡çš„ä¸‹é™ï¼Œä»è€Œå¯¹æˆ‘ä»¬çš„Appè¿›è¡Œç›¸åº”çš„æ”¹è¿›ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æŸä¸ªç¬¬ä¸‰æ–¹å¹³å°æä¾›çš„åŸ‹ç‚¹å®ä¾‹ã€‚</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1513759-01e20264d3596c3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="img"></p>
<p>åŸ‹ç‚¹ç»Ÿè®¡å­—æ®µå®šä¹‰</p>
<p>ä¸Šå›¾ä¸­è¯´æ˜äº†ï¼ŒæŸä¸ªæ—¶é—´å¯¹åº”çš„äº‹ä»¶ID,ä»¥åŠé’ˆå¯¹è¿™ä¸ªäº‹ä»¶éœ€è¦å…³è”çš„å­—æ®µã€‚ä¸‹é¢æ˜¯åå°ç³»ç»Ÿå¯¹æŸä¸ªåŸ‹ç‚¹æ‰€åšçš„æ•°æ®ç»Ÿè®¡:<br>[å›¾ç‰‡ä¸Šä¼ å¤±è´¥â€¦(image-5a9faa-1512050850766)]</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1513759-4630c1435e321dbe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="img"></p>
<p>åå°ç³»ç»Ÿå¯¹åŸ‹ç‚¹çš„æ•°æ®åˆ†æ</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¯¦ç»†çš„åˆ†æå‡ºç”¨æˆ·å¯¹äºAppçš„åé¦ˆï¼Œä»è€ŒåŠæ—¶çš„ä¿®æ”¹æˆ‘ä»¬çš„äº§å“ã€‚</p>
<h1 id="å¸¸è§„çš„åŸ‹ç‚¹çš„å¤„ç†æ–¹å¼æ˜¯æ€æ ·çš„"><a href="#å¸¸è§„çš„åŸ‹ç‚¹çš„å¤„ç†æ–¹å¼æ˜¯æ€æ ·çš„" class="headerlink" title="å¸¸è§„çš„åŸ‹ç‚¹çš„å¤„ç†æ–¹å¼æ˜¯æ€æ ·çš„?"></a>å¸¸è§„çš„åŸ‹ç‚¹çš„å¤„ç†æ–¹å¼æ˜¯æ€æ ·çš„?</h1><p>å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°±åœ¨ç›¸åº”çš„äº‹ä»¶é‡Œé¢åŠ å…¥ç›¸å…³çš„ä»£ç ï¼Œç»™æœåŠ¡å™¨ä¸ŠæŠ¥æ•°æ®ä¸å°±å¾—äº†ã€‚å¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// è¿™ä¸ªä¸€ä¸ªæŒ‰é’®çš„å“åº”äº‹ä»¶ </span><br><span class="line">- (void)someButtonAction:(UIButton *)someButton&#123;</span><br><span class="line"></span><br><span class="line">// è¯¥æŒ‰é’®éœ€è¦å¤„ç†çš„ä¸šåŠ¡</span><br><span class="line">[self upDateSomthing]</span><br><span class="line"></span><br><span class="line">// å¼€å§‹åŸ‹ç‚¹</span><br><span class="line">// eid:äº‹ä»¶idï¼Œsa:ç”¨æˆ·id, cI:å½“å‰æ—¶é—´</span><br><span class="line">NSDictionary *upLoadDic = @&#123;@&quot;eid&quot;:@&quot;311&quot;,@&quot;sa&quot;:@&quot;706976487532177&quot;,@&quot;cI&quot;:@&quot;2016-6-4 12:11:34&quot;&#125;;</span><br><span class="line">[ZHUpLoadManager upLoadWithDic:upLoadDic];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€ä¸ªåŸ‹ç‚¹é—®é¢˜å°±è§£å†³äº†ï¼Œå•åŒæ—¶å´éšè—ç€å¾ˆå¤šé—®é¢˜:1.è¿™æ ·æ¯ç‚¹å‡»ä¸€ä¸ªä¸€ä¸‹æŒ‰é’®å°±è¯·æ±‚ä¸€æ¬¡ç½‘ç»œä¼šä¸ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Ÿ2.å¦‚æœè¿™æ ·é¢‘ç¹çš„æ•°æ®ä¸ŠæŠ¥ä¼šä¸ä¼šæ¶ˆè€—æ›´å¤šçš„ç”¨æˆ·æµé‡ï¼Ÿ3.è¿™æ ·çš„ä»£ç èƒ½ç»å—ä½éœ€æ±‚çš„å˜æ›´å—ï¼Ÿæ¯”å¦‚å­—æ®µå˜äº†ï¼Œæˆ–è€…ä½ æŠŠ<code>cI</code>çœ‹é”™äº†ï¼Œåº”è¯¥æ˜¯<code>cl</code>ã€‚4.è¿™æ ·çš„ä»£ç ä¼šä¸ä¼šé€ æˆéš¾ä»¥æµ‹è¯•ï¼Ÿ5.è¿™æ ·çš„é¢‘ç¹ä¸ŠæŠ¥ä¼šä¸ä¼šå¢åŠ æœåŠ¡å™¨ç«¯çš„å‹åŠ›ï¼Ÿ6.ä»£ç æ•´æ´å—ï¼Ÿâ€¦â€¦(<strong>ç¨‹åºå‘˜çš„ä¸€ä¸ªå¥½ä¹ æƒ¯æ˜¯:è¿™ä¸ªä»£ç èƒ½å¦ç»å—ä½éœ€æ±‚çš„å˜æ›´ã€‚</strong>)</p>
<h1 id="æˆ‘ä»¬å¯ä»¥æ€æ ·ä¼˜åŒ–ï¼Ÿ"><a href="#æˆ‘ä»¬å¯ä»¥æ€æ ·ä¼˜åŒ–ï¼Ÿ" class="headerlink" title="æˆ‘ä»¬å¯ä»¥æ€æ ·ä¼˜åŒ–ï¼Ÿ"></a>æˆ‘ä»¬å¯ä»¥æ€æ ·ä¼˜åŒ–ï¼Ÿ</h1><ol>
<li>é¦–å…ˆæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç±»ï¼Œæ¥ä¸“é—¨å¤„ç†è¿™äº›éœ€è¦ä¸ŠæŠ¥çš„åŸ‹ç‚¹çš„å­—æ®µï¼Œå°†è¿™äº›å­—æ®µä½œä¸ºå¸¸é‡,ä¾‹å¦‚:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// LogManager.h</span><br><span class="line">extern NSString * const kLogEventKey;       //äº‹ä»¶id</span><br><span class="line">extern NSString * const kLogUserIdKey;      //ç”¨æˆ·id</span><br><span class="line">extern NSString * const kLogOperationInterval;  //æ“ä½œæ—¶é—´</span><br><span class="line"></span><br><span class="line">// LogManager.m</span><br><span class="line">NSString * const kLogEventKey           = @&quot;co&quot;; //äº‹ä»¶id</span><br><span class="line">NSString * const kLogUserIdKey          = @&quot;sa&quot;; //ç”¨æˆ·id</span><br><span class="line">NSString * const kLogOperationInterval           = @&quot;cq&quot;; //æ“ä½œæ—¶é—´</span><br></pre></td></tr></table></figure>
<ol>
<li>å¯¹äºç”¨æˆ·idï¼Œå½“å‰æ—¶é—´ï¼Œç”¨æˆ·æ‰‹æœºå‹å·ï¼Œæ‰‹æœºå“ç‰Œï¼Œç­‰ç­‰ä¸ç”¨æˆ·æ‰€åœ¨é¡µé¢æ— å…³çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ç»Ÿä¸€çš„ä¸€ä¸ªç±»è¿›è¡Œå¤„ç†ï¼Œå°†å…¶ä½œä¸ºè¿™ä¸ªç±»çš„ä¸€ä¸ªå±æ€§ï¼Œä½¿ç”¨<code>getter</code>æ–¹æ³•å°†å…¶ç›¸åº”çš„æ•°å€¼è¿”å›å³å¯(å¯¹äºæ’å®šä¸å˜çš„å¯ä»¥ä½¿ç”¨æ‡’åŠ è½½)ã€‚</li>
<li>è¿™æ ·çš„æ•°æ®ä¼ è¾“ç­–ç•¥æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½ä¸ŠæŠ¥ï¼Œå¯èƒ½ä¸€ä¸ªé¢éœ€è¦ä¸ŠæŠ¥çš„åœ°æ–¹å¾ˆå¤šï¼Œè¿™å°±ä¼šé€ æˆå¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥<strong>å…ˆå°†éœ€è¦ä¸Šä¼ çš„æ•°æ®ç¼“å­˜èµ·æ¥ï¼Œç„¶åç¼“å­˜å¤Ÿ50æ¡æ•°æ®ä¸ŠæŠ¥ä¸€æ¬¡ï¼Œæˆ–è€…æ¯éš”5åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡</strong>;</li>
<li>ä¸ºäº†èŠ‚çœæµé‡æˆ‘ä»¬å¯ä»¥ï¼Œ1ï¼‰å°†æ•°æ®å‹ç¼©ä¹‹åå†ä¸ŠæŠ¥,<a href="https://www.jianshu.com/p/7016ffdbe97d" target="_blank" rel="noopener">å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« </a>ï¼›2ï¼‰å’ŒæœåŠ¡ç«¯å•†é‡ï¼Œç”¨å°½å¯èƒ½çŸ­çš„å­—æ®µï¼Œå¦‚:<code>cityName = @&quot;åŒ—äº¬&quot;;</code>å˜ä¸º<code>cn = @&quot;åŒ—äº¬&quot;;</code>3)å°½é‡ä¸è¦ä¸Šä¼ çš„é¢‘ç‡è¿‡é«˜ï¼Œå¦‚ç¬¬ä¸‰ç‚¹ã€‚</li>
<li>å¦‚ä½•è§£å†³ä»£ç çš„æ•´æ´ï¼Œæ˜“äºæµ‹è¯•çš„é—®é¢˜ï¼Ÿè¯·çœ‹ä¸‹é¢ã€‚</li>
</ol>
<h1 id="æ€æ ·ä½¿ç”¨RunTimeæ¥è¿›è¡Œä¼˜åŒ–ï¼Ÿ"><a href="#æ€æ ·ä½¿ç”¨RunTimeæ¥è¿›è¡Œä¼˜åŒ–ï¼Ÿ" class="headerlink" title="æ€æ ·ä½¿ç”¨RunTimeæ¥è¿›è¡Œä¼˜åŒ–ï¼Ÿ"></a>æ€æ ·ä½¿ç”¨RunTimeæ¥è¿›è¡Œä¼˜åŒ–ï¼Ÿ</h1><p>æˆ‘ä¹ˆèƒ½ä¸èƒ½åˆ©ç”¨RunTimeæ¥ç»™æ¯ä¸€ä¸ªButtonçš„å“åº”äº‹ä»¶ä¸­æ·»åŠ ä¸€æ®µä»£ç ï¼Œåˆ©ç”¨è¿™æ®µä»£ç æ¥è¿›è¡ŒåŸ‹ç‚¹ä¸ŠæŠ¥å‘¢ï¼Ÿæˆ–è€…è¿›ä¸€æ­¥æ¥è¯´æˆ‘ä»¬èƒ½ä¸èƒ½ç»™æ‰€æœ‰ç»§æ‰¿è‡ªUIControlçš„å¯¹è±¡éƒ½æ·»åŠ è¿™æ ·ä¸€æ®µä»£ç å‘¢ï¼Ÿè¿™æ ·æˆ‘ä»¬ä¸æ˜¯å¯ä»¥æ•è·æ‰€æœ‰çš„ç”¨æˆ·äº‹ä»¶äº†å—ï¼Ÿ(å…¶å®ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œçœ‹ç¬¬äº”æ¡);è¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Mehod Swizzle,æˆ–è€…å«<code>æ–¹æ³•æ³¨å…¥</code>,æˆ–è€…å«<code>hook</code>ä½äº†æŸä¸ªæ–¹æ³•ï¼Œå¬ç€æŒºç„ä¹ï¼Œå…¶å®å°±æ˜¯RunTimeçš„ä¸€ä¸ªAPI,è¿™ä¸ªAPIèƒ½å¤Ÿäº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ã€‚é€šè¿‡è¿™ä¸ªAPI,æˆ‘ä»¬å¯ä»¥è¿™æ ·å®ç°æ–¹æ³•æ³¨å…¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1513759-4e30c9b337c4c891.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="img"></p>
<p>æ–¹æ³•æ³¨å…¥çš„å®ç°è¿‡ç¨‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)sendAction:(SEL)action to:(nullable id)target forEvent:(nullable UIEvent *)event;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•é‡Œé¢åµŒå…¥ç›¸åº”çš„ä»£ç ç‰‡æ®µã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·:1.å°†äº’æ¢æ–¹æ³•å®ç°çš„çš„è¿™ä¸ªæ–¹æ³•æ”¾åˆ°ä¸€ä¸ªå·¥å…·ç±»ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¸æ­¢ä¸€å¤„è¦ç”¨åˆ°è¿™ç§æ–¹æ³•ã€‚2.æˆ‘ä»¬ç»™UIControlæ·»åŠ ä¸€ä¸ªCategory,ç„¶ååœ¨é‡Œé¢è°ƒç”¨è¿™ä¸ªå·¥å…·ç±»ç„¶åå®ç°æ‰€æ’å…¥çš„ä»£ç ç‰‡æ®µã€‚è¿™é‡Œæˆ‘ä»¬æ—¢ç„¶å¯ä»¥å¾—åˆ°<code>target</code>è¿˜æœ‰<code>action</code>,é‚£ä¹ˆå¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥å”¯ä¸€ç¡®å®šè¿™ä¸ªåŸ‹ç‚¹äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€æ ·ä»è¿™ä¹ˆå¤šçš„åŸ‹ç‚¹ä¸­é€‰å‡ºè¿™ä¸ªè¿™ä¸ªåŸ‹ç‚¹å‘¢ï¼Ÿ<strong>æˆ‘ä»¬å…¶å®å¯ä»¥ç”¨å­—å…¸å’Œæ•°ç»„ç»“åˆçš„æ–¹å¼å°†è¿™äº›æ–¹æ³•çš„targetå’Œæ–¹æ³•çš„å‚æ•°ä¸€ä¸€å­˜èµ·æ¥ï¼Œç„¶ååœ¨åµŒå…¥çš„æ–¹æ³•å†…éƒ¨è·å–å…¶å¯¹åº”çš„æ–¹æ³•ï¼Œä»¥åŠå…¶ç›¸åº”çš„ï¼Œè¿™ä¸ªäº‹å…ˆé…ç½®å¥½çš„å­—å…¸å’Œæ•°ç»„çš„ç»“åˆæ”¾åœ¨å“ªé‡Œæ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿplistã€‚</strong>ä¸‹é¢å°±ä»¥æœ€ç®€å•çš„å½¢å¼å±•ç¤ºè¿™ç§æ€è·¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    // å·¥å…·ç±»</span><br><span class="line">    @interface ZHSwizzleTool : NSObject</span><br><span class="line">    </span><br><span class="line">    + (void)zhSwizzleWithClass:(Class)processedClass originalSelector:(SEL)originSelector swizzleSelector:(SEL)swizzlSelector;</span><br><span class="line">    </span><br><span class="line">    @end</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  @implementation ZHSwizzleTool</span><br><span class="line"></span><br><span class="line">  +(void)zhSwizzleWithClass:(Class)processedClass originalSelector:(SEL)originSelector swizzleSelector:(SEL)swizzlSelector&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Method originMethod = class_getInstanceMethod(processedClass, originSelector);</span><br><span class="line"></span><br><span class="line">Method swizzleMethod = class_getInstanceMethod(processedClass, swizzlSelector);</span><br><span class="line"></span><br><span class="line">BOOL didAddMethod = class_addMethod(processedClass, originSelector, method_getImplementation(swizzleMethod), method_getTypeEncoding(swizzleMethod));</span><br><span class="line"></span><br><span class="line">if (didAddMethod) &#123;</span><br><span class="line">    </span><br><span class="line">    class_replaceMethod(processedClass, swizzlSelector, method_getImplementation(originMethod), method_getTypeEncoding(originMethod));</span><br><span class="line">    </span><br><span class="line">&#125;else&#123;</span><br><span class="line"></span><br><span class="line">    method_exchangeImplementations(originMethod, swizzleMethod);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">// åˆ†ç±»</span><br><span class="line">@implementation UIControl (ZHSwizzle)</span><br><span class="line"></span><br><span class="line">+(void)load&#123;</span><br><span class="line"></span><br><span class="line">static dispatch_once_t onceToken;</span><br><span class="line">dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">    </span><br><span class="line">    SEL originSEL = @selector(sendAction:to:forEvent:);</span><br><span class="line">    SEL swizzleSEL = @selector(sendSwizzleAction:to:forEvent:);</span><br><span class="line">    </span><br><span class="line">    [ZHSwizzleTool zhSwizzleWithClass:[self class]originalSelector:originSEL swizzleSelector:swizzleSEL];</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"> - (void)sendSwizzleAction:(SEL)action to:(id)target   forEvent:(UIEvent *)event&#123;</span><br><span class="line"></span><br><span class="line">// æ³¨æ„è¿™é‡Œè°ƒç”¨çš„æ˜¯åŸæ¥çš„ç³»ç»Ÿæ–¹æ³•</span><br><span class="line">[self sendSwizzleAction:action to:target forEvent:event];</span><br><span class="line"></span><br><span class="line">NSString *selectorName = NSStringFromSelector(action);</span><br><span class="line"></span><br><span class="line">// è¿™ä¸ªplistä¸­å­˜å‚¨çš„æ•°æ®æ ¼å¼æ˜¯è¿™æ ·çš„:@&#123;@&quot;someViewController&quot;:@&quot;selector0&quot;:@[para0,para1,para2],@&quot;selector1&quot;:@[para0,para1]]&#125;;</span><br><span class="line"></span><br><span class="line">NSString *pathString = [[NSBundle mainBundle]pathForResource:@&quot;ZHLogInfo&quot; ofType:@&quot;plist&quot;];</span><br><span class="line">NSDictionary *plistDic = [NSDictionary dictionaryWithContentsOfFile:pathString];</span><br><span class="line"></span><br><span class="line">//1. è·å–Targetçš„åå­—</span><br><span class="line">NSDictionary *controllerDic = plistDic[NSStringFromClass([target class])];</span><br><span class="line"></span><br><span class="line">//2. è·å–è¿™ä¸ªæ–¹æ³•å¯¹åº”çš„å‚æ•°åˆ—è¡¨</span><br><span class="line">NSArray *parameterArray = controllerDic[selectorName];</span><br><span class="line">//3. å®ä¾‹åŒ–æ•°æ®ä¸­å¿ƒ</span><br><span class="line">ZHLogDataCenter *logCenter = [[ZHLogDataCenter alloc]init];</span><br><span class="line">NSMutableDictionary *logInfoDic = [NSMutableDictionary dictionary];</span><br><span class="line"></span><br><span class="line">for (NSString *parameter in parameterArray) &#123;</span><br><span class="line"></span><br><span class="line">    NSString *getSelector = [NSString stringWithFormat:@&quot;%@&quot;,parameter];</span><br><span class="line">    SEL getSeletor = NSSelectorFromString(getSelector);</span><br><span class="line">    //4. ä»æ•°æ®ä¸­å¿ƒä¸­è·å–ç›¸åº”çš„æ•°æ®</span><br><span class="line">    id value =  [logCenter performSelector:getSeletor withObject:nil];</span><br><span class="line">    //5.è·å–æˆåŠŸåˆ™å°†å…¶å­˜å…¥éœ€è¦ä¸Šä¼ çš„å­—å…¸</span><br><span class="line">    if (value)</span><br><span class="line">    [logInfoDic setObject:value forKey:parameter];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">   //6.å°†è¿™ä¸ªå­—å…¸å­˜å…¥åŸ‹ç‚¹ç®¡ç†ç±»ï¼Œå…¶ä¼šå°†å…¶å­˜å…¥ç¼“å­˜å¹¶ç­‰å¾…ä¸Šä¼ </span><br><span class="line">[ZHLogCenter zhLogWithInforDictionary:logInfoDic];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯è¿™ä¸ªä»£ç ä¸­ç”¨åˆ°çš„Plistä¸­çš„é…ç½®:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1513759-3c28e14477b58263.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000" alt="img"></p>
<p>åŸ‹ç‚¹ç›¸å…³å­—æ®µçš„plisté…ç½®</p>
<h1 id="åœ¨å®è·µä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#åœ¨å®è·µä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="åœ¨å®è·µä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Ÿ"></a>åœ¨å®è·µä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Ÿ</h1><ol>
<li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹ä»¶éƒ½æ˜¯æœ‰ç»§æ‰¿è‡ªUIControlçš„æ§ä»¶æ¥å‘å‡ºçš„ï¼Œæ¯”å¦‚ï¼šæ‰‹åŠ¿ï¼Œç‚¹å‡»Cellã€‚</li>
<li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„æŒ‰é’®ç‚¹å‡»äº†ä¹‹åå°±ç«‹é©¬éœ€è¦åŸ‹ç‚¹ä¸Šä¼ ï¼Ÿå¯èƒ½åœ¨æŒ‰é’®çš„å“åº”æ–¹æ³•ä¸­ç»è¿‡äº†å±‚å±‚çš„<code>if(){ } else{ }</code>æœ€åæ‰éœ€è¦åŸ‹ç‚¹ã€‚</li>
<li>å’Œäº‹ä»¶æ‰€åœ¨ç±»æ— å…³çš„åŸ‹ç‚¹æ•°æ®å¯ä»¥åŒæ„ä»<code>ZHLogDataCenter</code>è¿™ä¸ªç±»ä¸­ä¸­å–ï¼Œé‚£ä¹ˆå¦‚æœè¿™ä¸ªæ•°æ®æ˜¯å’Œæ‰€åœ¨ç±»æœ‰å…³å‘¢ï¼Ÿ</li>
<li>å¯¹äºä»£ç†æ–¹æ³•è¯¥æ€æ ·å¤„ç†ï¼Ÿ</li>
<li>å¦‚æœå¾ˆå¤šä¸ªæŒ‰é’®å¯¹åº”ç€ä¸€ä¸ªäº‹ä»¶è¯¥æ€æ ·å¤„ç†ï¼Ÿ</li>
<li>é¡¹ç›®ä¸­äº‹ä»¶çš„å¤„ç†æ–¹æ³•ä¸å°½ç›¸åŒï¼Œæ–¹æ³•çš„å‚æ•°ä¸ªæ•°ä¸ä¸€æ ·ï¼Œå¹¶ä¸”æ–¹æ³•çš„è¿”å›å€¼ä¹Ÿä¸ä¸€æ ·ï¼Œå¦‚ä½•å¯¹ä»–ä»¬è¿›è¡Œç»Ÿä¸€çš„å¤„ç†?<br>ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€è§£å†³è¿™äº›é—®é¢˜ã€‚</li>
</ol>
<p><strong>é—®é¢˜1</strong>ï¼šå¯¹äºä¸æ˜¯æ¥è‡ªUIControlçš„å­ç±»å‘å‡ºçš„äº‹ä»¶ï¼Œæˆ‘ä»¬ä¸€æ ·æ˜¯å¯ä»¥è¿›è¡ŒhooKï¼Œåªä¸è¿‡æ–¹æ³•æœ‰æ‰€ä¸åŒã€‚æˆ‘ä»¬åœ¨UIControlçš„åˆ†ç±»ä¸­å†™äº†ä¸€æ®µåµŒå…¥çš„ä»£ç ï¼Œç¡®å®hookä½äº†ç³»ç»ŸUIButtonçš„ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¯<strong>å› ä¸ºUIButtonè‡ªèº«ä¼šè°ƒç”¨UIControlçš„è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯å¯¹äºç‚¹å‡»äº‹ä»¶ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„çˆ¶ç±»UIViewControllerä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œæˆ‘ä»¬è‡ªå·±ç‚¹å‡»äº‹ä»¶çš„æ–¹æ³•æ—¶UIViewControlleråˆ†ç±»ä¸­è¦åµŒå…¥çš„æ–¹æ³•æ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ï¼Œè¿™æ—¶å€™æ€ä¹ˆåŠï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„ç»™æˆ‘ä»¬è‡ªå·±è¦hookçš„ViewControlleråŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åå°±å¯ä»¥hookäº†</strong>ï¼ˆè¿™ä¸€ç‚¹ä¸å¤ªå¥½ç†è§£ï¼‰ã€‚å…·ä½“çš„æ·»åŠ æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒæœ¬æ–‡çš„å®ä¾‹ä»£ç ã€‚</p>
<p><strong>é—®é¢˜2</strong>ï¼šå¯¹äºæ˜¯å¦ä¸Šä¼ å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ–¹æ³•æ‰€åœ¨ç±»çš„ä¸€ä¸ªå±æ€§å€¼è¿›è¡Œæ ‡è®°ï¼Œè¿™ä¸ªå±æ€§å†™åœ¨<code>.m</code>æ–‡ä»¶ä¸­å³å¯(KVCå¯ä»¥è·å–.mæ–‡ä»¶ä¸­çš„å±æ€§å€¼ã€‚)ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œè¦hooké‚£ä¸ªç±»çš„æ–¹æ³•ï¼Œç„¶åæ ¹æ®<code>plist</code>ä¸­é…ç½®çš„ç›¸å…³æ ‡è®°è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼ˆè¿™é‡Œçš„å±æ€§å€¼å…¶å®ä¹Ÿæ˜¯ä¸å¿…è¦çš„ï¼Œæˆ‘ä¹ˆå¯ä»¥æ ¹æ®ç±»åå’Œæ–¹æ³•åå­—ç¬¦ä¸²çš„å“ˆå¸Œç”Ÿæˆå”¯ä¸€çš„keyï¼Œç„¶ååˆ©ç”¨runtimeè‡ªåŠ¨å…³è”åˆ°è¿™ä¸ªç±»çš„<code>mf_condition</code>å±æ€§ä¸Šï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªå­—å…¸å…¶keyå°±æ˜¯åˆšæ‰ç”Ÿæˆçš„ï¼Œvalueå°±æ˜¯è¿è¡Œå®Œè¿™ä¸ªæ–¹æ³•ä¹‹åå¾—åˆ°çš„å€¼ï¼Œç„¶åè¿™ä¸ªå€¼å†è·Ÿplistä¸­çš„é…ç½®åšä»¥æ¯”è¾ƒï¼‰ã€‚</p>
<p><strong>é—®é¢˜3</strong>ï¼šå¯¹äºå’Œäº‹ä»¶æ‰€åœ¨ç±»æœ‰ç´§å¯†å…³è”çš„åŸ‹ç‚¹æ•°æ®ï¼Œæ¯”å¦‚æŸä¸ªé¡µé¢å¯¹åº”çš„äº§å“ID,æ¯”å¦‚æŸä¸ªé¡µé¢ç‚¹å‡»äº†cellï¼Œä¹‹åè¿™ä¸ªcellå¯¹åº”çš„modelçš„IDã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å‚è€ƒæ–¹æ³•2ï¼Œæ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œç”¨ä¸€ä¸ªå±æ€§å€¼æ¥å­˜å‚¨è¿™äº›è¿™äº›éœ€è¦ä¸Šä¼ çš„å…·ä½“æ•°æ®ã€‚</p>
<p><strong>é—®é¢˜4</strong>ï¼šä»£ç†æ–¹æ³•å’Œæ‰‹åŠ¿çš„å¤„ç†ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ—¢ç„¶ä¸€ä¸ªç±»å®ç°äº†æŸä¸ªä»£ç†æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶<code>[someInstance respondsToSelector:someSelector]</code>æ‰€è¿”å›çš„BOOLå€¼åº”è¯¥æ˜¯YESçš„ï¼Œç„¶åå…¶å®ƒçš„å°±å’Œæ‰‹åŠ¿çš„å¤„ç†æ˜¯ä¸€æ ·çš„äº†ã€‚</p>
<p><strong>é—®é¢˜5</strong>ï¼šå¯¹äºå¾ˆå¤šæŒ‰é’®å¯¹åº”ä¸€ä¸ªå“åº”äº‹ä»¶çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨RunTimeåŠ¨æ€çš„ç»™æŒ‰é’®æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œæ¯”å¦‚:buttonIdentifier,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨plistä¸­è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥è¿›è¡Œç›¸åº”çš„åŸ‹ç‚¹å¤„ç†ã€‚</p>
<p><strong>é—®é¢˜6</strong>ï¼šè¿™ä¸ªé—®é¢˜å…¶å®å°±æ˜¯hookä½æ‰€æœ‰çš„æ–¹æ³•ï¼Œç„¶åç»™ä»–ä»¬æ·»åŠ åŒä¸€ä¸ªä»£ç æ®µçš„é—®é¢˜ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Aspects</code>è¿™ä¸ªç¬¬ä¸‰æ–¹æ¡†æ¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                  withOptions:(AspectOptions)options</span><br><span class="line">                   usingBlock:(id)block</span><br><span class="line">                        error:(NSError **)error &#123;</span><br><span class="line">return aspect_add((id)self, selector, options, block, error);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œå› ä¸ºåœ¨<code>UIViewController</code>çš„åˆ†ç±»ä¸­è°ƒç”¨è¿™ä¸ªæ¥å£çš„å¯¹è±¡ä¸ä¸€æ ·ï¼Œå¹¶ä¸”æˆ‘ä»¬æ ¹æ®<code>plist</code>ä¸­çš„é…ç½®hookçš„selectorä¸ä¸€æ ·ï¼Œç„¶è€Œæœ€åæ‰§è¡Œçš„blockå´æ˜¯ä¸€æ ·çš„ï¼Œè¿™å°±å¾ˆå¥½çš„è§£å†³äº†é—®é¢˜ã€‚</p>
<h1 id="æœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#æœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="æœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>æœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h1><p>æœ€ç†æƒ³çš„åŸ‹ç‚¹æ˜¯åŠ¨æ€çš„ï¼Œå°±æ˜¯PMç»™æˆ‘ä»¬è¯´éœ€è¦å“ªäº›åŸ‹ç‚¹ï¼Œç„¶åæœåŠ¡å™¨ç»™æˆ‘ä»¬å‘ä¸€ä¸ªç±»ä¼¼ä¸ä¸Šæ–‡ä¸­æåˆ°çš„<code>plist</code>ä¸€æ ·çš„æ–‡ä»¶ï¼Œæˆ–è€…ä¸€ä¸ª<code>json</code>,æˆ‘ä»¬å­˜åˆ°æœ¬åœ°ï¼Œå¦‚æœè¿™äº›åŸ‹ç‚¹æ²¡æœ‰æ›´æ–°ï¼Œæˆ‘ä»¬å°±ä»æœ¬åœ°ä¸­è¯»å–ç›¸åº”çš„æ–‡ä»¶ï¼Œåšç›¸åº”çš„åŸ‹ç‚¹ï¼Œå¦‚æœæœ‰æ›´æ–°ï¼Œæˆ‘ä»¬é‡æ–°ä»æœåŠ¡å™¨è·å–æœ€æ–°çš„éœ€è¦åŸ‹çš„ç‚¹ï¼Œç„¶åè¿›è¡Œç›¸åº”åŸ‹ç‚¹ã€‚è¿™æ ·å°±è§£å†³äº†å°‘åŸ‹ï¼Œæˆ–è€…åŸ‹ç‚¹ä¸æ°å½“ï¼Œéœ€è¦æ·»åŠ åŸ‹ç‚¹çš„é—®é¢˜ã€‚</p>
<h1 id="å…¶ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#å…¶ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="å…¶ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"></a>å…¶ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ</h1><p>å½“ç„¶è¿™é‡Œé¢ä¹Ÿæœ‰å…¶éš¾ä»¥å¤„ç†çš„é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹æ§ä»¶ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹æ§ä»¶çš„äº‹ä»¶å›è°ƒä¸æ˜¯ç”¨delegateå®ç°çš„ï¼Œè€Œæ˜¯ç”¨blockå®ç°çš„ï¼Œå¹¶ä¸”è¿™ä¸ªåŸ‹ç‚¹å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘æœ‰å…³ç³»ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•å°±éš¾ä»¥å¤„ç†äº†ã€‚ å¦‚æœå¾ˆå¤šäº‹ä»¶çš„é€»è¾‘å¤„ç†æ”¾åˆ°äº†blockä¸­è¿›è¡Œï¼Œé‚£ä¹ˆä¹Ÿå°†é€ éš¾ä»¥å¤„ç†ã€‚</p>
<p>[è½¬è‡ª <a href="https://www.jianshu.com/p/69859d580354" target="_blank" rel="noopener">å‡»æ°´æ¹˜æ±Ÿ</a>]</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/Objective-C-isa-æŒ‡é’ˆ-ä¸-runtime-æœºåˆ¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/Objective-C-isa-æŒ‡é’ˆ-ä¸-runtime-æœºåˆ¶/" itemprop="url">
                  Objective-C isa æŒ‡é’ˆ ä¸ runtime æœºåˆ¶
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 11:49:08 / ä¿®æ”¹æ—¶é—´ï¼š11:52:21" itemprop="dateCreated datePublished" datetime="2018-09-13T11:49:08+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/runtime/" itemprop="url" rel="index"><span itemprop="name">runtime</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ä¸€-isaæŒ‡é’ˆ"><a href="#ä¸€-isaæŒ‡é’ˆ" class="headerlink" title="ä¸€.isaæŒ‡é’ˆ"></a>ä¸€.isaæŒ‡é’ˆ</h2><p>è¦è®¤è¯†ä»€ä¹ˆæ˜¯isaæŒ‡é’ˆï¼Œæˆ‘ä»¬å¾—å…ˆæ˜ç¡®ä¸€ç‚¹ï¼š</p>
<p><strong>åœ¨Objective-Cä¸­ï¼Œä»»ä½•ç±»çš„å®šä¹‰éƒ½æ˜¯å¯¹è±¡ã€‚ç±»å’Œç±»çš„å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰æ²¡æœ‰ä»»ä½•æœ¬è´¨ä¸Šçš„åŒºåˆ«ã€‚ä»»ä½•å¯¹è±¡éƒ½æœ‰isaæŒ‡é’ˆã€‚</strong></p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯ç±»å‘¢ï¼Ÿåœ¨xcodeä¸­ç”¨å¿«æ·é”®Shiftï¼‹Cmdï¼‹O æ‰“å¼€æ–‡ä»¶objc.h èƒ½çœ‹åˆ°ç±»çš„å®šä¹‰ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/449095-4006820f1afc3318.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/728" alt="img"></p>
<p>å¯ä»¥çœ‹å‡º:</p>
<p><strong>Class æ˜¯ä¸€ä¸ª objc_class ç»“æ„ç±»å‹çš„æŒ‡é’ˆ, idæ˜¯ä¸€ä¸ª objc_object ç»“æ„ç±»å‹çš„æŒ‡é’ˆ.</strong></p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ objc_class çš„å®šä¹‰ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/449095-02d25b1edb82d5b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/593" alt="img"></p>
<p>ç¨å¾®è§£é‡Šä¸€ä¸‹å„ä¸ªå‚æ•°çš„æ„æ€ï¼š</p>
<p>isaï¼šæ˜¯ä¸€ä¸ªClass ç±»å‹çš„æŒ‡é’ˆ. æ¯ä¸ªå®ä¾‹å¯¹è±¡æœ‰ä¸ªisaçš„æŒ‡é’ˆ,ä»–æŒ‡å‘å¯¹è±¡çš„ç±»ï¼Œè€ŒClassé‡Œä¹Ÿæœ‰ä¸ªisaçš„æŒ‡é’ˆ, æŒ‡å‘meteClass(å…ƒç±»)ã€‚å…ƒç±»ä¿å­˜äº†ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚å½“ç±»æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå…ˆä¼šä»æœ¬èº«æŸ¥æ‰¾ç±»æ–¹æ³•çš„å®ç°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå…ƒç±»ä¼šå‘ä»–çˆ¶ç±»æŸ¥æ‰¾è¯¥æ–¹æ³•ã€‚åŒæ—¶æ³¨æ„çš„æ˜¯ï¼š<strong>å…ƒç±»ï¼ˆmeteClassï¼‰ä¹Ÿæ˜¯ç±»ï¼Œå®ƒä¹Ÿæ˜¯å¯¹è±¡ã€‚</strong>å…ƒç±»ä¹Ÿæœ‰isaæŒ‡é’ˆ,å®ƒçš„isaæŒ‡é’ˆæœ€ç»ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ ¹å…ƒç±»(root meteClass).æ ¹å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘æœ¬èº«ï¼Œè¿™æ ·å½¢æˆäº†ä¸€ä¸ªå°é—­çš„å†…å¾ªç¯ã€‚</p>
<p>super_classï¼šçˆ¶ç±»ï¼Œå¦‚æœè¯¥ç±»å·²ç»æ˜¯æœ€é¡¶å±‚çš„æ ¹ç±»,é‚£ä¹ˆå®ƒä¸ºNULLã€‚</p>
<p>versionï¼šç±»çš„ç‰ˆæœ¬ä¿¡æ¯,é»˜è®¤ä¸º0</p>
<p>infoï¼šä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†ã€‚</p>
<p>instance_sizeï¼šè¯¥ç±»çš„å®ä¾‹å˜é‡å¤§å°</p>
<p>ivarsï¼šæˆå‘˜å˜é‡çš„æ•°ç»„</p>
<p>å†æ¥çœ‹çœ‹å„ä¸ªç±»å®ä¾‹å˜é‡çš„ç»§æ‰¿å…³ç³»ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/449095-3e972ec16703c54d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/598" alt="img"></p>
<p><strong>æ¯ä¸€ä¸ªå¯¹è±¡æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹ã€‚å…¶ä¸­ç±»å®šä¹‰äº†æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•çš„åˆ—è¡¨ã€‚å¯¹è±¡é€šè¿‡å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘ç±»ã€‚</strong></p>
<p><strong>æ¯ä¸€ä¸ªç±»æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç±»å…¶å®æ˜¯å…ƒç±»ï¼ˆmeteClassï¼‰çš„å®ä¾‹ã€‚å…ƒç±»å®šä¹‰äº†ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚ç±»é€šè¿‡ç±»çš„isaæŒ‡é’ˆæŒ‡å‘å…ƒç±»ã€‚</strong></p>
<p><strong>æ‰€æœ‰çš„å…ƒç±»æœ€ç»ˆç»§æ‰¿ä¸€ä¸ªæ ¹å…ƒç±»ï¼Œæ ¹å…ƒç±»isaæŒ‡é’ˆæŒ‡å‘æœ¬èº«ï¼Œå½¢æˆä¸€ä¸ªå°é—­çš„å†…å¾ªç¯ã€‚</strong></p>
<h2 id="äºŒ-runtime-æœºåˆ¶"><a href="#äºŒ-runtime-æœºåˆ¶" class="headerlink" title="äºŒ.runtime æœºåˆ¶"></a><strong>äºŒ.runtime æœºåˆ¶</strong></h2><p>runtimeï¼šæŒ‡ä¸€ä¸ªç¨‹åºåœ¨è¿è¡Œï¼ˆæˆ–è€…åœ¨è¢«æ‰§è¡Œï¼‰çš„çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ æ‰“å¼€ä¸€ä¸ªç¨‹åºä½¿å®ƒåœ¨ç”µè„‘ä¸Šè¿è¡Œçš„æ—¶å€™ï¼Œé‚£ä¸ªç¨‹åºå°±æ˜¯å¤„äºè¿è¡Œæ—¶åˆ»ã€‚åœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒæŠŠæŸäº›å¯ä»¥é‡ç”¨çš„ç¨‹åºæˆ–è€…å®ä¾‹æ‰“åŒ…æˆ–è€…é‡å»ºæˆä¸ºâ€œè¿è¡Œåº“â€ã€‚è¿™äº›å®ä¾‹å¯ä»¥åœ¨å®ƒä»¬è¿è¡Œçš„æ—¶å€™è¢«è¿æ¥æˆ–è€…è¢«ä»»ä½•ç¨‹åºè°ƒç”¨ã€‚</p>
<p>objective-cä¸­runtimeï¼šæ˜¯ä¸€å¥—æ¯”è¾ƒåº•å±‚çš„çº¯Cè¯­è¨€API, å±äº1ä¸ªCè¯­è¨€åº“, åŒ…å«äº†å¾ˆå¤šåº•å±‚çš„Cè¯­è¨€APIã€‚ åœ¨æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„OCä»£ç ä¸­, ç¨‹åºè¿è¡Œè¿‡ç¨‹æ—¶, å…¶å®æœ€ç»ˆéƒ½æ˜¯è½¬æˆäº†runtimeçš„Cè¯­è¨€ä»£ç ã€‚</p>
<p><strong>runtimeçš„åº”ç”¨ï¼š</strong></p>
<p>1.åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»(æ¯”å¦‚KVOçš„åº•å±‚å®ç°)</p>
<p> 2.åŠ¨æ€åœ°ä¸ºæŸä¸ªç±»æ·»åŠ å±æ€§\æ–¹æ³•, ä¿®æ”¹å±æ€§å€¼\æ–¹æ³•</p>
<p>3.éå†ä¸€ä¸ªç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡(å±æ€§)\æ‰€æœ‰æ–¹æ³•</p>
<p><strong>å®è´¨ä¸Šï¼Œä»¥ä¸Šçš„æ˜¯é€šè¿‡ç›¸å…³æ–¹æ³•æ¥è·å–å¯¹è±¡æˆ–è€…ç±»çš„isaæŒ‡é’ˆæ¥å®ç°çš„ã€‚</strong></p>
<p><strong>ç›¸å…³å‡½æ•°</strong></p>
<ol>
<li>å¢åŠ </li>
</ol>
<p>å¢åŠ å‡½æ•°:class_addMethod</p>
<p>å¢åŠ å®ä¾‹å˜é‡:class_addIvar</p>
<p>å¢åŠ å±æ€§:@dynamicæ ‡ç­¾ï¼Œæˆ–è€…class_addMethodï¼Œå› ä¸ºå±æ€§å…¶å®å°±æ˜¯ç”±getterå’Œsetterå‡½æ•°ç»„æˆ</p>
<p>å¢åŠ Protocol:class<em>addProtocol (è¯´å®è¯æˆ‘çœŸä¸çŸ¥é“åŠ¨æ€å¢åŠ ä¸€ä¸ªprotocolæœ‰ä»€ä¹ˆç”¨,-</em>-!!)</p>
<ol>
<li>è·å–</li>
</ol>
<p>è·å–å‡½æ•°åˆ—è¡¨åŠæ¯ä¸ªå‡½æ•°çš„ä¿¡æ¯(å‡½æ•°æŒ‡é’ˆã€å‡½æ•°åç­‰ç­‰):class_getClassMethod method_getName â€¦</p>
<p>è·å–å±æ€§åˆ—è¡¨åŠæ¯ä¸ªå±æ€§çš„ä¿¡æ¯:class_copyPropertyList property_getName</p>
<p>è·å–ç±»æœ¬èº«çš„ä¿¡æ¯,å¦‚ç±»åç­‰ï¼šclass_getName class_getInstanceSize</p>
<p>è·å–å˜é‡åˆ—è¡¨åŠå˜é‡ä¿¡æ¯ï¼šclass_copyIvarList</p>
<p>è·å–å˜é‡çš„å€¼</p>
<ol>
<li>æ›¿æ¢</li>
</ol>
<p>å°†å®ä¾‹æ›¿æ¢æˆå¦ä¸€ä¸ªç±»ï¼šobject_setClass</p>
<p>æ›¿æ¢ç±»æ–¹æ³•çš„å®šä¹‰ï¼šclass_replaceMethod</p>
<p>4.å…¶ä»–å¸¸ç”¨æ–¹æ³•ï¼š</p>
<p>äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ï¼šmethod_exchangeImplementations.</p>
<p>è®¾ç½®ä¸€ä¸ªæ–¹æ³•çš„å®ç°ï¼šmethod_setImplementation.        </p>
<p><img src="http://upload-images.jianshu.io/upload_images/449095-aec569427bcb7436.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/690" alt="img"></p>
<p>[è½¬è‡ª <a href="https://www.jianshu.com/p/41735c66dccb" target="_blank" rel="noopener">æ›²å¹´</a>]</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/Objective-C-æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/Objective-C-æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†/" itemprop="url">
                  Objective-C-æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç†
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 11:43:31 / ä¿®æ”¹æ—¶é—´ï¼š11:45:38" itemprop="dateCreated datePublished" datetime="2018-09-13T11:43:31+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/runtime/" itemprop="url" rel="index"><span itemprop="name">runtime</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æ¶ˆæ¯å‘é€å’Œè½¬å‘æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šæ¶ˆæ¯å‘é€ï¼ˆMessagingï¼‰æ˜¯ Runtime é€šè¿‡ selector å¿«é€ŸæŸ¥æ‰¾ IMP çš„è¿‡ç¨‹ï¼Œæœ‰äº†å‡½æ•°æŒ‡é’ˆå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å®ç°ï¼›æ¶ˆæ¯è½¬å‘ï¼ˆMessage Forwardingï¼‰æ˜¯åœ¨æŸ¥æ‰¾ IMP å¤±è´¥åæ‰§è¡Œä¸€ç³»åˆ—è½¬å‘æµç¨‹çš„æ…¢é€Ÿé€šé“ï¼Œå¦‚æœä¸ä½œè½¬å‘å¤„ç†ï¼Œåˆ™ä¼šæ‰“æ—¥å¿—å’ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><strong>æœ¬æ–‡ä¸è®²è¿°å¼€å‘è€…åœ¨æ¶ˆæ¯å‘é€å’Œè½¬å‘æµç¨‹ä¸­éœ€è¦åšçš„äº‹ï¼Œè€Œæ˜¯è®²è¿°åŸç†ã€‚èƒ½å¤Ÿå¾ˆå¥½åœ°é˜…è¯»æœ¬æ–‡çš„å‰ææ˜¯ä½ å¯¹ Objective-C Runtime å·²ç»æœ‰ä¸€å®šçš„äº†è§£ï¼Œå…³äºä»€ä¹ˆæ˜¯æ¶ˆæ¯ï¼ŒClass çš„ç»“æ„ï¼Œselectorã€IMPã€å…ƒç±»ç­‰æ¦‚å¿µå°†ä¸å†èµ˜è¿°</strong>ã€‚æœ¬æ–‡ç”¨åˆ°çš„æºç ä¸º objc4-680 å’Œ CF-1153.18ï¼Œé€†å‘ CoreFoundation.framework çš„ç³»ç»Ÿç‰ˆæœ¬ä¸º macOS 10.11.5ï¼Œæ±‡ç¼–è¯­è¨€æ¶æ„ä¸º x86_64ã€‚</p>
<h2 id="å…«é¢ç²ç‘çš„-objc-msgSend"><a href="#å…«é¢ç²ç‘çš„-objc-msgSend" class="headerlink" title="å…«é¢ç²ç‘çš„ objc_msgSend"></a>å…«é¢ç²ç‘çš„ objc_msgSend</h2><p>æ­¤å‡½æ•°æ˜¯æ¶ˆæ¯å‘é€å¿…ç»ä¹‹è·¯ï¼Œä½†åªè¦ä¸€æ <code>objc_msgSend</code>ï¼Œéƒ½ä¼šè¯´å®ƒçš„ä¼ªä»£ç å¦‚ä¸‹æˆ–ç±»ä¼¼çš„é€»è¾‘ï¼Œåæ­£å°±æ˜¯è·å– IMP å¹¶è°ƒç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id objc_msgSend(id self, SEL _cmd, ...) &#123;</span><br><span class="line">  Class class = object_getClass(self);</span><br><span class="line">  IMP imp = class_getMethodImplementation(class, _cmd);</span><br><span class="line">  return imp ? imp(self, _cmd, ...) : 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><p>ä¸ºå•¥è€ç”¨ä¼ªä»£ç ï¼Ÿå› ä¸º <code>objc_msgSend</code> æ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼Œé’ˆå¯¹ä¸åŒæ¶æ„æœ‰ä¸åŒçš„å®ç°ã€‚å¦‚ä¸‹ä¸º <code>x86_64</code> æ¶æ„ä¸‹çš„æºç ï¼Œå¯ä»¥åœ¨ <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s" target="_blank" rel="noopener">objc-msg-x86_64.s</a> æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">	ENTRY	_objc_msgSend</span><br><span class="line">	MESSENGER_START</span><br><span class="line"></span><br><span class="line">	NilTest	NORMAL</span><br><span class="line"></span><br><span class="line">	GetIsaFast NORMAL		// r11 = self-&gt;isa</span><br><span class="line">	CacheLookup NORMAL		// calls IMP on success</span><br><span class="line"></span><br><span class="line">	NilTestSupport	NORMAL</span><br><span class="line"></span><br><span class="line">	GetIsaSupport	   NORMAL</span><br><span class="line"></span><br><span class="line">// cache miss: go search the method lists</span><br><span class="line">LCacheMiss:</span><br><span class="line">	// isa still in r11</span><br><span class="line">	MethodTableLookup %a1, %a2	// r11 = IMP</span><br><span class="line">	cmp	%r11, %r11		// set eq (nonstret) for forwarding</span><br><span class="line">	jmp	*%r11			// goto *imp</span><br><span class="line"></span><br><span class="line">	END_ENTRY	_objc_msgSend</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢åŒ…å«ä¸€äº›æœ‰æ„ä¹‰çš„å®ï¼š</p>
<p><code>NilTest</code> å®ï¼Œåˆ¤æ–­è¢«å‘é€æ¶ˆæ¯çš„å¯¹è±¡æ˜¯å¦ä¸º <code>nil</code> çš„ã€‚å¦‚æœä¸º <code>nil</code>ï¼Œé‚£å°±ç›´æ¥è¿”å› <code>nil</code>ã€‚è¿™å°±æ˜¯ä¸ºå•¥ä¹Ÿå¯ä»¥å¯¹ <code>nil</code>å‘æ¶ˆæ¯ã€‚</p>
<p><code>GetIsaFast</code> å®å¯ä»¥ã€å¿«é€Ÿåœ°ã€è·å–åˆ°å¯¹è±¡çš„ <code>isa</code> æŒ‡é’ˆåœ°å€ï¼ˆæ”¾åˆ° <code>r11</code> å¯„å­˜å™¨ï¼Œ<code>r10</code> ä¼šè¢«é‡å†™ï¼›åœ¨ arm æ¶æ„ä¸Šæ˜¯ç›´æ¥èµ‹å€¼åˆ° <code>r9</code>ï¼‰</p>
<p><code>CacheLookup</code> è¿™ä¸ªå®æ˜¯åœ¨ç±»çš„ç¼“å­˜ä¸­æŸ¥æ‰¾ selector å¯¹åº”çš„ IMPï¼ˆæ”¾åˆ° <code>r10</code>ï¼‰å¹¶æ‰§è¡Œã€‚å¦‚æœç¼“å­˜æ²¡ä¸­ï¼Œé‚£å°±å¾—åˆ° Class çš„æ–¹æ³•è¡¨ä¸­æŸ¥æ‰¾äº†ã€‚</p>
<p><code>MethodTableLookup</code> å®æ˜¯é‡ç‚¹ï¼Œè´Ÿè´£åœ¨ç¼“å­˜æ²¡å‘½ä¸­æ—¶åœ¨æ–¹æ³•è¡¨ä¸­è´Ÿè´£æŸ¥æ‰¾ IMPï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.macro MethodTableLookup</span><br><span class="line"></span><br><span class="line">	MESSENGER_END_SLOW</span><br><span class="line">	</span><br><span class="line">	SaveRegisters</span><br><span class="line"></span><br><span class="line">	// _class_lookupMethodAndLoadCache3(receiver, selector, class)</span><br><span class="line"></span><br><span class="line">	movq	$0, %a1</span><br><span class="line">	movq	$1, %a2</span><br><span class="line">	movq	%r11, %a3</span><br><span class="line">	call	__class_lookupMethodAndLoadCache3</span><br><span class="line"></span><br><span class="line">	// IMP is now in %rax</span><br><span class="line">	movq	%rax, %r11</span><br><span class="line"></span><br><span class="line">	RestoreRegisters</span><br><span class="line"></span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºæ–¹æ³•æŸ¥æ‰¾ IMP çš„å·¥ä½œäº¤ç»™äº† OC ä¸­çš„ <code>_class_lookupMethodAndLoadCache3</code> å‡½æ•°ï¼Œå¹¶å°† IMP è¿”å›ï¼ˆä» <code>r11</code> æŒªåˆ° <code>rax</code>ï¼‰ã€‚æœ€ååœ¨ <code>objc_msgSend</code> ä¸­è°ƒç”¨ IMPã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨æ±‡ç¼–è¯­è¨€"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨æ±‡ç¼–è¯­è¨€" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨æ±‡ç¼–è¯­è¨€"></a>ä¸ºä»€ä¹ˆä½¿ç”¨æ±‡ç¼–è¯­è¨€</h3><p>å…¶å®åœ¨ <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s" target="_blank" rel="noopener">objc-msg-x86_64.s</a> ä¸­åŒ…å«äº†å¤šä¸ªç‰ˆæœ¬çš„ <code>objc_msgSend</code> æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯æ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè°ƒç”¨è€…çš„ç±»å‹åˆ†åˆ«å¤„ç†çš„ï¼š</p>
<ul>
<li><code>objc_msgSendSuper</code>:å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œè¿”å›å€¼ç±»å‹ä¸º <code>id</code></li>
<li><code>objc_msgSend_fpret</code>:è¿”å›å€¼ç±»å‹ä¸º floating-pointï¼Œå…¶ä¸­åŒ…å« <code>objc_msgSend_fp2ret</code> å…¥å£å¤„ç†è¿”å›å€¼ç±»å‹ä¸º <code>long double</code> çš„æƒ…å†µ</li>
<li><code>objc_msgSend_stret</code>:è¿”å›å€¼ä¸ºç»“æ„ä½“</li>
<li><code>objc_msgSendSuper_stret</code>:å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œè¿”å›å€¼ç±»å‹ä¸ºç»“æ„ä½“</li>
</ul>
<p>å½“éœ€è¦å‘é€æ¶ˆæ¯æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸­é—´ä»£ç ï¼Œæ ¹æ®æƒ…å†µåˆ†åˆ«è°ƒç”¨ <code>objc_msgSend</code>, <code>objc_msgSend_stret</code>, <code>objc_msgSendSuper</code>, æˆ– <code>objc_msgSendSuper_stret</code> å…¶ä¸­ä¹‹ä¸€ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>objc_msgSend</code> è¦ç”¨æ±‡ç¼–è¯­è¨€è€Œä¸æ˜¯ OCã€C æˆ– C++ è¯­è¨€æ¥å®ç°ï¼Œå› ä¸ºå•ç‹¬ä¸€ä¸ªæ–¹æ³•å®šä¹‰æ»¡è¶³ä¸äº†å¤šç§ç±»å‹è¿”å›å€¼ï¼Œæœ‰çš„æ–¹æ³•è¿”å› <code>id</code>ï¼Œæœ‰çš„è¿”å› <code>int</code>ã€‚è€ƒè™‘åˆ°ä¸åŒç±»å‹å‚æ•°è¿”å›å€¼æ’åˆ—ç»„åˆæ˜ å°„ä¸åŒæ–¹æ³•ç­¾åï¼ˆmethod signatureï¼‰çš„é—®é¢˜ï¼Œé‚£ switch è¯­å¥å¾—è€é•¿äº†ã€‚ã€‚ã€‚<strong>è¿™äº›åŸå› å¯ä»¥æ€»ç»“ä¸º Calling Conventionï¼Œä¹Ÿå°±æ˜¯è¯´å‡½æ•°è°ƒç”¨è€…ä¸è¢«è°ƒç”¨è€…å¿…é¡»çº¦å®šå¥½å‚æ•°ä¸è¿”å›å€¼åœ¨ä¸åŒæ¶æ„å¤„ç†å™¨ä¸Šçš„å­˜å–è§„åˆ™ï¼Œæ¯”å¦‚å‚æ•°æ˜¯ä»¥ä½•ç§é¡ºåºå­˜å‚¨åœ¨æ ˆä¸Šï¼Œæˆ–æ˜¯å­˜å‚¨åœ¨å“ªäº›å¯„å­˜å™¨ä¸Šã€‚</strong>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å…¶ä»–åŸå› ï¼Œæ¯”å¦‚å…¶å¯å˜å‚æ•°ç”¨æ±‡ç¼–å¤„ç†èµ·æ¥æœ€æ–¹ä¾¿ï¼Œå› ä¸ºæ‰¾åˆ° IMP åœ°å€åå‚æ•°éƒ½åœ¨æ ˆä¸Šã€‚è¦æ˜¯ç”¨ C++ ä¼ é€’å¯å˜å‚æ•°é‚£å°±æ‚²å‰§äº†ï¼Œprologue æœºåˆ¶ä¼šå¼„ä¹±åœ°å€ï¼ˆæ¯”å¦‚ i386 ä¸Šä¸ºäº†å­˜å‚¨ <code>ebp</code> å‘åç§»ä½ 4byteï¼‰ï¼Œæœ€åè¿˜è¦ç”¨ epilogue æ‰“æ‰«æˆ˜åœºã€‚è€Œä¸”æ±‡ç¼–ç¨‹åºæ‰§è¡Œæ•ˆç‡é«˜ï¼Œåœ¨ Objective-C Runtime ä¸­è°ƒç”¨é¢‘ç‡è¾ƒé«˜çš„å‡½æ•°å¥½å¤šéƒ½ç”¨æ±‡ç¼–å†™çš„ã€‚</p>
<h2 id="ä½¿ç”¨-lookUpImpOrForward-å¿«é€ŸæŸ¥æ‰¾-IMP"><a href="#ä½¿ç”¨-lookUpImpOrForward-å¿«é€ŸæŸ¥æ‰¾-IMP" class="headerlink" title="ä½¿ç”¨ lookUpImpOrForward å¿«é€ŸæŸ¥æ‰¾ IMP"></a>ä½¿ç”¨ lookUpImpOrForward å¿«é€ŸæŸ¥æ‰¾ IMP</h2><p>ä¸Šä¸€èŠ‚ä¸­è¯´åˆ°çš„ <code>_class_lookupMethodAndLoadCache3</code> å‡½æ•°å…¶å®åªæ˜¯ç®€å•çš„è°ƒç”¨äº† <code>lookUpImpOrForward</code> å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IMP _class_lookupMethodAndLoadCache3(id obj, SEL sel, Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    return lookUpImpOrForward(cls, sel, obj, </span><br><span class="line">                              YES/*initialize*/, NO/*cache*/, YES/*resolver*/);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ <code>lookUpImpOrForward</code> è°ƒç”¨æ—¶ä½¿ç”¨ç¼“å­˜å‚æ•°ä¼ å…¥ä¸º <code>NO</code>ï¼Œå› ä¸ºä¹‹å‰å·²ç»å°è¯•è¿‡æŸ¥æ‰¾ç¼“å­˜äº†ã€‚<code>IMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver)</code>å®ç°äº†ä¸€å¥—æŸ¥æ‰¾ IMP çš„æ ‡å‡†è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¶ˆæ¯è½¬å‘ï¼ˆForwardï¼‰ä¹‹å‰çš„é€»è¾‘ã€‚</p>
<h3 id="ä¼˜åŒ–ç¼“å­˜æŸ¥æ‰¾-amp-ç±»çš„åˆå§‹åŒ–"><a href="#ä¼˜åŒ–ç¼“å­˜æŸ¥æ‰¾-amp-ç±»çš„åˆå§‹åŒ–" class="headerlink" title="ä¼˜åŒ–ç¼“å­˜æŸ¥æ‰¾&amp;ç±»çš„åˆå§‹åŒ–"></a>ä¼˜åŒ–ç¼“å­˜æŸ¥æ‰¾&amp;ç±»çš„åˆå§‹åŒ–</h3><p>å…ˆå¯¹ debug æ¨¡å¼ä¸‹çš„ assert è¿›è¡Œ unlockï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runtimeLock.assertUnlocked();</span><br></pre></td></tr></table></figure>
<p><code>runtimeLock</code> æœ¬è´¨ä¸Šæ˜¯å¯¹ Darwin æä¾›çš„çº¿ç¨‹è¯»å†™é” <code>pthread_rwlock_t</code> çš„ä¸€å±‚å°è£…ï¼Œæä¾›äº†ä¸€äº›ä¾¿æ·çš„æ–¹æ³•ã€‚</p>
<p><code>lookUpImpOrForward</code> æ¥ç€åšäº†å¦‚ä¸‹ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>å¦‚æœä½¿ç”¨ç¼“å­˜ï¼ˆ<code>cache</code> å‚æ•°ä¸º <code>YES</code>ï¼‰ï¼Œé‚£å°±è°ƒç”¨ <code>cache_getImp</code> æ–¹æ³•ä»ç¼“å­˜æŸ¥æ‰¾ IMPã€‚<code>cache_getImp</code> æ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼Œä¹Ÿå¯ä»¥åœ¨ <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s" target="_blank" rel="noopener">objc-msg-x86_64.s</a> æ‰¾åˆ°ï¼Œå…¶ä¾ç„¶ç”¨äº†ä¹‹å‰è¯´è¿‡çš„ <code>CacheLookup</code> å®ã€‚å› ä¸º <code>_class_lookupMethodAndLoadCache3</code> è°ƒç”¨ <code>lookUpImpOrForward</code> æ—¶ <code>cache</code> å‚æ•°ä¸º <code>NO</code>ï¼Œ<strong>è¿™æ­¥ç›´æ¥ç•¥è¿‡</strong>ã€‚</li>
<li>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”¨åˆ°è¿™ä¸ªç±»ä¸” <code>initialize</code> å‚æ•°ä¸º <code>YES</code>ï¼ˆ<code>initialize &amp;&amp; !cls-&gt;isInitialized()</code>ï¼‰ï¼Œéœ€è¦è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œä¹Ÿå°±æ˜¯å¼€è¾Ÿä¸€ä¸ªç”¨äºè¯»å†™æ•°æ®çš„ç©ºé—´ã€‚å…ˆå¯¹ <code>runtimeLock</code> å†™æ“ä½œåŠ é”ï¼Œç„¶åè°ƒç”¨ <code>cls</code> çš„ <code>initialize</code>æ–¹æ³•ã€‚å¦‚æœ <code>sel == initialize</code> ä¹Ÿæ²¡å…³ç³»ï¼Œè™½ç„¶ <code>initialize</code> è¿˜ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä½†ä¸ä¼šèµ·ä½œç”¨å•¦ï¼Œå› ä¸º <code>cls-&gt;isInitialized()</code> å·²ç»æ˜¯ <code>YES</code> å•¦ã€‚</li>
</ol>
<h3 id="ç»§ç»­åœ¨ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­æŸ¥æ‰¾"><a href="#ç»§ç»­åœ¨ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­æŸ¥æ‰¾" class="headerlink" title="ç»§ç»­åœ¨ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­æŸ¥æ‰¾"></a>ç»§ç»­åœ¨ç±»çš„ç»§æ‰¿ä½“ç³»ä¸­æŸ¥æ‰¾</h3><p>è€ƒè™‘åˆ°è¿è¡Œæ—¶ç±»ä¸­çš„æ–¹æ³•å¯èƒ½ä¼šå¢åŠ ï¼Œéœ€è¦å…ˆåšè¯»æ“ä½œåŠ é”ï¼Œä½¿å¾—æ–¹æ³•æŸ¥æ‰¾å’Œç¼“å­˜å¡«å……æˆä¸ºåŸå­æ“ä½œã€‚æ·»åŠ  category ä¼šåˆ·æ–°ç¼“å­˜ï¼Œä¹‹åå¦‚æœæ—§æ•°æ®åˆè¢«é‡å¡«åˆ°ç¼“å­˜ä¸­ï¼Œcategory æ·»åŠ æ“ä½œå°±ä¼šè¢«å¿½ç•¥æ‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runtimeLock.read();</span><br></pre></td></tr></table></figure>
<p>ä¹‹åçš„é€»è¾‘æ•´ç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœ selector æ˜¯éœ€è¦è¢«å¿½ç•¥çš„åƒåœ¾å›æ”¶ç”¨åˆ°çš„æ–¹æ³•ï¼Œåˆ™å°† IMP ç»“æœè®¾ä¸º <code>_objc_ignored_method</code>ï¼Œè¿™æ˜¯ä¸ªæ±‡ç¼–ç¨‹åºå…¥å£ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ ‡è®°ã€‚å¯¹æ­¤ç§æƒ…å†µè¿›è¡Œç¼“å­˜å¡«å……æ“ä½œåï¼Œè·³åˆ°ç¬¬ 7 æ­¥ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚</li>
<li>æŸ¥æ‰¾å½“å‰ç±»ä¸­çš„ç¼“å­˜ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ï¼Œä½¿ç”¨ <code>cache_getImp</code> æ±‡ç¼–ç¨‹åºå…¥å£ã€‚å¦‚æœå‘½ä¸­ç¼“å­˜è·å–åˆ°äº† IMPï¼Œåˆ™ç›´æ¥è·³åˆ°ç¬¬ 7 æ­¥ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚</li>
<li>åœ¨å½“å‰ç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨ï¼ˆmethod listï¼‰ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¹Ÿå°±æ˜¯æ ¹æ® selector æŸ¥æ‰¾åˆ° Method åï¼Œè·å– Method ä¸­çš„ IMPï¼ˆä¹Ÿå°±æ˜¯ <code>method_imp</code> å±æ€§ï¼‰ï¼Œå¹¶å¡«å……åˆ°ç¼“å­˜ä¸­ã€‚æŸ¥æ‰¾è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¼šé’ˆå¯¹å·²ç»æ’åºçš„åˆ—è¡¨ä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œæœªæ’åºçš„åˆ—è¡¨åˆ™æ˜¯çº¿æ€§éå†ã€‚å¦‚æœæˆåŠŸæŸ¥æ‰¾åˆ° Method å¯¹è±¡ï¼Œå°±ç›´æ¥è·³åˆ°ç¬¬ 7 æ­¥ï¼›å¦åˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚</li>
<li>åœ¨ç»§æ‰¿å±‚çº§ä¸­é€’å½’å‘çˆ¶ç±»ä¸­æŸ¥æ‰¾ï¼Œæƒ…å†µè·Ÿä¸Šä¸€æ­¥ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å…ˆæŸ¥æ‰¾ç¼“å­˜ï¼Œç¼“å­˜æ²¡ä¸­å°±æŸ¥æ‰¾æ–¹æ³•åˆ—è¡¨ã€‚è¿™é‡Œè·Ÿä¸Šä¸€æ­¥ä¸åŒçš„åœ°æ–¹åœ¨äºç¼“å­˜ç­–ç•¥ï¼Œæœ‰ä¸ª <code>_objc_msgForward_impcache</code> æ±‡ç¼–ç¨‹åºå…¥å£ä½œä¸ºç¼“å­˜ä¸­æ¶ˆæ¯è½¬å‘çš„æ ‡è®°ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº† IMPï¼Œä½†å¦‚æœå‘ç°å…¶å†…å®¹æ˜¯ <code>_objc_msgForward_impcache</code>ï¼Œé‚£å°±ç»ˆæ­¢åœ¨ç±»çš„ç»§æ‰¿å±‚çº§ä¸­é€’å½’æŸ¥æ‰¾ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼›å¦åˆ™è·³åˆ°ç¬¬ 7 æ­¥ã€‚</li>
<li>å½“ä¼ å…¥ <code>lookUpImpOrForward</code> çš„å‚æ•° <code>resolver</code> ä¸º <code>YES</code> å¹¶ä¸”æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥ç¬¬ 5 æ­¥æ—¶ï¼Œæ—¶è¿›å…¥åŠ¨æ€æ–¹æ³•è§£æï¼›å¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚è¿™æ­¥æ¶ˆæ¯è½¬å‘å‰çš„æœ€åä¸€æ¬¡æœºä¼šã€‚æ­¤æ—¶é‡Šæ”¾è¯»å…¥é”ï¼ˆ<code>runtimeLock.unlockRead()</code>ï¼‰ï¼Œæ¥ç€é—´æ¥åœ°å‘é€ <code>+resolveInstanceMethod</code> æˆ– <code>+resolveClassMethod</code> æ¶ˆæ¯ã€‚è¿™ç›¸å½“äºå‘Šè¯‰ç¨‹åºå‘˜ã€èµ¶ç´§ç”¨ Runtime ç»™ç±»é‡Œè¿™ä¸ª selector å¼„ä¸ªå¯¹åº”çš„ IMP å§ã€ï¼Œå› ä¸ºæ­¤æ—¶é”å·²ç» unlock äº†æ‰€ä»¥ä¸ä¼šç¼“å­˜ç»“æœï¼Œç”šè‡³è¿˜éœ€è¦è½¯æ€§åœ°å¤„ç†ç¼“å­˜è¿‡æœŸé—®é¢˜å¯èƒ½å¸¦æ¥çš„é”™è¯¯ã€‚è¿™é‡Œçš„ä¸šåŠ¡é€»è¾‘ç¨å¾®å¤æ‚äº›ï¼Œåé¢ä¼šæ€»ç»“ã€‚å› ä¸ºè¿™äº›å·¥ä½œéƒ½æ˜¯åœ¨éçº¿ç¨‹å®‰å…¨ä¸‹è¿›è¡Œçš„ï¼Œå®Œæˆåéœ€è¦å›åˆ°ç¬¬ 1 æ­¥å†æ¬¡æŸ¥æ‰¾ IMPã€‚</li>
<li>æ­¤æ—¶ä¸ä»…æ²¡æŸ¥æ‰¾åˆ° IMPï¼ŒåŠ¨æ€æ–¹æ³•è§£æä¹Ÿä¸å¥æ•ˆï¼Œåªèƒ½å°† <code>_objc_msgForward_impcache</code> å½“åš IMP å¹¶å†™å…¥ç¼“å­˜ã€‚è¿™ä¹Ÿå°±æ˜¯ä¹‹å‰ç¬¬ 4 æ­¥ä¸­ä¸ºä½•æŸ¥æ‰¾åˆ° <code>_objc_msgForward_impcache</code> å°±è¡¨æ˜äº†è¦è¿›å…¥æ¶ˆæ¯è½¬å‘äº†ã€‚</li>
<li>è¯»æ“ä½œè§£é”ï¼Œå¹¶å°†ä¹‹å‰æ‰¾åˆ°çš„ IMP è¿”å›ã€‚ï¼ˆæ— è®ºæ˜¯æ­£ç» IMP è¿˜æ˜¯ä¸æ­£ç»çš„ <code>_objc_msgForward_impcache</code>ï¼‰è¿™æ­¥è¿˜åæ‰§åœ°åšäº†ä¸€äº›è„‘æ´ç•¥å¤§çš„ assertï¼Œå¾ˆæœ‰è¶£ã€‚</li>
</ol>
<p>å¯¹äºç¬¬ 5 æ­¥ï¼Œå…¶å®æ˜¯ç›´æ¥è°ƒç”¨ <code>_class_resolveMethod</code> å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å®ç°äº†å¤æ‚çš„æ–¹æ³•è§£æé€»è¾‘ã€‚å¦‚æœ <code>cls</code> æ˜¯å…ƒç±»åˆ™ä¼šå‘é€  <code>+resolveClassMethod</code>ï¼Œç„¶åæ ¹æ® <code>lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)</code> å‡½æ•°çš„ç»“æœæ¥åˆ¤æ–­æ˜¯å¦å‘é€ <code>+resolveInstanceMethod</code>ï¼›å¦‚æœä¸æ˜¯å…ƒç±»ï¼Œåˆ™åªéœ€è¦å‘é€ <code>+resolveInstanceMethod</code> æ¶ˆæ¯ã€‚è¿™é‡Œè°ƒç”¨ <code>+resolveInstanceMethod</code> æˆ– <code>+resolveClassMethod</code> æ—¶å†æ¬¡ç”¨åˆ°äº† <code>objc_msgSend</code>ï¼Œè€Œä¸”ç¬¬ä¸‰ä¸ªå‚æ•°æ­£æ˜¯ä¼ å…¥ <code>lookUpImpOrForward</code> çš„é‚£ä¸ª <code>sel</code>ã€‚åœ¨å‘é€æ–¹æ³•è§£ææ¶ˆæ¯ä¹‹åè¿˜ä¼šè°ƒç”¨ <code>lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)</code> æ¥åˆ¤æ–­æ˜¯å¦å·²ç»æ·»åŠ ä¸Š <code>sel</code> å¯¹åº”çš„ IMP äº†ï¼Œæ‰“å°å‡ºç»“æœã€‚</p>
<p>æœ€å <code>lookUpImpOrForward</code> æ–¹æ³•ä¹Ÿä¼šæŠŠçœŸæ­£çš„ IMP æˆ–è€…éœ€è¦æ¶ˆæ¯è½¬å‘çš„ <code>_objc_msgForward_impcache</code> è¿”å›ï¼Œå¹¶æœ€ç»ˆä¸“é€’åˆ° <code>objc_msgSend</code> ä¸­ã€‚è€Œ <code>_objc_msgForward_impcache</code> ä¼šåœ¨è½¬åŒ–æˆ <code>_objc_msgForward</code> æˆ– <code>_objc_msgForward_stret</code>ã€‚è¿™ä¸ªåé¢ä¼šè®²è§£åŸç†ã€‚</p>
<h3 id="å›é¡¾-objc-msgSend-ä¼ªä»£ç "><a href="#å›é¡¾-objc-msgSend-ä¼ªä»£ç " class="headerlink" title="å›é¡¾ objc_msgSend ä¼ªä»£ç "></a>å›é¡¾ objc_msgSend ä¼ªä»£ç </h3><p>å›è¿‡å¤´æ¥ä¼šå‘ç° <code>objc_msgSend</code> çš„ä¼ªä»£ç æè¿°å¾—å¾ˆä¼ ç¥å•Šï¼Œå› ä¸º<code>class_getMethodImplementation</code> çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">IMP class_getMethodImplementation(Class cls, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp;</span><br><span class="line">    if (!cls  ||  !sel) return nil;</span><br><span class="line">    imp = lookUpImpOrNil(cls, sel, nil, YES/*initialize*/, YES/*cache*/, YES/*resolver*/);</span><br><span class="line">    // Translate forwarding function to C-callable external version</span><br><span class="line">    if (!imp) &#123;</span><br><span class="line">        return _objc_msgForward;</span><br><span class="line">    &#125;</span><br><span class="line">    return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>lookUpImpOrNil</code> å‡½æ•°è·å–ä¸åˆ° IMP æ—¶å°±è¿”å› <code>_objc_msgForward</code>ï¼Œåé¢ä¼šè®²åˆ°å®ƒã€‚<code>lookUpImpOrNil</code> è·Ÿ <code>lookUpImpOrForward</code> çš„åŠŸèƒ½å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯å°† <code>lookUpImpOrForward</code> å®ç°ä¸­çš„ <code>_objc_msgForward_impcache</code> æ›¿æ¢æˆäº† <code>nil</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IMP lookUpImpOrNil(Class cls, SEL sel, id inst, </span><br><span class="line">                   bool initialize, bool cache, bool resolver)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp = lookUpImpOrForward(cls, sel, inst, initialize, cache, resolver);</span><br><span class="line">    if (imp == _objc_msgForward_impcache) return nil;</span><br><span class="line">    else return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>lookUpImpOrNil</code> æ–¹æ³•å¯ä»¥æŸ¥æ‰¾åˆ° selector å¯¹åº”çš„ IMP æˆ–æ˜¯ <code>nil</code>ï¼Œæ‰€ä»¥å¦‚æœä¸è€ƒè™‘è¿”å›å€¼ç±»å‹ä¸ºç»“æ„ä½“çš„æƒ…å†µï¼Œç”¨é‚£å‡ è¡Œä¼ªä»£ç æ¥è¡¨ç¤ºå¤æ‚çš„æ±‡ç¼–å®ç°è¿˜æ˜¯æŒºæ°å½“çš„ã€‚</p>
<h2 id="forwarding-ä¸­è·¯æ¼«æ¼«çš„æ¶ˆæ¯è½¬å‘"><a href="#forwarding-ä¸­è·¯æ¼«æ¼«çš„æ¶ˆæ¯è½¬å‘" class="headerlink" title="forwarding ä¸­è·¯æ¼«æ¼«çš„æ¶ˆæ¯è½¬å‘"></a><strong>forwarding</strong> ä¸­è·¯æ¼«æ¼«çš„æ¶ˆæ¯è½¬å‘</h2><h3 id="objc-msgForward-impcache-çš„è½¬æ¢"><a href="#objc-msgForward-impcache-çš„è½¬æ¢" class="headerlink" title="objc_msgForward_impcache çš„è½¬æ¢"></a>objc_msgForward_impcache çš„è½¬æ¢</h3><p><code>_objc_msgForward_impcache</code> åªæ˜¯ä¸ªå†…éƒ¨çš„å‡½æ•°æŒ‡é’ˆï¼Œåªå­˜å‚¨äºä¸ŠèŠ‚æåˆ°çš„ç±»çš„æ–¹æ³•ç¼“å­˜ä¸­ï¼Œéœ€è¦è¢«è½¬åŒ–ä¸º <code>_objc_msgForward</code> å’Œ <code>_objc_msgForward_stret</code> æ‰èƒ½è¢«å¤–éƒ¨è°ƒç”¨ã€‚ä½†åœ¨ <del>Mac OS X</del> macOS 10.6 åŠæ›´æ—©ç‰ˆæœ¬çš„ libobjc.A.dylib ä¸­æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨çš„ï¼Œå†µä¸”æˆ‘ä»¬æ ¹æœ¬ä¸ä¼šç›´æ¥ç”¨åˆ°å®ƒã€‚å¸¦ <code>stret</code> åç¼€çš„å‡½æ•°ä¾æ—§æ˜¯è¿”å›å€¼ä¸ºç»“æ„ä½“çš„ç‰ˆæœ¬ã€‚</p>
<p>ä¸Šä¸€èŠ‚æœ€åè®²åˆ°å¦‚æœæ²¡æ‰¾åˆ° IMPï¼Œå°±ä¼šå°† <code>_objc_msgForward_impcache</code> è¿”å›åˆ° <code>objc_msgSend</code> å‡½æ•°ï¼Œè€Œæ­£æ˜¯å› ä¸ºå®ƒæ˜¯ç”¨æ±‡ç¼–è¯­è¨€å†™çš„ï¼Œæ‰€ä»¥å°†å†…éƒ¨ä½¿ç”¨çš„ <code>_objc_msgForward_impcache</code> è½¬åŒ–æˆå¤–éƒ¨å¯è°ƒç”¨çš„ <code>_objc_msgForward</code> æˆ– <code>_objc_msgForward_stret</code> ä¹Ÿæ˜¯ç”±æ±‡ç¼–ä»£ç æ¥å®Œæˆã€‚å®ç°åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å¢åŠ ä¸ªé™æ€å…¥å£ <code>__objc_msgForward_impcache</code>ï¼Œç„¶åæ ¹æ®æ­¤æ—¶ CPU çš„çŠ¶æ€å¯„å­˜å™¨çš„å†…å®¹æ¥å†³å®šè½¬æ¢æˆå“ªä¸ªã€‚å¦‚æœæ˜¯ <code>NE</code>(Not Equal) åˆ™è½¬æ¢æˆ <code>_objc_msgForward_stret</code>ï¼Œåä¹‹æ˜¯ <code>EQ</code>(Equal) åˆ™è½¬æ¢æˆ <code>_objc_msgForward</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jne	__objc_msgForward_stret</span><br><span class="line">jmp	__objc_msgForward</span><br></pre></td></tr></table></figure>
<p>ä¸ºä½•æ ¹æ®çŠ¶æ€å¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­è½¬æ¢æˆå“ªä¸ªå‡½æ•°æŒ‡é’ˆå‘¢ï¼Ÿå›è¿‡å¤´æ¥çœ‹çœ‹ <code>objc_msgSend</code> ä¸­è°ƒç”¨å®Œ <code>MethodTableLookup</code>ä¹‹åå¹²äº†ä»€ä¹ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MethodTableLookup %a1, %a2	// r11 = IMP</span><br><span class="line">cmp	%r11, %r11		// set eq (nonstret) for forwarding</span><br><span class="line">jmp	*%r11			// goto *imp</span><br></pre></td></tr></table></figure>
<p>å†çœ‹çœ‹è¿”å›å€¼ä¸ºç»“æ„ä½“çš„ <code>objc_msgSend_stret</code> è¿™é‡Œçš„é€»è¾‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MethodTableLookup %a2, %a3	// r11 = IMP</span><br><span class="line">test	%r11, %r11		// set ne (stret) for forward; r11!=0</span><br><span class="line">jmp	*%r11			// goto *imp</span><br></pre></td></tr></table></figure>
<p>ç¨å¾®æ‡‚æ±‡ç¼–çš„äººä¸€çœ¼å°±çœ‹æ˜ç™½äº†ï¼Œä¸æ‡‚çš„çœ‹æ³¨é‡Šä¹Ÿæ‡‚äº†ï¼Œæˆ‘å°±ä¸å¢¨è¿¹äº†ã€‚ç°åœ¨æ€»ç®—æ˜¯æŠŠæ¶ˆæ¯è½¬å‘å‰çš„é€»è¾‘ç»•å›æ¥æ„æˆé—­ç¯äº†ã€‚</p>
<p>ä¸Šä¸€èŠ‚ä¸­æåˆ° <code>class_getMethodImplementation</code> å‡½æ•°çš„å®ç°ï¼Œåœ¨æŸ¥æ‰¾ä¸åˆ° IMP æ—¶è¿”å› <code>_objc_msgForward</code>ï¼Œè€Œ <code>_objc_msgForward_stret</code> æ­£å¥½å¯¹åº”ç€ <code>class_getMethodImplementation_stret</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IMP class_getMethodImplementation_stret(Class cls, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp = class_getMethodImplementation(cls, sel);</span><br><span class="line">    // Translate forwarding function to struct-returning version</span><br><span class="line">    if (imp == (IMP)&amp;_objc_msgForward /* not _internal! */) &#123;</span><br><span class="line">        return (IMP)&amp;_objc_msgForward_stret;</span><br><span class="line">    &#125;</span><br><span class="line">    return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ <code>_objc_msgForward*</code> ç³»åˆ—æœ¬è´¨éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œéƒ½ç”¨æ±‡ç¼–è¯­è¨€å®ç°ï¼Œéƒ½å¯ä»¥ä¸ IMP ç±»å‹çš„å€¼ä½œæ¯”è¾ƒã€‚<code>_objc_msgForward</code> å’Œ <code>_objc_msgForward_stret</code> å£°æ˜åœ¨ <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/message.h" target="_blank" rel="noopener">message.h</a> æ–‡ä»¶ä¸­ã€‚<code>_objc_msgForward_impcache</code> åœ¨æ—©æœŸç‰ˆæœ¬çš„ Runtime ä¸­å«åš <code>_objc_msgForward_internal</code>ã€‚</p>
<h3 id="objc-msgForward-ä¹Ÿåªæ˜¯ä¸ªå…¥å£"><a href="#objc-msgForward-ä¹Ÿåªæ˜¯ä¸ªå…¥å£" class="headerlink" title="objc_msgForward ä¹Ÿåªæ˜¯ä¸ªå…¥å£"></a>objc_msgForward ä¹Ÿåªæ˜¯ä¸ªå…¥å£</h3><p>ä»æ±‡ç¼–æºç å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡º <strong>_objc_msgForward å’Œ _objc_msgForward_stret ä¼šåˆ†åˆ«è°ƒç”¨ _objc_forward_handler å’Œ _objc_forward_handler_stret</strong>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ENTRY	__objc_msgForward</span><br><span class="line">// Non-stret version</span><br><span class="line"></span><br><span class="line">movq	__objc_forward_handler(%rip), %r11</span><br><span class="line">jmp	*%r11</span><br><span class="line"></span><br><span class="line">END_ENTRY	__objc_msgForward</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ENTRY	__objc_msgForward_stret</span><br><span class="line">// Struct-return version</span><br><span class="line"></span><br><span class="line">movq	__objc_forward_stret_handler(%rip), %r11</span><br><span class="line">jmp	*%r11</span><br><span class="line"></span><br><span class="line">END_ENTRY	__objc_msgForward_stret</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ª handler å‡½æ•°çš„åŒºåˆ«ä»å­—é¢ä¸Šå°±èƒ½çœ‹å‡ºæ¥ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆæ¯è½¬å‘è¿‡ç¨‹æ˜¯ç°å°† <code>_objc_msgForward_impcache</code> å¼ºè½¬æˆ <code>_objc_msgForward</code> æˆ– <code>_objc_msgForward_stret</code>ï¼Œå†åˆ†åˆ«è°ƒç”¨ <code>_objc_forward_handler</code> æˆ– <code>_objc_forward_handler_stret</code>ã€‚</p>
<h3 id="objc-setForwardHandler-è®¾ç½®äº†æ¶ˆæ¯è½¬å‘çš„å›è°ƒ"><a href="#objc-setForwardHandler-è®¾ç½®äº†æ¶ˆæ¯è½¬å‘çš„å›è°ƒ" class="headerlink" title="objc_setForwardHandler è®¾ç½®äº†æ¶ˆæ¯è½¬å‘çš„å›è°ƒ"></a>objc_setForwardHandler è®¾ç½®äº†æ¶ˆæ¯è½¬å‘çš„å›è°ƒ</h3><p>åœ¨ Objective-C 2.0 ä¹‹å‰ï¼Œé»˜è®¤çš„ <code>_objc_forward_handler</code> æˆ– <code>_objc_forward_handler_stret</code> éƒ½æ˜¯ <code>nil</code>ï¼Œè€Œæ–°ç‰ˆæœ¬çš„é»˜è®¤å®ç°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Default forward handler halts the process.</span><br><span class="line">__attribute__((noreturn)) void </span><br><span class="line">objc_defaultForwardHandler(id self, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot;</span><br><span class="line">                &quot;(no message forward handler is installed)&quot;, </span><br><span class="line">                class_isMetaClass(object_getClass(self)) ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                object_getClassName(self), sel_getName(sel), self);</span><br><span class="line">&#125;</span><br><span class="line">void *_objc_forward_handler = (void*)objc_defaultForwardHandler;</span><br><span class="line"></span><br><span class="line">#if SUPPORT_STRET</span><br><span class="line">struct stret &#123; int i[100]; &#125;;</span><br><span class="line">__attribute__((noreturn)) struct stret </span><br><span class="line">objc_defaultForwardStretHandler(id self, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    objc_defaultForwardHandler(self, sel);</span><br><span class="line">&#125;</span><br><span class="line">void *_objc_forward_stret_handler = (void*)objc_defaultForwardStretHandler;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p><code>objc_defaultForwardHandler</code> ä¸­çš„ <code>_objc_fatal</code> ä½œç”¨å°±æ˜¯æ‰“æ—¥å¿—å¹¶è°ƒç”¨ <code>__builtin_trap()</code> è§¦å‘ crashï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„é‚£å¥ â€œunrecognized selector sent to instanceâ€ æ—¥å¿—ã€‚<code>__builtin_trap()</code> åœ¨æ€æ‰è¿›ç¨‹çš„åŒæ—¶è¿˜èƒ½ç”Ÿæˆæ—¥å¿—ï¼Œæ¯”è°ƒç”¨ <code>exit()</code> æ›´å¥½ã€‚<code>objc_defaultForwardStretHandler</code> å°±æ˜¯è£…æ¨¡ä½œæ ·æä¸ªå½¢å¼ä¸»ä¹‰ï¼ŒæŠŠ <code>objc_defaultForwardHandler</code> åŒ…äº†ä¸€å±‚ã€‚<code>__attribute__((noreturn))</code> å±æ€§é€šçŸ¥ç¼–è¯‘å™¨å‡½æ•°ä»ä¸è¿”å›å€¼ï¼Œå½“é‡åˆ°ç±»ä¼¼å‡½æ•°éœ€è¦è¿”å›å€¼è€Œå´ä¸å¯èƒ½è¿è¡Œåˆ°è¿”å›å€¼å¤„å°±å·²ç»é€€å‡ºæ¥çš„æƒ…å†µï¼Œè¯¥å±æ€§å¯ä»¥é¿å…å‡ºç°é”™è¯¯ä¿¡æ¯ã€‚è¿™é‡Œæ­£é€‚åˆæ­¤å±æ€§ï¼Œå› ä¸ºè¦æ±‚è¿”å›ç»“æ„ä½“å“’ã€‚</p>
<p>å› ä¸ºé»˜è®¤çš„ Handler å¹²çš„äº‹å„¿å°±æ˜¯æ‰“æ—¥å¿—è§¦å‘ crashï¼Œæˆ‘ä»¬æƒ³è¦å®ç°æ¶ˆæ¯è½¬å‘ï¼Œå°±éœ€è¦æ›¿æ¢æ‰ Handler å¹¶èµ‹å€¼ç»™ <code>_objc_forward_handler</code> æˆ– <code>_objc_forward_handler_stret</code>ï¼Œèµ‹å€¼çš„è¿‡ç¨‹å°±éœ€è¦ç”¨åˆ° <code>objc_setForwardHandler</code>å‡½æ•°ï¼Œå®ç°ä¹Ÿæ˜¯ç®€å•ç²—æš´ï¼Œå°±æ˜¯èµ‹å€¼å•Šï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void objc_setForwardHandler(void *fwd, void *fwd_stret)</span><br><span class="line">&#123;</span><br><span class="line">    _objc_forward_handler = fwd;</span><br><span class="line">#if SUPPORT_STRET</span><br><span class="line">    _objc_forward_stret_handler = fwd_stret;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é€†å‘å·¥ç¨‹åŠ©åŠ›åˆ¨æ ¹é—®åº•"><a href="#é€†å‘å·¥ç¨‹åŠ©åŠ›åˆ¨æ ¹é—®åº•" class="headerlink" title="é€†å‘å·¥ç¨‹åŠ©åŠ›åˆ¨æ ¹é—®åº•"></a>é€†å‘å·¥ç¨‹åŠ©åŠ›åˆ¨æ ¹é—®åº•</h3><p>é‡å¤´æˆåœ¨äºå¯¹ <code>objc_setForwardHandler</code> çš„è°ƒç”¨ï¼Œä»¥åŠä¹‹åçš„æ¶ˆæ¯è½¬å‘è°ƒç”¨æ ˆã€‚è¿™å›ä¸æ˜¯åœ¨ Objective-C Runtime ï¼ˆlibobjc.dylibï¼‰ä¸­å•¦ï¼Œè€Œæ˜¯åœ¨ Core Foundationï¼ˆCoreFoundation.frameworkï¼‰ä¸­ã€‚è™½ç„¶ CF æ˜¯å¼€æºçš„ï¼Œä½†æœ‰æ„æ€çš„æ˜¯è‹¹æœæ•…æ„åœ¨å¼€æºçš„ä»£ç ä¸­åˆ é™¤äº†åœ¨ <a href="https://github.com/opensource-apple/CF/blob/master/CFRuntime.c" target="_blank" rel="noopener">CFRuntime.c</a> æ–‡ä»¶ <code>__CFInitialize()</code> ä¸­è°ƒç”¨ <code>objc_setForwardHandler</code> çš„ä»£ç ã€‚<code>__CFInitialize()</code> å‡½æ•°æ˜¯åœ¨ CF runtime è¿æ¥åˆ°è¿›ç¨‹æ—¶åˆå§‹åŒ–è°ƒç”¨çš„ã€‚ä»åç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–ä»£ç ä¸­å¯ä»¥å¾ˆå®¹æ˜“è·Ÿ C æºç å¯¹æ¯”å‡ºæ¥ï¼Œæˆ‘ç”¨çº¢è‰²æ ‡å‡ºäº†åŒä¸€æ®µä»£ç çš„å·®å¼‚ã€‚</p>
<p>æ±‡ç¼–è¯­è¨€è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œçº¢è‰²æ ‡å‡ºçš„é‚£ä¸‰ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠ <code>__CF_forwarding_prep_0</code> å’Œ <code>___forwarding_prep_1___</code>ä½œä¸ºå‚æ•°è°ƒç”¨ <code>objc_setForwardHandler</code> æ–¹æ³•ï¼ˆé‚£ä¹ˆä¹‹å‰é‚£ä¸¤ä¸ª DefaultHandler åµç”¨éƒ½æ²¡æœ‰å’¯ï¼Œåæ­£ä¸å‡ºæ„å¤–ä¼šè¢« CF æ›¿æ¢æ‰ï¼‰ï¼š</p>
<p><a href="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/QQ20160614-1@2x.png" target="_blank" rel="noopener"><img src="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/QQ20160614-1@2x.png" alt="åç¼–è¯‘åçš„ __CFInitialize() æ±‡ç¼–ä»£ç "></a>åç¼–è¯‘åçš„ __CFInitialize() æ±‡ç¼–ä»£ç </p>
<p>ç„¶è€Œåœ¨æºç ä¸­å¯¹åº”çš„ä»£ç å´è¢«åˆ æ‰å•¦ï¼š</p>
<p><a href="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/QQ20160614-2@2x.png" target="_blank" rel="noopener"><img src="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/QQ20160614-2@2x.png" alt="è‹¹æœæä¾›çš„ __CFInitialize() å‡½æ•°æºç "></a>è‹¹æœæä¾›çš„ __CFInitialize() å‡½æ•°æºç </p>
<p>åœ¨æ—©æœŸç‰ˆæœ¬çš„ CF æºç ä¸­ï¼Œè¿˜æ˜¯å¯ä»¥çœ‹åˆ° <code>__CF_forwarding_prep_0</code> å’Œ <code>___forwarding_prep_1___</code> çš„å£°æ˜çš„ï¼Œä½†æ˜¯ä¸ä¼šæœ‰å®ç°æºç ï¼Œä¹Ÿæ²¡æœ‰å¯¹ <code>objc_setForwardHandler</code> çš„è°ƒç”¨ã€‚è¿™äº›ç»†èŠ‚ä»å‡½æ•°è°ƒç”¨æ ˆä¸­æ— æ³•çœ‹å‡ºï¼Œåªèƒ½é€†å‘å·¥ç¨‹çœ‹æ±‡ç¼–æŒ‡ä»¤ã€‚ä½†ä»å‡½æ•°è°ƒç”¨æ ˆå¯ä»¥çœ‹å‡º <code>__CF_forwarding_prep_0</code> å’Œ <code>___forwarding_prep_1___</code> è¿™ä¸¤ä¸ª Forward Handler åšäº†å•¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2016-06-14 12:50:15.385 MessageForward[67364:7174239] -[MFObject sendMessage]: unrecognized selector sent to instance 0x1006001a0</span><br><span class="line">2016-06-14 12:50:15.387 MessageForward[67364:7174239] *** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;-[MFObject sendMessage]: unrecognized selector sent to instance 0x1006001a0&apos;</span><br><span class="line">*** First throw call stack:</span><br><span class="line">(</span><br><span class="line">	0   CoreFoundation                      0x00007fff8fa554f2 __exceptionPreprocess + 178</span><br><span class="line">	1   libobjc.A.dylib                     0x00007fff98396f7e objc_exception_throw + 48</span><br><span class="line">	2   CoreFoundation                      0x00007fff8fabf1ad -[NSObject(NSObject) doesNotRecognizeSelector:] + 205</span><br><span class="line">	3   CoreFoundation                      0x00007fff8f9c5571 ___forwarding___ + 1009</span><br><span class="line">	4   CoreFoundation                      0x00007fff8f9c50f8 _CF_forwarding_prep_0 + 120</span><br><span class="line">	5   MessageForward                      0x0000000100000f1f main + 79</span><br><span class="line">	6   libdyld.dylib                       0x00007fff8bc2c5ad start + 1</span><br><span class="line">	7   ???                                 0x0000000000000001 0x0 + 1</span><br><span class="line">)</span><br><span class="line">libc++abi.dylib: terminating with uncaught exception of type NSException</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¥å¿—åœºæ™¯ç†Ÿæ‚‰å¾—ä¸èƒ½å†ç†Ÿæ‚‰äº†ï¼Œå¯ä»¥çœ‹å‡º <code>_CF_forwarding_prep_0</code> å‡½æ•°è°ƒç”¨äº† <code>___forwarding___</code> å‡½æ•°ï¼Œæ¥ç€åˆè°ƒç”¨äº† <code>doesNotRecognizeSelector</code> æ–¹æ³•ï¼Œæœ€åæŠ›å‡ºå¼‚å¸¸ã€‚<strong>ä½†æ˜¯é è¿™äº›æ˜¯æ— æ³•è¯´æœçœ‹å®¢çš„ï¼Œè¿˜å¾—é é€†å‘å·¥ç¨‹åç¼–è¯‘åå†åæ±‡ç¼–æˆä¼ªä»£ç æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œåˆ¨æ ¹é—®åº•ã€‚</strong></p>
<p><code>__CF_forwarding_prep_0</code> å’Œ <code>___forwarding_prep_1___</code> å‡½æ•°éƒ½è°ƒç”¨äº† <code>___forwarding___</code>ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸åŒã€‚<code>___forwarding___</code> æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå°†è¦è¢«è½¬å‘æ¶ˆæ¯çš„æ ˆæŒ‡é’ˆï¼ˆå¯ä»¥ç®€å•ç†è§£æˆ IMPï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ ‡è®°æ˜¯å¦è¿”å›ç»“æ„ä½“ã€‚<code>__CF_forwarding_prep_0</code> ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ <code>0</code>ï¼Œ<code>___forwarding_prep_1___</code> ä¼ å…¥çš„æ˜¯ <code>1</code>ï¼Œä»å‡½æ•°åéƒ½èƒ½çœ‹å¾—å‡ºæ¥ã€‚ä¸‹é¢æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°çš„ä¼ªä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int __CF_forwarding_prep_0(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) &#123;</span><br><span class="line">    rax = ____forwarding___(rsp, 0x0);</span><br><span class="line">    if (rax != 0x0) &#123; // è½¬å‘ç»“æœä¸ä¸ºç©ºï¼Œå°†å†…å®¹è¿”å›</span><br><span class="line">            rax = *rax;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123; // è½¬å‘ç»“æœä¸ºç©ºï¼Œè°ƒç”¨ objc_msgSend(id self, SEL _cmd,...);</span><br><span class="line">            rsi = *(rsp + 0x8);</span><br><span class="line">            rdi = *rsp;</span><br><span class="line">            rax = objc_msgSend(rdi, rsi);</span><br><span class="line">    &#125;</span><br><span class="line">    return rax;</span><br><span class="line">&#125;</span><br><span class="line">int ___forwarding_prep_1___(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) &#123;</span><br><span class="line">    rax = ____forwarding___(rsp, 0x1);</span><br><span class="line">    if (rax != 0x0) &#123;// è½¬å‘ç»“æœä¸ä¸ºç©ºï¼Œå°†å†…å®¹è¿”å›</span><br><span class="line">            rax = *rax;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;// è½¬å‘ç»“æœä¸ºç©ºï¼Œè°ƒç”¨ objc_msgSend_stret(void * st_addr, id self, SEL _cmd, ...);</span><br><span class="line">            rdx = *(rsp + 0x10);</span><br><span class="line">            rsi = *(rsp + 0x8);</span><br><span class="line">            rdi = *rsp;</span><br><span class="line">            rax = objc_msgSend_stret(rdi, rsi, rdx);</span><br><span class="line">    &#125;</span><br><span class="line">    return rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>x86_64</code> æ¶æ„ä¸­ï¼Œ<code>rax</code> å¯„å­˜å™¨ä¸€èˆ¬æ˜¯ä½œä¸ºè¿”å›å€¼ï¼Œ<code>rsp</code> å¯„å­˜å™¨æ˜¯æ ˆæŒ‡é’ˆã€‚åœ¨è°ƒç”¨ <code>objc_msgSend</code> å‡½æ•°æ—¶ï¼Œå‚æ•° <code>arg0(self), arg1(_cmd), arg2, arg3, arg4, arg5</code> åˆ†åˆ«ä½¿ç”¨å¯„å­˜å™¨ <code>rdi, rsi, rdx, rcx, r8, r9</code> çš„å€¼ã€‚åœ¨è°ƒç”¨ <code>objc_msgSend_stret</code> æ—¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸º <code>st_addr</code>ï¼Œå…¶ä½™å‚æ•°ä¾æ¬¡åç§»ã€‚ä¸ºäº†èƒ½å¤Ÿæ‰“åŒ…å‡º <code>NSInvocation</code> å®ä¾‹å¹¶ä¼ å…¥åç»­çš„ <code>forwardInvocation:</code> æ–¹æ³•ï¼Œåœ¨è°ƒç”¨ <code>___forwarding___</code> å‡½æ•°ä¹‹å‰ä¼šå…ˆå°†æ‰€æœ‰å‚æ•°å‹å…¥æ ˆä¸­ã€‚å› ä¸ºå¯„å­˜å™¨ <code>rsp</code>ä¸ºæ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œæ‰€ä»¥ <code>rsp</code> çš„å†…å®¹å°±æ˜¯ <code>self</code> å•¦ï¼Œå› ä¸º <code>x86_64</code> æ˜¯å°ç«¯ï¼Œæ ˆå¢é•¿æ–¹å‘æ˜¯ç”±é«˜åœ°å€åˆ°ä½åœ°å€ï¼Œæ‰€ä»¥ä»æ ˆé¡¶å¾€ä¸‹ç§»åŠ¨ä¸€ä¸ªæŒ‡é’ˆéœ€è¦<strong>åŠ </strong> <code>0x8ï¼ˆ64bitï¼‰</code>ã€‚è€Œå°†å‚æ•°å…¥æ ˆçš„é¡ºåºæ˜¯ä»åå¾€å‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>arg0</code> æ˜¯æœ€åä¸€ä¸ªå…¥æ ˆçš„ï¼Œä½äºæ ˆé¡¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> __CF_forwarding_prep_0:</span><br><span class="line">0000000000085080         push       rbp                                         ; XREF=___CFInitialize+138</span><br><span class="line">0000000000085081         mov        rbp, rsp</span><br><span class="line">0000000000085084         sub        rsp, 0xd0</span><br><span class="line">000000000008508b         mov        qword [ss:rsp+0xb0], rax</span><br><span class="line">0000000000085093         movq       qword [ss:rsp+0xa0], xmm7</span><br><span class="line">000000000008509c         movq       qword [ss:rsp+0x90], xmm6</span><br><span class="line">00000000000850a5         movq       qword [ss:rsp+0x80], xmm5</span><br><span class="line">00000000000850ae         movq       qword [ss:rsp+0x70], xmm4</span><br><span class="line">00000000000850b4         movq       qword [ss:rsp+0x60], xmm3</span><br><span class="line">00000000000850ba         movq       qword [ss:rsp+0x50], xmm2</span><br><span class="line">00000000000850c0         movq       qword [ss:rsp+0x40], xmm1</span><br><span class="line">00000000000850c6         movq       qword [ss:rsp+0x30], xmm0</span><br><span class="line">00000000000850cc         mov        qword [ss:rsp+0x28], r9</span><br><span class="line">00000000000850d1         mov        qword [ss:rsp+0x20], r8</span><br><span class="line">00000000000850d6         mov        qword [ss:rsp+0x18], rcx</span><br><span class="line">00000000000850db         mov        qword [ss:rsp+0x10], rdx</span><br><span class="line">00000000000850e0         mov        qword [ss:rsp+0x8], rsi</span><br><span class="line">00000000000850e5         mov        qword [ss:rsp], rdi</span><br><span class="line">00000000000850e9         mov        rdi, rsp                                    ; argument #1 for method ____forwarding___</span><br><span class="line">00000000000850ec         mov        rsi, 0x0                                    ; argument #2 for method ____forwarding___</span><br><span class="line">00000000000850f3         call       ____forwarding___</span><br></pre></td></tr></table></figure>
<p>æ¶ˆæ¯è½¬å‘çš„é€»è¾‘å‡ ä¹éƒ½å†™åœ¨ <code>___forwarding___</code> å‡½æ•°ä¸­äº†ï¼Œå®ç°æ¯”è¾ƒå¤æ‚ï¼Œåç¼–è¯‘å‡ºçš„ä¼ªä»£ç ä¹Ÿä¸æ˜¯å¾ˆç›´è§‚ã€‚æˆ‘å¯¹ <a href="http://arigrant.com/blog/2013/12/13/a-selector-left-unhandled" target="_blank" rel="noopener">arigrant.com</a> çš„ç»“æœå®Œå–„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">int __forwarding__(void *frameStackPointer, int isStret) &#123;</span><br><span class="line">  id receiver = *(id *)frameStackPointer;</span><br><span class="line">  SEL sel = *(SEL *)(frameStackPointer + 8);</span><br><span class="line">  const char *selName = sel_getName(sel);</span><br><span class="line">  Class receiverClass = object_getClass(receiver);</span><br><span class="line"></span><br><span class="line">  // è°ƒç”¨ forwardingTargetForSelector:</span><br><span class="line">  if (class_respondsToSelector(receiverClass, @selector(forwardingTargetForSelector:))) &#123;</span><br><span class="line">    id forwardingTarget = [receiver forwardingTargetForSelector:sel];</span><br><span class="line">    if (forwardingTarget &amp;&amp; forwarding != receiver) &#123;</span><br><span class="line">    	if (isStret == 1) &#123;</span><br><span class="line">    		int ret;</span><br><span class="line">    		objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</span><br><span class="line">    		return ret;</span><br><span class="line">    	&#125;</span><br><span class="line">      return objc_msgSend(forwardingTarget, sel, ...);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // åƒµå°¸å¯¹è±¡</span><br><span class="line">  const char *className = class_getName(receiverClass);</span><br><span class="line">  const char *zombiePrefix = &quot;_NSZombie_&quot;;</span><br><span class="line">  size_t prefixLen = strlen(zombiePrefix); // 0xa</span><br><span class="line">  if (strncmp(className, zombiePrefix, prefixLen) == 0) &#123;</span><br><span class="line">    CFLog(kCFLogLevelError,</span><br><span class="line">          @&quot;*** -[%s %s]: message sent to deallocated instance %p&quot;,</span><br><span class="line">          className + prefixLen,</span><br><span class="line">          selName,</span><br><span class="line">          receiver);</span><br><span class="line">    &lt;breakpoint-interrupt&gt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // è°ƒç”¨ methodSignatureForSelector è·å–æ–¹æ³•ç­¾ååå†è°ƒç”¨ forwardInvocation</span><br><span class="line">  if (class_respondsToSelector(receiverClass, @selector(methodSignatureForSelector:))) &#123;</span><br><span class="line">    NSMethodSignature *methodSignature = [receiver methodSignatureForSelector:sel];</span><br><span class="line">    if (methodSignature) &#123;</span><br><span class="line">      BOOL signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</span><br><span class="line">      if (signatureIsStret != isStret) &#123;</span><br><span class="line">        CFLog(kCFLogLevelWarning ,</span><br><span class="line">              @&quot;*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of &apos;%s&apos;.  Signature thinks it does%s return a struct, and compiler thinks it does%s.&quot;,</span><br><span class="line">              selName,</span><br><span class="line">              signatureIsStret ? &quot;&quot; : not,</span><br><span class="line">              isStret ? &quot;&quot; : not);</span><br><span class="line">      &#125;</span><br><span class="line">      if (class_respondsToSelector(receiverClass, @selector(forwardInvocation:))) &#123;</span><br><span class="line">        NSInvocation *invocation = [NSInvocation _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</span><br><span class="line"></span><br><span class="line">        [receiver forwardInvocation:invocation];</span><br><span class="line"></span><br><span class="line">        void *returnValue = NULL;</span><br><span class="line">        [invocation getReturnValue:&amp;value];</span><br><span class="line">        return returnValue;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        CFLog(kCFLogLevelWarning ,</span><br><span class="line">              @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement forwardInvocation: -- dropping message&quot;,</span><br><span class="line">              receiver,</span><br><span class="line">              className);</span><br><span class="line">        return 0;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SEL *registeredSel = sel_getUid(selName);</span><br><span class="line"></span><br><span class="line">  // selector æ˜¯å¦å·²ç»åœ¨ Runtime æ³¨å†Œè¿‡</span><br><span class="line">  if (sel != registeredSel) &#123;</span><br><span class="line">    CFLog(kCFLogLevelWarning ,</span><br><span class="line">          @&quot;*** NSForwarding: warning: selector (%p) for message &apos;%s&apos; does not match selector known to Objective C runtime (%p)-- abort&quot;,</span><br><span class="line">          sel,</span><br><span class="line">          selName,</span><br><span class="line">          registeredSel);</span><br><span class="line">  &#125; // doesNotRecognizeSelector</span><br><span class="line">  else if (class_respondsToSelector(receiverClass,@selector(doesNotRecognizeSelector:))) &#123;</span><br><span class="line">    [receiver doesNotRecognizeSelector:sel];</span><br><span class="line">  &#125; </span><br><span class="line">  else &#123;</span><br><span class="line">    CFLog(kCFLogLevelWarning ,</span><br><span class="line">          @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement doesNotRecognizeSelector: -- abort&quot;,</span><br><span class="line">          receiver,</span><br><span class="line">          className);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // The point of no return.</span><br><span class="line">  kill(getpid(), 9);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹ˆä¸€å¤§å¨ä»£ç å°±æ˜¯æ•´ä¸ªæ¶ˆæ¯è½¬å‘è·¯å¾„çš„é€»è¾‘ï¼Œæ¦‚æ‹¬å¦‚ä¸‹ï¼š</p>
<ol>
<li>å…ˆè°ƒç”¨ <code>forwardingTargetForSelector</code> æ–¹æ³•è·å–æ–°çš„ target ä½œä¸º receiver é‡æ–°æ‰§è¡Œ selectorï¼Œå¦‚æœè¿”å›çš„å†…å®¹ä¸åˆæ³•ï¼ˆä¸º <code>nil</code> æˆ–è€…è·Ÿæ—§ receiver ä¸€æ ·ï¼‰ï¼Œé‚£å°±è¿›å…¥ç¬¬äºŒæ­¥ã€‚</li>
<li>è°ƒç”¨ <code>methodSignatureForSelector</code> è·å–æ–¹æ³•ç­¾ååï¼Œåˆ¤æ–­è¿”å›ç±»å‹ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œå†è°ƒç”¨ <code>forwardInvocation</code>æ‰§è¡Œ <code>NSInvocation</code> å¯¹è±¡ï¼Œå¹¶å°†ç»“æœè¿”å›ã€‚å¦‚æœå¯¹è±¡æ²¡å®ç° <code>methodSignatureForSelector</code> æ–¹æ³•ï¼Œè¿›å…¥ç¬¬ä¸‰æ­¥ã€‚</li>
<li>è°ƒç”¨ <code>doesNotRecognizeSelector</code> æ–¹æ³•ã€‚</li>
</ol>
<p><code>doesNotRecognizeSelector</code> ä¹‹å‰å…¶å®è¿˜æœ‰ä¸ªåˆ¤æ–­ selector åœ¨ Runtime ä¸­æ˜¯å¦æ³¨å†Œè¿‡çš„é€»è¾‘ï¼Œä½†åœ¨æˆ‘ä»¬æ­£å¸¸å‘æ¶ˆæ¯çš„æ—¶å€™ä¸ä¼šå‡ºæ­¤é—®é¢˜ã€‚ä½†å¦‚æœæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª <code>NSInvocation</code> å¯¹è±¡å¹¶è°ƒç”¨ <code>invoke</code>ï¼Œå¹¶å°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®æˆä¸€ä¸ªä¸å­˜åœ¨çš„ selectorï¼Œé‚£å°±ä¼šå¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œå¹¶è¾“å…¥æ—¥å¿— â€œdoes not match selector known to Objective C runtimeâ€ã€‚è¾ƒçœŸå„¿çš„è¯»è€…å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šä½•è¿™æ®µé€»è¾‘åˆ¤æ–­å¹²è„†ç”¨ä¸åˆ°å´è¿˜å­˜åœ¨ç€ï¼Ÿéš¾é“é™¤äº† <code>__CF_forwarding_prep_0</code> å’Œ <code>___forwarding_prep_1___</code> å‡½æ•°è¿˜æœ‰å…¶ä»–å‡½æ•°ä¹Ÿè°ƒç”¨ <code>___forwarding___</code> ä¹ˆï¼Ÿè«éæ¶ˆæ¯è½¬å‘è¿˜æœ‰å…¶ä»–è·¯å¾„ï¼Ÿå…¶å®å¹¶ä¸æ˜¯ï¼åŸå› æ˜¯ <code>___forwarding___</code> è°ƒç”¨äº† <code>___invoking___</code> å‡½æ•°ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¼ªä»£ç ç›´æ¥æŠŠ <code>___invoking___</code> å‡½æ•°çš„é€»è¾‘ä¹Ÿã€ç¿»è¯‘ã€è¿‡æ¥äº†ã€‚é™¤äº† <code>___forwarding___</code> å‡½æ•°ï¼Œä»¥ä¸‹æ–¹æ³•ä¹Ÿä¼šè°ƒç”¨<code>___invoking___</code> å‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-[NSInvocation invoke]</span><br><span class="line">-[NSInvocation invokeUsingIMP:]</span><br><span class="line">-[NSInvocation invokeSuper]</span><br></pre></td></tr></table></figure>
<p><code>doesNotRecognizeSelector</code> æ–¹æ³•å…¶å®åœ¨ libobj.A.dylib ä¸­å·²ç»åºŸå¼ƒäº†ï¼Œè€Œæ˜¯åœ¨ CF æ¡†æ¶ä¸­å®ç°ï¼Œè€Œä¸”ä¹Ÿä¸æ˜¯å¼€æºçš„ã€‚ä»å‡½æ•°è°ƒç”¨æ ˆå¯ä»¥å‘ç° <code>doesNotRecognizeSelector</code> ä¹‹åä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ Runtime ä¸­åºŸå¼ƒçš„å®ç°åªæ˜¯æ‰“æ—¥å¿—åç›´æ¥æ€æ‰è¿›ç¨‹ï¼ˆ<code>__builtin_trap()</code>ï¼‰ã€‚ä¸‹é¢æ˜¯ CF ä¸­å®ç°çš„ä¼ªä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void -[NSObject doesNotRecognizeSelector:](void * self, void * _cmd, void * arg2) &#123;</span><br><span class="line">    r14 = ___CFFullMethodName([self class], self, arg2);</span><br><span class="line">    _CFLog(0x3, @&quot;%@: unrecognized selector sent to instance %p&quot;, r14, self, r8, r9, stack[2048]);</span><br><span class="line">    rbx = _CFMakeCollectable(_CFStringCreateWithFormat(___kCFAllocatorSystemDefault, 0x0, @&quot;%@: unrecognized selector sent to instance %p&quot;));</span><br><span class="line">    if (*(int8_t *)___CFOASafe != 0x0) &#123;</span><br><span class="line">            ___CFRecordAllocationEvent();</span><br><span class="line">    &#125;</span><br><span class="line">    rax = _objc_rootAutorelease(rbx);</span><br><span class="line">    rax = [NSException exceptionWithName:@&quot;NSInvalidArgumentException&quot; reason:rax userInfo:0x0];</span><br><span class="line">    objc_exception_throw(rax);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line">void +[NSObject doesNotRecognizeSelector:](void * self, void * _cmd, void * arg2) &#123;</span><br><span class="line">    r14 = ___CFFullMethodName([self class], self, arg2);</span><br><span class="line">    _CFLog(0x3, @&quot;%@: unrecognized selector sent to class %p&quot;, r14, self, r8, r9, stack[2048]);</span><br><span class="line">    rbx = _CFMakeCollectable(_CFStringCreateWithFormat(___kCFAllocatorSystemDefault, 0x0, @&quot;%@: unrecognized selector sent to class %p&quot;));</span><br><span class="line">    if (*(int8_t *)___CFOASafe != 0x0) &#123;</span><br><span class="line">            ___CFRecordAllocationEvent();</span><br><span class="line">    &#125;</span><br><span class="line">    rax = _objc_rootAutorelease(rbx);</span><br><span class="line">    rax = [NSException exceptionWithName:@&quot;NSInvalidArgumentException&quot; reason:rax userInfo:0x0];</span><br><span class="line">    objc_exception_throw(rax);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ override <code>doesNotRecognizeSelector</code> æˆ–è€…æ•è·å…¶æŠ›å‡ºçš„å¼‚å¸¸ã€‚åœ¨è¿™é‡Œè¿˜æ˜¯å¤§æœ‰æ–‡ç« å¯åšçš„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘å°†æ•´ä¸ªå®ç°æµç¨‹ç»˜åˆ¶å‡ºæ¥ï¼Œè¿‡æ»¤äº†ä¸€äº›ä¸ä¼šè¿›å…¥çš„åˆ†æ”¯è·¯å¾„å’Œè·Ÿä¸»é¢˜æ— å…³çš„ç»†èŠ‚ï¼š</p>
<p><a href="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" target="_blank" rel="noopener"><img src="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="æ¶ˆæ¯å‘é€ä¸è½¬å‘è·¯å¾„æµç¨‹å›¾"></a>æ¶ˆæ¯å‘é€ä¸è½¬å‘è·¯å¾„æµç¨‹å›¾</p>
<p>ä»‹äºå›½å†…å…³äºè¿™å—çŸ¥è¯†çš„å¥½å¤šæ–‡ç« æè¿°ä¸å¤Ÿå‡†ç¡®å’Œè¯¦ç»†ï¼Œæˆ–æ˜¯å¯¹æ¶ˆæ¯è½¬å‘çš„åŸç†æè¿°ç†è§£ä¸å¤Ÿæ·±åˆ»ï¼Œæˆ–æ˜¯ä¾§é‡è´´æºç è€Œæ¬ æ€è€ƒï¼Œæ‰€ä»¥æˆ‘åšäº†ä¸€ä¸ªæ¯”è¾ƒå…¨é¢è¯¦ç»†çš„è®²è§£ã€‚</p>
<p><a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/#å‚è€ƒæ–‡çŒ®" target="_blank" rel="noopener">è½¬è‡ª ç‰ä»¤å¤©ä¸‹çš„åšå®¢</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/13/runtimeç†è§£/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/runtimeç†è§£/" itemprop="url">
                  runtimeç†è§£
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-13 11:09:34 / ä¿®æ”¹æ—¶é—´ï¼š11:13:42" itemprop="dateCreated datePublished" datetime="2018-09-13T11:09:34+08:00">2018-09-13</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/runtime/" itemprop="url" rel="index"><span itemprop="name">runtime</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ä»€ä¹ˆæ˜¯Runtime"><a href="#ä»€ä¹ˆæ˜¯Runtime" class="headerlink" title="ä»€ä¹ˆæ˜¯Runtime"></a>ä»€ä¹ˆæ˜¯Runtime</h2><ul>
<li><p>æˆ‘ä»¬å†™çš„ä»£ç åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šè¢«è½¬åŒ–æˆruntimeçš„Cä»£ç æ‰§è¡Œï¼Œä¾‹å¦‚<code>[target doSomething];</code>ä¼šè¢«è½¬åŒ–æˆ<code>objc_msgSend(target, @selector(doSomething));</code>ã€‚</p>
</li>
<li><p>OCä¸­ä¸€åˆ‡éƒ½è¢«è®¾è®¡æˆäº†å¯¹è±¡ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªç±»è¢«åˆå§‹åŒ–æˆä¸€ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å®é™…ä¸Šä¸€ä¸ªç±»æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨runtimeä¸­ç”¨ç»“æ„ä½“è¡¨ç¤ºã€‚</p>
</li>
<li><p>ç›¸å…³çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/// æè¿°ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•</span><br><span class="line">typedef struct objc_method *Method;</span><br><span class="line"></span><br><span class="line">/// å®ä¾‹å˜é‡</span><br><span class="line">typedef struct objc_ivar *Ivar;</span><br><span class="line"></span><br><span class="line">/// ç±»åˆ«Category</span><br><span class="line">typedef struct objc_category *Category;</span><br><span class="line"></span><br><span class="line">/// ç±»ä¸­å£°æ˜çš„å±æ€§</span><br><span class="line">typedef struct objc_property *objc_property_t;</span><br></pre></td></tr></table></figure>
<p>ç±»åœ¨runtimeä¸­çš„è¡¨ç¤º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//ç±»åœ¨runtimeä¸­çš„è¡¨ç¤º</span><br><span class="line">struct objc_class &#123;</span><br><span class="line">    Class isa;//æŒ‡é’ˆï¼Œé¡¾åæ€ä¹‰ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªä»€ä¹ˆï¼Œ</span><br><span class="line">    //å®ä¾‹çš„isaæŒ‡å‘ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡çš„isaæŒ‡å‘å…ƒç±»</span><br><span class="line"></span><br><span class="line">#if !__OBJC2__</span><br><span class="line">    Class super_class;  //æŒ‡å‘çˆ¶ç±»</span><br><span class="line">    const char *name;  //ç±»å</span><br><span class="line">    long version;</span><br><span class="line">    long info;</span><br><span class="line">    long instance_size</span><br><span class="line">    struct objc_ivar_list *ivars //æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">    struct objc_method_list **methodLists; //æ–¹æ³•åˆ—è¡¨</span><br><span class="line">    struct objc_cache *cache;//ç¼“å­˜</span><br><span class="line">    //ä¸€ç§ä¼˜åŒ–ï¼Œè°ƒç”¨è¿‡çš„æ–¹æ³•å­˜å…¥ç¼“å­˜åˆ—è¡¨ï¼Œä¸‹æ¬¡è°ƒç”¨å…ˆæ‰¾ç¼“å­˜</span><br><span class="line">    struct objc_protocol_list *protocols //åè®®åˆ—è¡¨</span><br><span class="line">    #endif</span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line">/* Use `Class` instead of `struct objc_class *` */</span><br></pre></td></tr></table></figure>
<h2 id="è·å–åˆ—è¡¨"><a href="#è·å–åˆ—è¡¨" class="headerlink" title="è·å–åˆ—è¡¨"></a>è·å–åˆ—è¡¨</h2><p>æœ‰æ—¶å€™ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰ç±»ä¸­æ¯ä¸ªå±æ€§çš„åå­—ï¼ˆæ¯”å¦‚å­—å…¸è½¬æ¨¡å‹ï¼Œå­—å…¸çš„Keyå’Œæ¨¡å‹å¯¹è±¡çš„å±æ€§åå­—ä¸åŒ¹é…ï¼‰ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡runtimeçš„ä¸€ç³»åˆ—æ–¹æ³•è·å–ç±»çš„ä¸€äº›ä¿¡æ¯ï¼ˆåŒ…æ‹¬å±æ€§åˆ—è¡¨ï¼Œæ–¹æ³•åˆ—è¡¨ï¼Œæˆå‘˜å˜é‡åˆ—è¡¨ï¼Œå’Œéµå¾ªçš„åè®®åˆ—è¡¨ï¼‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">unsigned int count;</span><br><span class="line">  //è·å–å±æ€§åˆ—è¡¨</span><br><span class="line">  objc_property_t *propertyList = class_copyPropertyList([self class], &amp;count);</span><br><span class="line">  for (unsigned int i=0; i&lt;count; i++) &#123;</span><br><span class="line">      const char *propertyName = property_getName(propertyList[i]);</span><br><span class="line">      NSLog(@&quot;property----&gt;%@&quot;, [NSString stringWithUTF8String:propertyName]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //è·å–æ–¹æ³•åˆ—è¡¨</span><br><span class="line">  Method *methodList = class_copyMethodList([self class], &amp;count);</span><br><span class="line">  for (unsigned int i; i&lt;count; i++) &#123;</span><br><span class="line">      Method method = methodList[i];</span><br><span class="line">      NSLog(@&quot;method----&gt;%@&quot;, NSStringFromSelector(method_getName(method)));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //è·å–æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">  Ivar *ivarList = class_copyIvarList([self class], &amp;count);</span><br><span class="line">  for (unsigned int i; i&lt;count; i++) &#123;</span><br><span class="line">      Ivar myIvar = ivarList[i];</span><br><span class="line">      const char *ivarName = ivar_getName(myIvar);</span><br><span class="line">      NSLog(@&quot;Ivar----&gt;%@&quot;, [NSString stringWithUTF8String:ivarName]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //è·å–åè®®åˆ—è¡¨</span><br><span class="line">  __unsafe_unretained Protocol **protocolList = class_copyProtocolList([self class], &amp;count);</span><br><span class="line">  for (unsigned int i; i&lt;count; i++) &#123;</span><br><span class="line">      Protocol *myProtocal = protocolList[i];</span><br><span class="line">      const char *protocolName = protocol_getName(myProtocal);</span><br><span class="line">      NSLog(@&quot;protocol----&gt;%@&quot;, [NSString stringWithUTF8String:protocolName]);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨Xcodeä¸Šè·‘ä¸€ä¸‹çœ‹çœ‹è¾“å‡ºå§ï¼Œéœ€è¦ç»™ä½ å½“å‰çš„ç±»å†™å‡ ä¸ªå±æ€§ï¼Œæˆå‘˜å˜é‡ï¼Œæ–¹æ³•å’Œåè®®ï¼Œä¸ç„¶è·å–çš„åˆ—è¡¨æ˜¯æ²¡æœ‰ä¸œè¥¿çš„ã€‚<br>æ³¨æ„ï¼Œè°ƒç”¨è¿™äº›è·å–åˆ—è¡¨çš„æ–¹æ³•åˆ«å¿˜è®°å¯¼å…¥å¤´æ–‡ä»¶<code>#import &lt;objc/runtime.h&gt;</code>ã€‚</p>
<h2 id="æ–¹æ³•è°ƒç”¨"><a href="#æ–¹æ³•è°ƒç”¨" class="headerlink" title="æ–¹æ³•è°ƒç”¨"></a>æ–¹æ³•è°ƒç”¨</h2><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ–¹æ³•è°ƒç”¨åœ¨è¿è¡Œæ—¶çš„è¿‡ç¨‹ï¼ˆå‚ç…§å‰æ–‡ç±»åœ¨runtimeä¸­çš„è¡¨ç¤ºï¼‰</p>
<p><strong>å¦‚æœç”¨å®ä¾‹å¯¹è±¡è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œä¼šåˆ°å®ä¾‹çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯ç±»å¯¹è±¡ï¼‰æ“ä½œã€‚å¦‚æœè°ƒç”¨çš„æ˜¯ç±»æ–¹æ³•ï¼Œå°±ä¼šåˆ°ç±»å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯å…ƒç±»å¯¹è±¡ï¼‰ä¸­æ“ä½œã€‚</strong></p>
<ol>
<li>é¦–å…ˆï¼Œåœ¨ç›¸åº”æ“ä½œçš„å¯¹è±¡ä¸­çš„ç¼“å­˜æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾è°ƒç”¨çš„æ–¹æ³•ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œè½¬å‘ç›¸åº”å®ç°å¹¶æ‰§è¡Œã€‚</li>
<li>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨ç›¸åº”æ“ä½œçš„å¯¹è±¡ä¸­çš„æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾è°ƒç”¨çš„æ–¹æ³•ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œè½¬å‘ç›¸åº”å®ç°æ‰§è¡Œ</li>
<li>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå»çˆ¶ç±»æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡ä¸­æ‰§è¡Œ1ï¼Œ2.</li>
<li>ä»¥æ­¤ç±»æ¨ï¼Œå¦‚æœä¸€ç›´åˆ°æ ¹ç±»è¿˜æ²¡æ‰¾åˆ°ï¼Œè½¬å‘æ‹¦æˆªè°ƒç”¨ã€‚</li>
<li>å¦‚æœæ²¡æœ‰é‡å†™æ‹¦æˆªè°ƒç”¨çš„æ–¹æ³•ï¼Œç¨‹åºæŠ¥é”™ã€‚</li>
</ol>
<p><strong>ä»¥ä¸Šçš„è¿‡ç¨‹ç»™æˆ‘å¸¦æ¥çš„å¯å‘ï¼š</strong></p>
<ul>
<li>é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰è¦†ç›–æ‰çˆ¶ç±»çš„æ–¹æ³•ï¼Œåªæ˜¯åœ¨å½“å‰ç±»å¯¹è±¡ä¸­æ‰¾åˆ°äº†è¿™ä¸ªæ–¹æ³•åå°±ä¸ä¼šå†å»çˆ¶ç±»ä¸­æ‰¾äº†ã€‚</li>
<li>å¦‚æœæƒ³è°ƒç”¨å·²ç»é‡å†™è¿‡çš„æ–¹æ³•çš„çˆ¶ç±»çš„å®ç°ï¼Œåªéœ€ä½¿ç”¨<code>super</code>è¿™ä¸ªç¼–è¯‘å™¨æ ‡è¯†ï¼Œå®ƒä¼šåœ¨è¿è¡Œæ—¶è·³è¿‡åœ¨å½“å‰çš„ç±»å¯¹è±¡ä¸­å¯»æ‰¾æ–¹æ³•çš„è¿‡ç¨‹ã€‚</li>
</ul>
<h2 id="æ‹¦æˆªè°ƒç”¨"><a href="#æ‹¦æˆªè°ƒç”¨" class="headerlink" title="æ‹¦æˆªè°ƒç”¨"></a>æ‹¦æˆªè°ƒç”¨</h2><p>åœ¨æ–¹æ³•è°ƒç”¨ä¸­è¯´åˆ°äº†ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–¹æ³•å°±ä¼šè½¬å‘æ‹¦æˆªè°ƒç”¨ã€‚<br>é‚£ä¹ˆä»€ä¹ˆæ˜¯æ‹¦æˆªè°ƒç”¨å‘¢ã€‚<br>æ‹¦æˆªè°ƒç”¨å°±æ˜¯ï¼Œåœ¨æ‰¾ä¸åˆ°è°ƒç”¨çš„æ–¹æ³•ç¨‹åºå´©æºƒä¹‹å‰ï¼Œä½ æœ‰æœºä¼šé€šè¿‡é‡å†™<code>NSObject</code>çš„å››ä¸ªæ–¹æ³•æ¥å¤„ç†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)resolveClassMethod:(SEL)sel;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel;</span><br><span class="line">//åä¸¤ä¸ªæ–¹æ³•éœ€è¦è½¬å‘åˆ°å…¶ä»–çš„ç±»å¤„ç†</span><br><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector;</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯å½“ä½ è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„ç±»æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œé»˜è®¤è¿”å›NOï¼Œä½ å¯ä»¥åŠ ä¸Šè‡ªå·±çš„å¤„ç†ç„¶åè¿”å›YESã€‚</li>
<li>ç¬¬äºŒä¸ªæ–¹æ³•å’Œç¬¬ä¸€ä¸ªæ–¹æ³•ç›¸ä¼¼ï¼Œåªä¸è¿‡å¤„ç†çš„æ˜¯å®ä¾‹æ–¹æ³•ã€‚</li>
<li>ç¬¬ä¸‰ä¸ªæ–¹æ³•æ˜¯å°†ä½ è°ƒç”¨çš„ä¸å­˜åœ¨çš„æ–¹æ³•é‡å®šå‘åˆ°ä¸€ä¸ªå…¶ä»–å£°æ˜äº†è¿™ä¸ªæ–¹æ³•çš„ç±»ï¼Œåªéœ€è¦ä½ è¿”å›ä¸€ä¸ªæœ‰è¿™ä¸ªæ–¹æ³•çš„targetã€‚</li>
<li>ç¬¬å››ä¸ªæ–¹æ³•æ˜¯å°†ä½ è°ƒç”¨çš„ä¸å­˜åœ¨çš„æ–¹æ³•æ‰“åŒ…æˆ<code>NSInvocation</code>ä¼ ç»™ä½ ã€‚åšå®Œä½ è‡ªå·±çš„å¤„ç†åï¼Œè°ƒç”¨<code>invokeWithTarget:</code>æ–¹æ³•è®©æŸä¸ªtargetè§¦å‘è¿™ä¸ªæ–¹æ³•ã€‚</li>
</ul>
<h2 id="åŠ¨æ€æ·»åŠ æ–¹æ³•"><a href="#åŠ¨æ€æ·»åŠ æ–¹æ³•" class="headerlink" title="åŠ¨æ€æ·»åŠ æ–¹æ³•"></a>åŠ¨æ€æ·»åŠ æ–¹æ³•</h2><p>é‡å†™äº†æ‹¦æˆªè°ƒç”¨çš„æ–¹æ³•å¹¶ä¸”è¿”å›äº†YESï¼Œæˆ‘ä»¬è¦æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ<br>æœ‰ä¸€ä¸ªåŠæ³•æ˜¯æ ¹æ®ä¼ è¿›æ¥çš„<code>SEL</code>ç±»å‹çš„selectoråŠ¨æ€æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<p>é¦–å…ˆä»å¤–éƒ¨éšå¼è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//éšå¼è°ƒç”¨æ–¹æ³•</span><br><span class="line">[target performSelector:@selector(resolveAdd:) withObject:@&quot;test&quot;];</span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œåœ¨targetå¯¹è±¡å†…éƒ¨é‡å†™æ‹¦æˆªè°ƒç”¨çš„æ–¹æ³•ï¼ŒåŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void runAddMethod(id self, SEL _cmd, NSString *string)&#123;</span><br><span class="line">    NSLog(@&quot;add C IMP &quot;, string);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel&#123;</span><br><span class="line">    </span><br><span class="line">    //ç»™æœ¬ç±»åŠ¨æ€æ·»åŠ ä¸€ä¸ªæ–¹æ³•</span><br><span class="line">    if ([NSStringFromSelector(sel) isEqualToString:@&quot;resolveAdd:&quot;]) &#123;</span><br><span class="line">        class_addMethod(self, sel, (IMP)runAddMethod, &quot;v@:*&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>class_addMethod</code>çš„å››ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li><code>Class cls</code>ç»™å“ªä¸ªç±»æ·»åŠ æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­æ˜¯self</li>
<li><code>SEL name</code>æ·»åŠ çš„æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­æ˜¯é‡å†™çš„æ‹¦æˆªè°ƒç”¨ä¼ è¿›æ¥çš„selectorã€‚</li>
<li><code>IMP imp</code>æ–¹æ³•çš„å®ç°ï¼ŒCæ–¹æ³•çš„æ–¹æ³•å®ç°å¯ä»¥ç›´æ¥è·å¾—ã€‚å¦‚æœæ˜¯OCæ–¹æ³•ï¼Œå¯ä»¥ç”¨<code>+ (IMP)instanceMethodForSelector:(SEL)aSelector;</code>è·å¾—æ–¹æ³•çš„å®ç°ã€‚</li>
<li><code>&quot;v@:*&quot;</code>æ–¹æ³•çš„ç­¾åï¼Œä»£è¡¨æœ‰ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•ã€‚</li>
</ol>
<h2 id="å…³è”å¯¹è±¡"><a href="#å…³è”å¯¹è±¡" class="headerlink" title="å…³è”å¯¹è±¡"></a>å…³è”å¯¹è±¡</h2><p>ç°åœ¨ä½ å‡†å¤‡ç”¨ä¸€ä¸ªç³»ç»Ÿçš„ç±»ï¼Œä½†æ˜¯ç³»ç»Ÿçš„ç±»å¹¶ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ éœ€è¦é¢å¤–æ·»åŠ ä¸€ä¸ªå±æ€§ã€‚<br>è¿™ç§æƒ…å†µçš„ä¸€èˆ¬è§£å†³åŠæ³•å°±æ˜¯ç»§æ‰¿ã€‚<br>ä½†æ˜¯ï¼Œåªå¢åŠ ä¸€ä¸ªå±æ€§ï¼Œå°±å»ç»§æ‰¿ä¸€ä¸ªç±»ï¼Œæ€»æ˜¯è§‰å¾—å¤ªéº»çƒ¦ç±»ã€‚<br>è¿™ä¸ªæ—¶å€™ï¼Œruntimeçš„å…³è”å±æ€§å°±å‘æŒ¥å®ƒçš„ä½œç”¨äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//é¦–å…ˆå®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨å®ƒçš„åœ°å€ä½œä¸ºå…³è”å¯¹è±¡çš„key</span><br><span class="line">static char associatedObjectKey;</span><br><span class="line">//è®¾ç½®å…³è”å¯¹è±¡</span><br><span class="line">objc_setAssociatedObject(target, &amp;associatedObjectKey, @&quot;æ·»åŠ çš„å­—ç¬¦ä¸²å±æ€§&quot;, OBJC_ASSOCIATION_RETAIN_NONATOMIC); //è·å–å…³è”å¯¹è±¡</span><br><span class="line">NSString *string = objc_getAssociatedObject(target, &amp;associatedObjectKey);</span><br><span class="line">NSLog(@&quot;AssociatedObject = %@&quot;, string);</span><br></pre></td></tr></table></figure>
<p><code>objc_setAssociatedObject</code>çš„å››ä¸ªå‚æ•°ï¼š</p>
<ol>
<li><code>id object</code>ç»™è°è®¾ç½®å…³è”å¯¹è±¡ã€‚</li>
<li><code>const void *key</code>å…³è”å¯¹è±¡å”¯ä¸€çš„keyï¼Œè·å–æ—¶ä¼šç”¨åˆ°ã€‚</li>
<li><code>id value</code>å…³è”å¯¹è±¡ã€‚</li>
<li><code>objc_AssociationPolicy</code>å…³è”ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enum &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = 0,</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, </span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = 01401,</span><br><span class="line">    OBJC_ASSOCIATION_COPY = 01403 </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ ç†Ÿæ‚‰OCï¼Œçœ‹åå­—åº”è¯¥çŸ¥é“è¿™å‡ ç§ç­–ç•¥çš„æ„æ€äº†å§ã€‚</p>
<p><code>objc_getAssociatedObject</code>çš„ä¸¤ä¸ªå‚æ•°ã€‚</p>
<ol>
<li><code>id object</code>è·å–è°çš„å…³è”å¯¹è±¡ã€‚</li>
<li><code>const void *key</code>æ ¹æ®è¿™ä¸ªå”¯ä¸€çš„keyè·å–å…³è”å¯¹è±¡ã€‚</li>
</ol>
<p>å…¶å®ï¼Œä½ è¿˜å¯ä»¥æŠŠæ·»åŠ å’Œè·å–å…³è”å¯¹è±¡çš„æ–¹æ³•å†™åœ¨ä½ éœ€è¦ç”¨åˆ°è¿™ä¸ªåŠŸèƒ½çš„ç±»çš„ç±»åˆ«ä¸­ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//æ·»åŠ å…³è”å¯¹è±¡</span><br><span class="line">- (void)addAssociatedObject:(id)object&#123;</span><br><span class="line">    objc_setAssociatedObject(self, @selector(getAssociatedObject), object, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">//è·å–å…³è”å¯¹è±¡</span><br><span class="line">- (id)getAssociatedObject&#123;</span><br><span class="line">    return objc_getAssociatedObject(self, _cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong>è¿™é‡Œé¢æˆ‘ä»¬æŠŠ<code>getAssociatedObject</code>æ–¹æ³•çš„åœ°å€ä½œä¸ºå”¯ä¸€çš„keyï¼Œ<code>_cmd</code>ä»£è¡¨å½“å‰è°ƒç”¨æ–¹æ³•çš„åœ°å€ã€‚</p>
<h2 id="æ–¹æ³•äº¤æ¢"><a href="#æ–¹æ³•äº¤æ¢" class="headerlink" title="æ–¹æ³•äº¤æ¢"></a>æ–¹æ³•äº¤æ¢</h2><p>æ–¹æ³•äº¤æ¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†ä¸¤ä¸ªæ–¹æ³•çš„å®ç°äº¤æ¢ã€‚ä¾‹å¦‚ï¼Œå°†Aæ–¹æ³•å’ŒBæ–¹æ³•äº¤æ¢ï¼Œè°ƒç”¨Aæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡ŒBæ–¹æ³•ä¸­çš„ä»£ç ï¼Œåä¹‹äº¦ç„¶ã€‚<br>è¯ä¸å¤šè¯´ï¼Œè¿™æ˜¯å‚è€ƒMatttå¤§ç¥åœ¨NSHipsterä¸Šçš„æ–‡ç« è‡ªå·±å†™çš„ä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;UIViewController+swizzling.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation UIViewController (swizzling)</span><br><span class="line"></span><br><span class="line">//loadæ–¹æ³•ä¼šåœ¨ç±»ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™è¢«è°ƒç”¨</span><br><span class="line">//è°ƒç”¨çš„æ—¶é—´æ¯”è¾ƒé å‰ï¼Œé€‚åˆåœ¨è¿™ä¸ªæ–¹æ³•é‡Œåšæ–¹æ³•äº¤æ¢</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">    //æ–¹æ³•äº¤æ¢åº”è¯¥è¢«ä¿è¯ï¼Œåœ¨ç¨‹åºä¸­åªä¼šæ‰§è¡Œä¸€æ¬¡</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        </span><br><span class="line">        //è·å¾—viewControllerçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„selector</span><br><span class="line">        SEL systemSel = @selector(viewWillAppear:);</span><br><span class="line">        //è‡ªå·±å®ç°çš„å°†è¦è¢«äº¤æ¢çš„æ–¹æ³•çš„selector</span><br><span class="line">        SEL swizzSel = @selector(swiz_viewWillAppear:);</span><br><span class="line">        //ä¸¤ä¸ªæ–¹æ³•çš„Method</span><br><span class="line">        Method systemMethod = class_getInstanceMethod([self class], systemSel);</span><br><span class="line">        Method swizzMethod = class_getInstanceMethod([self class], swizzSel);</span><br><span class="line">        </span><br><span class="line">        //é¦–å…ˆåŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œå®ç°æ˜¯è¢«äº¤æ¢çš„æ–¹æ³•ï¼Œè¿”å›å€¼è¡¨ç¤ºæ·»åŠ æˆåŠŸè¿˜æ˜¯å¤±è´¥</span><br><span class="line">        BOOL isAdd = class_addMethod(self, systemSel, method_getImplementation(swizzMethod), method_getTypeEncoding(swizzMethod));</span><br><span class="line">        if (isAdd) &#123;</span><br><span class="line">            //å¦‚æœæˆåŠŸï¼Œè¯´æ˜ç±»ä¸­ä¸å­˜åœ¨è¿™ä¸ªæ–¹æ³•çš„å®ç°</span><br><span class="line">            //å°†è¢«äº¤æ¢æ–¹æ³•çš„å®ç°æ›¿æ¢åˆ°è¿™ä¸ªå¹¶ä¸å­˜åœ¨çš„å®ç°</span><br><span class="line">            class_replaceMethod(self, swizzSel, method_getImplementation(systemMethod), method_getTypeEncoding(systemMethod));</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            //å¦åˆ™ï¼Œäº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°</span><br><span class="line">            method_exchangeImplementations(systemMethod, swizzMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)swiz_viewWillAppear:(BOOL)animated&#123;</span><br><span class="line">    //è¿™æ—¶å€™è°ƒç”¨è‡ªå·±ï¼Œçœ‹èµ·æ¥åƒæ˜¯æ­»å¾ªç¯</span><br><span class="line">    //ä½†æ˜¯å…¶å®è‡ªå·±çš„å®ç°å·²ç»è¢«æ›¿æ¢äº†</span><br><span class="line">    [self swiz_viewWillAppear:animated];</span><br><span class="line">    NSLog(@&quot;swizzle&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„viewControllerä¸­é‡å†™viewWillAppear</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewWillAppear:(BOOL)animated&#123;</span><br><span class="line">    [super viewWillAppear:animated];</span><br><span class="line">    NSLog(@&quot;viewWillAppear&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Runèµ·æ¥çœ‹çœ‹è¾“å‡ºå§ï¼</p>
<p><strong>æˆ‘çš„ç†è§£ï¼š</strong></p>
<ul>
<li><p>æ–¹æ³•äº¤æ¢å¯¹äºæˆ‘æ¥è¯´æ›´åƒæ˜¯å®ç°ä¸€ç§æ€æƒ³çš„æœ€ä½³æŠ€æœ¯ï¼šAOPé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚</p>
</li>
<li><p>æ—¢ç„¶æ˜¯åˆ‡é¢ï¼Œå°±ä¸€å®šä¸è¦å¿˜è®°ï¼Œäº¤æ¢å®Œå†è°ƒå›è‡ªå·±ã€‚</p>
</li>
<li><p>ä¸€å®šè¦ä¿è¯åªäº¤æ¢ä¸€æ¬¡ï¼Œå¦åˆ™å°±ä¼šå¾ˆä¹±ã€‚</p>
</li>
<li><p>æœ€åï¼Œæ®è¯´è¿™ä¸ªæŠ€æœ¯å¾ˆå±é™©ï¼Œè°¨æ…ä½¿ç”¨ã€‚</p>
<p>[è½¬è‡ª <a href="https://www.jianshu.com/u/kNDmhv" target="_blank" rel="noopener">å…´å®‡æ˜¯è°</a>]</p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/12/äº‹ä»¶çš„ä¼ é€’å’Œå“åº”æœºåˆ¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/12/äº‹ä»¶çš„ä¼ é€’å’Œå“åº”æœºåˆ¶/" itemprop="url">
                  äº‹ä»¶çš„ä¼ é€’å’Œå“åº”æœºåˆ¶
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-12 14:39:25" itemprop="dateCreated datePublished" datetime="2018-09-12T14:39:25+08:00">2018-09-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2018-09-13 10:18:36" itemprop="dateModified" datetime="2018-09-13T10:18:36+08:00">2018-09-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UIè§†å›¾/" itemprop="url" rel="index"><span itemprop="name">UIè§†å›¾</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ"></a>äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ</h1><p>ã€€äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’ï¼ˆäº‹ä»¶å¦‚ä½•ä»çˆ¶æ§ä»¶ä¼ é€’åˆ°å­æ§ä»¶å¹¶å¯»æ‰¾åˆ°æœ€åˆé€‚çš„viewã€å¯»æ‰¾æœ€åˆé€‚çš„viewçš„åº•å±‚å®ç°ã€æ‹¦æˆªäº‹ä»¶çš„å¤„ç†ï¼‰-&gt;æ‰¾åˆ°æœ€åˆé€‚çš„viewåäº‹ä»¶çš„å¤„ç†ï¼ˆtouchesæ–¹æ³•çš„é‡å†™ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶çš„å“åº”ï¼‰</p>
<p>â€‹     å…¶ä¸­é‡ç‚¹å’Œéš¾ç‚¹æ˜¯ï¼š<br>ã€€ã€€1.å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„view<br>ã€€ã€€2.å¯»æ‰¾æœ€åˆé€‚çš„viewçš„åº•å±‚å®ç°ï¼ˆhitTest:withEvent:åº•å±‚å®ç°ï¼‰</p>
<h1 id="iOSä¸­çš„äº‹ä»¶"><a href="#iOSä¸­çš„äº‹ä»¶" class="headerlink" title="iOSä¸­çš„äº‹ä»¶"></a>iOSä¸­çš„äº‹ä»¶</h1><p>iOSä¸­çš„äº‹ä»¶å¯ä»¥åˆ†ä¸º3å¤§ç±»å‹ï¼š</p>
<ul>
<li><p>è§¦æ‘¸äº‹ä»¶</p>
</li>
<li><p>åŠ é€Ÿè®¡äº‹ä»¶</p>
</li>
<li><p>è¿œç¨‹æ§åˆ¶äº‹ä»¶</p>
<p>æœ¬æ–‡åªè®¨è®ºæ¥è§¦äº‹ä»¶    </p>
<h2 id="å“åº”è€…å¯¹è±¡-UIResponder"><a href="#å“åº”è€…å¯¹è±¡-UIResponder" class="headerlink" title="å“åº”è€…å¯¹è±¡(UIResponder)"></a>å“åº”è€…å¯¹è±¡(UIResponder)</h2><p>å­¦ä¹ è§¦æ‘¸äº‹ä»¶é¦–å…ˆè¦äº†è§£ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µ-å“åº”è€…å¯¹è±¡ï¼ˆUIResponderï¼‰ã€‚</p>
<p>åœ¨iOSä¸­ä¸æ˜¯ä»»ä½•å¯¹è±¡éƒ½èƒ½å¤„ç†äº‹ä»¶ï¼Œåªæœ‰ç»§æ‰¿äº†UIResponderçš„å¯¹è±¡æ‰èƒ½æ¥å—å¹¶å¤„ç†äº‹ä»¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå“åº”è€…å¯¹è±¡â€ã€‚ä»¥ä¸‹éƒ½æ˜¯ç»§æ‰¿è‡ªUIResponderçš„ï¼Œæ‰€ä»¥éƒ½èƒ½æ¥æ”¶å¹¶å¤„ç†äº‹ä»¶ã€‚</p>
<ul>
<li>UIApplication</li>
<li>UIViewController</li>
<li>UIView</li>
</ul>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆç»§æ‰¿è‡ªUIResponderçš„ç±»å°±èƒ½å¤Ÿæ¥æ”¶å¹¶å¤„ç†äº‹ä»¶å‘¢ï¼Ÿ</p>
<ul>
<li><p>å› ä¸ºUIResponderä¸­æä¾›äº†ä»¥ä¸‹4ä¸ªå¯¹è±¡æ–¹æ³•æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">UIResponderå†…éƒ¨æä¾›äº†ä»¥ä¸‹æ–¹æ³•æ¥å¤„ç†äº‹ä»¶è§¦æ‘¸äº‹ä»¶</span><br><span class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event;</span><br><span class="line">- (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event;</span><br><span class="line">- (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event;</span><br><span class="line">- (void)touchesCancelled:(NSSet *)touches withEvent:(UIEvent *)event;</span><br><span class="line">åŠ é€Ÿè®¡äº‹ä»¶</span><br><span class="line">- (void)motionBegan:(UIEventSubtype)motion withEvent:(UIEvent *)event;</span><br><span class="line">- (void)motionEnded:(UIEventSubtype)motion withEvent:(UIEvent *)event;</span><br><span class="line">- (void)motionCancelled:(UIEventSubtype)motion withEvent:(UIEvent *)event;</span><br><span class="line">è¿œç¨‹æ§åˆ¶äº‹ä»¶</span><br><span class="line">- (void)remoteControlReceivedWithEvent:(UIEvent *)event;</span><br><span class="line"></span><br><span class="line">ä½œè€…ï¼šVVæœ¨å…¬å­</span><br><span class="line">é“¾æ¥ï¼šhttps://www.jianshu.com/p/2e074db792ba</span><br><span class="line">ä¾†æºï¼šç®€ä¹¦</span><br><span class="line">ç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒå¹¶æ³¨æ˜å‡ºå¤„ã€‚</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="iOSä¸­çš„äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’"><a href="#iOSä¸­çš„äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’" class="headerlink" title="iOSä¸­çš„äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’"></a>iOSä¸­çš„äº‹ä»¶çš„äº§ç”Ÿå’Œä¼ é€’</h1><h2 id="äº‹ä»¶çš„äº§ç”Ÿ"><a href="#äº‹ä»¶çš„äº§ç”Ÿ" class="headerlink" title="äº‹ä»¶çš„äº§ç”Ÿ"></a>äº‹ä»¶çš„äº§ç”Ÿ</h2><p>å‘ç”Ÿè§¦æ‘¸äº‹ä»¶åï¼Œç³»ç»Ÿä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°ä¸€ä¸ªç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­,ä¸ºä»€ä¹ˆæ˜¯é˜Ÿåˆ—è€Œä¸æ˜¯æ ˆï¼Ÿå› ä¸ºé˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯FIFOï¼Œå³å…ˆè¿›å…ˆå‡ºï¼Œå…ˆäº§ç”Ÿçš„äº‹ä»¶å…ˆå¤„ç†æ‰ç¬¦åˆå¸¸ç†ï¼Œæ‰€ä»¥æŠŠäº‹ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—ã€‚</p>
<p>UIApplicationä¼šä»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼Œå¹¶å°†äº‹ä»¶åˆ†å‘ä¸‹å»ä»¥ä¾¿å¤„ç†ï¼Œé€šå¸¸ï¼Œå…ˆå‘é€äº‹ä»¶ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰ã€‚</p>
<p>ä¸»çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æ„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªäº‹ä»¶å¤„ç†è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ã€‚<br>æ‰¾åˆ°åˆé€‚çš„è§†å›¾æ§ä»¶åï¼Œå°±ä¼šè°ƒç”¨è§†å›¾æ§ä»¶çš„touchesæ–¹æ³•æ¥ä½œå…·ä½“çš„äº‹ä»¶å¤„ç†ã€‚</p>
<h2 id="äº‹ä»¶çš„ä¼ é€’"><a href="#äº‹ä»¶çš„ä¼ é€’" class="headerlink" title="äº‹ä»¶çš„ä¼ é€’"></a>äº‹ä»¶çš„ä¼ é€’</h2><ul>
<li>è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’æ˜¯ä»çˆ¶æ§ä»¶ä¼ é€’åˆ°å­æ§ä»¶</li>
<li>ä¹Ÿå°±æ˜¯UIApplication-&gt;window-&gt;å¯»æ‰¾å¤„ç†äº‹ä»¶æœ€åˆé€‚çš„view</li>
</ul>
<p><code>æ³¨ æ„</code>: å¦‚æœçˆ¶æ§ä»¶ä¸èƒ½æ¥å—è§¦æ‘¸äº‹ä»¶ï¼Œé‚£ä¹ˆå­æ§ä»¶å°±ä¸å¯èƒ½æ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶</p>
<h3 id="åº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ"><a href="#åº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ" class="headerlink" title="åº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ"></a>åº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ</h3><p>1.é¦–å…ˆåˆ¤æ–­ä¸»çª—å£ï¼ˆkeyWindowï¼‰è‡ªå·±æ˜¯å¦èƒ½æ¥å—è§¦æ‘¸äº‹ä»¶</p>
<p>2.åˆ¤æ–­è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è‡ªå·±èº«ä¸Š</p>
<p>3.å­æ§ä»¶æ•°ç»„ä¸­ä»åå¾€å‰éå†å­æ§ä»¶ï¼Œé‡å¤å‰é¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆæ‰€è°“ä»åå¾€å‰éå†å­æ§ä»¶ï¼Œå°±æ˜¯é¦–å…ˆæŸ¥æ‰¾å­æ§ä»¶æ•°ç»„ä¸­æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç„¶åæ‰§è¡Œ1ã€2æ­¥éª¤ï¼‰</p>
<p>4.viewï¼Œæ¯”å¦‚å«åšfitViewï¼Œé‚£ä¹ˆä¼šæŠŠè¿™ä¸ªäº‹ä»¶äº¤ç»™è¿™ä¸ªfitViewï¼Œå†éå†è¿™ä¸ªfitViewçš„å­æ§ä»¶ï¼Œç›´è‡³æ²¡æœ‰æ›´åˆé€‚çš„viewä¸ºæ­¢ã€‚</p>
<p>5.å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­æ§ä»¶ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè‡ªå·±æœ€åˆé€‚å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±æ˜¯æœ€åˆé€‚çš„viewã€‚</p>
<h3 id="UIViewä¸èƒ½æ¥æ”¶è§¦æ‘¸äº‹ä»¶çš„ä¸‰ç§æƒ…å†µï¼š"><a href="#UIViewä¸èƒ½æ¥æ”¶è§¦æ‘¸äº‹ä»¶çš„ä¸‰ç§æƒ…å†µï¼š" class="headerlink" title="UIViewä¸èƒ½æ¥æ”¶è§¦æ‘¸äº‹ä»¶çš„ä¸‰ç§æƒ…å†µï¼š"></a>UIViewä¸èƒ½æ¥æ”¶è§¦æ‘¸äº‹ä»¶çš„ä¸‰ç§æƒ…å†µï¼š</h3><ul>
<li><strong>ä¸å…è®¸äº¤äº’</strong>ï¼šuserInteractionEnabled = NO</li>
<li><strong>éšè—</strong>ï¼šå¦‚æœæŠŠçˆ¶æ§ä»¶éšè—ï¼Œé‚£ä¹ˆå­æ§ä»¶ä¹Ÿä¼šéšè—ï¼Œéšè—çš„æ§ä»¶ä¸èƒ½æ¥å—äº‹ä»¶</li>
<li><strong>é€æ˜åº¦</strong>ï¼šå¦‚æœè®¾ç½®ä¸€ä¸ªæ§ä»¶çš„é€æ˜åº¦&lt;0.01ï¼Œä¼šç›´æ¥å½±å“å­æ§ä»¶çš„é€æ˜åº¦ã€‚alphaï¼š0.0~0.01ä¸ºé€æ˜ã€‚</li>
</ul>
<p><code>æ³¨ æ„</code>:é»˜è®¤UIImageViewä¸èƒ½æ¥å—è§¦æ‘¸äº‹ä»¶ï¼Œå› ä¸ºä¸å…è®¸äº¤äº’ï¼Œå³userInteractionEnabled = NOã€‚æ‰€ä»¥å¦‚æœå¸Œæœ›UIImageViewå¯ä»¥äº¤äº’ï¼Œéœ€è¦è®¾ç½®UIImageViewçš„userInteractionEnabled = YESã€‚</p>
<h3 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h3><p>1.ç‚¹å‡»ä¸€ä¸ªUIViewæˆ–äº§ç”Ÿä¸€ä¸ªè§¦æ‘¸äº‹ä»¶Aï¼Œè¿™ä¸ªè§¦æ‘¸äº‹ä»¶Aä¼šè¢«æ·»åŠ åˆ°ç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼ˆå³ï¼Œé¦–å…ˆæ¥æ”¶åˆ°äº‹ä»¶çš„æ˜¯UIApplicationï¼‰ã€‚<br>2.UIApplicationä¼šä»äº‹ä»¶å¯¹åˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼ˆæ­¤å¤„å‡è®¾ä¸ºè§¦æ‘¸äº‹ä»¶Aï¼‰ï¼ŒæŠŠäº‹ä»¶Aä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰ã€‚<br>3.çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æ„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ã€‚ï¼ˆè‡³æ­¤ï¼Œç¬¬ä¸€æ­¥å·²å®Œæˆï¼‰</p>
<p><img src="http://ovwhbnlx7.bkt.clouddn.com/%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E7%A4%BA%E4%BE%8B.png" alt="avatar"></p>
<h2 id="é‡éš¾ç‚¹ï¼‰å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„view"><a href="#é‡éš¾ç‚¹ï¼‰å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„view" class="headerlink" title="(é‡éš¾ç‚¹ï¼‰å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„view"></a>(é‡éš¾ç‚¹ï¼‰å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„view</h2><p>åº”ç”¨å¦‚ä½•æ‰¾åˆ°æœ€åˆé€‚çš„æ§ä»¶æ¥å¤„ç†äº‹ä»¶ï¼Ÿ<br>1.é¦–å…ˆåˆ¤æ–­ä¸»çª—å£ï¼ˆkeyWindowï¼‰è‡ªå·±æ˜¯å¦èƒ½æ¥å—è§¦æ‘¸äº‹ä»¶<br>2.è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è‡ªå·±èº«ä¸Š<br>3.ä»åå¾€å‰éå†å­æ§ä»¶ï¼Œé‡å¤å‰é¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆé¦–å…ˆæŸ¥æ‰¾æ•°ç»„ä¸­æœ€åä¸€ä¸ªå…ƒç´ ï¼‰<br>4.å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å­æ§ä»¶ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè‡ªå·±æœ€åˆé€‚å¤„ç†</p>
<p>è¯¦è¿°ï¼š1.ä¸»çª—å£æ¥æ”¶åˆ°åº”ç”¨ç¨‹åºä¼ é€’è¿‡æ¥çš„äº‹ä»¶åï¼Œé¦–å…ˆåˆ¤æ–­è‡ªå·±èƒ½å¦æ¥æ‰‹è§¦æ‘¸äº‹ä»¶ã€‚å¦‚æœèƒ½ï¼Œé‚£ä¹ˆåœ¨åˆ¤æ–­è§¦æ‘¸ç‚¹åœ¨ä¸åœ¨çª—å£è‡ªå·±èº«ä¸Š<br>ã€€ã€€ã€€2.å¦‚æœè§¦æ‘¸ç‚¹ä¹Ÿåœ¨çª—å£èº«ä¸Šï¼Œé‚£ä¹ˆçª—å£ä¼šä»åå¾€å‰éå†è‡ªå·±çš„å­æ§ä»¶ï¼ˆéå†è‡ªå·±çš„å­æ§ä»¶åªæ˜¯ä¸ºäº†å¯»æ‰¾å‡ºæ¥æœ€åˆé€‚çš„viewï¼‰<br>ã€€ã€€ã€€3.éå†åˆ°æ¯ä¸€ä¸ªå­æ§ä»¶åï¼Œåˆä¼šé‡å¤ä¸Šé¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼ˆä¼ é€’äº‹ä»¶ç»™å­æ§ä»¶ï¼Œ1.åˆ¤æ–­å­æ§ä»¶èƒ½å¦æ¥å—äº‹ä»¶ï¼Œ2.ç‚¹åœ¨ä¸åœ¨å­æ§ä»¶ä¸Šï¼‰<br>ã€€ã€€ã€€4.å¦‚æ­¤å¾ªç¯éå†å­æ§ä»¶ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åˆé€‚çš„viewï¼Œå¦‚æœæ²¡æœ‰æ›´åˆé€‚çš„å­æ§ä»¶ï¼Œé‚£ä¹ˆè‡ªå·±å°±æˆä¸ºæœ€åˆé€‚çš„viewã€‚<br>æ‰¾åˆ°æœ€åˆé€‚çš„viewåï¼Œå°±ä¼šè°ƒç”¨è¯¥viewçš„touchesæ–¹æ³•å¤„ç†å…·ä½“çš„äº‹ä»¶ã€‚æ‰€ä»¥ï¼Œåªæœ‰æ‰¾åˆ°æœ€åˆé€‚çš„viewï¼ŒæŠŠäº‹ä»¶ä¼ é€’ç»™æœ€åˆé€‚çš„viewåï¼Œæ‰ä¼šè°ƒç”¨touchesæ–¹æ³•è¿›è¡Œæ¥ä¸‹æ¥çš„äº‹ä»¶å¤„ç†ã€‚æ‰¾ä¸åˆ°æœ€åˆé€‚çš„viewï¼Œå°±ä¸ä¼šè°ƒç”¨touchesæ–¹æ³•è¿›è¡Œäº‹ä»¶å¤„ç†ã€‚<br>æ³¨æ„ï¼šä¹‹æ‰€ä»¥ä¼šé‡‡å–ä»åå¾€å‰éå†å­æ§ä»¶çš„æ–¹å¼å¯»æ‰¾æœ€åˆé€‚çš„viewåªæ˜¯ä¸ºäº†åšä¸€äº›å¾ªç¯ä¼˜åŒ–ã€‚å› ä¸ºç›¸æ¯”è¾ƒä¹‹ä¸‹ï¼Œåæ·»åŠ çš„viewåœ¨ä¸Šé¢ï¼Œé™ä½å¾ªç¯æ¬¡æ•°ã€‚</p>
<h3 id="å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æ"><a href="#å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æ" class="headerlink" title="å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æ"></a>å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æ</h3><p>ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•ï¼š<br><strong>hitTest:withEvent:</strong>æ–¹æ³•<br><strong>pointInside</strong>æ–¹æ³•</p>
<h4 id="3-3-1-1-hitTestï¼šwithEventï¼šæ–¹æ³•"><a href="#3-3-1-1-hitTestï¼šwithEventï¼šæ–¹æ³•" class="headerlink" title="3.3.1.1.hitTestï¼šwithEventï¼šæ–¹æ³•"></a>3.3.1.1.hitTestï¼šwithEventï¼šæ–¹æ³•</h4><p><strong>ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Ÿ</strong> </p>
<ul>
<li>åªè¦äº‹ä»¶ä¸€ä¼ é€’ç»™ä¸€ä¸ªæ§ä»¶,è¿™ä¸ªæ§ä»¶å°±ä¼šè°ƒç”¨ä»–è‡ªå·±çš„hitTestï¼šwithEventï¼šæ–¹æ³•</li>
</ul>
<p><strong>ä½œç”¨</strong></p>
<ul>
<li>å¯»æ‰¾å¹¶è¿”å›æœ€åˆé€‚çš„view(èƒ½å¤Ÿå“åº”äº‹ä»¶çš„é‚£ä¸ªæœ€åˆé€‚çš„view)</li>
</ul>
<p><code>æ³¨ æ„</code>ï¼šä¸ç®¡è¿™ä¸ªæ§ä»¶èƒ½ä¸èƒ½å¤„ç†äº‹ä»¶ï¼Œä¹Ÿä¸ç®¡è§¦æ‘¸ç‚¹åœ¨ä¸åœ¨è¿™ä¸ªæ§ä»¶ä¸Šï¼Œäº‹ä»¶éƒ½ä¼šå…ˆä¼ é€’ç»™è¿™ä¸ªæ§ä»¶ï¼Œéšåå†è°ƒç”¨hitTest:withEvent:æ–¹æ³•</p>
<p><strong>æ‹¦æˆªäº‹ä»¶çš„å¤„ç†</strong></p>
<ul>
<li>æ­£å› ä¸ºhitTestï¼šwithEventï¼šæ–¹æ³•å¯ä»¥è¿”å›æœ€åˆé€‚çš„viewï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡é‡å†™hitTestï¼šwithEventï¼šæ–¹æ³•ï¼Œè¿”å›æŒ‡å®šçš„viewä½œä¸ºæœ€åˆé€‚çš„viewã€‚</li>
<li>ä¸ç®¡ç‚¹å‡»å“ªé‡Œï¼Œæœ€åˆé€‚çš„viewéƒ½æ˜¯hitTestï¼šwithEventï¼šæ–¹æ³•ä¸­è¿”å›çš„é‚£ä¸ªviewã€‚</li>
<li>é€šè¿‡é‡å†™hitTestï¼šwithEventï¼šï¼Œå°±å¯ä»¥æ‹¦æˆªäº‹ä»¶çš„ä¼ é€’è¿‡ç¨‹ï¼Œæƒ³è®©è°å¤„ç†äº‹ä»¶è°å°±å¤„ç†äº‹ä»¶ã€‚</li>
</ul>
<p>äº‹ä»¶ä¼ é€’ç»™è°ï¼Œå°±ä¼šè°ƒç”¨è°çš„hitTest:withEvent:æ–¹æ³•ã€‚<br><code>æ³¨ æ„</code>ï¼šå¦‚æœhitTest:withEvent:æ–¹æ³•ä¸­è¿”å›nilï¼Œé‚£ä¹ˆè°ƒç”¨è¯¥æ–¹æ³•çš„æ§ä»¶æœ¬èº«å’Œå…¶å­æ§ä»¶éƒ½ä¸æ˜¯æœ€åˆé€‚çš„viewï¼Œä¹Ÿå°±æ˜¯åœ¨è‡ªå·±èº«ä¸Šæ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„viewã€‚é‚£ä¹ˆæœ€åˆé€‚çš„viewå°±æ˜¯è¯¥æ§ä»¶çš„çˆ¶æ§ä»¶ã€‚<br><strong>æ‰€ä»¥äº‹ä»¶çš„ä¼ é€’é¡ºåºæ˜¯è¿™æ ·çš„ï¼š</strong><br>ã€€ã€€äº§ç”Ÿè§¦æ‘¸äº‹ä»¶-&gt;UIApplicationäº‹ä»¶é˜Ÿåˆ—-&gt;[UIWindow hitTest:withEvent:]-&gt;è¿”å›<strong>æ›´åˆé€‚</strong>çš„view-&gt;[å­æ§ä»¶ hitTest:withEvent:]-&gt;è¿”å›<strong>æœ€åˆé€‚</strong>çš„view</p>
<p><strong>äº‹ä»¶ä¼ é€’ç»™çª—å£æˆ–æ§ä»¶çš„åï¼Œå°±è°ƒç”¨hitTest:withEvent:æ–¹æ³•å¯»æ‰¾æ›´åˆé€‚çš„viewã€‚æ‰€ä»¥æ˜¯ï¼Œå…ˆä¼ é€’äº‹ä»¶ï¼Œå†æ ¹æ®äº‹ä»¶åœ¨è‡ªå·±èº«ä¸Šæ‰¾æ›´åˆé€‚çš„viewã€‚</strong><br><strong>ä¸ç®¡å­æ§ä»¶æ˜¯ä¸æ˜¯æœ€åˆé€‚çš„viewï¼Œç³»ç»Ÿé»˜è®¤éƒ½è¦å…ˆæŠŠäº‹ä»¶ä¼ é€’ç»™å­æ§ä»¶ï¼Œç»è¿‡å­æ§ä»¶è°ƒç”¨å­æ§ä»¶è‡ªå·±çš„hitTest:withEvent:æ–¹æ³•éªŒè¯åæ‰çŸ¥é“æœ‰æ²¡æœ‰æ›´åˆé€‚çš„viewã€‚å³ä¾¿çˆ¶æ§ä»¶æ˜¯æœ€åˆé€‚çš„viewäº†ï¼Œå­æ§ä»¶çš„hitTest:withEvent:æ–¹æ³•è¿˜æ˜¯ä¼šè°ƒç”¨ï¼Œä¸ç„¶æ€ä¹ˆçŸ¥é“æœ‰æ²¡æœ‰æ›´åˆé€‚çš„ï¼å³ï¼Œå¦‚æœç¡®å®šæœ€ç»ˆçˆ¶æ§ä»¶æ˜¯æœ€åˆé€‚çš„viewï¼Œé‚£ä¹ˆè¯¥çˆ¶æ§ä»¶çš„å­æ§ä»¶çš„hitTest:withEvent:æ–¹æ³•ä¹Ÿæ˜¯ä¼šè¢«è°ƒç”¨çš„ã€‚</strong><br><strong>æŠ€å·§ï¼š</strong>æƒ³è®©è°æˆä¸ºæœ€åˆé€‚çš„viewå°±é‡å†™è°è‡ªå·±çš„çˆ¶æ§ä»¶çš„hitTest:withEvent:æ–¹æ³•è¿”å›æŒ‡å®šçš„å­æ§ä»¶ï¼Œæˆ–è€…é‡å†™è‡ªå·±çš„hitTest:withEvent:æ–¹æ³• return selfã€‚ä½†æ˜¯ï¼Œ<strong>å»ºè®®åœ¨çˆ¶æ§ä»¶çš„hitTest:withEvent:ä¸­è¿”å›å­æ§ä»¶ä½œä¸ºæœ€åˆé€‚çš„viewï¼</strong></p>
<p><strong>åŸå› </strong>åœ¨äºåœ¨è‡ªå·±çš„hitTest:withEvent:æ–¹æ³•ä¸­è¿”å›è‡ªå·±æœ‰æ—¶å€™ä¼šå‡ºç°é—®é¢˜ã€‚å› ä¸ºä¼šå­˜åœ¨è¿™ä¹ˆä¸€ç§æƒ…å†µï¼šå½“éå†å­æ§ä»¶æ—¶ï¼Œå¦‚æœè§¦æ‘¸ç‚¹ä¸åœ¨å­æ§ä»¶Aè‡ªå·±èº«ä¸Šè€Œæ˜¯åœ¨å­æ§ä»¶Bèº«ä¸Šï¼Œè¿˜è¦è¦æ±‚è¿”å›å­æ§ä»¶Aä½œä¸ºæœ€åˆé€‚çš„viewï¼Œé‡‡ç”¨è¿”å›è‡ªå·±çš„æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´è¿˜æ²¡æœ‰æ¥å¾—åŠéå†Aè‡ªå·±ï¼Œå°±æœ‰å¯èƒ½å·²ç»éå†äº†ç‚¹çœŸæ­£æ‰€åœ¨çš„viewï¼Œä¹Ÿå°±æ˜¯Bã€‚è¿™å°±å¯¼è‡´äº†è¿”å›çš„ä¸æ˜¯è‡ªå·±è€Œæ˜¯è§¦æ‘¸ç‚¹çœŸæ­£æ‰€åœ¨çš„viewã€‚æ‰€ä»¥è¿˜æ˜¯å»ºè®®åœ¨çˆ¶æ§ä»¶çš„hitTest:withEvent:ä¸­è¿”å›å­æ§ä»¶ä½œä¸ºæœ€åˆé€‚çš„viewï¼<br><strong>ä¾‹å¦‚ï¼š</strong>whiteViewæœ‰redViewå’ŒgreenViewä¸¤ä¸ªå­æ§ä»¶ã€‚redViewå…ˆæ·»åŠ ï¼ŒgreenViewåæ·»åŠ ã€‚å¦‚æœè¦æ±‚æ— è®ºç‚¹å‡»é‚£é‡Œéƒ½è¦è®©redViewä½œä¸ºæœ€åˆé€‚çš„viewï¼ˆæŠŠäº‹ä»¶äº¤ç»™redViewæ¥å¤„ç†ï¼‰é‚£ä¹ˆåªèƒ½åœ¨whiteViewçš„hitTest:withEvent:æ–¹æ³•ä¸­return self.subViews[0];è¿™ç§æƒ…å†µä¸‹åœ¨redViewçš„hitTest:withEvent:æ–¹æ³•ä¸­return self;æ˜¯ä¸å¥½ä½¿çš„ï¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡ŒredViewæ˜¯whiteViewçš„ç¬¬0ä¸ªå­æ§ä»¶</span><br><span class="line">#import &quot;redView.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation redView</span><br><span class="line">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123; </span><br><span class="line">   return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; </span><br><span class="line">   NSLog(@&quot;red-touch&quot;);</span><br><span class="line">&#125;@end</span><br><span class="line">// æˆ–è€…</span><br><span class="line">#import &quot;whiteView.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation whiteView</span><br><span class="line">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123; </span><br><span class="line">   return self.subviews[0];</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; </span><br><span class="line">   NSLog(@&quot;white-touch&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><strong>ç‰¹æ®Šæƒ…å†µï¼š</strong><br>è°éƒ½ä¸èƒ½å¤„ç†äº‹ä»¶ï¼Œçª—å£ä¹Ÿä¸èƒ½å¤„ç†ã€‚</p>
<ul>
<li>é‡å†™windowçš„hitTestï¼šwithEventï¼šæ–¹æ³•return nil</li>
</ul>
<p>åªèƒ½æœ‰çª—å£å¤„ç†äº‹ä»¶ã€‚</p>
<ul>
<li>æ§åˆ¶å™¨çš„viewçš„hitTestï¼šwithEventï¼šæ–¹æ³•return nilæˆ–è€…windowçš„hitTestï¼šwithEventï¼šæ–¹æ³•return self</li>
</ul>
<p><strong>return nilçš„å«ä¹‰ï¼š</strong><br>hitTestï¼šwithEventï¼šä¸­return nilçš„æ„æ€æ˜¯è°ƒç”¨å½“å‰hitTestï¼šwithEventï¼šæ–¹æ³•çš„viewä¸æ˜¯åˆé€‚çš„viewï¼Œå­æ§ä»¶ä¹Ÿä¸æ˜¯åˆé€‚çš„viewã€‚å¦‚æœåŒçº§çš„å…„å¼Ÿæ§ä»¶ä¹Ÿæ²¡æœ‰åˆé€‚çš„viewï¼Œé‚£ä¹ˆæœ€åˆé€‚çš„viewå°±æ˜¯çˆ¶æ§ä»¶ã€‚</p>
<p>å¯»æ‰¾æœ€åˆé€‚çš„viewåº•å±‚å‰–æä¹‹hitTestï¼šwithEventï¼šæ–¹æ³•åº•å±‚åšæ³•<br>/<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> hitTest:withEvent:æ–¹æ³•åº•å±‚å®ç°<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;WSWindow.h&quot;</span><br><span class="line">@implementation WSWindow</span><br><span class="line">// ä»€ä¹ˆæ—¶å€™è°ƒç”¨:åªè¦äº‹ä»¶ä¸€ä¼ é€’ç»™ä¸€ä¸ªæ§ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ§ä»¶å°±ä¼šè°ƒç”¨è‡ªå·±çš„è¿™ä¸ªæ–¹æ³•</span><br><span class="line">// ä½œç”¨:å¯»æ‰¾å¹¶è¿”å›æœ€åˆé€‚çš„view</span><br><span class="line">// UIApplication -&gt; [UIWindow hitTest:withEvent:]å¯»æ‰¾æœ€åˆé€‚çš„viewå‘Šè¯‰ç³»ç»Ÿ</span><br><span class="line">// point:å½“å‰æ‰‹æŒ‡è§¦æ‘¸çš„ç‚¹</span><br><span class="line">// point:æ˜¯æ–¹æ³•è°ƒç”¨è€…åæ ‡ç³»ä¸Šçš„ç‚¹</span><br><span class="line">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123;</span><br><span class="line">    // 1.åˆ¤æ–­ä¸‹çª—å£èƒ½å¦æ¥æ”¶äº‹ä»¶</span><br><span class="line">     if (self.userInteractionEnabled == NO || self.hidden == YES ||  self.alpha &lt;= 0.01) return nil; </span><br><span class="line">    // 2.åˆ¤æ–­ä¸‹ç‚¹åœ¨ä¸åœ¨çª—å£ä¸Š </span><br><span class="line">    // ä¸åœ¨çª—å£ä¸Š </span><br><span class="line">    if ([self pointInside:point withEvent:event] == NO) return nil; </span><br><span class="line">    // 3.ä»åå¾€å‰éå†å­æ§ä»¶æ•°ç»„ </span><br><span class="line">    int count = (int)self.subviews.count; </span><br><span class="line">    for (int i = count - 1; i &gt;= 0; i--)     &#123; </span><br><span class="line">    // è·å–å­æ§ä»¶</span><br><span class="line">    UIView *childView = self.subviews[i]; </span><br><span class="line">    // åæ ‡ç³»çš„è½¬æ¢,æŠŠçª—å£ä¸Šçš„ç‚¹è½¬æ¢ä¸ºå­æ§ä»¶ä¸Šçš„ç‚¹ </span><br><span class="line">    // æŠŠè‡ªå·±æ§ä»¶ä¸Šçš„ç‚¹è½¬æ¢æˆå­æ§ä»¶ä¸Šçš„ç‚¹ </span><br><span class="line">    CGPoint childP = [self convertPoint:point toView:childView]; </span><br><span class="line">    UIView *fitView = [childView hitTest:childP withEvent:event]; </span><br><span class="line">    if (fitView) &#123;</span><br><span class="line">    // å¦‚æœèƒ½æ‰¾åˆ°æœ€åˆé€‚çš„view </span><br><span class="line">    return fitView; </span><br><span class="line">    &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    // 4.æ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„viewï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ¯”è‡ªå·±æ›´åˆé€‚çš„view </span><br><span class="line">    return self;</span><br><span class="line">    &#125;</span><br><span class="line">    // ä½œç”¨:åˆ¤æ–­ä¸‹ä¼ å…¥è¿‡æ¥çš„ç‚¹åœ¨ä¸åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Š</span><br><span class="line">    // point:æ˜¯æ–¹æ³•è°ƒç”¨è€…åæ ‡ç³»ä¸Šçš„ç‚¹</span><br><span class="line">    //- (BOOL)pointInside:(CGPoint)point withEvent:(UIEvent *)event</span><br><span class="line">    //&#123;</span><br><span class="line">    // return NO;</span><br><span class="line">    //&#125;</span><br><span class="line">    - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; </span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">    &#125;</span><br><span class="line">    @end</span><br></pre></td></tr></table></figure>
<p><strong>hit:withEvent:æ–¹æ³•åº•å±‚ä¼šè°ƒç”¨pointInside:withEvent:æ–¹æ³•åˆ¤æ–­ç‚¹åœ¨ä¸åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Šã€‚</strong></p>
<h4 id="3-3-1-2-pointInside-withEvent-æ–¹æ³•"><a href="#3-3-1-2-pointInside-withEvent-æ–¹æ³•" class="headerlink" title="3.3.1.2.pointInside:withEvent:æ–¹æ³•"></a>3.3.1.2.pointInside:withEvent:æ–¹æ³•</h4><p>pointInside:withEvent:æ–¹æ³•åˆ¤æ–­ç‚¹åœ¨ä¸åœ¨å½“å‰viewä¸Šï¼ˆæ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Šï¼‰å¦‚æœè¿”å›YESï¼Œä»£è¡¨ç‚¹åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Š;è¿”å›NOä»£è¡¨ç‚¹ä¸åœ¨æ–¹æ³•è°ƒç”¨è€…çš„åæ ‡ç³»ä¸Šï¼Œé‚£ä¹ˆæ–¹æ³•è°ƒç”¨è€…ä¹Ÿå°±ä¸èƒ½å¤„ç†äº‹ä»¶ã€‚</p>
<h4 id="3-3-2-ç»ƒä¹ "><a href="#3-3-2-ç»ƒä¹ " class="headerlink" title="3.3.2.ç»ƒä¹ "></a>3.3.2.ç»ƒä¹ </h4><p>å±å¹•ä¸Šç°åœ¨æœ‰ä¸€ä¸ªviewAï¼ŒviewAæœ‰ä¸€ä¸ªsubViewå«åšviewBï¼Œè¦æ±‚è§¦æ‘¸viewBæ—¶,viewBä¼šå“åº”äº‹ä»¶ï¼Œè€Œè§¦æ‘¸viewAæœ¬èº«ï¼Œä¸ä¼šå“åº”è¯¥äº‹ä»¶ã€‚å¦‚ä½•å®ç°ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123;</span><br><span class="line">    UIView *view = [super hitTest:point withEvent:event];</span><br><span class="line">    if (view == self) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="äº‹ä»¶çš„å“åº”"><a href="#äº‹ä»¶çš„å“åº”" class="headerlink" title="äº‹ä»¶çš„å“åº”"></a>äº‹ä»¶çš„å“åº”</h2><h3 id="è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹"><a href="#è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹" class="headerlink" title="è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹"></a>è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹</h3><p>1&gt;ç”¨æˆ·ç‚¹å‡»å±å¹•åäº§ç”Ÿçš„ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„ä¼ é€’è¿‡ç¨‹åï¼Œä¼šæ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾æ§ä»¶æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶2&gt;æ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾æ§ä»¶åï¼Œå°±ä¼šè°ƒç”¨æ§ä»¶çš„touchesæ–¹æ³•æ¥ä½œå…·ä½“çš„äº‹ä»¶å¤„ç†touchesBeganâ€¦touchesMovedâ€¦touchedEndedâ€¦3&gt;è¿™äº›touchesæ–¹æ³•çš„é»˜è®¤åšæ³•æ˜¯å°†äº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å‘ä¸Šä¼ é€’ï¼ˆä¹Ÿå°±æ˜¯touchæ–¹æ³•é»˜è®¤ä¸å¤„ç†äº‹ä»¶ï¼Œåªä¼ é€’äº‹ä»¶ï¼‰ï¼Œå°†äº‹ä»¶äº¤ç»™ä¸Šä¸€ä¸ªå“åº”è€…è¿›è¡Œå¤„ç†</p>
<h3 id="å“åº”è€…é“¾æ¡ç¤ºæ„å›¾"><a href="#å“åº”è€…é“¾æ¡ç¤ºæ„å›¾" class="headerlink" title="å“åº”è€…é“¾æ¡ç¤ºæ„å›¾"></a>å“åº”è€…é“¾æ¡ç¤ºæ„å›¾</h3><p><strong>å“åº”è€…é“¾æ¡ï¼š</strong>åœ¨iOSç¨‹åºä¸­æ— è®ºæ˜¯æœ€åé¢çš„UIWindowè¿˜æ˜¯æœ€å‰é¢çš„æŸä¸ªæŒ‰é’®ï¼Œå®ƒä»¬çš„æ‘†æ”¾æ˜¯æœ‰å‰åå…³ç³»çš„ï¼Œä¸€ä¸ªæ§ä»¶å¯ä»¥æ”¾åˆ°å¦ä¸€ä¸ªæ§ä»¶ä¸Šé¢æˆ–ä¸‹é¢ï¼Œé‚£ä¹ˆç”¨æˆ·ç‚¹å‡»æŸä¸ªæ§ä»¶æ—¶æ˜¯è§¦å‘ä¸Šé¢çš„æ§ä»¶è¿˜æ˜¯ä¸‹é¢çš„æ§ä»¶å‘¢ï¼Œè¿™ç§å…ˆåå…³ç³»æ„æˆä¸€ä¸ªé“¾æ¡å°±å«â€œå“åº”è€…é“¾â€ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå“åº”è€…é“¾æ˜¯ç”±å¤šä¸ªå“åº”è€…å¯¹è±¡è¿æ¥èµ·æ¥çš„é“¾æ¡ã€‚åœ¨iOSä¸­å“åº”è€…é“¾çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š</p>
<p><img src="http://ovwhbnlx7.bkt.clouddn.com/1055199-2a49a16e1e483b5c.png" alt="avatar">    </p>
<p>å“åº”è€…å¯¹è±¡ï¼š</p>
<p>ä½œç”¨ï¼š</p>
<p><strong>å¦‚ä½•åˆ¤æ–­ä¸Šä¸€ä¸ªå“åº”è€…</strong></p>
<ul>
<li>1&gt; å¦‚æœå½“å‰è¿™ä¸ªviewæ˜¯æ§åˆ¶å™¨çš„view,é‚£ä¹ˆæ§åˆ¶å™¨å°±æ˜¯ä¸Šä¸€ä¸ªå“åº”è€…</li>
<li>2&gt; å¦‚æœå½“å‰è¿™ä¸ªviewä¸æ˜¯æ§åˆ¶å™¨çš„view,é‚£ä¹ˆçˆ¶æ§ä»¶å°±æ˜¯ä¸Šä¸€ä¸ªå“åº”è€…</li>
</ul>
<p><strong>å“åº”è€…é“¾çš„äº‹ä»¶ä¼ é€’è¿‡ç¨‹:</strong></p>
<ul>
<li>1&gt;å¦‚æœå½“å‰viewæ˜¯æ§åˆ¶å™¨çš„viewï¼Œé‚£ä¹ˆæ§åˆ¶å™¨å°±æ˜¯ä¸Šä¸€ä¸ªå“åº”è€…ï¼Œäº‹ä»¶å°±ä¼ é€’ç»™æ§åˆ¶å™¨ï¼›å¦‚æœå½“å‰viewä¸æ˜¯æ§åˆ¶å™¨çš„viewï¼Œé‚£ä¹ˆçˆ¶è§†å›¾å°±æ˜¯å½“å‰viewçš„ä¸Šä¸€ä¸ªå“åº”è€…ï¼Œäº‹ä»¶å°±ä¼ é€’ç»™å®ƒçš„çˆ¶è§†å›¾</li>
<li>2&gt;åœ¨è§†å›¾å±‚æ¬¡ç»“æ„çš„æœ€é¡¶çº§è§†å›¾ï¼Œå¦‚æœä¹Ÿä¸èƒ½å¤„ç†æ”¶åˆ°çš„äº‹ä»¶æˆ–æ¶ˆæ¯ï¼Œåˆ™å…¶å°†äº‹ä»¶æˆ–æ¶ˆæ¯ä¼ é€’ç»™windowå¯¹è±¡è¿›è¡Œå¤„ç†</li>
<li>3&gt;å¦‚æœwindowå¯¹è±¡ä¹Ÿä¸å¤„ç†ï¼Œåˆ™å…¶å°†äº‹ä»¶æˆ–æ¶ˆæ¯ä¼ é€’ç»™UIApplicationå¯¹è±¡</li>
<li>4&gt;å¦‚æœUIApplicationä¹Ÿä¸èƒ½å¤„ç†è¯¥äº‹ä»¶æˆ–æ¶ˆæ¯ï¼Œåˆ™å°†å…¶ä¸¢å¼ƒ</li>
</ul>
<p><strong>äº‹ä»¶å¤„ç†çš„æ•´ä¸ªæµç¨‹æ€»ç»“ï¼š</strong><br>ã€€ã€€1.è§¦æ‘¸å±å¹•äº§ç”Ÿè§¦æ‘¸äº‹ä»¶åï¼Œè§¦æ‘¸äº‹ä»¶ä¼šè¢«æ·»åŠ åˆ°ç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼ˆå³ï¼Œé¦–å…ˆæ¥æ”¶åˆ°äº‹ä»¶çš„æ˜¯UIApplicationï¼‰ã€‚<br>ã€€ã€€2.UIApplicationä¼šä»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼ŒæŠŠäº‹ä»¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰ã€‚<br>ã€€ã€€3.ä¸»çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æ„ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾æ¥å¤„ç†è§¦æ‘¸äº‹ä»¶ã€‚ï¼ˆè‡³æ­¤ï¼Œç¬¬ä¸€æ­¥å·²å®Œæˆ)<br>ã€€ã€€4.æœ€åˆé€‚çš„viewä¼šè°ƒç”¨è‡ªå·±çš„touchesæ–¹æ³•å¤„ç†äº‹ä»¶<br>ã€€ã€€5.touchesé»˜è®¤åšæ³•æ˜¯æŠŠäº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å‘ä¸ŠæŠ›ã€‚<br>touchesçš„é»˜è®¤åšæ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;WSView.h&quot;</span><br><span class="line">@implementation WSView </span><br><span class="line">//åªè¦ç‚¹å‡»æ§ä»¶,å°±ä¼šè°ƒç”¨touchBegin,å¦‚æœæ²¡æœ‰é‡å†™è¿™ä¸ªæ–¹æ³•,è‡ªå·±å¤„ç†ä¸äº†è§¦æ‘¸äº‹ä»¶</span><br><span class="line">// ä¸Šä¸€ä¸ªå“åº”è€…å¯èƒ½æ˜¯çˆ¶æ§ä»¶</span><br><span class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; </span><br><span class="line">// é»˜è®¤ä¼šæŠŠäº‹ä»¶ä¼ é€’ç»™ä¸Šä¸€ä¸ªå“åº”è€…,ä¸Šä¸€ä¸ªå“åº”è€…æ˜¯çˆ¶æ§ä»¶,äº¤ç»™çˆ¶æ§ä»¶å¤„ç†</span><br><span class="line">[super touchesBegan:touches withEvent:event]; </span><br><span class="line">// æ³¨æ„ä¸æ˜¯è°ƒç”¨çˆ¶æ§ä»¶çš„touchesæ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨çˆ¶ç±»çš„touchesæ–¹æ³•</span><br><span class="line">// superæ˜¯çˆ¶ç±» superviewæ˜¯çˆ¶æ§ä»¶ </span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><strong>äº‹ä»¶çš„ä¼ é€’ä¸å“åº”ï¼š</strong><br>1ã€å½“ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿåï¼Œäº‹ä»¶ä¼šä»çˆ¶æ§ä»¶ä¼ ç»™å­æ§ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ç”±UIApplication -&gt; UIWindow -&gt; UIView -&gt; initial view,ä»¥ä¸Šå°±æ˜¯äº‹ä»¶çš„ä¼ é€’ï¼Œä¹Ÿå°±æ˜¯å¯»æ‰¾æœ€åˆé€‚çš„viewçš„è¿‡ç¨‹ã€‚</p>
<p>2ã€æ¥ä¸‹æ¥æ˜¯äº‹ä»¶çš„å“åº”ã€‚é¦–å…ˆçœ‹initial viewèƒ½å¦å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œå¦‚æœä¸èƒ½åˆ™ä¼šå°†äº‹ä»¶ä¼ é€’ç»™å…¶ä¸Šçº§è§†å›¾ï¼ˆinital viewçš„superViewï¼‰ï¼›å¦‚æœä¸Šçº§è§†å›¾ä»ç„¶æ— æ³•å¤„ç†åˆ™ä¼šç»§ç»­å¾€ä¸Šä¼ é€’ï¼›ä¸€ç›´ä¼ é€’åˆ°è§†å›¾æ§åˆ¶å™¨view controllerï¼Œé¦–å…ˆåˆ¤æ–­è§†å›¾æ§åˆ¶å™¨çš„æ ¹è§†å›¾viewæ˜¯å¦èƒ½å¤„ç†æ­¤äº‹ä»¶ï¼›å¦‚æœä¸èƒ½åˆ™æ¥ç€åˆ¤æ–­è¯¥è§†å›¾æ§åˆ¶å™¨èƒ½å¦å¤„ç†æ­¤äº‹ä»¶ï¼Œå¦‚æœè¿˜æ˜¯ä¸èƒ½åˆ™ç»§ç»­å‘ä¸Šä¼  é€’ï¼›ï¼ˆå¯¹äºç¬¬äºŒä¸ªå›¾è§†å›¾æ§åˆ¶å™¨æœ¬èº«è¿˜åœ¨å¦ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨ä¸­ï¼Œåˆ™ç»§ç»­äº¤ç»™çˆ¶è§†å›¾æ§åˆ¶å™¨çš„æ ¹è§†å›¾ï¼Œå¦‚æœæ ¹è§†å›¾ä¸èƒ½å¤„ç†åˆ™äº¤ç»™çˆ¶è§†å›¾æ§åˆ¶å™¨å¤„ç†ï¼‰ï¼›ä¸€ç›´åˆ° windowï¼Œå¦‚æœwindowè¿˜æ˜¯ä¸èƒ½å¤„ç†æ­¤äº‹ä»¶åˆ™ç»§ç»­äº¤ç»™applicationå¤„ç†ï¼Œå¦‚æœæœ€åapplicationè¿˜æ˜¯ä¸èƒ½å¤„ç†æ­¤äº‹ä»¶åˆ™å°†å…¶ä¸¢å¼ƒ</p>
<p>3ã€åœ¨äº‹ä»¶çš„å“åº”ä¸­ï¼Œå¦‚æœæŸä¸ªæ§ä»¶å®ç°äº†touchesâ€¦æ–¹æ³•ï¼Œåˆ™è¿™ä¸ªäº‹ä»¶å°†ç”±è¯¥æ§ä»¶æ¥æ¥å—ï¼Œå¦‚æœè°ƒç”¨äº†[supertouchesâ€¦.];å°±ä¼šå°†äº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å¾€ä¸Šä¼ é€’ï¼Œä¼ é€’ç»™ä¸Šä¸€ä¸ªå“åº”è€…ï¼›æ¥ç€å°±ä¼šè°ƒç”¨ä¸Šä¸€ä¸ªå“åº”è€…çš„touchesâ€¦.æ–¹æ³•</p>
<p><strong>å¦‚ä½•åšåˆ°ä¸€ä¸ªäº‹ä»¶å¤šä¸ªå¯¹è±¡å¤„ç†ï¼š</strong><br>å› ä¸ºç³»ç»Ÿé»˜è®¤åšæ³•æ˜¯æŠŠäº‹ä»¶ä¸ŠæŠ›ç»™çˆ¶æ§ä»¶ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡é‡å†™è‡ªå·±çš„touchesæ–¹æ³•å’Œçˆ¶æ§ä»¶çš„touchesæ–¹æ³•æ¥è¾¾åˆ°ä¸€ä¸ªäº‹ä»¶å¤šä¸ªå¯¹è±¡å¤„ç†çš„ç›®çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event&#123; </span><br><span class="line">// 1.è‡ªå·±å…ˆå¤„ç†äº‹ä»¶...</span><br><span class="line">NSLog(@&quot;do somthing...&quot;);</span><br><span class="line">// 2.å†è°ƒç”¨ç³»ç»Ÿçš„é»˜è®¤åšæ³•ï¼Œå†æŠŠäº‹ä»¶äº¤ç»™ä¸Šä¸€ä¸ªå“åº”è€…å¤„ç†</span><br><span class="line">[super touchesBegan:touches withEvent:event]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>äº‹ä»¶çš„ä¼ é€’å’Œå“åº”çš„åŒºåˆ«ï¼š</strong><br>äº‹ä»¶çš„ä¼ é€’æ˜¯ä»ä¸Šåˆ°ä¸‹ï¼ˆçˆ¶æ§ä»¶åˆ°å­æ§ä»¶ï¼‰ï¼Œäº‹ä»¶çš„å“åº”æ˜¯ä»ä¸‹åˆ°ä¸Šï¼ˆé¡ºç€å“åº”è€…é“¾æ¡å‘ä¸Šä¼ é€’ï¼šå­æ§ä»¶åˆ°çˆ¶æ§ä»¶ã€‚</p>
<p><a href="https://www.jianshu.com/p/2e074db792ba" target="_blank" rel="noopener">è½¬è‡ªVVæœ¨å…¬å­ï¼ˆç®€ä¹¦ä½œè€…ï¼‰</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/iOSé¢è¯•/2018/09/11/UITableViewç›¸å…³/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sun Lei">
      <meta itemprop="description" content="åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Man Tou Pu's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/11/UITableViewç›¸å…³/" itemprop="url">
                  UITableViewç›¸å…³
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-11 17:11:06" itemprop="dateCreated datePublished" datetime="2018-09-11T17:11:06+08:00">2018-09-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2018-09-13 10:57:06" itemprop="dateModified" datetime="2018-09-13T10:57:06+08:00">2018-09-13</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/UIè§†å›¾/" itemprop="url" rel="index"><span itemprop="name">UIè§†å›¾</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…ˆæ¥ç‚¹æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œ</p>
<ul>
<li><p>å¡é¡¿&amp;æ‰å¸§</p>
</li>
<li><ul>
<li><p>æ¦‚å¿µï¼šåœ¨è§„å®šçš„16.7msä¹‹å†…ï¼Œä¸‹ä¸€å¸§VSyncä¿¡å·åˆ°æ¥ä¹‹å‰ï¼Œå¹¶æ²¡æœ‰CPUå’ŒGPUå…±åŒå®Œæˆä¸‹ä¸€å¸§ç”»é¢çš„åˆæˆï¼Œäºæ˜¯å°±ä¼šé€ æˆå¡é¡¿å’Œæ‰å¸§</p>
</li>
<li><p>æ»‘åŠ¨ä¼˜åŒ–æ–¹æ¡ˆ</p>
</li>
<li><ul>
<li><p>CPU</p>
</li>
<li><ul>
<li>å¯¹è±¡åˆ›å»ºã€è°ƒæ•´ã€é”€æ¯</li>
<li>é¢„æ’ç‰ˆï¼ˆå¸ƒå±€è®¡ç®—ã€æ–‡æœ¬è®¡ç®—ï¼‰</li>
<li>é¢„æ¸²æŸ“ï¼ˆæ–‡æœ¬ç­‰å¼‚æ­¥ç»˜åˆ¶ï¼Œå›¾ç‰‡ç¼–è§£ç ç­‰ï¼‰</li>
</ul>
</li>
<li><p>GPU</p>
</li>
<li><ul>
<li>çº¹ç†æ¸²æŸ“</li>
<li>è§†å›¾æ··åˆ  </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>ç¦»å±æ¸²æŸ“</p>
</li>
<li><ul>
<li><p>æ¦‚å¿µï¼šå½“æˆ‘ä»¬å¤„ç†å›¾å±‚çš„å±æ€§åœ¨è¢«æŒ‡å®šä¸ºæœªè¢«é¢„åˆæˆä¹‹å‰ä¸èƒ½ç›´æ¥åœ¨å±å¹•ä¸Šæ˜¾ç¤ºï¼Œå°±è§¦å‘äº†ç¦»å±æ¸²æŸ“ã€‚ç¦»å±æ¸²æŸ“çš„æ¦‚å¿µèµ·æºä¸GPUå±‚é¢ï¼ŒæŒ‡çš„æ˜¯GPUåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–æ–°å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œ</p>
</li>
<li><p>ä½•æ—¶ä¼šè§¦å‘</p>
</li>
<li><ul>
<li>åœ†è§’ï¼ˆå½“å’ŒmaskToBoundsä¸€èµ·ä½¿ç”¨æ—¶ï¼‰</li>
<li>å›¾å±‚è’™ç‰ˆ</li>
<li>é˜´å½±</li>
<li>å…‰æ …åŒ–</li>
</ul>
</li>
<li><p>ä¸ºä½•è¦é¿å…</p>
</li>
<li><ul>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒGPUé¢å¤–çš„å¼€é”€</li>
<li>åˆ›å»ºæ–°çš„æ¸²æŸ“ç¼“å†²åŒºï¼Œå†…å­˜æŸè€—</li>
<li>é«˜çº§å›ç­”ï¼šè§¦å‘ç¦»å±æ¸²æŸ“ä¼šå¢åŠ GPUçš„å·¥ä½œé‡ï¼Œè€Œå¢åŠ äº†GPUçš„å·¥ä½œé‡å¾ˆæœ‰å¯èƒ½å¯¼è‡´CPUå’ŒGPUçš„å·¥ä½œæ€»è€—æ—¶è¶…è¿‡äº†16.67msï¼Œæœ‰å¯èƒ½å¯¼è‡´UIçš„å¡é¡¿å’Œæ‰å¸§</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="UITableViewæ€§èƒ½ä¼˜åŒ–"><a href="#UITableViewæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="UITableViewæ€§èƒ½ä¼˜åŒ–"></a>UITableViewæ€§èƒ½ä¼˜åŒ–</h1><p>å½“è·å–åˆ° API JSON æ•°æ®åï¼Œæˆ‘ä¼šæŠŠæ¯æ¡ Cell éœ€è¦çš„æ•°æ®éƒ½åœ¨åå°çº¿ç¨‹è®¡ç®—å¹¶å°è£…ä¸ºä¸€ä¸ªå¸ƒå±€å¯¹è±¡ CellLayoutã€‚CellLayout åŒ…å«æ‰€æœ‰æ–‡æœ¬çš„ CoreText æ’ç‰ˆç»“æœã€Cell å†…éƒ¨æ¯ä¸ªæ§ä»¶çš„é«˜åº¦ã€Cell çš„æ•´ä½“é«˜åº¦ã€‚æ¯ä¸ª CellLayout çš„å†…å­˜å ç”¨å¹¶ä¸å¤šï¼Œæ‰€ä»¥å½“ç”Ÿæˆåï¼Œå¯ä»¥å…¨éƒ¨ç¼“å­˜åˆ°å†…å­˜ï¼Œä»¥ä¾›ç¨åä½¿ç”¨ã€‚è¿™æ ·ï¼ŒTableView åœ¨è¯·æ±‚å„ä¸ªé«˜åº¦å‡½æ•°æ—¶ï¼Œä¸ä¼šæ¶ˆè€—ä»»ä½•å¤šä½™è®¡ç®—é‡ï¼›å½“æŠŠ CellLayout è®¾ç½®åˆ° Cell å†…éƒ¨æ—¶ï¼ŒCell å†…éƒ¨ä¹Ÿä¸ç”¨å†è®¡ç®—å¸ƒå±€äº†ã€‚</p>
<h2 id="ç¼“å­˜é«˜åº¦"><a href="#ç¼“å­˜é«˜åº¦" class="headerlink" title="ç¼“å­˜é«˜åº¦"></a>ç¼“å­˜é«˜åº¦</h2><p>å¯¹äºé€šå¸¸çš„ TableView æ¥è¯´ï¼Œæå‰åœ¨åå°è®¡ç®—å¥½å¸ƒå±€ç»“æœæ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–ç‚¹ã€‚ä¸ºäº†è¾¾åˆ°æœ€é«˜æ€§èƒ½ï¼Œä½ å¯èƒ½éœ€è¦ç‰ºç‰²ä¸€äº›å¼€å‘é€Ÿåº¦ï¼Œä¸è¦ç”¨ Autolayout ç­‰æŠ€æœ¯ï¼Œå°‘ç”¨ UILabel ç­‰æ–‡æœ¬æ§ä»¶ã€‚ä½†å¦‚æœä½ å¯¹æ€§èƒ½çš„è¦æ±‚å¹¶ä¸é‚£ä¹ˆé«˜ï¼Œå¯ä»¥å°è¯•ç”¨ TableView çš„é¢„ä¼°é«˜åº¦çš„åŠŸèƒ½ï¼Œå¹¶æŠŠæ¯ä¸ª Cell é«˜åº¦ç¼“å­˜ä¸‹æ¥ã€‚è¿™é‡Œæœ‰ä¸ªæ¥è‡ªç™¾åº¦çŸ¥é“å›¢é˜Ÿçš„å¼€æºé¡¹ç›®å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¸®ä½ å®ç°è¿™ä¸€ç‚¹ï¼š<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell/" target="_blank" rel="noopener">FDTemplateLayoutCell</a>ã€‚</p>
<p><a href="https://www.jianshu.com/p/64f0e1557562" target="_blank" rel="noopener">tableviewcellé«˜åº¦ç¼“å­˜å…·ä½“å®ç°æ–¹å¼</a></p>
<h2 id="é¢„æ¸²æŸ“"><a href="#é¢„æ¸²æŸ“" class="headerlink" title="é¢„æ¸²æŸ“"></a>é¢„æ¸²æŸ“</h2><p>å¾®åšçš„å¤´åƒåœ¨æŸæ¬¡æ”¹ç‰ˆä¸­æ¢æˆäº†åœ†å½¢ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿè·Ÿè¿›äº†ä¸€ä¸‹ã€‚å½“å¤´åƒä¸‹è½½ä¸‹æ¥åï¼Œæˆ‘ä¼šåœ¨åå°çº¿ç¨‹å°†å¤´åƒé¢„å…ˆæ¸²æŸ“ä¸ºåœ†å½¢å¹¶å•ç‹¬ä¿å­˜åˆ°ä¸€ä¸ª ImageCache ä¸­å»ã€‚</p>
<p>å¯¹äº TableView æ¥è¯´ï¼ŒCell å†…å®¹çš„ç¦»å±æ¸²æŸ“ä¼šå¸¦æ¥è¾ƒå¤§çš„ GPU æ¶ˆè€—ã€‚åœ¨ Twitter Demo ä¸­ï¼Œæˆ‘ä¸ºäº†å›¾çœäº‹å„¿ç”¨åˆ°äº†ä¸å°‘ layer çš„åœ†è§’å±æ€§ï¼Œä½ å¯ä»¥åœ¨ä½æ€§èƒ½çš„è®¾å¤‡ï¼ˆæ¯”å¦‚ iPad 3ï¼‰ä¸Šå¿«é€Ÿæ»‘åŠ¨ä¸€ä¸‹è¿™ä¸ªåˆ—è¡¨ï¼Œèƒ½æ„Ÿå—åˆ°è™½ç„¶åˆ—è¡¨å¹¶æ²¡æœ‰è¾ƒå¤§çš„å¡é¡¿ï¼Œä½†æ˜¯æ•´ä½“çš„å¹³å‡å¸§æ•°é™äº†ä¸‹æ¥ã€‚ç”¨ Instument æŸ¥çœ‹æ—¶èƒ½å¤Ÿçœ‹åˆ° GPU å·²ç»æ»¡è´Ÿè·è¿è½¬ï¼Œè€Œ CPU å´æ¯”è¾ƒæ¸…é—²ã€‚ä¸ºäº†é¿å…ç¦»å±æ¸²æŸ“ï¼Œä½ åº”å½“å°½é‡é¿å…ä½¿ç”¨ layer çš„ borderã€cornerã€shadowã€mask ç­‰æŠ€æœ¯ï¼Œè€Œå°½é‡åœ¨åå°çº¿ç¨‹é¢„å…ˆç»˜åˆ¶å¥½å¯¹åº”å†…å®¹ã€‚</p>
<h3 id="ç¦»å±æ¸²æŸ“"><a href="#ç¦»å±æ¸²æŸ“" class="headerlink" title="ç¦»å±æ¸²æŸ“"></a>ç¦»å±æ¸²æŸ“</h3><p>â€‹    åœ¨ä½¿ç”¨åœ†è§’ã€é˜´å½±å’Œé®ç½©ç­‰è§†å›¾åŠŸèƒ½çš„æ—¶å€™ï¼Œå›¾å±‚å±æ€§çš„æ··åˆä½“è¢«æŒ‡å®šä¸ºåœ¨æœªé¢„åˆæˆä¹‹å‰ä¸èƒ½ç›´æ¥åœ¨å±å¹•ä¸­ç»˜åˆ¶ï¼Œæ‰€æœ‰å°±éœ€è¦åœ¨å±å¹•å¤–çš„ä¸Šä¸‹æ–‡ä¸­æ¸²æŸ“ï¼Œå³ç¦»å±æ¸²æŸ“ã€‚</p>
<h4 id="ç¦»å±æ¸²æŸ“äº§ç”ŸåŸå› "><a href="#ç¦»å±æ¸²æŸ“äº§ç”ŸåŸå› " class="headerlink" title="ç¦»å±æ¸²æŸ“äº§ç”ŸåŸå› "></a>ç¦»å±æ¸²æŸ“äº§ç”ŸåŸå› </h4><p>ç¦»å±æ¸²æŸ“ä¹‹æ‰€ä»¥ä¼šç‰¹åˆ«æ¶ˆè€—æ€§èƒ½ï¼Œæ˜¯å› ä¸ºè¦åˆ›å»ºä¸€ä¸ªå±å¹•å¤–çš„ç¼“å†²åŒºï¼Œç„¶åä»å½“å±ç¼“å†²åŒºåˆ‡æ¢åˆ°å±å¹•å¤–çš„ç¼“å†²åŒºï¼Œç„¶åå†å®Œæˆæ¸²æŸ“ï¼›å…¶ä¸­ï¼Œåˆ›å»ºç¼“å†²åŒºå’Œåˆ‡æ¢ä¸Šä¸‹æ–‡æœ€æ¶ˆè€—æ€§èƒ½ï¼Œè€Œç»˜åˆ¶å…¶å®ä¸æ˜¯æ€§èƒ½æŸè€—çš„ä¸»è¦åŸå› ã€‚</p>
<p>è®¾ç½®äº†ä»¥ä¸‹å±æ€§æ—¶ï¼Œå°±ä¼šè§¦å‘ç¦»å±ç»˜åˆ¶ï¼š</p>
<ul>
<li><p>shouldRasterizeï¼ˆå…‰æ …åŒ–ï¼‰</p>
</li>
<li><p>masksï¼ˆé®ç½©ï¼‰</p>
</li>
<li><p>shadowsï¼ˆé˜´å½±ï¼‰</p>
</li>
<li><p>edge antialiasingï¼ˆæŠ—é”¯é½¿ï¼‰</p>
</li>
<li><p>group opacityï¼ˆä¸é€æ˜ï¼‰</p>
</li>
<li><p>å¤æ‚å½¢çŠ¶è®¾ç½®åœ†è§’ç­‰</p>
</li>
<li><p>æ¸å˜</p>
<h4 id="å…‰æ …åŒ–"><a href="#å…‰æ …åŒ–" class="headerlink" title="å…‰æ …åŒ–"></a>å…‰æ …åŒ–</h4><p>å…‰æ …åŒ–æ¦‚å¿µ:å°†å›¾è½¬åŒ–ä¸ºä¸€ä¸ªä¸ªæ …æ ¼ç»„æˆçš„å›¾è±¡ã€‚ å…‰æ …åŒ–ç‰¹ç‚¹:æ¯ä¸ªå…ƒç´ å¯¹åº”å¸§ç¼“å†²åŒºä¸­çš„ä¸€åƒç´ ã€‚</p>
<p>â€‹</p>
<p>shouldRasterize = YESåœ¨å…¶ä»–å±æ€§è§¦å‘ç¦»å±æ¸²æŸ“çš„åŒæ—¶,ä¼šå°†å…‰æ …åŒ–åçš„å†…å®¹ç¼“å­˜èµ·æ¥,å¦‚æœå¯¹åº”çš„layeråŠå…¶sublayersæ²¡æœ‰å‘ç”Ÿæ”¹å˜,åœ¨ä¸‹ä¸€å¸§çš„æ—¶å€™å¯ä»¥ç›´æ¥å¤ç”¨ã€‚shouldRasterize = YES,è¿™å°†éšå¼çš„åˆ›å»ºä¸€ä¸ªä½å›¾,å„ç§é˜´å½±é®ç½©ç­‰æ•ˆæœä¹Ÿä¼šä¿å­˜åˆ°ä½å›¾ä¸­å¹¶ç¼“å­˜èµ·æ¥,ä»è€Œå‡å°‘æ¸²æŸ“çš„é¢‘åº¦</p>
<p>å½“ä½ ä½¿ç”¨å…‰æ …åŒ–æ—¶,ä½ å¯ä»¥å¼€å¯â€œColor Hits Green and Misses Redâ€æ¥æ£€æŸ¥è¯¥åœºæ™¯ä¸‹å…‰æ …åŒ–æ“ä½œæ˜¯å¦æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚ç»¿è‰²è¡¨ç¤ºç¼“å­˜è¢«å¤ç”¨,çº¢è‰²è¡¨ç¤ºç¼“å­˜åœ¨è¢«é‡å¤åˆ›å»ºã€‚</p>
<p>å¦‚æœå…‰æ …åŒ–çš„å±‚å˜çº¢å¾—å¤ªé¢‘ç¹é‚£ä¹ˆå…‰æ …åŒ–å¯¹ä¼˜åŒ–å¯èƒ½æ²¡æœ‰å¤šå°‘ç”¨å¤„ã€‚ä½å›¾ç¼“å­˜ä»å†…å­˜ä¸­åˆ é™¤åˆé‡æ–°åˆ›å»ºå¾—å¤ªè¿‡é¢‘ç¹,çº¢è‰²è¡¨æ˜ç¼“å­˜é‡å»ºå¾—å¤ªè¿Ÿã€‚å¯ä»¥é’ˆå¯¹æ€§çš„é€‰æ‹©æŸä¸ªè¾ƒå°è€Œè¾ƒæ·±çš„å±‚ç»“æ„è¿›è¡Œå…‰æ …åŒ–,æ¥å°è¯•å‡å°‘æ¸²æŸ“æ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬ç»å¸¸çš„TableViewCell,å› ä¸ºTableViewCellçš„é‡ç»˜æ˜¯å¾ˆé¢‘ç¹çš„(å› ä¸ºCellçš„å¤ç”¨),å¦‚æœCellçš„å†…å®¹ä¸æ–­å˜åŒ–,åˆ™Celléœ€è¦ä¸æ–­é‡ç»˜,å¦‚æœæ­¤æ—¶è®¾ç½®äº†cell.layerå¯å…‰æ …åŒ–ã€‚åˆ™ä¼šé€ æˆå¤§é‡çš„ç¦»å±æ¸²æŸ“,é™ä½å›¾å½¢æ€§èƒ½ã€‚ </p>
<p>æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥æŠŠé‚£äº›éœ€è¦å±å¹•å¤–ç»˜åˆ¶çš„å›¾å±‚å¼€å¯å…‰æ …åŒ–ä»¥ä½œä¸ºä¸€ä¸ªä¼˜åŒ–æ–¹å¼,å‰ææ˜¯è¿™äº›å›¾å±‚å¹¶ä¸ä¼šè¢«é¢‘ç¹åœ°é‡ç»˜ã€‚ </p>
<p><strong>é’ˆå¯¹å…‰æ …åŒ–å¤„ç†</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//ç¦»å±æ¸²æŸ“ - å¼‚æ­¥ç»˜åˆ¶  è€—ç”µ</span><br><span class="line">self.layer.drawsAsynchronously = true</span><br><span class="line">   </span><br><span class="line">//æ …æ ¼åŒ– - å¼‚æ­¥ç»˜åˆ¶ä¹‹å ï¼Œä¼šç”Ÿæˆä¸€å¼ ç‹¬ç«‹çš„å›¾ç‰‡ cell åœ¨å±å¹•ä¸Šæ»šåŠ¨çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ»šåŠ¨çš„æ˜¯è¿™å¼ å›¾ç‰‡ </span><br><span class="line">//cell ä¼˜åŒ–ï¼Œè¦å°½é‡å‡å°‘å›¾å±‚çš„æ•°é‡ï¼Œæƒ³å½“äºåªæœ‰ä¸€å±‚</span><br><span class="line">//åœæ­¢æ»šåŠ¨ä¹‹åï¼Œå¯ä»¥æ¥å—ç›‘å¬</span><br><span class="line">self.layer.shouldRasterize = true</span><br><span class="line">   </span><br><span class="line">//ä½¿ç”¨ â€œæ …æ ¼åŒ–â€ å¿…é¡»æŒ‡å®šåˆ†è¾¨ç‡</span><br><span class="line">self.layer.rasterizationScale = UIScreen.main.scale</span><br></pre></td></tr></table></figure>
<p><strong>é˜´å½±å¤„ç†</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// æŒ‡å®šé˜´å½±æ›²çº¿ï¼Œé˜²æ­¢é˜´å½±æ•ˆæœå¸¦æ¥çš„ç¦»å±æ¸²æŸ“</span><br><span class="line">        imageView.layer.shadowPath = UIBezierPath(rect: imageView.bounds).cgPath</span><br></pre></td></tr></table></figure>
<p>â€‹</p>
<h4 id="é®ç½©"><a href="#é®ç½©" class="headerlink" title="é®ç½©"></a>é®ç½©</h4><p>masks(é®ç½©) </p>
<p>maskæ˜¯layerçš„ä¸€ä¸ªå±æ€§.</p>
<p>å½“é€æ˜åº¦æ”¹å˜çš„æ—¶å€™,è¿™ä¸ª mask å°±æ˜¯è¦†ç›–ä¸Šå»çš„é‚£ä¸ªé˜´å½±ã€‚è¯¥å±‚çš„layerçš„alphaå†³å®šäº†å¤šå°‘å±‚èƒŒæ™¯è·Ÿå†…å®¹é€šè¿‡å¹¶æ˜¾ç¤º,å®Œå…¨æˆ–è€…éƒ¨åˆ†ä¸é€æ˜çš„åƒç´ å…è®¸æ½œåœ¨çš„å†…å®¹ é€šè¿‡å¹¶æ˜¾ç¤ºã€‚ é»˜è®¤æ˜¯nil,å½“é…ç½®ä¸€ä¸ªé®ç½©çš„æ—¶å€™,è®°å¾—è®¾ç½®é®ç½©çš„å¤§å°ã€ä½ç½®ã€‚å·²ç¡®ä¿è·Ÿç›–å›¾å±‚å¯¹é½ã€‚å¦‚æœä½ æƒ³ç»™è¿™ä¸ªå±æ€§èµ‹å€¼,å‰ææ˜¯å¿…é¡»æ²¡æœ‰ superLayer,å¦‚æœæœ‰superLayer,è¿™ä¸ªè¡Œä¸ºåˆ™æ˜¯æ— æ•ˆçš„ã€‚</p>
<h4 id="shadows-é˜´å½±"><a href="#shadows-é˜´å½±" class="headerlink" title="shadows(é˜´å½±)"></a>shadows(é˜´å½±)</h4><p>åœ¨é¡¹ç›®ä¸­,å½“æˆ‘ä»¬æƒ³è¦è®¾ç½®Viewçš„é˜´å½±æ•ˆæœæ—¶,å¯ä»¥é€šè¿‡shadow*ç›¸å…³æ–¹æ³•å®ç°,å¦‚:</p>
<p>self.layer.shadowOffset = CGSizeMake(4, -2); </p>
<p>self.layer.shadowOpacity = 0.5; </p>
<p>self.layer.shadowColor = [[UIColor blackColor] colorWithAlphaComponent:0.5].CGColor; </p>
<p>shadowså¯ä»¥ç»™è§†å›¾å‘¨è¾¹æ·»åŠ é˜´å½±,å½“ç»™ä¸€äº›æ»‘åŠ¨è§†å›¾åŠ é˜´å½±æ—¶,æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°åœ¨åŠ¨ç”»ä¸æ˜¯å¾ˆæµç•…,æœ‰å¡é¡¿ã€‚è¿™æ˜¯å› ä¸ºè®¡ç®—é˜´å½±éœ€è¦Core Animationåšä¸€ä¸ªç¦»å±æ¸²æŸ“,ä»¥Viewå‡†ç¡®çš„å½¢çŠ¶ç¡®å®šæ¸…æ¥šå¦‚ä½•å‘ˆç°å…¶é˜´å½±ã€‚</p>
<p>####å±å¹•æ¸²æŸ“æœ‰å¦‚ä¸‹ä¸‰ç§</p>
<p><code>GPU</code>ä¸­çš„å±å¹•æ¸²æŸ“ï¼š</p>
<p>1ã€<code>On-Screen Rendering</code></p>
<p>æ„ä¸ºå½“å‰å±å¹•æ¸²æŸ“ï¼ŒæŒ‡çš„æ˜¯<code>GPU</code>çš„æ¸²æŸ“æ“ä½œæ˜¯åœ¨å½“å‰ç”¨äºæ˜¾ç¤ºçš„å±å¹•ç¼“å†²åŒºä¸­è¿›è¡Œ</p>
<p>2ã€<code>Off-Screen Rendering</code></p>
<p>æ„ä¸ºç¦»å±æ¸²æŸ“ï¼ŒæŒ‡çš„æ˜¯<code>GPU</code>åœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–æ–°å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œ</p>
<p>3ã€<code>CPU</code>ä¸­çš„ç¦»å±æ¸²æŸ“ï¼ˆç‰¹æ®Šç¦»å±æ¸²æŸ“ï¼Œå³ä¸åœ¨<code>GPU</code>ä¸­çš„æ¸²æŸ“ï¼‰</p>
<p>å¦‚æœæˆ‘ä»¬é‡å†™äº†<code>drawRect</code>æ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ç”¨ä»»ä½•<code>Core Graphics</code>çš„æŠ€æœ¯è¿›è¡Œäº†ç»˜åˆ¶æ“ä½œï¼Œå°±æ¶‰åŠåˆ°äº†<code>CPU</code>æ¸²æŸ“</p>
<h4 id="åˆ‡åœ†è§’ä¼˜åŒ–"><a href="#åˆ‡åœ†è§’ä¼˜åŒ–" class="headerlink" title="åˆ‡åœ†è§’ä¼˜åŒ–"></a>åˆ‡åœ†è§’ä¼˜åŒ–</h4><p>åˆ‡åœ†è§’æ˜¯å¼€å‘<code>app</code>è¿‡ç¨‹ä¸­ç»å¸¸ä¼šç”¨åˆ°çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä½¿ç”¨ä¸åŒçš„æ–¹å¼ï¼Œæ€§èƒ½æŸè€—ä¹Ÿä¼šä¸åŒï¼Œä¸‹é¢ä¼šä»‹ç»<code>3</code>ç§åˆ‡åœ†è§’çš„æ–¹æ³•ï¼›å…¶ä¸­ï¼Œæ–¹æ³•ä¸‰çš„æ€§èƒ½ç›¸å¯¹æœ€å¥½ã€‚</p>
<h5 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h5><p>ä½¿ç”¨<code>cornerRadius</code>è¿›è¡Œåˆ‡åœ†è§’ï¼Œåœ¨<code>iOS9</code>ä¹‹å‰ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ï¼Œæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ï¼Œè€Œä¹‹åç³»ç»Ÿåšäº†ä¼˜åŒ–ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ï¼Œä½†æ˜¯æ“ä½œæœ€ç®€å•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iv.layer.cornerRadius = 30;</span><br><span class="line">iv.layer.masksToBounds = YES;</span><br></pre></td></tr></table></figure>
<h5 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h5><p>åˆ©ç”¨<code>mask</code>è®¾ç½®åœ†è§’ï¼Œåˆ©ç”¨çš„æ˜¯<code>UIBezierPath</code>å’Œ<code>CAShapeLayer</code>æ¥å®Œæˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CAShapeLayer *mask1 = [[CAShapeLayer alloc] init];</span><br><span class="line">mask1.opacity = 0.5;</span><br><span class="line">mask1.path = [UIBezierPath bezierPathWithOvalInRect:iv.bounds].CGPath;</span><br><span class="line">iv.layer.mask = mask1;</span><br></pre></td></tr></table></figure>
<h5 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h5><p>åˆ©ç”¨<code>CoreGraphics</code>ç”»ä¸€ä¸ªåœ†å½¢ä¸Šä¸‹æ–‡ï¼Œç„¶åæŠŠå›¾ç‰‡ç»˜åˆ¶ä¸Šå»ï¼Œå¾—åˆ°ä¸€ä¸ªåœ†å½¢çš„å›¾ç‰‡ï¼Œè¾¾åˆ°åˆ‡åœ†è§’çš„ç›®çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (UIImage *)drawCircleImage:(UIImage*)image</span><br><span class="line">&#123;</span><br><span class="line">    CGFloat side = MIN(image.size.width, image.size.height);</span><br><span class="line">    </span><br><span class="line">    UIGraphicsBeginImageContextWithOptions(CGSizeMake(side, side), false, [UIScreen mainScreen].scale);</span><br><span class="line">    CGContextAddPath(UIGraphicsGetCurrentContext(), [UIBezierPath bezierPathWithOvalInRect:CGRectMake(0, 0, side, side)].CGPath);</span><br><span class="line">    CGContextClip(UIGraphicsGetCurrentContext());</span><br><span class="line">    </span><br><span class="line">    CGFloat marginX = -(image.size.width - side) * 0.5;</span><br><span class="line">    CGFloat marginY = -(image.size.height - side) * 0.5;</span><br><span class="line">    [image drawInRect:CGRectMake(marginX, marginY, image.size.width, image.size.height)];</span><br><span class="line">    </span><br><span class="line">    CGContextDrawPath(UIGraphicsGetCurrentContext(), kCGPathFillStroke);</span><br><span class="line">    </span><br><span class="line">    UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext();</span><br><span class="line">    UIGraphicsEndImageContext();</span><br><span class="line">    </span><br><span class="line">    return newImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="å¼‚æ­¥ç»˜åˆ¶"><a href="#å¼‚æ­¥ç»˜åˆ¶" class="headerlink" title="å¼‚æ­¥ç»˜åˆ¶"></a>å¼‚æ­¥ç»˜åˆ¶</h2><p>å½“æƒ³è¿›ä¸€æ­¥ä¼˜åŒ–tableviewæ€§èƒ½æ—¶å¯ä»¥è€ƒè™‘å¼‚æ­¥ç»˜åˆ¶cellåŠæ–‡æœ¬æ§ä»¶ç­‰ã€‚å¤§ç¥çš„<a href="https://github.com/ibireme/YYAsyncLayer" target="_blank" rel="noopener">YYAsyncLayer</a>å®ç°äº†å¼‚æ­¥ç»˜åˆ¶çš„æ§ä»¶ã€‚</p>
<h2 id="UITableViewä¼˜åŒ–æ€»ç»“"><a href="#UITableViewä¼˜åŒ–æ€»ç»“" class="headerlink" title="UITableViewä¼˜åŒ–æ€»ç»“"></a>UITableViewä¼˜åŒ–æ€»ç»“</h2><p>UITableViewçš„ä¼˜åŒ–ä¸»è¦ä»ä¸‰ä¸ªæ–¹é¢å…¥æ‰‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æå‰è®¡ç®—å¹¶ç¼“å­˜å¥½é«˜åº¦ï¼ˆå¸ƒå±€ï¼‰ï¼Œå› ä¸ºheightForRowAtIndexPath:æ˜¯è°ƒç”¨æœ€é¢‘ç¹çš„æ–¹æ³•ï¼›</span><br><span class="line">å¼‚æ­¥ç»˜åˆ¶ï¼Œé‡åˆ°å¤æ‚ç•Œé¢ï¼Œé‡åˆ°æ€§èƒ½ç“¶é¢ˆæ—¶ï¼Œå¯èƒ½å°±æ˜¯çªç ´å£ï¼›</span><br><span class="line">æ»‘åŠ¨æ—¶æŒ‰éœ€åŠ è½½ï¼Œè¿™ä¸ªåœ¨å¤§é‡å›¾ç‰‡å±•ç¤ºï¼Œç½‘ç»œåŠ è½½çš„æ—¶å€™å¾ˆç®¡ç”¨ï¼ï¼ˆSDWebImageå·²ç»å®ç°å¼‚æ­¥åŠ è½½ï¼Œé…åˆè¿™æ¡æ€§èƒ½æ æ çš„ï¼‰ã€‚</span><br></pre></td></tr></table></figure>
<p>é™¤äº†ä¸Šé¢æœ€ä¸»è¦çš„ä¸‰ä¸ªæ–¹é¢å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå‡ ä¹å¤§ä¼™éƒ½å¾ˆç†ŸçŸ¥çš„ä¼˜åŒ–ç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ­£ç¡®ä½¿ç”¨reuseIdentifieræ¥é‡ç”¨Cells</span><br><span class="line">å°½é‡ä½¿æ‰€æœ‰çš„view opaqueï¼ŒåŒ…æ‹¬Cellè‡ªèº«</span><br><span class="line">å°½é‡å°‘ç”¨æˆ–ä¸ç”¨é€æ˜å›¾å±‚</span><br><span class="line">å¦‚æœCellå†…ç°å®çš„å†…å®¹æ¥è‡ªwebï¼Œä½¿ç”¨å¼‚æ­¥åŠ è½½ï¼Œç¼“å­˜è¯·æ±‚ç»“æœ</span><br><span class="line">å‡å°‘subviewsçš„æ•°é‡</span><br><span class="line">åœ¨heightForRowAtIndexPath:ä¸­å°½é‡ä¸ä½¿ç”¨cellForRowAtIndexPath:ï¼Œå¦‚æœä½ éœ€è¦ç”¨åˆ°å®ƒï¼Œåªç”¨ä¸€æ¬¡ç„¶åç¼“å­˜ç»“æœ</span><br><span class="line">å°½é‡å°‘ç”¨addViewç»™CellåŠ¨æ€æ·»åŠ Viewï¼Œå¯ä»¥åˆå§‹åŒ–æ—¶å°±æ·»åŠ ï¼Œç„¶åé€šè¿‡hideæ¥æ§åˆ¶æ˜¯å¦æ˜¾ç¤º</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒ:</p>
<p><a href="https://blog.ibireme.com/author/ibireme/" target="_blank" rel="noopener">ibireme</a>iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</p>
<p><a href="https://blog.csdn.net/mo_xiao_mo" target="_blank" rel="noopener">mo_xiao_mo</a>UITableViewçš„ä¼˜åŒ–æŠ€å·§ï¼å¼‚æ­¥ç»˜åˆ¶Cell</p>
<p><a href="https://www.jianshu.com/p/64f0e1557562" target="_blank" rel="noopener">iOS_å°æ¾å“¥</a>UITableViewè‡ªåŠ¨è®¡ç®—cellé«˜åº¦å¹¶ç¼“å­˜ï¼Œå†ä¹Ÿä¸ç”¨ç®¡é«˜åº¦å•¦</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Sun Lei</p>
              <p class="site-description motion-element" itemprop="description">åªæœ‰ç”¨å¿ƒæ‰èƒ½çœ‹æ¸…æ¥šÂ·çœŸæ­£é‡è¦çš„ä¸œè¥¿Â·ç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sun Lei</span>

  

  
</div>




  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨ v3.4.4</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ â€“ <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
